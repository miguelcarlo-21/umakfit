<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UMakFit - Data Privacy Agreement</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Inter:600,500,400,700" rel="stylesheet">
    <style>
        * {
            -webkit-font-smoothing: antialiased;
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', Helvetica, sans-serif;
            background: linear-gradient(180deg, rgba(30, 58, 138, 1) 0%, rgba(59, 130, 246, 1) 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .privacy-container {
            max-width: 900px;
            margin: 40px auto;
            background: white;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .privacy-header {
            background: linear-gradient(270deg, rgba(59, 130, 246, 1) 0%, rgba(30, 58, 138, 1) 100%);
            padding: 40px;
            text-align: center;
            color: white;
        }

        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .logo-box {
            width: 53px;
            height: 50px;
            border-radius: 7px;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .logo-text {
            background: linear-gradient(90deg, rgba(251, 191, 36, 1) 0%, rgba(255, 229, 0, 1) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
            font-size: 32px;
        }

        .privacy-title {
            font-weight: 700;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .privacy-subtitle {
            font-weight: 400;
            font-size: 14px;
            opacity: 0.9;
        }

        .privacy-content {
            padding: 40px;
            max-height: 500px;
            overflow-y: auto;
        }

        .privacy-content::-webkit-scrollbar {
            width: 8px;
        }

        .privacy-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .privacy-content::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 10px;
        }

        .section-title {
            font-weight: 700;
            color: #1e3a8a;
            font-size: 20px;
            margin-top: 30px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title:first-child {
            margin-top: 0;
        }

        .section-icon {
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .privacy-text {
            color: #475569;
            font-size: 14px;
            line-height: 1.8;
            margin-bottom: 15px;
        }

        .privacy-list {
            list-style: none;
            padding-left: 0;
            margin-bottom: 20px;
        }

        .privacy-list li {
            color: #475569;
            font-size: 14px;
            line-height: 1.8;
            padding-left: 30px;
            position: relative;
            margin-bottom: 10px;
        }

        .privacy-list li:before {
            content: "‚úì";
            position: absolute;
            left: 0;
            color: #10b981;
            font-weight: 700;
            font-size: 18px;
        }

        .highlight-box {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }

        .highlight-box strong {
            color: #1e3a8a;
            display: block;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .privacy-footer {
            padding: 30px 40px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
        }

        .agreement-section {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 25px;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

        .custom-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #3b82f6;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .custom-checkbox:hover {
            background: #eff6ff;
        }

        .custom-checkbox.checked {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border-color: #3b82f6;
        }

        .checkbox-svg {
            width: 14px;
            height: 14px;
            stroke: white;
            stroke-width: 3;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .custom-checkbox.checked .checkbox-svg {
            opacity: 1;
        }

        .agreement-text {
            color: #475569;
            font-size: 14px;
            line-height: 1.6;
            user-select: none;
        }

        .agreement-text strong {
            color: #1e3a8a;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: space-between;
        }

        .btn {
            height: 50px;
            border-radius: 11px;
            font-weight: 600;
            font-size: 16px;
            padding: 0 32px;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-decline {
            background: #f1f5f9;
            color: #64748b;
            flex: 1;
        }

        .btn-decline:hover {
            background: #e2e8f0;
        }

        .btn-accept {
            background: linear-gradient(270deg, rgba(59, 130, 246, 1) 0%, rgba(30, 58, 138, 1) 100%);
            color: white;
            flex: 2;
        }

        .btn-accept:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .btn-accept:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            color: #dc2626;
            font-size: 13px;
            text-align: center;
            padding: 10px;
            background: #fee2e2;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            gap: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .privacy-container {
                margin: 20px auto;
            }

            .privacy-header {
                padding: 30px 20px;
            }

            .privacy-content {
                padding: 30px 20px;
            }

            .privacy-footer {
                padding: 20px;
            }

            .button-group {
                flex-direction: column-reverse;
            }

            .btn {
                width: 100%;
            }

            .privacy-title {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div style="color: #1e3a8a; font-weight: 600;" id="loadingText">Processing...</div>
    </div>

    <div class="privacy-container">
        <div class="privacy-header">
            <div class="logo-container">
                <div class="logo-box">üèÉ‚Äç‚ôÇÔ∏è</div>
                <div class="logo-text">UmakFit</div>
            </div>
            <div class="privacy-title">Data Privacy Agreement</div>
            <div class="privacy-subtitle">Please read and accept our data privacy policy to continue</div>
        </div>

        <div class="privacy-content">
            <div class="section-title">
                <div class="section-icon">üìã</div>
                Introduction
            </div>
            <p class="privacy-text">
                The University of Makati (UMak) is committed to protecting your personal data in accordance with the 
                <strong>Republic Act No. 10173</strong>, also known as the <strong>Data Privacy Act of 2012</strong>. 
                This agreement outlines how we collect, use, and protect your information through the UMakFit platform.
            </p>

            <div class="section-title">
                <div class="section-icon">üîí</div>
                Data We Collect
            </div>
            <p class="privacy-text">When you register and use UMakFit, we collect the following information:</p>
            <ul class="privacy-list">
                <li>Personal Information (Name, Email, Student ID, Contact Number)</li>
                <li>Academic Information (Program Course, Year Level, Section)</li>
                <li>Physical Information (Height, Weight, Age, Gender)</li>
                <li>Medical Information (Health conditions relevant to physical activities)</li>
                <li>Fitness Test Results and Progress Data</li>
                <li>Account Activity and Login Information</li>
            </ul>

            <div class="section-title">
                <div class="section-icon">üéØ</div>
                Purpose of Data Collection
            </div>
            <p class="privacy-text">Your data will be used for the following purposes:</p>
            <ul class="privacy-list">
                <li>To create and manage your UMakFit account</li>
                <li>To track and monitor your fitness progress</li>
                <li>To provide personalized fitness recommendations</li>
                <li>To facilitate communication between students and professors</li>
                <li>To generate reports and analytics for academic purposes</li>
                <li>To ensure the safety and effectiveness of fitness programs</li>
            </ul>

            <div class="highlight-box">
                <strong>Important Notice:</strong>
                <p class="privacy-text" style="margin: 0;">
                    Your medical information will only be accessible to authorized personnel (professors and administrators) 
                    to ensure your safety during physical activities. This information is kept strictly confidential.
                </p>
            </div>

            <div class="section-title">
                <div class="section-icon">üë•</div>
                Data Sharing and Access
            </div>
            <p class="privacy-text">Your information may be accessed by:</p>
            <ul class="privacy-list">
                <li>Your assigned Physical Education professors</li>
                <li>University administrators and authorized staff</li>
                <li>Technical support personnel for system maintenance</li>
            </ul>
            <p class="privacy-text">
                <strong>We will NOT</strong> share your personal data with third parties outside the university 
                without your explicit consent, except when required by law.
            </p>

            <div class="section-title">
                <div class="section-icon">üõ°Ô∏è</div>
                Data Security
            </div>
            <p class="privacy-text">
                UMak implements appropriate technical and organizational measures to protect your personal data against 
                unauthorized access, alteration, disclosure, or destruction. All data is stored securely using industry-standard 
                encryption protocols.
            </p>

            <div class="section-title">
                <div class="section-icon">‚öñÔ∏è</div>
                Your Rights
            </div>
            <p class="privacy-text">Under the Data Privacy Act, you have the right to:</p>
            <ul class="privacy-list">
                <li>Access your personal data stored in the system</li>
                <li>Request correction of inaccurate or incomplete data</li>
                <li>Object to the processing of your data</li>
                <li>Request deletion of your data (subject to university retention policies)</li>
                <li>Lodge complaints with the National Privacy Commission</li>
            </ul>

            <div class="section-title">
                <div class="section-icon">üìû</div>
                Contact Information
            </div>
            <p class="privacy-text">
                For questions or concerns regarding data privacy, you may contact the University's Data Protection Officer:
            </p>
            <div class="highlight-box">
                <p class="privacy-text" style="margin: 0;">
                    <strong>Email:</strong> dpo@umak.edu.ph<br>
                    <strong>Phone:</strong> (02) 8883-1234<br>
                    <strong>Address:</strong> J.P. Rizal Extension, West Rembo, Makati City
                </p>
            </div>
        </div>

        <div class="privacy-footer">
            <div class="error-message" id="errorMessage"></div>
            
            <div class="agreement-section">
                <div class="checkbox-wrapper" onclick="toggleCheckbox()">
                    <div class="custom-checkbox" id="checkboxDisplay">
                        <svg class="checkbox-svg" viewBox="0 0 24 24">
                            <path d="M20 6L9 17L4 12" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="agreement-text">
                        I have read and understood the Data Privacy Agreement. I hereby give my <strong>free, 
                        informed, and voluntary consent</strong> to the University of Makati to collect, use, 
                        and process my personal data as described above.
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-decline" onclick="handleDecline()">
                    Decline
                </button>
                <button class="btn btn-accept" id="acceptBtn" onclick="handleAccept()" disabled>
                    I Accept - Continue to Dashboard
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, updateDoc, getDoc, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAgaLunqEf2gs6dSpF_sz1hV5XQ5Wm52jo",
            authDomain: "umakfit-e3b1d.firebaseapp.com",
            projectId: "umakfit-e3b1d",
            storageBucket: "umakfit-e3b1d.appspot.com",
            messagingSenderId: "276569891504",
            appId: "1:276569891504:web:39b1732b519f4d8b785175"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.auth = auth;
        window.db = db;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.getDoc = getDoc;
        window.collection = collection;
        window.query = query;
        window.where = where;
        window.getDocs = getDocs;
        window.signOut = signOut;

        let currentUser = null;
        let currentStudentId = null;
        let isChecked = false;

        // Find student by email
        async function findStudentByEmail(email) {
            try {
                console.log('üîç Looking for student with email:', email);
                const studentsQuery = window.query(
                    window.collection(window.db, 'students'),
                    window.where('email', '==', email.toLowerCase())
                );
                const studentsSnapshot = await window.getDocs(studentsQuery);
                
                if (!studentsSnapshot.empty) {
                    const studentDoc = studentsSnapshot.docs[0];
                    console.log('‚úÖ Found student:', studentDoc.id);
                    return {
                        id: studentDoc.id,
                        data: studentDoc.data()
                    };
                }
                
                console.log('‚ùå No student found with email:', email);
                return null;
                
            } catch (error) {
                console.error('Error finding student by email:', error);
                return null;
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                console.log('‚ùå No user logged in');
                alert('Please log in first');
                window.location.href = '/login/index.html';
                return;
            }

            currentUser = user;
            console.log('=== DATA PRIVACY PAGE ===');
            console.log('User:', user.email);

            // Find student by email
            const studentInfo = await findStudentByEmail(user.email);
            
            if (!studentInfo) {
                console.log('‚ùå Student not found in system');
                alert('Your account is not registered. Please contact your college secretary.');
                await window.signOut(window.auth);
                window.location.href = '/login/index.html';
                return;
            }

            currentStudentId = studentInfo.id;
            
            console.log('Student ID:', studentInfo.id);
            console.log('Email Verified:', studentInfo.data.emailVerified);
            console.log('Privacy Accepted:', studentInfo.data.privacyAccepted);

            // If email not verified, send back to verification
            if (!studentInfo.data.emailVerified) {
                console.log('‚ö†Ô∏è Email not verified, redirecting to OTP verification');
                alert('Please verify your email first');
                window.location.href = 'otp-verification.html';
                return;
            }

            // If privacy already accepted, go to dashboard
            if (studentInfo.data.privacyAccepted) {
                console.log('‚úì Privacy already accepted, redirecting to dashboard');
                window.location.href = '/student/studentDashboard.html';
                return;
            }

            console.log('‚úì User ready to accept privacy policy');
        });

        window.toggleCheckbox = function() {
            isChecked = !isChecked;
            const checkboxDisplay = document.getElementById('checkboxDisplay');
            const acceptBtn = document.getElementById('acceptBtn');
            
            if (isChecked) {
                checkboxDisplay.classList.add('checked');
                acceptBtn.disabled = false;
            } else {
                checkboxDisplay.classList.remove('checked');
                acceptBtn.disabled = true;
            }
            
            console.log('Checkbox state:', isChecked);
        };

        window.handleDecline = async function() {
            if (confirm('If you decline, you will not be able to use UMakFit. Are you sure you want to decline?')) {
                await window.signOut(window.auth);
                window.location.href = '/login/index.html';
            }
        };

        window.handleAccept = async function() {
            if (!isChecked) {
                showError('Please accept the Data Privacy Agreement to continue');
                return;
            }

            if (!currentUser || !currentStudentId) {
                showError('Session expired. Please log in again.');
                return;
            }

            console.log('=== ACCEPTING PRIVACY POLICY ===');
            console.log('User:', currentUser.email);
            console.log('Student ID:', currentStudentId);
            
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('loadingText').textContent = 'Saving your acceptance...';

            try {
                // Update student record
                const studentRef = window.doc(window.db, 'students', currentStudentId);
                
                await window.updateDoc(studentRef, {
                    privacyAccepted: true,
                    privacyAcceptedAt: new Date().toISOString(),
                    uid: currentUser.uid,
                    lastLogin: new Date().toISOString(),
                    isActive: true
                });

                console.log('‚úì Privacy policy accepted successfully');

                // Also update users collection
                try {
                    const userRef = window.doc(window.db, 'users', currentUser.uid);
                    await window.updateDoc(userRef, {
                        privacyAccepted: true,
                        lastLogin: new Date().toISOString(),
                        isActive: true
                    }, { merge: true });
                    console.log('‚úì Users collection updated');
                } catch (error) {
                    console.log('Note: Could not update users collection:', error);
                }

                console.log('‚Üí Redirecting to dashboard');
                document.getElementById('loadingText').textContent = 'Redirecting to dashboard...';

                setTimeout(() => {
                    window.location.href = '/student/studentDashboard.html';
                }, 1000);

            } catch (error) {
                console.error('‚ùå Error accepting privacy policy:', error);
                document.getElementById('loadingOverlay').style.display = 'none';
                showError('Error saving your response. Please try again.');
            }
        };

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>