<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UmakFit - Test Management</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Manrope:600,800|Inter:300,500,400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { -webkit-font-smoothing: antialiased; box-sizing: border-box; }
        body { font-family: 'Inter', Helvetica, sans-serif; margin: 0; padding: 0; background-color: #f6f6f6; }
        
        /* Header Styles */
        .header-top { 
            background-color: #ffffff; 
            padding: 15px 0; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.08); 
            position: fixed; 
            top: 0; 
            width: 100%; 
            z-index: 1000; 
            border-bottom: 1px solid #e2e8f0;
        }
        .header-top .container { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .logo-text { 
            font-family: "Inter", Helvetica; 
            font-weight: 700; 
            color: #1e3a8a; 
            font-size: 24px; 
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo-text i {
            color: #f59e0b;
            font-size: 26px;
        }
        .header-actions { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        .logout-btn { 
            padding: 8px 20px; 
            background: linear-gradient(90deg, rgba(251, 191, 36, 1) 0%, rgba(245, 158, 11, 1) 100%); 
            border: none; 
            border-radius: 8px; 
            color: #000; 
            font-weight: 600; 
            font-size: 14px; 
            cursor: pointer; 
            transition: all 0.3s; 
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        }
        .logout-btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.4); 
        }
        .account-circle { 
            width: 44px; 
            height: 44px; 
            cursor: pointer; 
            border-radius: 50%;
            border: 2px solid #e2e8f0;
            transition: all 0.3s;
        }
        
        /* Navigation Styles */
        .nav-section { 
            background: linear-gradient(180deg, rgba(30, 58, 138, 1) 0%, rgba(59, 130, 246, 1) 100%); 
            padding: 20px 0; 
            margin-top: 74px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .nav-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }
        .nav-brand { 
            display: flex;
            align-items: center;
            gap: 15px;
            font-family: "Manrope", Helvetica; 
            font-weight: 800; 
            font-size: 28px; 
            background: linear-gradient(90deg, rgba(245, 158, 11, 1) 0%, rgba(255, 229, 0, 1) 100%); 
            -webkit-background-clip: text; 
            background-clip: text; 
            -webkit-text-fill-color: transparent;
            margin: 0;
        }
        .nav-brand-logo {
            height: 60px;
            width: auto;
        }
        .nav-pills-custom { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
            padding: 0; 
            margin: 0;
        }
        .nav-pills-custom .nav-link { 
            font-family: "Manrope", Helvetica; 
            font-weight: 600; 
            color: #000000; 
            font-size: 14px; 
            padding: 12px 18px;
            border-radius: 8px; 
            background-color: #ffffff; 
            transition: all 0.3s; 
            border: none; 
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .nav-pills-custom .nav-link.active { 
            background: linear-gradient(90deg, rgba(251, 191, 36, 1) 0%, rgba(245, 158, 11, 1) 100%); 
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
        }
        .nav-pills-custom .nav-link:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.15); 
        }
        
        /* Main Content */
        .main-content { 
            padding: 40px 0 80px 0; 
            min-height: calc(100vh - 200px); 
        }
        
        /* Info Banner */
        .info-banner {
            background: white;
            border-radius: 16px;
            padding: 25px 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .info-banner-icon {
            width: 55px;
            height: 55px;
            flex-shrink: 0;
        }
        .info-banner-content {
            flex: 1;
        }
        .info-banner-title {
            font-family: "Inter", Helvetica;
            font-weight: 700;
            color: #1e3a8a;
            font-size: 28px;
            margin-bottom: 5px;
        }
        .info-banner-subtitle {
            font-family: "Inter", Helvetica;
            font-weight: 700;
            color: #1e3a8a;
            font-size: 14px;
        }
        
        /* Test Section */
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 4px rgba(0,0,0,0.25);
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .section-title {
            font-family: "Inter", Helvetica;
            font-weight: 600;
            color: #1e3a8a;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .btn-primary-custom {
            background: linear-gradient(90deg, rgba(30, 58, 138, 1) 0%, rgba(59, 130, 246, 1) 100%);
            border: none;
            border-radius: 7px;
            padding: 8px 20px;
            color: white;
            font-family: "Inter", Helvetica;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(30, 58, 138, 0.3);
        }
        .btn-generate {
            background: linear-gradient(90deg, rgba(30, 58, 138, 1) 0%, rgba(59, 130, 246, 1) 100%);
            border: none;
            border-radius: 7px;
            padding: 6px 15px;
            color: white;
            font-family: "Inter", Helvetica;
            font-weight: 400;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .search-box {
            position: relative;
            margin-bottom: 15px;
        }
        .search-box input {
            width: 298px;
            height: 28px;
            border: 1px solid #000;
            border-radius: 5px;
            padding: 5px 10px 5px 30px;
            font-family: "Inter", Helvetica;
            font-size: 10px;
            color: #000;
        }
        .search-box input::placeholder {
            color: rgba(0,0,0,0.5);
        }
        .search-box i {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            font-size: 12px;
        }
        
        /* Table Styles */
        .table-responsive {
            overflow-x: auto;
        }
        .custom-table {
            width: 100%;
            border-collapse: collapse;
        }
        .custom-table thead {
            background-color: #f3f2f2;
        }
        .custom-table th {
            font-family: "Inter", Helvetica;
            font-weight: 600;
            color: #1e3a8a;
            font-size: 15px;
            text-align: center;
            padding: 12px 8px;
            border-bottom: 2px solid #e2e8f0;
        }
        .custom-table td {
            font-family: "Inter", Helvetica;
            font-weight: 400;
            color: #000;
            font-size: 14px;
            text-align: center;
            padding: 16px 8px;
            border-bottom: 1px solid #f1f5f9;
        }
        .custom-table tbody tr:hover {
            background-color: #f8fafc;
        }
        .progress-cell {
            font-size: 10px;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 14px;
            font-family: "Inter", Helvetica;
            font-weight: 600;
            font-size: 11px;
        }
        .status-active {
            background-color: #a4fbb1;
            color: #000;
        }
        .status-scheduled {
            background-color: #fbbf24;
            color: #000;
        }
        .status-completed {
            background-color: #3b82f6;
            color: #fff;
        }
        .rating-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 14px;
            font-family: "Inter", Helvetica;
            font-weight: 600;
            font-size: 11px;
        }
        .rating-excellent {
            background-color: #a4fbb1;
            color: #000;
        }
        .rating-good {
            background-color: #3b82f6;
            color: #fff;
        }
        .rating-fair {
            background-color: #fbbf24;
            color: #000;
        }
        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .btn-action {
            padding: 4px 10px;
            border: none;
            border-radius: 4px;
            font-family: "Inter", Helvetica;
            font-weight: 600;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-edit {
            background-color: #111b66;
            color: white;
        }
        .btn-edit:hover {
            background-color: #0d1450;
        }
        .btn-cancel {
            background: linear-gradient(180deg, rgba(245, 158, 11, 1) 0%, rgba(251, 191, 36, 1) 100%);
            color: white;
        }
        .btn-cancel:hover {
            opacity: 0.9;
        }
        .btn-view {
            background-color: #111b66;
            color: white;
        }
        .btn-view:hover {
            background-color: #0d1450;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }
        .modal-content {
            background-color: white;
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title {
            font-family: "Inter", Helvetica;
            font-weight: 600;
            color: #1e3a8a;
            font-size: 20px;
            margin: 0;
        }
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
            transition: color 0.3s;
        }
        .close-modal:hover {
            color: #1e293b;
        }
        .modal-body {
            padding: 25px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-label {
            display: block;
            font-family: "Inter", Helvetica;
            font-weight: 500;
            color: #374151;
            font-size: 14px;
            margin-bottom: 8px;
        }
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-family: "Inter", Helvetica;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        .form-control:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-family: "Inter", Helvetica;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
        }
        .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            font-family: "Inter", Helvetica;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .btn-success {
            background: linear-gradient(90deg, rgba(30, 58, 138, 1) 0%, rgba(59, 130, 246, 1) 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            font-family: "Inter", Helvetica;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(30, 58, 138, 0.3);
        }
        
        /* Empty State */
        .empty-state {
            padding: 60px 40px;
            text-align: center;
        }
        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.4;
        }
        .empty-title {
            font-family: "Inter", Helvetica;
            font-weight: 700;
            color: #1f2937;
            font-size: 20px;
            margin-bottom: 12px;
        }
        .empty-text {
            font-family: "Inter", Helvetica;
            font-weight: 400;
            color: #64748b;
            font-size: 14px;
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto;
        }
        
        /* Loading Screen */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            gap: 20px;
        }
        .loading-text {
            font-family: "Inter", Helvetica;
            font-weight: 500;
            color: #475569;
            font-size: 16px;
        }
        .spinner {
            border: 4px solid #f1f5f9;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
                align-items: flex-start;
            }
            .nav-pills-custom {
                width: 100%;
                justify-content: center;
            }
            .info-banner {
                flex-direction: column;
                text-align: center;
            }
            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .search-box input {
                width: 100%;
            }
            .custom-table {
                font-size: 12px;
            }
            .custom-table th,
            .custom-table td {
                padding: 8px 4px;
            }
            .modal-content {
                margin: 10px;
                max-height: calc(100vh - 20px);
            }
        }
    </style>
</head>
<body>
    <div id="loadingScreen" class="loading">
        <div class="spinner"></div>
        <div class="loading-text">Loading Test Management...</div>
    </div>
    
    <div id="mainContent" style="display: none;">
        <div class="header-top">
            <div class="container">
                <div class="logo-text">
                    <i class="fas fa-graduation-cap"></i>
                    University of Makati
                </div>
                <div class="header-actions">
                    <button class="logout-btn" onclick="handleLogout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                    <img class="account-circle" src="https://c.animaapp.com/kboeAmgh/img/icon.svg" alt="Account">
                </div>
            </div>
        </div>
        
      <div class="nav-section">
    <div class="container">
        <div class="nav-container">
            <div class="nav-brand">
                <img class="nav-brand-logo" src="logo.png" alt="UMakFit">
                UMakFit
            </div>
            <ul class="nav nav-pills-custom">
                <li class="nav-item">
                    <a class="nav-link" href="professor.html">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="studentmanagement.html">
                        <i class="fas fa-users"></i> Student Management
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="addactivities.html">
                        <i class="fas fa-dumbbell"></i> Add Activities
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="addlesson.html">
                        <i class="fas fa-book-open"></i> Add Lesson
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="monitoringactivities.html">
                        <i class="fas fa-chart-bar"></i> Monitoring Activities
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="grades.html">
                        <i class="fas fa-graduation-cap"></i> Grades
                    </a>
                </li>
            </ul>
        </div>
    </div>
</div>
        
        <div class="main-content">
            <div class="container">
                <div class="info-banner">
                    <img class="info-banner-icon" src="https://c.animaapp.com/kboeAmgh/img/image-13@2x.png" alt="Icon">
                    <div class="info-banner-content">
                        <div class="info-banner-title">Test Management</div>
                        <div class="info-banner-subtitle">Schedule fitness tests, track progress, and manage student assessments</div>
                    </div>
                </div>
                
                <div class="test-section">
                    <div class="section-header">
                        <div class="section-title">
                            <i class="fas fa-calendar-check"></i> My Test Schedule
                        </div>
                        <button class="btn-primary-custom" onclick="showScheduleTestModal()">
                            <i class="fas fa-plus"></i> Schedule New Test
                        </button>
                    </div>
                    
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchSchedule" placeholder="Search by Test Name or Section" onkeyup="filterScheduleTable()">
                    </div>
                    
                    <div class="table-responsive">
                        <table class="custom-table" id="scheduleTable">
                            <thead>
                                <tr>
                                    <th>Test Name</th>
                                    <th>Section</th>
                                    <th>Date</th>
                                    <th>Deadline</th>
                                    <th>Progress</th>
                                    <th>Attempts Allowed</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleTableBody">
                                <tr>
                                    <td colspan="8">
                                        <div class="empty-state">
                                            <div class="empty-icon">üìÖ</div>
                                            <div class="empty-title">No Scheduled Tests</div>
                                            <div class="empty-text">You haven't scheduled any tests yet. Click "Schedule New Test" to create your first fitness test schedule.</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="test-section">
                    <div class="section-header">
                        <div class="section-title">
                            <i class="fas fa-chart-line"></i> Recent Test Results
                        </div>
                        <button class="btn-generate" onclick="generateReports()">
                            <i class="fas fa-file-alt"></i> Generate Reports
                        </button>
                    </div>
                    
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchResults" placeholder="Search by student name" onkeyup="filterResultsTable()">
                    </div>
                    
                    <div class="table-responsive">
                        <table class="custom-table" id="resultsTable">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Section</th>
                                    <th>Date</th>
                                    <th>Test</th>
                                    <th>Score</th>
                                    <th>BMI</th>
                                    <th>Rating</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody">
                                <tr>
                                    <td colspan="8">
                                        <div class="empty-state">
                                            <div class="empty-icon">üìä</div>
                                            <div class="empty-title">No Test Results Yet</div>
                                            <div class="empty-text">No students have completed tests yet. Test results will appear here once students start taking and completing their fitness assessments.</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule Test Modal -->
   <!-- Schedule Test Modal -->
   <div id="scheduleTestModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Schedule New Test</h3>
            <button class="close-modal" onclick="closeScheduleTestModal()">&times;</button>
        </div>
        <div class="modal-body">
          <!-- REPLACE THIS in the modal (around line 280): -->
<div class="form-group">
    <label class="form-label" for="videoURL">
        <i class="fab fa-youtube"></i> Instruction Video URL (Optional)
    </label>
    <input type="url" class="form-control" id="videoURL" placeholder="https://www.youtube.com/watch?v=...">
    <small style="color: #64748b; font-size: 12px; margin-top: 5px; display: block;">
        üì∫ Paste a YouTube video link for test instructions (optional)
    </small>
    <small style="color: #3b82f6; font-size: 12px; margin-top: 5px;">
        üí° Tip: Upload your video to YouTube first, then copy the link here
    </small>
</div>
            
           <div class="form-group">
    <label class="form-label" for="testType">Test Type <span style="color: #ef4444;">*</span></label>
    <select class="form-select" id="testType" required>
        <option value="">Select Test Type</option>
        
        <!-- Cardiorespiratory Endurance -->
        <optgroup label="ü´Å Cardiorespiratory Endurance">
            <option value="3-Minute Step Test">3-Minute Step Test</option>
            <option value="1-Mile Run">1-Mile Run</option>
        </optgroup>
        
        <!-- Muscular Strength -->
        <optgroup label="üí™ Muscular Strength">
            <option value="Grip Strength">Grip Strength Test</option>
        </optgroup>
        
        <!-- Muscular Endurance -->
        <optgroup label="üîÅ Muscular Endurance">
            <option value="Curl-Up Test">Curl-Up Test (Abdominal)</option>
            <option value="Push-Up Test">Push-Up Test</option>
        </optgroup>
        
        <!-- Flexibility -->
        <optgroup label="ü§∏ Flexibility">
            <option value="Sit-and-Reach">Sit-and-Reach Test</option>
        </optgroup>
        
        <!-- Body Composition -->
        <optgroup label="‚öñÔ∏è Body Composition">
            <option value="BMI Assessment">BMI Assessment</option>
            <option value="Skinfold Caliper">Skinfold Caliper Measurements</option>
        </optgroup>
    </select>
</div>
            <div class="form-group">
                <label class="form-label" for="testSection">Section</label>
                <select class="form-select" id="testSection">
                    <option value="">Select Section</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="testDate">Test Date</label>
                <input type="date" class="form-control" id="testDate">
            </div>
            <div class="form-group">
                <label class="form-label" for="testDeadline">Deadline Date</label>
                <input type="date" class="form-control" id="testDeadline">
            </div>
            <div class="form-group">
                <label class="form-label" for="testDeadlineTime">Deadline Time</label>
                <input type="time" class="form-control" id="testDeadlineTime" value="23:59">
            </div>
            <div class="form-group">
                <label class="form-label" for="attemptsAllowed">Attempts Allowed</label>
                <select class="form-select" id="attemptsAllowed">
                    <option value="1">1 Attempt</option>
                    <option value="2">2 Attempts</option>
                    <option value="3">3 Attempts</option>
                </select>
            </div>
            <div class="form-group" id="testTargetGroup" style="display: none;">
                <label class="form-label" id="testTargetLabel">Test Target</label>
                <input type="number" class="form-control" id="testTarget" min="1">
                <small class="text-muted" id="testTargetHint"></small>
            </div>
            <div class="form-group">
                <label class="form-label" for="testInstructions">Additional Instructions (Optional)</label>
                <textarea class="form-control" id="testInstructions" rows="3" placeholder="Add any specific instructions for this test..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeScheduleTestModal()">Cancel</button>
            <button class="btn-success" onclick="scheduleTest()">Schedule Test</button>
        </div>
    </div>
</div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
   <script type="module">
import { 
    initializeApp 
} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { 
    getAuth, 
    onAuthStateChanged, 
    signOut 
} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
import { 
    getFirestore, 
    collection, 
    query, 
    where, 
    getDocs, 
    orderBy, 
    doc, 
    getDoc, 
    addDoc, 
    serverTimestamp,
    onSnapshot,
    deleteDoc
} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
import { 
    getStorage, 
    ref, 
    uploadBytesResumable, 
    getDownloadURL, 
    deleteObject 
} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

const firebaseConfig = {
    apiKey: "AIzaSyAgaLunqEf2gs6dSpF_sz1hV5XQ5Wm52jo",
    authDomain: "umakfit-e3b1d.firebaseapp.com",
    projectId: "umakfit-e3b1d",
    storageBucket: "umakfit-e3b1d.appspot.com",
    messagingSenderId: "276569891504",
    appId: "1:276569891504:web:39b1732b519f4d8b785175"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// CRITICAL: Make these globally available
window.auth = auth;
window.db = db;
window.storage = storage;
window.signOut = signOut;
window.addDoc = addDoc;
window.collection = collection;
window.serverTimestamp = serverTimestamp;
window.doc = doc;
window.getDoc = getDoc;
window.getDocs = getDocs;
window.query = query;
window.where = where;
window.uploadBytesResumable = uploadBytesResumable;
window.getDownloadURL = getDownloadURL;
window.ref = ref;
window.deleteDoc = deleteDoc;

// Global variables - STORE IN WINDOW OBJECT
window.currentUser = null;
window.assignedSections = [];

// Add this right after Firebase initialization
console.log('Storage initialized:', storage ? 'YES' : 'NO');
console.log('Storage bucket:', firebaseConfig.storageBucket);

function getRating(score) {
    if (score >= 90) return { text: 'Excellent', class: 'rating-excellent' };
    if (score >= 80) return { text: 'Good', class: 'rating-good' };
    if (score >= 70) return { text: 'Fair', class: 'rating-fair' };
    return { text: 'Needs Improvement', class: 'rating-fair' };
}

async function loadScheduledTests(userEmail, userId) {
    try {
        console.log('=== LOADING SCHEDULED TESTS ===');
        console.log('Professor email:', userEmail);
        console.log('Professor UID:', userId);
        
        // STEP 1: Get professor's assigned sections from professorProfiles
        console.log('Step 1: Checking professorProfiles...');
        const profileRef = doc(db, 'professorProfiles', userEmail);
        const profileSnap = await getDoc(profileRef);
        
        window.assignedSections = [];
        
        if (profileSnap.exists()) {
            const profileData = profileSnap.data();
            console.log('‚úì Professor profile found:', profileData);
            
            if (profileData.assignedClass) {
                const studentsQuery = query(
                    collection(db, 'students'),
                    where('section', '==', profileData.assignedClass)
                );
                const studentsSnapshot = await getDocs(studentsQuery);
                const actualStudentCount = studentsSnapshot.size;
                
                window.assignedSections.push({
                    section: profileData.assignedClass,
                    students: actualStudentCount
                });
                console.log('‚úì Assigned class added:', profileData.assignedClass, 'with', actualStudentCount, 'students');
            }
        } else {
            console.log('‚úó Professor profile NOT FOUND');
        }
        
        // STEP 2: Also check sections collection
        console.log('Step 2: Checking sections collection...');
        const sectionsQuery = query(
            collection(db, 'sections'),
            where('professorEmail', '==', userEmail)
        );
        const sectionsSnapshot = await getDocs(sectionsQuery);
        
        console.log('Sections query result:', sectionsSnapshot.size, 'documents');
        
        for (const docSnap of sectionsSnapshot.docs) {
            const sectionData = docSnap.data();
            console.log('Found section:', sectionData);
            
            const exists = window.assignedSections.find(s => s.section === sectionData.name);
            if (!exists) {
                const studentsQuery = query(
                    collection(db, 'students'),
                    where('section', '==', sectionData.name)
                );
                const studentsSnapshot = await getDocs(studentsQuery);
                const actualStudentCount = studentsSnapshot.size;
                
                window.assignedSections.push({
                    section: sectionData.name,
                    students: actualStudentCount
                });
                console.log('‚úì Section added:', sectionData.name, 'with', actualStudentCount, 'students');
            }
        }
        
        console.log('=== FINAL ASSIGNED SECTIONS ===');
        console.log('Total sections:', window.assignedSections.length);
        console.log('Sections:', window.assignedSections);
        
        // STEP 3: Load scheduled tests
        console.log('Step 3: Loading scheduled tests...');
        
        let testsQuery;

        if (window.assignedSections.length > 0) {
            const sectionNames = window.assignedSections.map(s => s.section);
            testsQuery = query(
                collection(db, 'scheduledTests'),
                where('professorEmail', '==', userEmail),
                where('section', 'in', sectionNames)
            );
        } else {
            testsQuery = query(
                collection(db, 'scheduledTests'),
                where('professorEmail', '==', userEmail)
            );
        }
        
        let testsSnapshot = await getDocs(testsQuery);
        
        if (testsSnapshot.empty) {
            console.log('No tests by email, trying userId...');
            testsQuery = query(
                collection(db, 'scheduledTests'),
                where('professorId', '==', userId)
            );
            testsSnapshot = await getDocs(testsQuery);
        }
        
        const tableBody = document.getElementById('scheduleTableBody');

        if (!testsSnapshot.empty) {
            let html = '';
            let hasVisibleTests = false;
            
            testsSnapshot.forEach((docSnap) => {
                const test = docSnap.data();
                
                // Skip tests that have passed their deadline
                const deadlineDateTime = new Date(test.deadlineDateTime);
                const now = new Date();
                if (deadlineDateTime < now) {
                    return;
                }
                
                hasVisibleTests = true;
                
                const status = test.status || 'scheduled';
                const statusClass = status === 'active' ? 'status-active' : 
                                   status === 'completed' ? 'status-completed' : 
                                   'status-scheduled';
                
                const totalStudents = test.totalStudents || 0;
                const completedStudents = test.completedStudents || 0;
                const progress = totalStudents > 0 ? `${completedStudents}/${totalStudents}` : '0/0';
                
                html += `
                    <tr>
                    <td>${test.testName || 'Unnamed Test'}</td>
                    <td>${test.section || 'N/A'}</td>
                    <td>${test.date || 'N/A'}</td>
                    <td>${test.deadline || 'N/A'} ${test.deadlineTime || ''}</td>
                    <td class="progress-cell">${progress}</td>
                    <td>${test.attemptsAllowed || '1'}</td>
                    <td><span class="status-badge ${statusClass}">${status.charAt(0).toUpperCase() + status.slice(1)}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-edit" onclick="editTest('${docSnap.id}')">Edit</button>
                            <button class="btn-action btn-cancel" onclick="deleteTest('${docSnap.id}')">Delete</button>
                        </div>
                    </td>
                    </tr>
                `;
            });
            
            if (!hasVisibleTests) {
                if (window.assignedSections.length > 0) {
                    let sectionsInfo = window.assignedSections.map(s => `${s.section} (${s.students} students)`).join(', ');
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="8">
                                <div class="empty-state">
                                    <div class="empty-icon">üìÖ</div>
                                    <div class="empty-title">No Active Test Schedules</div>
                                    <div class="empty-text">
                                        You have been assigned: <strong>${sectionsInfo}</strong><br><br>
                                        All scheduled tests have expired or you haven't created any tests yet.<br>
                                        Click "Schedule New Test" to create a fitness test for your assigned section(s).
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="8">
                                <div class="empty-state">
                                    <div class="empty-icon">‚ö†Ô∏è</div>
                                    <div class="empty-title">No Sections Assigned</div>
                                    <div class="empty-text">
                                        You have not been assigned to any sections yet.<br><br>
                                        Please contact the Head Admin to assign you to a section.
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                }
            } else {
                tableBody.innerHTML = html;
            }
            
            console.log('‚úì Loaded', testsSnapshot.size, 'scheduled tests');
        } else {
            if (window.assignedSections.length > 0) {
                let sectionsInfo = window.assignedSections.map(s => `${s.section} (${s.students} students)`).join(', ');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <div class="empty-icon">üìÖ</div>
                                <div class="empty-title">No Test Schedules</div>
                                <div class="empty-text">
                                    You have been assigned: <strong>${sectionsInfo}</strong><br><br>
                                    You haven't scheduled any tests yet.<br>
                                    Click "Schedule New Test" to create a fitness test for your assigned section(s).
                                </div>
                            </td>
                        </tr>
                `;
            } else {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <div class="empty-icon">‚ö†Ô∏è</div>
                                <div class="empty-title">No Sections Assigned</div>
                                <div class="empty-text">
                                    You have not been assigned to any sections yet.<br><br>
                                    Please contact the Head Admin to assign you to a section.
                                </div>
                            </td>
                        </tr>
                `;
            }
        }
        
        console.log('=== LOAD COMPLETE ===');
        
    } catch (error) {
        console.error('=== ERROR LOADING SCHEDULED TESTS ===');
        console.error('Error:', error);
    }
}

function setupRealTimeUpdates(userEmail, userId) {
    try {
        console.log('Setting up real-time updates for:', userEmail);
        
        let testsQuery;

        if (window.assignedSections.length > 0) {
            const sectionNames = window.assignedSections.map(s => s.section);
            testsQuery = query(
                collection(db, 'scheduledTests'),
                where('professorEmail', '==', userEmail),
                where('section', 'in', sectionNames)
            );
        } else {
            testsQuery = query(
                collection(db, 'scheduledTests'),
                where('professorEmail', '==', userEmail)
            );
        }
        
        onSnapshot(testsQuery, (snapshot) => {
            console.log('üîÑ Real-time update triggered');
            loadScheduledTests(userEmail, userId);
        }, (error) => {
            console.error('‚ùå Real-time listener error:', error);
        });
        
    } catch (error) {
        console.error('Error setting up real-time updates:', error);
    }
}

       async function loadTestResults(userEmail, userId) {
    try {
        console.log('Loading test results for:', userEmail);
        
        let resultsQuery;

        if (window.assignedSections.length > 0) {
            const sectionNames = window.assignedSections.map(s => s.section);
            
            // Use a simpler query that doesn't require composite index
            // We'll filter sections in memory instead of using 'in' operator
            resultsQuery = query(
                collection(db, 'testResults'),
                orderBy('submittedAt', 'desc') // Use submittedAt instead of timestamp
            );
        } else {
            resultsQuery = query(
                collection(db, 'testResults'),
                orderBy('submittedAt', 'desc')
            );
        }
        
        const resultsSnapshot = await getDocs(resultsQuery);
        
        const tableBody = document.getElementById('resultsTableBody');

        if (!resultsSnapshot.empty) {
            let html = '';
            let filteredResults = [];
            
            // Filter results by section in memory
            resultsSnapshot.forEach((docSnap) => {
                const result = docSnap.data();
                
                // If we have assigned sections, filter by them
                if (window.assignedSections.length > 0) {
                    const sectionNames = window.assignedSections.map(s => s.section);
                    if (!sectionNames.includes(result.section)) {
                        return; // Skip results not in assigned sections
                    }
                }
                
                filteredResults.push({ id: docSnap.id, ...result });
            });
            
            // Sort by date (most recent first)
            filteredResults.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));
            
            // Display results (limit to 20 most recent)
            filteredResults.slice(0, 20).forEach((result) => {
                // Calculate score
                const score = calculateTestScore(result.testName, result.result, result.testTarget);
                const rating = getRating(score);
                
                // Calculate BMI if height and weight available (optional)
                const bmi = result.bmi || 'N/A';
                
                // Format date
                const date = result.submittedAt ? 
                    new Date(result.submittedAt).toLocaleDateString() : 
                    'N/A';
                
                // Show attempt info
                const attemptInfo = result.attemptNumber ? 
                    `Attempt ${result.attemptNumber}/${result.attemptsAllowed}` : 
                    'N/A';
                
                html += `
                    <tr>
                        <td>${result.studentName || 'Unknown'}</td>
                        <td>${result.section || 'N/A'}</td>
                        <td>${date}</td>
                        <td>${result.testName || 'N/A'}<br><small class="text-muted">${attemptInfo}</small></td>
                        <td><strong>${score}</strong></td>
                        <td>${bmi}</td>
                        <td><span class="rating-badge ${rating.class}">${rating.text}</span></td>
                        <td>
                            <button class="btn-action btn-view" onclick="viewDetails('${result.id}', '${result.testName}', '${result.result}', '${result.studentName}', '${date}', '${score}', '${result.timerValue || 'N/A'}', '${(result.notes || 'No notes').replace(/'/g, "\\'")}', '${attemptInfo}')">View Details</button>
                        </td>
                    </tr>
                `;
            });
            
            if (filteredResults.length > 0) {
                tableBody.innerHTML = html;
                console.log('‚úì Loaded', filteredResults.length, 'test results');
            } else {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <div class="empty-icon">üìä</div>
                                <div class="empty-title">No Test Results Yet</div>
                                <div class="empty-text">No students have completed tests yet in your assigned sections.</div>
                            </div>
                        </td>
                    </tr>
                `;
            }
        } else {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="8">
                        <div class="empty-state">
                            <div class="empty-icon">üìä</div>
                            <div class="empty-title">No Test Results Yet</div>
                            <div class="empty-text">No students have completed tests yet. Test results will appear here once students start taking and completing their fitness assessments.</div>
                        </div>
                    </td>
                </tr>
            `;
        }
    } catch (error) {
        console.error('Error loading test results:', error);
        const tableBody = document.getElementById('resultsTableBody');
        tableBody.innerHTML = `
            <tr>
                <td colspan="8">
                    <div class="empty-state">
                        <div class="empty-icon">‚ö†Ô∏è</div>
                        <div class="empty-title">Error Loading Results</div>
                        <div class="empty-text">${error.message}</div>
                    </div>
                </td>
            </tr>
        `;
    }
}


function calculateTestScore(testName, result, testTarget = null) {
    const normalized = testName.toLowerCase();
    
    // If professor set a target, use target-based scoring
    if (testTarget && testTarget > 0) {
        const value = parseFloat(result);
        
        if (normalized.includes('push-up') || normalized.includes('pushup') || 
            normalized.includes('sit-up') || normalized.includes('situp')) {
            // For rep-based tests (push-ups, sit-ups)
            const reps = parseInt(result);
            if (reps >= testTarget) return 100;
            if (reps >= testTarget * 0.9) return 95;
            if (reps >= testTarget * 0.8) return 90;
            if (reps >= testTarget * 0.7) return 85;
            if (reps >= testTarget * 0.6) return 80;
            if (reps >= testTarget * 0.5) return 75;
            return Math.max(50, Math.round((reps / testTarget) * 100));
        } else if (normalized.includes('plank')) {
            // For plank (time-based in seconds)
            const seconds = parseInt(result.split(':')[1] || result);
            if (seconds >= testTarget) return 100;
            if (seconds >= testTarget * 0.9) return 95;
            if (seconds >= testTarget * 0.8) return 90;
            if (seconds >= testTarget * 0.7) return 85;
            if (seconds >= testTarget * 0.6) return 80;
            if (seconds >= testTarget * 0.5) return 75;
            return Math.max(50, Math.round((seconds / testTarget) * 100));
        } else if (normalized.includes('sit-and-reach')) {
            // For sit-and-reach (distance-based)
            const distance = parseFloat(result);
            if (distance >= testTarget) return 100;
            if (distance >= testTarget * 0.9) return 95;
            if (distance >= testTarget * 0.8) return 90;
            if (distance >= testTarget * 0.7) return 85;
            if (distance >= testTarget * 0.6) return 80;
            if (distance >= testTarget * 0.5) return 75;
            return Math.max(50, Math.round((distance / testTarget) * 100));
        }
    }
    
    // Fallback to default scoring if no target set
    if (normalized.includes('push-up') || normalized.includes('pushup')) {
        const reps = parseInt(result);
        if (reps >= 40) return 100;
        if (reps >= 30) return 90;
        if (reps >= 20) return 80;
        if (reps >= 15) return 70;
        if (reps >= 10) return 60;
        return 50;
    } else if (normalized.includes('sit-up') || normalized.includes('situp')) {
        const reps = parseInt(result);
        if (reps >= 50) return 100;
        if (reps >= 40) return 90;
        if (reps >= 30) return 80;
        if (reps >= 20) return 70;
        if (reps >= 15) return 60;
        return 50;
    } else if (normalized.includes('plank')) {
        const seconds = parseInt(result.split(':')[1] || result);
        if (seconds >= 120) return 100;
        if (seconds >= 90) return 90;
        if (seconds >= 60) return 80;
        if (seconds >= 45) return 70;
        if (seconds >= 30) return 60;
        return 50;
    } else if (normalized.includes('step test') || normalized.includes('3-minute')) {
        const heartRate = parseInt(result);
        if (heartRate <= 80) return 100;
        if (heartRate <= 100) return 90;
        if (heartRate <= 120) return 80;
        if (heartRate <= 140) return 70;
        if (heartRate <= 160) return 60;
        return 50;
    } else if (normalized.includes('mile') || normalized.includes('run')) {
        const [minutes, seconds] = result.split(':').map(Number);
        const totalSeconds = minutes * 60 + (seconds || 0);
        if (totalSeconds <= 420) return 100;
        if (totalSeconds <= 480) return 90;
        if (totalSeconds <= 540) return 80;
        if (totalSeconds <= 600) return 70;
        if (totalSeconds <= 660) return 60;
        return 50;
    } else if (normalized.includes('sit-and-reach')) {
        const distance = parseFloat(result);
        if (distance >= 20) return 100;
        if (distance >= 15) return 90;
        if (distance >= 10) return 80;
        if (distance >= 5) return 70;
        if (distance >= 0) return 60;
        return 50;
    }
    
    return 75;
}
       function setupRealTimeResultUpdates(userEmail, userId) {
    try {
        console.log('Setting up real-time result updates...');
        
        // Use a simpler query without composite index requirements
        const resultsQuery = query(
            collection(db, 'testResults'),
            orderBy('submittedAt', 'desc')
        );
        
        onSnapshot(resultsQuery, (snapshot) => {
            console.log('üîÑ Real-time results update triggered');
            loadTestResults(userEmail, userId);
        }, (error) => {
            console.error('‚ùå Real-time results listener error:', error);
        });
        
    } catch (error) {
        console.error('Error setting up real-time results updates:', error);
    }
}
    function setupTestVisibilityUpdates() {
    try {
        console.log('üîî Setting up test visibility real-time updates...');
        
        // Listen for new tests
        const testsRef = collection(db, 'scheduledTests');
        onSnapshot(testsRef, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === 'added') {
                    console.log('üÜï New test added:', change.doc.data().testName);
                    // Refresh the tests list
                    if (window.currentUser) {
                        loadScheduledTests(window.currentUser.email, window.currentUser.uid);
                    }
                }
            });
        });
    } catch (error) {
        console.error('Error setting up test visibility updates:', error);
    }
}
        function showScheduleTestModal() {
    console.log('Opening schedule modal...');
    
    const modal = document.getElementById('scheduleTestModal');
    const sectionSelect = document.getElementById('testSection');
    
    // Clear previous options
    sectionSelect.innerHTML = '<option value="">Select Section</option>';
    
    if (window.assignedSections && window.assignedSections.length > 0) {
        // Remove duplicates before adding to dropdown
        const uniqueSections = [];
        const seenSections = new Set();
        
        window.assignedSections.forEach(section => {
            if (!seenSections.has(section.section)) {
                seenSections.add(section.section);
                uniqueSections.push(section);
            }
        });
        
        // Add unique sections to dropdown
        uniqueSections.forEach(section => {
            const option = document.createElement('option');
            option.value = section.section;
            option.textContent = `${section.section} (${section.students} students)`;
            sectionSelect.appendChild(option);
        });
        
        console.log('‚úì Added', uniqueSections.length, 'unique sections to dropdown');
    } else {
        const option = document.createElement('option');
        option.value = "no-sections";
        option.textContent = "No sections assigned - Contact Head Admin";
        option.disabled = true;
        sectionSelect.appendChild(option);
    }
    
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('testDate').value = today;
    
    const nextWeek = new Date();
    nextWeek.setDate(nextWeek.getDate() + 7);
    document.getElementById('testDeadline').value = nextWeek.toISOString().split('T')[0];
    document.getElementById('testDeadlineTime').value = '23:59';
    
    // Remove previous event listener if exists
    const testTypeSelect = document.getElementById('testType');
    testTypeSelect.removeEventListener('change', handleTestTypeChange);
    testTypeSelect.addEventListener('change', handleTestTypeChange);
    
    modal.style.display = 'flex';
}

                function handleTestTypeChange(event) {
                    const testType = event.target.value;
                    const targetGroup = document.getElementById('testTargetGroup');
                    const targetLabel = document.getElementById('testTargetLabel');
                    const targetInput = document.getElementById('testTarget');
                    const targetHint = document.getElementById('testTargetHint');
                    
                    if (!testType) {
                        targetGroup.style.display = 'none';
                        return;
                    }
                    
                    const normalizedType = testType.toLowerCase();
                    
                    if (normalizedType.includes('push-up') || normalizedType.includes('pushup')) {
                        targetGroup.style.display = 'block';
                        targetLabel.textContent = 'Target Push-ups';
                        targetInput.placeholder = 'Enter target number of push-ups';
                        targetInput.value = '20';
                        targetHint.textContent = 'Set the target number of push-ups students should aim to complete';
                    } else if (normalizedType.includes('sit-up') || normalizedType.includes('situp')) {
                        targetGroup.style.display = 'block';
                        targetLabel.textContent = 'Target Sit-ups';
                        targetInput.placeholder = 'Enter target number of sit-ups';
                        targetInput.value = '30';
                        targetHint.textContent = 'Set the target number of sit-ups students should aim to complete';
                    } else if (normalizedType.includes('plank')) {
                        targetGroup.style.display = 'block';
                        targetLabel.textContent = 'Target Duration (seconds)';
                        targetInput.placeholder = 'Enter target duration in seconds';
                        targetInput.value = '60';
                        targetHint.textContent = 'Set the target plank hold duration in seconds';
                    } else if (normalizedType.includes('3-minute') || normalizedType.includes('step test')) {
                        targetGroup.style.display = 'block';
                        targetLabel.textContent = 'Target Duration (minutes)';
                        targetInput.placeholder = 'Duration is fixed at 3 minutes';
                        targetInput.value = '3';
                        targetInput.readOnly = true;
                        targetHint.textContent = 'This test has a fixed duration of 3 minutes';
                    } else if (normalizedType.includes('sit-and-reach')) {
                        targetGroup.style.display = 'block';
                        targetLabel.textContent = 'Target Distance (cm)';
                        targetInput.placeholder = 'Enter target distance in cm';
                        targetInput.value = '15';
                        targetHint.textContent = 'Set the target reach distance in centimeters';
                    } else if (normalizedType.includes('curl-up')) {
                        targetGroup.style.display = 'block';
                        targetLabel.textContent = 'Target Curl-Ups';
                        targetInput.placeholder = 'Enter target number of curl-ups';
                        targetInput.value = '25';
                        targetInput.readOnly = false;
                        targetHint.textContent = 'Set the target number of abdominal curls (one every 3 seconds)';
                    } else if (normalizedType.includes('grip')) {
                        targetGroup.style.display = 'block';
                        targetLabel.textContent = 'Target Grip Strength (kg)';
                        targetInput.placeholder = 'Enter target grip strength in kg';
                        targetInput.value = '40';
                        targetInput.readOnly = false;
                        targetHint.textContent = 'Set the target grip strength in kilograms';
                    } else if (normalizedType.includes('skinfold')) {
                        targetGroup.style.display = 'block';
                        targetLabel.textContent = 'Target Body Fat %';
                        targetInput.placeholder = 'Enter target body fat percentage';
                        targetInput.value = '15';
                        targetInput.readOnly = false;
                        targetHint.textContent = 'Set the target body fat percentage (requires trained professional)';
                    } else if (normalizedType.includes('1-mile') || normalizedType.includes('mile run')) {
                        targetGroup.style.display = 'block';
                        targetLabel.textContent = 'Target Time (minutes)';
                        targetInput.placeholder = 'Enter target time in minutes';
                        targetInput.value = '8';
                        targetInput.readOnly = false;
                        targetHint.textContent = 'Set the target completion time for 1-mile run in minutes';
                    }else {
                        targetGroup.style.display = 'none';
                    }
                }

                async function scheduleTest() {
                    const testType = document.getElementById('testType').value;
                    const testSection = document.getElementById('testSection').value;
                    const testDate = document.getElementById('testDate').value;
                    const testDeadline = document.getElementById('testDeadline').value;
                    const testDeadlineTime = document.getElementById('testDeadlineTime').value;
                    const attemptsAllowed = document.getElementById('attemptsAllowed').value;
                    const testInstructions = document.getElementById('testInstructions').value;
                    const testTarget = document.getElementById('testTarget').value;
                    const videoURL = document.getElementById('videoURL').value;

                    if (!testType || !testSection || !testDate || !testDeadline || !testDeadlineTime) {
                        alert('Please fill in all required fields.');
                        return;
                    }

                    if (testSection === "no-sections") {
                        alert('You need to be assigned to a section before scheduling tests.');
                        return;
                    }

                    // Make video URL optional
                    if (videoURL && !videoURL.includes('youtube.com') && !videoURL.includes('youtu.be')) {
                        alert('Please provide a valid YouTube URL or leave it empty');
                        return;
                    }

                    try {
                        // Disable buttons during submission
                        const submitBtn = document.querySelector('#scheduleTestModal .btn-success');
                        const cancelBtn = document.querySelector('#scheduleTestModal .btn-secondary');
                        submitBtn.disabled = true;
                        cancelBtn.disabled = true;
                        submitBtn.textContent = 'Scheduling...';

                        const sectionDetails = window.assignedSections.find(s => s.section === testSection);
                        const totalStudents = sectionDetails ? sectionDetails.students : 0;

                        const deadlineDateTime = new Date(`${testDeadline}T${testDeadlineTime}`);
                        const testDateObj = new Date(testDate);
                        const now = new Date();
                        
                        let status = 'scheduled';
                        if (testDateObj <= now && deadlineDateTime >= now) {
                            status = 'active';
                        } else if (deadlineDateTime < now) {
                            status = 'completed';
                        }

                             const testData = {
                                testName: testType,
                                section: testSection,
                                date: testDate,
                                deadline: testDeadline,
                                deadlineTime: testDeadlineTime,
                                deadlineDateTime: deadlineDateTime.toISOString(),
                                attemptsAllowed: parseInt(attemptsAllowed),
                                instructions: testInstructions,
                                testTarget: testTarget ? parseInt(testTarget) : null,
                                videoURL: videoURL || null,
                                professorEmail: window.currentUser.email,
                                professorId: window.currentUser.uid,
                                professorName: window.currentUser.displayName || window.currentUser.email,
                                status: status,
                                totalStudents: totalStudents,
                                completedStudents: 0,
                                createdAt: window.serverTimestamp(),
                                isVisible: true,        // CRITICAL: Must be true
                                isActive: true,         // Must be true
                                visibleToStudents: true // Must be true
                            };

                        console.log('üìù Scheduling test:', testData);
                        
                        // Save to scheduledTests collection
                        const docRef = await window.addDoc(window.collection(window.db, 'scheduledTests'), testData);
                        console.log('‚úÖ Test added with ID:', docRef.id);
                        
                        // Create notification for all students in the section
                        try {
                            // Get all students in the section
                            const studentsQuery = query(
                                collection(db, 'students'),
                                where('section', '==', testSection)
                            );
                            const studentsSnapshot = await getDocs(studentsQuery);
                            
                            const notificationPromises = [];
                            studentsSnapshot.forEach((studentDoc) => {
                                const studentData = studentDoc.data();
                                const notificationData = {
                                    type: 'new_test',
                                    title: 'New Fitness Test Scheduled',
                                    message: `${testType} has been scheduled for ${testSection}. Deadline: ${testDeadline} at ${testDeadlineTime}`,
                                    section: testSection,
                                    testName: testType,
                                    testId: docRef.id,
                                    testDate: testDate,
                                    deadline: testDeadline,
                                    deadlineTime: testDeadlineTime,
                                    studentEmail: studentData.email,
                                    studentId: studentDoc.id,
                                    isRead: false,
                                    createdAt: window.serverTimestamp(),
                                    timestamp: new Date().toISOString()
                                };
                                
                                notificationPromises.push(
                                    addDoc(collection(db, 'notifications'), notificationData)
                                );
                            });
                            
                            await Promise.all(notificationPromises);
                            console.log(`‚úÖ ${notificationPromises.length} notifications created for students`);
                        } catch (notifError) {
                            console.error('Error creating notifications:', notifError);
                        }

                        // Close modal and refresh
                        closeScheduleTestModal();
                        alert('Test scheduled successfully' + (videoURL ? ' with video URL!' : '!'));
                        
                        // Refresh the tests list
                        await loadScheduledTests(window.currentUser.email, window.currentUser.uid);
                        
                    } catch (error) {
                        console.error('‚ùå Error scheduling test:', error);
                        alert('Error scheduling test: ' + error.message);
                        
                        // Re-enable buttons on error
                        const submitBtn = document.querySelector('#scheduleTestModal .btn-success');
                        const cancelBtn = document.querySelector('#scheduleTestModal .btn-secondary');
                        submitBtn.disabled = false;
                        cancelBtn.disabled = false;
                        submitBtn.textContent = 'Schedule Test';
                    }
                }
async function deleteTest(testId) {
    if (confirm('Are you sure you want to delete this test? This action cannot be undone.')) {
        try {
            await deleteDoc(doc(db, 'scheduledTests', testId));
            alert('Test deleted successfully!');
            await loadScheduledTests(window.currentUser.email, window.currentUser.uid);
        } catch (error) {
            console.error('‚ùå Error deleting test:', error);
            alert('Error deleting test: ' + error.message);
        }
    }
}

            onAuthStateChanged(auth, async (user) => {
                const loadingScreen = document.getElementById('loadingScreen');
                const mainContent = document.getElementById('mainContent');

                if (user) {
                    try {
                        console.log('User authenticated:', user.email);
                        window.currentUser = user;
                        
                        await loadScheduledTests(user.email, user.uid);
                        await loadTestResults(user.email, user.uid);
                        setupRealTimeUpdates(user.email, user.uid);
                        setupRealTimeResultUpdates(user.email, user.uid);
                        setupTestVisibilityUpdates(); // Add this line
                        
                        loadingScreen.style.display = 'none';
                        mainContent.style.display = 'block';
                    } catch (error) {
                        console.error('Error loading data:', error);
                        loadingScreen.style.display = 'none';
                        mainContent.style.display = 'block';
                    }
                } else {
                    window.location.href = '/login/index.html';
                }
            });

window.loadScheduledTests = loadScheduledTests;
window.loadTestResults = loadTestResults;
window.scheduleTest = scheduleTest;
window.showScheduleTestModal = showScheduleTestModal;
window.closeScheduleTestModal = closeScheduleTestModal;
window.deleteTest = deleteTest;
</script>

    <script>
        async function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await window.signOut(window.auth);
                    const baseUrl = window.location.origin;
                    window.location.href = baseUrl + '/login/index.html';
                } catch (error) {
                    console.error('Error logging out:', error);
                    alert('Error logging out. Please try again.');
                }
            }
        }

        function editTest(testId) {
            alert(`Edit Test: ${testId}\n\nThis feature will be implemented by head admin.\n\nYou will be able to:\n- Modify test details\n- Update date and deadline\n- Change section assignments\n- Adjust attempts allowed`);
        }

        function cancelTest(testId) {
            if (confirm('Are you sure you want to cancel this test?')) {
                alert(`Test ${testId} cancellation will be implemented by head admin.\n\nThis will:\n- Mark the test as cancelled\n- Notify students\n- Update the schedule`);
            }
        }

        function viewDetails(resultId, testName, result, studentName, date, score, timerValue, notes, attemptInfo) {
    // Create a modal to show detailed results
    const modalHtml = `
        <div class="modal-overlay" style="display: flex;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Test Result Details</h3>
                    <button class="close-modal" onclick="closeResultModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <strong>Student:</strong> ${studentName}
                        </div>
                        <div>
                            <strong>Test:</strong> ${testName}
                        </div>
                        <div>
                            <strong>Date:</strong> ${date}
                        </div>
                        <div>
                            <strong>Score:</strong> ${score}/100
                        </div>
                        <div>
                            <strong>Result:</strong> ${result}
                        </div>
                        <div>
                            <strong>Timer:</strong> ${timerValue}
                        </div>
                    </div>
                    <div>
                        <strong>Attempt:</strong> ${attemptInfo}
                    </div>
                    <div style="margin-top: 15px;">
                        <strong>Notes:</strong><br>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 5px;">
                            ${notes || 'No notes provided'}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeResultModal()">Close</button>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}
    
function closeResultModal() {
    const modal = document.querySelector('.modal-overlay');
    if (modal) {
        modal.remove();
    }
}

        function filterResultsTable() {
            const input = document.getElementById('searchResults');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('resultsTable');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                let found = false;
                const td = tr[i].getElementsByTagName('td');
                
                for (let j = 0; j < td.length; j++) {
                    if (td[j]) {
                        const txtValue = td[j].textContent || td[j].innerText;
                        if (txtValue.toUpperCase().indexOf(filter) > -1) {
                            found = true;
                            break;
                        }
                    }
                }
                
                if (found) {
                    tr[i].style.display = '';
                } else {
                    tr[i].style.display = 'none';
                }
            }
        }
        function closeScheduleTestModal() {
    document.getElementById('scheduleTestModal').style.display = 'none';
    
    // Clear all form fields
    document.getElementById('testType').value = '';
    document.getElementById('testSection').value = '';
    document.getElementById('testDate').value = '';
    document.getElementById('testDeadline').value = '';
    document.getElementById('testDeadlineTime').value = '23:59';
    document.getElementById('attemptsAllowed').value = '1';
    document.getElementById('testInstructions').value = '';
    document.getElementById('testTarget').value = '';
    document.getElementById('videoURL').value = ''; // Clear video URL
    
    // Hide target group
    document.getElementById('testTargetGroup').style.display = 'none';
}
    </script>
</body>
</html> 