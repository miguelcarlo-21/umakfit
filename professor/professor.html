<!DOCTYPE html>aa
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UmakFit - Professor Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Manrope:600,800|Inter:300,500,400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { -webkit-font-smoothing: antialiased; box-sizing: border-box; }
        body { font-family: 'Inter', Helvetica, sans-serif; margin: 0; padding: 0; background-color: #f8fafc; }
        
        .header-top { 
            background-color: #ffffff; 
            padding: 15px 0; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.08); 
            position: fixed; 
            top: 0; 
            width: 100%; 
            z-index: 1000; 
            border-bottom: 1px solid #e2e8f0;
        }
        .header-top .container { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .logo-text { 
            font-family: "Inter", Helvetica; 
            font-weight: 700; 
            color: #1e3a8a; 
            font-size: 24px; 
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo-text i {
            color: #f59e0b;
            font-size: 26px;
        }
        .header-actions { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        .logout-btn { 
            padding: 8px 20px; 
            background: linear-gradient(90deg, rgba(251, 191, 36, 1) 0%, rgba(245, 158, 11, 1) 100%); 
            border: none; 
            border-radius: 8px; 
            color: #000; 
            font-weight: 600; 
            font-size: 14px; 
            cursor: pointer; 
            transition: all 0.3s; 
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        }
        .logout-btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.4); 
        }
        .account-circle { 
            width: 44px; 
            height: 44px; 
            cursor: pointer; 
            border-radius: 50%;
            border: 2px solid #e2e8f0;
            transition: all 0.3s;
        }
        .account-circle:hover {
            border-color: #f59e0b;
        }
        
        .nav-section { 
            background: linear-gradient(180deg, rgba(30, 58, 138, 1) 0%, rgba(59, 130, 246, 1) 100%); 
            padding: 20px 0; 
            margin-top: 74px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .nav-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }
        .nav-brand { 
            display: flex;
            align-items: center;
            gap: 15px;
            font-family: "Manrope", Helvetica; 
            font-weight: 800; 
            font-size: 28px; 
            background: linear-gradient(90deg, rgba(245, 158, 11, 1) 0%, rgba(255, 229, 0, 1) 100%); 
            -webkit-background-clip: text; 
            background-clip: text; 
            -webkit-text-fill-color: transparent;
            margin: 0;
        }
        .nav-brand-logo {
            height: 60px;
            width: auto;
        }
        .nav-pills-custom { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
            padding: 0; 
            margin: 0;
        }
        .nav-pills-custom .nav-link { 
            font-family: "Manrope", Helvetica; 
            font-weight: 600; 
            color: #000000; 
            font-size: 14px; 
            padding: 12px 18px;
            border-radius: 8px; 
            background-color: #ffffff; 
            transition: all 0.3s; 
            border: none; 
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .nav-pills-custom .nav-link.active { 
            background: linear-gradient(90deg, rgba(251, 191, 36, 1) 0%, rgba(245, 158, 11, 1) 100%); 
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
        }
        .nav-pills-custom .nav-link:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.15); 
        }
        
        .main-content { 
            background: linear-gradient(180deg, rgba(248, 250, 252, 1) 0%, rgba(241, 245, 249, 1) 100%); 
            padding: 40px 0 80px 0; 
            min-height: calc(100vh - 200px); 
        }
        
        .profile-section { 
            background: white; 
            border-radius: 16px; 
            padding: 30px; 
            margin-bottom: 40px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
            border: 1px solid #e2e8f0;
        }
        .profile-header { 
            display: flex; 
            align-items: center; 
            gap: 20px; 
            margin-bottom: 20px; 
        }
        .profile-logo { 
            width: 77px; 
            height: 90px; 
        }
        .profile-title { 
            font-family: "Inter", Helvetica; 
            font-weight: 700; 
            color: #1e3a8a; 
            font-size: 32px; 
        }
        .profile-divider { 
            width: 100%; 
            height: 2px; 
            background: linear-gradient(90deg, transparent, #e5e7eb, transparent); 
            margin: 20px 0; 
        }
        .profile-content { 
            display: flex; 
            align-items: center; 
            gap: 30px; 
            padding: 25px; 
            background: #f9fafb; 
            border-radius: 12px; 
            border: 1px solid #f1f5f9;
        }
        .profile-photo { 
            width: 60px; 
            height: 60px; 
            border-radius: 50%; 
            object-fit: cover; 
            border: 3px solid #e2e8f0;
        }
        .profile-info { 
            display: flex; 
            gap: 80px; 
            flex: 1; 
            flex-wrap: wrap; 
        }
        .profile-field { 
            flex: 1; 
            min-width: 150px; 
        }
        .profile-label { 
            font-family: "Inter", Helvetica; 
            font-weight: 500; 
            color: #64748b; 
            font-size: 13px; 
            margin-bottom: 5px; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .profile-value { 
            font-family: "Inter", Helvetica; 
            font-weight: 700; 
            color: #1e3a8a; 
            font-size: 16px; 
        }
        .profile-value.email { 
            font-weight: 500; 
            color: #475569; 
        }
        
        .stats-row { 
            margin-bottom: 40px; 
        }
        .stat-card { 
            border-radius: 16px; 
            padding: 25px; 
            color: white; 
            transition: all 0.3s; 
            border: none;
            height: 100%; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 80px;
            height: 80px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            transform: translate(30px, -30px);
        }
        .stat-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 8px 20px rgba(0,0,0,0.15); 
        }
        .stat-card.purple { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-card.blue { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .stat-card.green { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .stat-card.orange { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .stat-card.red { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .stat-card.cyan { background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); }
        .stat-label { 
            font-family: "Inter", Helvetica; 
            font-weight: 600; 
            font-size: 14px; 
            margin-bottom: 10px; 
            opacity: 0.95; 
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .stat-value { 
            font-family: "Inter", Helvetica; 
            font-weight: 800; 
            font-size: 32px; 
        }
        
        .monitoring-container { 
            background: white; 
            border-radius: 16px; 
            padding: 25px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
            border: 1px solid #e2e8f0;
        }
        .monitoring-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            flex-wrap: wrap; 
        }
        .monitoring-title { 
            font-family: "Inter", Helvetica; 
            font-weight: 700; 
            color: #1f2937; 
            font-size: 22px; 
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .live-indicator { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            font-family: "Inter", Helvetica; 
            font-weight: 600; 
            color: #10b981; 
            font-size: 14px; 
            background: #ecfdf5;
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid #d1fae5;
        }
        .live-dot { 
            width: 8px; 
            height: 8px; 
            background: #10b981; 
            border-radius: 50%; 
            animation: pulse 2s infinite; 
        }
        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.5; } 
        }
        
        /* Enhanced Monitoring Grid */
        .monitoring-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .monitoring-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e2e8f0;
        }
        .monitoring-card-title {
            font-family: "Inter", Helvetica;
            font-weight: 600;
            color: #374151;
            font-size: 16px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .student-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .student-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: white;
            border: 1px solid #f1f5f9;
            transition: all 0.3s;
        }
        .student-item:hover {
            background: #f8fafc;
            transform: translateX(4px);
        }
        .student-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-weight: 600;
            color: #64748b;
        }
        .student-info {
            flex: 1;
        }
        .student-name {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
        }
        .student-details {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: #64748b;
        }
        .student-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-online {
            color: #10b981;
        }
        .status-offline {
            color: #64748b;
        }
        .status-active {
            color: #3b82f6;
        }
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }
        .status-dot.online {
            background: #10b981;
        }
        .status-dot.offline {
            background: #64748b;
        }
        .status-dot.active {
            background: #3b82f6;
        }
        
        .empty-state { 
            padding: 40px 20px; 
            text-align: center; 
        }
        .empty-icon { 
            font-size: 48px; 
            margin-bottom: 15px; 
            opacity: 0.4; 
        }
        .empty-title { 
            font-family: "Inter", Helvetica; 
            font-weight: 600; 
            color: #6b7280; 
            font-size: 16px; 
            margin-bottom: 8px; 
        }
        .empty-text { 
            font-family: "Inter", Helvetica; 
            font-weight: 400; 
            color: #9ca3af; 
            font-size: 13px; 
            line-height: 1.4; 
        }
        
        .footer { 
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%); 
            padding: 40px 0; 
            margin-top: 40px; 
        }
        .footer-title { 
            font-family: "Inter", Helvetica; 
            font-weight: 700; 
            color: #f59e0b; 
            font-size: 18px; 
            text-align: center; 
            margin-bottom: 20px; 
        }
        .footer-text { 
            font-family: "Inter", Helvetica; 
            font-weight: 400; 
            color: #cbd5e1; 
            font-size: 13px; 
            line-height: 1.6; 
        }
        
        .loading { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(255,255,255,0.95); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 9999; 
            flex-direction: column;
            gap: 20px;
        }
        .loading-text {
            font-family: "Inter", Helvetica;
            font-weight: 500;
            color: #475569;
            font-size: 16px;
        }
        .spinner { 
            border: 4px solid #f1f5f9; 
            border-top: 4px solid #3b82f6; 
            border-radius: 50%; 
            width: 50px; 
            height: 50px; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        @media (max-width: 992px) {
            .nav-container {
                flex-direction: column;
                align-items: flex-start;
            }
            .nav-pills-custom {
                width: 100%;
                justify-content: center;
            }
        }
        @media (max-width: 768px) {
            .header-top .container { padding: 0 15px; }
            .logo-text { font-size: 20px; }
            .profile-content { flex-direction: column; align-items: flex-start; }
            .profile-info { gap: 20px; }
            .stat-value { font-size: 24px; }
            .monitoring-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            .nav-pills-custom {
                flex-wrap: nowrap;
                overflow-x: auto;
                padding-bottom: 5px;
            }
            .nav-brand-logo {
                height: 50px;
            }
            .nav-brand {
                font-size: 24px;
            }
            .monitoring-grid {
                grid-template-columns: 1fr;
            }
        }
        .umak-logo {
            height: 40px;
            width: auto;
        }
        
        /* Section Cards */
        .sections-container {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
        }
        .sections-title {
            font-family: "Inter", Helvetica;
            font-weight: 700;
            color: #1f2937;
            font-size: 22px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .sections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .section-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s;
        }
        .section-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            border-color: #f59e0b;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .section-name {
            font-family: "Inter", Helvetica;
            font-weight: 700;
            color: #1e3a8a;
            font-size: 18px;
        }
        .section-student-count {
            background: #3b82f6;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .section-details {
            margin-bottom: 15px;
        }
        .section-detail {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 13px;
            color: #64748b;
        }
        .section-students {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }
        .section-students-title {
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .student-badge {
            display: inline-flex;
            align-items: center;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 4px 8px;
            margin: 4px;
            font-size: 11px;
            color: #4b5563;
        }
    </style>
</head>
<body>
    <div id="loadingScreen" class="loading">
        <div class="spinner"></div>
        <div class="loading-text">Loading Dashboard...</div>
    </div>
    
    <div id="dashboardContent" style="display: none;">
        <div class="header-top">
            <div class="container">
                <div class="logo-text">
                    <img class="umak-logo" src="umaklogo.png" alt="University of Makati">
                    University of Makati
                </div>
                <div class="header-actions">
                    <button class="logout-btn" onclick="handleLogout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                    <img class="account-circle" src="https://c.animaapp.com/tzMzyNnw/img/icon.svg" alt="Account">
                </div>
            </div>
        </div>
        
        <div class="nav-section">
            <div class="container">
                <div class="nav-container">
                    <div class="nav-brand">
                        <img class="nav-brand-logo" src="logo.png" alt="UMakFit">
                        UMakFit
                    </div>
                    <ul class="nav nav-pills-custom">
                        <li class="nav-item">
                            <a class="nav-link active" href="#">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="studentmanagement.html">
                                <i class="fas fa-users"></i> Student Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="addactivities.html">
                                <i class="fas fa-dumbbell"></i> Add Activities
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="addlesson.html">
                                <i class="fas fa-book-open"></i> Add Lesson
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="monitoringactivities.html">
                                <i class="fas fa-chart-bar"></i> Monitoring Activities
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="grades.html">
                                <i class="fas fa-graduation-cap"></i> Grades
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="container">
                <!-- Profile Section -->
                <div class="profile-section">
                    <div class="profile-header">
                        <div class="profile-title">Professor Profile</div>
                    </div>
                    <div class="profile-divider"></div>
                    <div class="profile-content">
                        <img class="profile-photo" id="userPhoto" src="https://c.animaapp.com/tzMzyNnw/img/image-13@2x.png" alt="Profile">
                        <div class="profile-info">
                            <div class="profile-field">
                                <div class="profile-label">Name</div>
                                <div class="profile-value" id="userName">Loading...</div>
                            </div>
                            <div class="profile-field">
                                <div class="profile-label">College</div>
                                <div class="profile-value" id="userCollege">College of Human Kinetics</div>
                            </div>
                            <div class="profile-field">
                                <div class="profile-label">Email</div>
                                <div class="profile-value email" id="userEmail">Loading...</div>
                            </div>
                            <div class="profile-field">
                                <div class="profile-label">Assigned Sections</div>
                                <div class="profile-value" id="assignedSections">0</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Stats Section -->
                <div class="row stats-row g-3">
                    <div class="col-12 col-sm-6 col-lg-4 col-xl-2">
                        <div class="stat-card purple">
                            <div class="stat-label">
                                <i class="fas fa-layer-group"></i> My Sections
                            </div>
                            <div class="stat-value" id="statSections">0</div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-4 col-xl-2">
                        <div class="stat-card blue">
                            <div class="stat-label">
                                <i class="fas fa-user-graduate"></i> My Students
                            </div>
                            <div class="stat-value" id="statStudents">0</div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-4 col-xl-2">
                        <div class="stat-card green">
                            <div class="stat-label">
                                <i class="fas fa-check-circle"></i> Activities Completed
                            </div>
                            <div class="stat-value" id="statCompleted">0</div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-4 col-xl-2">
                        <div class="stat-card orange">
                            <div class="stat-label">
                                <i class="fas fa-chart-line"></i> Average Score
                            </div>
                            <div class="stat-value" id="statAverage">0</div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-4 col-xl-2">
                        <div class="stat-card red">
                            <div class="stat-label">
                                <i class="fas fa-clock"></i> Pending Activities
                            </div>
                            <div class="stat-value" id="statPending">0</div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-4 col-xl-2">
                        <div class="stat-card cyan">
                            <div class="stat-label">
                                <i class="fas fa-percentage"></i> Completion Rate
                            </div>
                            <div class="stat-value" id="statRate">0%</div>
                        </div>
                    </div>
                </div>
                
                <!-- My Sections Section -->
                <div class="sections-container" id="sectionsContainer" style="display: none;">
                    <div class="sections-title">
                        <i class="fas fa-chalkboard"></i> My Assigned Sections
                    </div>
                    <div class="sections-grid" id="sectionsGrid">
                        <!-- Sections will be dynamically added here -->
                    </div>
                </div>
                
                <!-- Real-time Monitoring -->
                <div class="monitoring-container">
                    <div class="monitoring-header">
                        <div class="monitoring-title">
                            <i class="fas fa-desktop"></i> Real-time Activity Monitoring
                        </div>
                        <div class="live-indicator">
                            <div class="live-dot"></div>
                            <span>Live Updates</span>
                        </div>
                    </div>
                    
                    <!-- Enhanced Monitoring Grid -->
                    <div class="monitoring-grid">
                        <div class="monitoring-card">
                            <div class="monitoring-card-title">
                                <i class="fas fa-user-check" style="color: #10b981;"></i>
                                Active Activity Sessions
                            </div>
                            <div class="student-list" id="activeTestsList">
                                <div class="empty-state">
                                    <div class="empty-icon">ðŸ‘¥</div>
                                    <div class="empty-title">No Active Activities</div>
                                    <div class="empty-text">Students will appear here when they start activities</div>
                                </div>
                            </div>
                        </div>
                        <div class="monitoring-card">
                            <div class="monitoring-card-title">
                                <i class="fas fa-history" style="color: #f59e0b;"></i>
                                Recent Activity Completions
                            </div>
                            <div class="student-list" id="recentCompletions">
                                <div class="empty-state">
                                    <div class="empty-icon">âœ…</div>
                                    <div class="empty-title">No Recent Activities</div>
                                    <div class="empty-text">Completed activities will appear here</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <div class="container">
                <div class="footer-title">About CTBL</div>
                <div class="row g-4">
                    <div class="col-12 col-md-4">
                        <div class="footer-text">
                            The Center for Technology Based Learning serves as the learning management system operating hub, 
                            reporting to the university MANCOM officials, with a director on duty who manages and handles the 
                            center's daily operations.
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="footer-text">
                            Working closely with the Office of the President, the Center for Information Technology, and the 
                            Deans and Directors to support the LMS end-users' day-to-day activity.
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="footer-text">
                            The center focuses on implementing new forms of training and determining the validity of data to 
                            support the university's educational objectives.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, onSnapshot, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAgaLunqEf2gs6dSpF_sz1hV5XQ5Wm52jo",
            authDomain: "umakfit-e3b1d.firebaseapp.com",
            projectId: "umakfit-e3b1d",
            storageBucket: "umakfit-e3b1d.appspot.com",
            messagingSenderId: "276569891504",
            appId: "1:276569891504:web:39b1732b519f4d8b785175"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentProfessor = null;
        let professorSections = [];
        let professorStudents = [];

        onAuthStateChanged(auth, async (user) => {
            const loadingScreen = document.getElementById('loadingScreen');
            const dashboardContent = document.getElementById('dashboardContent');
            
            if (user) {
                try {
                    console.log('=== PROFESSOR AUTHENTICATION ===');
                    console.log('User authenticated:', user.email);
                    
                    const userEmail = user.email.toLowerCase();
                    
                    // First try to find professor by email in professors collection
                    const professorsQuery = query(
                        collection(db, 'professors'),
                        where('email', '==', userEmail)
                    );
                    const professorsSnapshot = await getDocs(professorsQuery);
                    
                    if (!professorsSnapshot.empty) {
                        const professorDoc = professorsSnapshot.docs[0];
                        currentProfessor = { id: professorDoc.id, ...professorDoc.data() };
                        console.log('âœ“ Professor found in professors collection:', currentProfessor);
                    } else {
                        // Try users collection
                        const usersQuery = query(
                            collection(db, 'users'),
                            where('email', '==', userEmail),
                            where('role', '==', 'professor')
                        );
                        const usersSnapshot = await getDocs(usersQuery);
                        
                        if (!usersSnapshot.empty) {
                            const userDoc = usersSnapshot.docs[0];
                            currentProfessor = { id: userDoc.id, ...userDoc.data() };
                            console.log('âœ“ Professor found in users collection:', currentProfessor);
                        } else {
                            throw new Error('Professor account not found. Please contact the secretary.');
                        }
                    }
                    
                    // Update UI with professor information
                    document.getElementById('userName').textContent = 
                        currentProfessor.fullName || currentProfessor.name || user.displayName || 'Professor';
                    document.getElementById('userEmail').textContent = userEmail;
                    
                    // Load professor's sections and students
                    await loadProfessorSections();
                    await loadProfessorStatistics();
                    setupRealtimeMonitoring();
                    
                    // Show dashboard
                    loadingScreen.style.display = 'none';
                    dashboardContent.style.display = 'block';
                    
                } catch (error) {
                    console.error('=== ERROR IN AUTHENTICATION ===');
                    console.error('Error:', error);
                    
                    loadingScreen.style.display = 'none';
                    alert(error.message || 'Error loading dashboard. Please try again.');
                    await signOut(auth);
                    window.location.href = '/login/index.html';
                }
            } else {
                console.log('No user authenticated, redirecting to login...');
                window.location.href = '/login/index.html';
            }
        });

        async function loadProfessorSections() {
            try {
                console.log('Loading professor sections...');
                
                professorSections = [];
                professorStudents = [];
                
                // Get professor's name for matching
                const professorName = currentProfessor.fullName || currentProfessor.name || '';
                const professorEmail = currentProfessor.email;
                
                console.log('Professor name for matching:', professorName);
                console.log('Professor email:', professorEmail);
                
                // Query sections collection for this professor
                // Try multiple matching strategies
                const sectionsQuery = query(
                    collection(db, 'sections')
                );
                const sectionsSnapshot = await getDocs(sectionsQuery);
                
                console.log('Total sections in database:', sectionsSnapshot.size);
                
                sectionsSnapshot.forEach((doc) => {
                    const sectionData = doc.data();
                    
                    // Check if this professor teaches this section
                    // Match by email or name
                    const professorMatches = 
                        sectionData.professor === professorName ||
                        sectionData.professorEmail === professorEmail ||
                        (sectionData.professor && professorName.includes(sectionData.professor)) ||
                        (sectionData.professor && sectionData.professor.includes(professorName));
                    
                    if (professorMatches) {
                        console.log(`âœ“ Section assigned: ${sectionData.name}`);
                        
                        professorSections.push({
                            id: doc.id,
                            ...sectionData
                        });
                        
                        // Add students from this section
                        if (sectionData.students && Array.isArray(sectionData.students)) {
                            sectionData.students.forEach(student => {
                                professorStudents.push({
                                    ...student,
                                    section: sectionData.name,
                                    sectionId: doc.id
                                });
                            });
                        }
                    }
                });
                
                console.log(`Found ${professorSections.length} sections with ${professorStudents.length} students`);
                
                // Update UI
                document.getElementById('assignedSections').textContent = professorSections.length;
                document.getElementById('statSections').textContent = professorSections.length;
                document.getElementById('statStudents').textContent = professorStudents.length;
                
                // Display sections if any found
                if (professorSections.length > 0) {
                    document.getElementById('sectionsContainer').style.display = 'block';
                    displaySections();
                }
                
            } catch (error) {
                console.error('Error loading sections:', error);
            }
        }

        function displaySections() {
            const sectionsGrid = document.getElementById('sectionsGrid');
            
            if (professorSections.length === 0) {
                sectionsGrid.innerHTML = `
                    <div class="col-12">
                        <div class="empty-state">
                            <div class="empty-icon">ðŸ“š</div>
                            <div class="empty-title">No Sections Assigned</div>
                            <div class="empty-text">Sections assigned by the secretary will appear here</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            professorSections.forEach(section => {
                const students = section.students || [];
                const firstFewStudents = students.slice(0, 5);
                const remainingCount = Math.max(0, students.length - 5);
                
                let studentsHtml = '';
                firstFewStudents.forEach(student => {
                    const displayName = student.name || student.email || 'Unknown Student';
                    studentsHtml += `<span class="student-badge">${displayName}</span>`;
                });
                
                if (remainingCount > 0) {
                    studentsHtml += `<span class="student-badge">+${remainingCount} more</span>`;
                }
                
                html += `
                    <div class="section-card">
                        <div class="section-header">
                            <div class="section-name">${section.name || 'Unnamed Section'}</div>
                            <div class="section-student-count">${students.length} students</div>
                        </div>
                        <div class="section-details">
                            <div class="section-detail">
                                <i class="fas fa-book" style="color: #6b7280;"></i>
                                <span>${section.courseCode || 'PE 3'}</span>
                            </div>
                            <div class="section-detail">
                                <i class="fas fa-user-tie" style="color: #6b7280;"></i>
                                <span>${section.professor || 'Professor'}</span>
                            </div>
                            <div class="section-detail">
                                <i class="fas fa-calendar-alt" style="color: #6b7280;"></i>
                                <span>Updated: ${formatDate(section.lastUpdated || section.createdAt)}</span>
                            </div>
                        </div>
                        ${students.length > 0 ? `
                            <div class="section-students">
                                <div class="section-students-title">
                                    <i class="fas fa-users"></i>
                                    Students in this section:
                                </div>
                                <div>${studentsHtml}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            sectionsGrid.innerHTML = html;
        }

        async function loadProfessorStatistics() {
            try {
                // Initialize stats
                document.getElementById('statCompleted').textContent = '0';
                document.getElementById('statAverage').textContent = '0';
                document.getElementById('statPending').textContent = '0';
                document.getElementById('statRate').textContent = '0%';
                
                // Get student IDs for querying activities
                const studentIds = professorStudents.map(s => s.studentId || s.uid || s.email);
                if (studentIds.length === 0) return;
                
                // Query activity results for these students
                const activitiesQuery = query(
                    collection(db, 'activityResults'),
                    where('studentId', 'in', studentIds.slice(0, 10)) // Firestore limit of 10 for 'in' queries
                );
                const activitiesSnapshot = await getDocs(activitiesQuery);
                
                let completedCount = 0;
                let totalScore = 0;
                let pendingCount = 0;
                
                activitiesSnapshot.forEach(doc => {
                    const activity = doc.data();
                    if (activity.status === 'completed') {
                        completedCount++;
                        const score = parseFloat(activity.score) || 0;
                        totalScore += score;
                    } else if (activity.status === 'pending') {
                        pendingCount++;
                    }
                });
                
                // Update stats
                document.getElementById('statCompleted').textContent = completedCount;
                document.getElementById('statPending').textContent = pendingCount;
                
                const averageScore = completedCount > 0 ? Math.round(totalScore / completedCount) : 0;
                document.getElementById('statAverage').textContent = averageScore;
                
                const totalAssigned = completedCount + pendingCount;
                const completionRate = totalAssigned > 0 ? Math.round((completedCount / totalAssigned) * 100) : 0;
                document.getElementById('statRate').textContent = completionRate + '%';
                
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        function setupRealtimeMonitoring() {
            try {
                // Get student IDs for monitoring
                const studentIds = professorStudents.map(s => s.studentId || s.uid || s.email);
                
                if (studentIds.length > 0) {
                    // Set up real-time listener for active tests
                    const activeTestsQuery = query(
                        collection(db, 'activeTests'),
                        where('studentId', 'in', studentIds.slice(0, 10)),
                        where('status', '==', 'active')
                    );
                    
                    onSnapshot(activeTestsQuery, (snapshot) => {
                        updateActiveTestsList(snapshot);
                    });
                    
                    // Set up real-time listener for recent completions
                    const recentCompletionsQuery = query(
                        collection(db, 'activityResults'),
                        where('studentId', 'in', studentIds.slice(0, 10)),
                        where('status', '==', 'completed'),
                        orderBy('submittedAt', 'desc')
                    );
                    
                    onSnapshot(recentCompletionsQuery, (snapshot) => {
                        updateRecentCompletions(snapshot);
                    });
                }
                
            } catch (error) {
                console.error('Error setting up real-time monitoring:', error);
            }
        }

        function updateActiveTestsList(snapshot) {
            const container = document.getElementById('activeTestsList');
            
            if (snapshot.empty) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ðŸ‘¥</div>
                        <div class="empty-title">No Active Activities</div>
                        <div class="empty-text">Students will appear here when they start activities</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            let count = 0;
            snapshot.forEach((doc) => {
                if (count >= 8) return; // Limit to 8
                count++;
                
                const activity = doc.data();
                const progress = activity.progress || 0;
                const studentName = activity.studentName || 'Unknown Student';
                const initials = getInitials(studentName);
                
                // Find student info
                const studentInfo = professorStudents.find(s => 
                    s.studentId === activity.studentId || 
                    s.email === activity.studentEmail ||
                    s.uid === activity.studentId
                );
                
                const section = studentInfo?.section || 'N/A';
                
                html += `
                    <div class="student-item">
                        <div class="student-avatar">${initials}</div>
                        <div class="student-info">
                            <div class="student-name">${studentName}</div>
                            <div class="student-details">
                                <span>${section}</span>
                                <span>${activity.activityName || 'Unnamed Activity'}</span>
                            </div>
                        </div>
                        <div class="student-status">
                            <div class="status-dot active"></div>
                            <span class="status-active">${progress}%</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateRecentCompletions(snapshot) {
            const container = document.getElementById('recentCompletions');
            
            if (snapshot.empty) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">âœ…</div>
                        <div class="empty-title">No Recent Activities</div>
                        <div class="empty-text">Completed activities will appear here</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            let count = 0;
            snapshot.forEach((doc) => {
                if (count >= 5) return; // Show only 5 most recent
                count++;
                
                const result = doc.data();
                const studentName = result.studentName || 'Unknown Student';
                const activityName = result.activityName || 'Unknown Activity';
                const score = result.score || 0;
                const initials = getInitials(studentName);
                
                // Find student info
                const studentInfo = professorStudents.find(s => 
                    s.studentId === result.studentId || 
                    s.email === result.studentEmail ||
                    s.uid === result.studentId
                );
                
                const section = studentInfo?.section || 'N/A';
                
                html += `
                    <div class="student-item">
                        <div class="student-avatar">${initials}</div>
                        <div class="student-info">
                            <div class="student-name">${studentName}</div>
                            <div class="student-details">
                                <span>${section}</span>
                                <span>${activityName}</span>
                            </div>
                        </div>
                        <div class="student-status">
                            <span>Score: ${score}</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function getInitials(name) {
            if (!name) return '??';
            const nameParts = name.split(' ');
            if (nameParts.length >= 2) {
                return (nameParts[0].charAt(0) + nameParts[nameParts.length - 1].charAt(0)).toUpperCase();
            }
            return name.substring(0, 2).toUpperCase();
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown';
            
            try {
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
            } catch (error) {
                return 'Invalid date';
            }
        }

        async function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await signOut(auth);
                    window.location.href = '/login/index.html';
                } catch (error) {
                    console.error('Error logging out:', error);
                    alert('Error logging out. Please try again.');
                }
            }
        }

        // Export functions to global scope
        window.handleLogout = handleLogout;

    </script>
</body>
</html>