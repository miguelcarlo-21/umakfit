<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UmakFit - Student Management</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Manrope:600,800|Inter:300,500,400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { -webkit-font-smoothing: antialiased; box-sizing: border-box; }
        body { font-family: 'Inter', Helvetica, sans-serif; margin: 0; padding: 0; background-color: #f6f6f6; }
        
        /* Header Styles */
        .header-top { 
            background-color: #ffffff; 
            padding: 15px 0; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.08); 
            position: fixed; 
            top: 0; 
            width: 100%; 
            z-index: 1000; 
            border-bottom: 1px solid #e2e8f0;
        }
        .header-top .container { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .logo-text { 
            font-family: "Inter", Helvetica; 
            font-weight: 700; 
            color: #1e3a8a; 
            font-size: 24px; 
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo-text i {
            color: #f59e0b;
            font-size: 26px;
        }
        .header-actions { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        .logout-btn { 
            padding: 8px 20px; 
            background: linear-gradient(90deg, rgba(251, 191, 36, 1) 0%, rgba(245, 158, 11, 1) 100%); 
            border: none; 
            border-radius: 8px; 
            color: #000; 
            font-weight: 600; 
            font-size: 14px; 
            cursor: pointer; 
            transition: all 0.3s; 
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        }
        .logout-btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.4); 
        }
        .account-circle { 
            width: 44px; 
            height: 44px; 
            cursor: pointer; 
            border-radius: 50%;
            border: 2px solid #e2e8f0;
            transition: all 0.3s;
        }
        .account-circle:hover {
            border-color: #f59e0b;
        }
        
        /* Navigation Styles */
        .nav-section { 
            background: linear-gradient(180deg, rgba(30, 58, 138, 1) 0%, rgba(59, 130, 246, 1) 100%); 
            padding: 20px 0; 
            margin-top: 74px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .nav-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }
        .nav-brand { 
            display: flex;
            align-items: center;
            gap: 15px;
            font-family: "Manrope", Helvetica; 
            font-weight: 800; 
            font-size: 28px; 
            background: linear-gradient(90deg, rgba(245, 158, 11, 1) 0%, rgba(255, 229, 0, 1) 100%); 
            -webkit-background-clip: text; 
            background-clip: text; 
            -webkit-text-fill-color: transparent;
            margin: 0;
        }
        .nav-brand-logo {
            height: 60px;
            width: auto;
        }
        .nav-pills-custom { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
            padding: 0; 
            margin: 0;
        }
        .nav-pills-custom .nav-link { 
            font-family: "Manrope", Helvetica; 
            font-weight: 600; 
            color: #000000; 
            font-size: 14px; 
            padding: 12px 18px;
            border-radius: 8px; 
            background-color: #ffffff; 
            transition: all 0.3s; 
            border: none; 
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .nav-pills-custom .nav-link.active { 
            background: linear-gradient(90deg, rgba(251, 191, 36, 1) 0%, rgba(245, 158, 11, 1) 100%); 
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
        }
        .nav-pills-custom .nav-link:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.15); 
        }
        
        /* Main Content */
        .main-content { 
            padding: 40px 0 80px 0; 
            min-height: calc(100vh - 200px); 
        }
        
        /* Info Banner */
        .info-banner {
            background: white;
            border-radius: 16px;
            padding: 25px 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .info-banner-icon {
            width: 55px;
            height: 55px;
            flex-shrink: 0;
        }
        .info-banner-content {
            flex: 1;
        }
        .info-banner-title {
            font-family: "Inter", Helvetica;
            font-weight: 700;
            color: #1e3a8a;
            font-size: 28px;
            margin-bottom: 5px;
        }
        .info-banner-subtitle {
            font-family: "Inter", Helvetica;
            font-weight: 700;
            color: #1e3a8a;
            font-size: 14px;
        }
        
        /* Section Styles */
        .management-section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .section-title {
            font-family: "Inter", Helvetica;
            font-weight: 700;
            color: #1e3a8a;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .section-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn-primary-custom {
            background: linear-gradient(90deg, rgba(30, 58, 138, 1) 0%, rgba(59, 130, 246, 1) 100%);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            color: white;
            font-family: "Inter", Helvetica;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
        }
        .btn-secondary-custom {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px 20px;
            color: #475569;
            font-family: "Inter", Helvetica;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-secondary-custom:hover {
            background: #e2e8f0;
            transform: translateY(-1px);
        }
        
        /* Search and Filter */
        .search-filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .search-box {
            position: relative;
            flex: 1;
            min-width: 250px;
        }
        .search-box input {
            width: 100%;
            height: 42px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px 15px 10px 40px;
            font-family: "Inter", Helvetica;
            font-size: 14px;
            color: #475569;
            background: #f8fafc;
            transition: all 0.3s;
        }
        .search-box input:focus {
            outline: none;
            border-color: #3b82f6;
            background: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
            font-size: 14px;
        }
        .filter-select {
            min-width: 200px;
        }
        .filter-select select {
            width: 100%;
            height: 42px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 0 15px;
            font-family: "Inter", Helvetica;
            font-size: 14px;
            color: #475569;
            background: #f8fafc;
            cursor: pointer;
            transition: all 0.3s;
        }
        .filter-select select:focus {
            outline: none;
            border-color: #3b82f6;
            background: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Table Styles */
        .table-responsive {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            background: white;
        }
        .custom-table {
            width: 100%;
            border-collapse: collapse;
        }
        .custom-table thead {
            background: linear-gradient(90deg, #f8fafc 0%, #f1f5f9 100%);
        }
        .custom-table th {
            font-family: "Inter", Helvetica;
            font-weight: 600;
            color: #475569;
            font-size: 12px;
            text-align: left;
            padding: 16px 12px;
            border-bottom: 2px solid #e2e8f0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }
        .custom-table td {
            font-family: "Inter", Helvetica;
            font-weight: 500;
            color: #1e293b;
            font-size: 14px;
            padding: 16px 12px;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
        }
        .custom-table tbody tr {
            transition: all 0.3s;
        }
        .custom-table tbody tr:hover {
            background-color: #f8fafc;
        }
        .custom-table tbody tr:last-child td {
            border-bottom: none;
        }
  
        .info-value-email {
            word-break: break-all; 
            font-size: 13px;       
            color: #475569;
        }


        .info-value-email.truncate {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .scrollable-table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-top: 15px;
        }

        .scrollable-table-container table {
            margin-bottom: 0;
        }

        .scrollable-table-container thead {
            position: sticky;
            top: 0;
            background: #f8fafc;
            z-index: 10;
        }
        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-family: "Inter", Helvetica;
            font-weight: 600;
            font-size: 12px;
            text-align: center;
            min-width: 80px;
        }
        .status-active {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        .status-inactive {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .btn-action {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-family: "Inter", Helvetica;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }
        .btn-action:hover {
            transform: translateY(-1px);
        }
        .btn-view {
            background: #10b981;
            color: white;
        }
        .btn-view:hover {
            background: #059669;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }
        .btn-attempt {
            background: #f59e0b;
            color: white;
        }
        .btn-attempt:hover {
            background: #d97706;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }
        .modal-content {
            background-color: white;
            border-radius: 12px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title {
            font-family: "Inter", Helvetica;
            font-weight: 600;
            color: #1e3a8a;
            font-size: 20px;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
            transition: color 0.3s;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }
        .close-modal:hover {
            background: #f1f5f9;
            color: #1e293b;
        }
        .modal-body {
            padding: 25px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        .form-label {
            display: block;
            font-family: "Inter", Helvetica;
            font-weight: 500;
            color: #374151;
            font-size: 14px;
            margin-bottom: 8px;
        }
        .form-label.required::after {
            content: " *";
            color: #ef4444;
        }
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-family: "Inter", Helvetica;
            font-size: 14px;
            color: #374151;
            transition: all 0.3s;
        }
        .form-control:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-family: "Inter", Helvetica;
            font-size: 14px;
            color: #374151;
            background-color: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .btn-cancel {
            background-color: #6b7280;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            font-family: "Inter", Helvetica;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-cancel:hover {
            background-color: #4b5563;
        }
        .btn-submit {
            background: linear-gradient(90deg, rgba(30, 58, 138, 1) 0%, rgba(59, 130, 246, 1) 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            font-family: "Inter", Helvetica;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-submit:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(30, 58, 138, 0.3);
        }
        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Empty State */
        .empty-state {
            padding: 60px 40px;
            text-align: center;
            background: #f8fafc;
            border-radius: 8px;
            margin: 20px;
        }
        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.4;
            color: #64748b;
        }
        .empty-title {
            font-family: "Inter", Helvetica;
            font-weight: 700;
            color: #1f2937;
            font-size: 20px;
            margin-bottom: 12px;
        }
        .empty-text {
            font-family: "Inter", Helvetica;
            font-weight: 400;
            color: #64748b;
            font-size: 14px;
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto;
        }
        
        /* Loading Screen */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            gap: 20px;
        }
        .loading-text {
            font-family: "Inter", Helvetica;
            font-weight: 500;
            color: #475569;
            font-size: 16px;
        }
        .spinner {
            border: 4px solid #f1f5f9;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Student Info Card */
        .student-info-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
        }
        .student-info-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        .student-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            color: white;
        }
        .student-basic-info {
            flex: 1;
        }
        .student-name {
            font-family: "Inter", Helvetica;
            font-weight: 700;
            color: #1e3a8a;
            font-size: 20px;
            margin-bottom: 5px;
        }
        .student-id {
            font-family: "Inter", Helvetica;
            font-weight: 500;
            color: #64748b;
            font-size: 14px;
        }
        .student-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        .info-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .info-label {
            font-family: "Inter", Helvetica;
            font-weight: 600;
            color: #64748b;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        .info-value {
            font-family: "Inter", Helvetica;
            font-weight: 500;
            color: #1e293b;
            font-size: 14px;
        }
        
        /* Activities Table */
        .activities-table {
            margin-top: 20px;
        }
        .activities-table th {
            background: #f1f5f9;
            font-weight: 600;
            font-size: 12px;
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
        }
        .activities-table td {
            padding: 12px;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
        }
        .score-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        .score-excellent {
            background-color: #d1fae5;
            color: #065f46;
        }
        .score-good {
            background-color: #fef3c7;
            color: #92400e;
        }
        .score-poor {
            background-color: #fee2e2;
            color: #991b1b;
        }   
            /* Scrollable attempts table */
            .scrollable-attempts-table {
                max-height: 400px;
                overflow-y: auto;
                border: 1px solid #e2e8f0;
                border-radius: 8px;
                margin-top: 10px;
            }

            .scrollable-attempts-table thead {
                position: sticky;
                top: 0;
                background: #f8fafc;
                z-index: 10;
            }
                    /* Attempt Form */
        .attempt-form {
            background: #f8fafc;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            margin-top: 20px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        @media (max-width: 576px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        /* Section Info Card */
        .section-info-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
        }
        .section-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        .section-basic-info {
            flex: 1;
        }
        .section-name {
            font-family: "Inter", Helvetica;
            font-weight: 700;
            color: #1e3a8a;
            font-size: 24px;
            margin-bottom: 5px;
        }
        .section-details {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #64748b;
        }
        .section-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        /* Responsive */
        @media (max-width: 992px) {
            .nav-container {
                flex-direction: column;
                align-items: flex-start;
            }
            .nav-pills-custom {
                width: 100%;
                justify-content: center;
            }
        }
        @media (max-width: 768px) {
            .header-top .container { padding: 0 15px; }
            .logo-text { font-size: 20px; }
            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .section-actions {
                width: 100%;
                justify-content: flex-start;
            }
            .search-filter-bar {
                flex-direction: column;
            }
            .search-box, .filter-select {
                width: 100%;
                min-width: auto;
            }
            .custom-table {
                font-size: 12px;
            }
            .custom-table th,
            .custom-table td {
                padding: 12px 8px;
            }
            .action-buttons {
                flex-direction: column;
                gap: 5px;
            }
            .modal-content {
                margin: 10px;
                max-height: calc(100vh - 20px);
            }
        }
        .umak-logo {
            height: 40px;
            width: auto;
        }
         /* Modal Overlay */
        .edit-score-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Modal Container */
        .edit-score-modal {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 550px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Modal Header */
        .edit-score-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 24px 28px;
            border-radius: 20px 20px 0 0;
            position: relative;
            overflow: hidden;
        }

        .edit-score-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }

        .edit-score-header-content {
            position: relative;
            z-index: 1;
        }

        .edit-score-title {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            color: white;
            font-size: 24px;
            margin: 0 0 8px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .edit-score-subtitle {
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            margin: 0;
        }

        .close-edit-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            transition: all 0.3s;
            z-index: 2;
        }

        .close-edit-modal:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        /* Modal Body */
        .edit-score-body {
            padding: 32px 28px;
        }

        /* Info Cards */
        .info-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            border-left: 4px solid #667eea;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .info-row:last-child {
            margin-bottom: 0;
        }

        .info-label {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            color: #64748b;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            color: #1e293b;
            font-size: 16px;
        }

        .target-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 18px;
            display: inline-block;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        /* Step Indicators */
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 32px;
            position: relative;
        }

        .step-indicator::before {
            content: '';
            position: absolute;
            top: 16px;
            left: 32px;
            right: 32px;
            height: 2px;
            background: #e2e8f0;
            z-index: 0;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            position: relative;
            z-index: 1;
            flex: 1;
        }

        .step-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #94a3b8;
            transition: all 0.3s;
        }

        .step.active .step-circle {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .step.completed .step-circle {
            background: #10b981;
            color: white;
        }

        .step-label {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 11px;
            color: #94a3b8;
            text-align: center;
        }

        .step.active .step-label {
            color: #667eea;
        }

        .step.completed .step-label {
            color: #10b981;
        }

        /* Form Group */
        .form-group-modal {
            margin-bottom: 24px;
        }

        .form-label-modal {
            display: block;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            color: #334155;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .form-label-modal .required {
            color: #ef4444;
        }

        .input-group {
            position: relative;
        }

        .input-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            font-size: 20px;
        }

        .form-input-modal {
            width: 100%;
            padding: 14px 16px 14px 50px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            transition: all 0.3s;
            background: white;
        }

        .form-input-modal:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .form-input-modal::placeholder {
            color: #cbd5e1;
            font-weight: 500;
        }

        .form-hint {
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            color: #64748b;
            margin-top: 6px;
        }

        /* Score Preview */
        .score-preview {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            border-left: 4px solid #f59e0b;
            display: none;
        }

        .score-preview.show {
            display: block;
            animation: slideDown 0.4s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .score-preview-label {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            color: #92400e;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .score-preview-value {
            font-family: 'Inter', sans-serif;
            font-weight: 800;
            color: #78350f;
            font-size: 48px;
            line-height: 1;
        }

        .score-preview-text {
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            color: #92400e;
            font-size: 13px;
            margin-top: 8px;
        }

        /* Modal Footer */
        .edit-score-footer {
            padding: 20px 28px;
            border-top: 2px solid #f1f5f9;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn-modal {
            padding: 12px 28px;
            border-radius: 10px;
            border: none;
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-cancel-modal {
            background: #e2e8f0;
            color: #475569;
        }

        .btn-cancel-modal:hover {
            background: #cbd5e1;
            transform: translateY(-1px);
        }

        .btn-next {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-next:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-next:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-submit-modal {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-submit-modal:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-submit-modal:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Success Animation */
        .success-checkmark {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
        }

        .success-checkmark .check-icon {
            width: 80px;
            height: 80px;
            position: relative;
            border-radius: 50%;
            box-sizing: content-box;
            border: 4px solid #10b981;
            background: #d1fae5;
        }

        .success-checkmark .check-icon::before {
            top: 3px;
            left: -2px;
            width: 30px;
            transform-origin: 100% 50%;
            border-radius: 100px 0 0 100px;
        }

        .success-checkmark .check-icon::after {
            top: 0;
            left: 30px;
            width: 60px;
            transform-origin: 0 50%;
            border-radius: 0 100px 100px 0;
            animation: rotate-circle 4.25s ease-in;
        }

        .success-checkmark .icon-line {
            height: 5px;
            background-color: #10b981;
            display: block;
            border-radius: 2px;
            position: absolute;
            z-index: 10;
        }

        .success-checkmark .icon-line.line-tip {
            top: 43px;
            left: 14px;
            width: 25px;
            transform: rotate(45deg);
            animation: icon-line-tip 0.75s;
        }

        .success-checkmark .icon-line.line-long {
            top: 38px;
            right: 8px;
            width: 47px;
            transform: rotate(-45deg);
            animation: icon-line-long 0.75s;
        }

        @keyframes icon-line-tip {
            0% {
                width: 0;
                left: 1px;
                top: 19px;
            }
            54% {
                width: 0;
                left: 1px;
                top: 19px;
            }
            70% {
                width: 50px;
                left: -8px;
                top: 37px;
            }
            84% {
                width: 17px;
                left: 21px;
                top: 48px;
            }
            100% {
                width: 25px;
                left: 14px;
                top: 43px;
            }
        }

        @keyframes icon-line-long {
            0% {
                width: 0;
                right: 46px;
                top: 54px;
            }
            65% {
                width: 0;
                right: 46px;
                top: 54px;
            }
            84% {
                width: 55px;
                right: 0px;
                top: 35px;
            }
            100% {
                width: 47px;
                right: 8px;
                top: 38px;
            }
        }
            /* Tablet View */
        @media (max-width: 1024px) {
            .nav-container {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .nav-pills-custom {
                width: 100%;
                justify-content: flex-start;
                overflow-x: auto;
                flex-wrap: nowrap;
                padding-bottom: 10px;
            }
            
            .nav-pills-custom .nav-link {
                white-space: nowrap;
            }
            
            .student-info-grid,
            .section-info-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
            /* Mobile View */
        @media (max-width: 768px) {
            .header-top .container { 
                padding: 0 15px; 
                flex-wrap: wrap;
            }
            
            .logo-text { 
                font-size: 16px;
                gap: 5px;
            }
            
            .logo-text i {
                font-size: 18px;
            }
            
            .umak-logo {
                height: 30px;
            }
            
            .logout-btn {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            .account-circle {
                width: 36px;
                height: 36px;
            }
            
            .nav-brand {
                font-size: 20px;
            }
            
            .nav-brand-logo {
                height: 40px;
            }
            
            .info-banner {
                flex-direction: column;
                text-align: center;
                padding: 20px;
            }
            
            .info-banner-icon {
                width: 45px;
                height: 45px;
            }
            
            .info-banner-title {
                font-size: 22px;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .section-actions {
                width: 100%;
                justify-content: flex-start;
            }
            
            .section-title {
                font-size: 18px;
            }
            
            .search-filter-bar {
                flex-direction: column;
            }
            
            .search-box, .filter-select {
                width: 100%;
                min-width: auto;
            }
            
            /* Make tables scrollable horizontally on mobile */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .custom-table {
                min-width: 800px;
                font-size: 12px;
            }
            
            .custom-table th,
            .custom-table td {
                padding: 10px 8px;
                white-space: nowrap;
            }
            
            .action-buttons {
                flex-direction: row;
                gap: 5px;
                flex-wrap: nowrap;
            }
            
            .btn-action {
                font-size: 11px;
                padding: 5px 8px;
            }
            
            .modal-content {
                margin: 10px;
                max-height: calc(100vh - 20px);
                width: calc(100% - 20px);
            }
            
            .modal-header,
            .modal-body,
            .modal-footer {
                padding: 15px;
            }
            
            .student-info-grid,
            .section-info-grid {
                grid-template-columns: 1fr;
            }
            
            .student-info-header {
                flex-direction: column;
                text-align: center;
            }
            
            .student-name {
                font-size: 18px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            /* Hide pagination, make scrollable */
            .pagination-controls {
                display: none !important;
            }
            
            /* Tabs responsive */
            .flex.gap-2 {
                flex-wrap: wrap;
            }
            
            #allStudentsTab,
            #overdueTab {
                flex: 1;
                min-width: 120px;
                font-size: 13px;
                padding: 10px 8px;
            }
        }

        /* Extra Small Mobile */
        @media (max-width: 480px) {
            .logo-text {
                font-size: 14px;
            }
            
            .header-actions {
                width: 100%;
                justify-content: space-between;
                margin-top: 10px;
            }
            
            .nav-pills-custom .nav-link {
                font-size: 12px;
                padding: 10px 12px;
            }
            
            .info-banner-title {
                font-size: 18px;
            }
            
            .info-banner-subtitle {
                font-size: 12px;
            }
            
            .section-title {
                font-size: 16px;
            }
            
            .btn-primary-custom,
            .btn-secondary-custom {
                font-size: 12px;
                padding: 8px 12px;
            }
            
            .custom-table {
                min-width: 700px;
            }
            
            .status-badge {
                font-size: 10px;
                padding: 4px 8px;
                min-width: 60px;
            }
            
            .score-badge {
                font-size: 11px;
                padding: 3px 6px;
            }
        }

        /* Make scrollable attempts table more mobile-friendly */
        @media (max-width: 768px) {
            .scrollable-attempts-table {
                max-height: 300px;
            }
            
            .scrollable-table-container {
                max-height: 300px;
            }
            
            #attemptsTable {
                min-width: 650px;
            }
        }
        /* Responsive */
        @media (max-width: 640px) {
            .edit-score-modal {
                width: 95%;
                max-height: 95vh;
            }

            .edit-score-header {
                padding: 20px;
            }

            .edit-score-title {
                font-size: 20px;
            }

            .edit-score-body {
                padding: 24px 20px;
            }

            .edit-score-footer {
                flex-direction: column;
                padding: 16px 20px;
            }

            .btn-modal {
                width: 100%;
                justify-content: center;
            }

            .step-label {
                font-size: 10px;
            }
        }
                /* Make overdue table scrollable on all devices */
        #overdueView .table-responsive {
            max-height: 600px;
            overflow-y: auto;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        #overdueView .table-responsive table {
            margin-bottom: 0;
        }

        #overdueView .custom-table {
            min-width: 900px;
        }

        @media (max-width: 768px) {
            #overdueView .table-responsive {
                max-height: 400px;
            }
            
            #overdueView .custom-table {
                min-width: 750px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div id="loadingScreen" class="loading">
        <div class="spinner"></div>
        <div class="loading-text">Loading Student Management...</div>
    </div>
    
    <div id="mainContent" style="display: none;">
        <div class="header-top">
            <div class="container">
                <div class="logo-text">
                    <img class="umak-logo" src="umaklogo.png" alt="University of Makati">
                    University of Makati
                </div>
                <div class="header-actions">
                    <button class="logout-btn" onclick="handleLogout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                    <img class="account-circle" src="https://c.animaapp.com/kboeAmgh/img/icon.svg" alt="Account">
                </div>
            </div>
        </div>
        
        <div class="nav-section">
            <div class="container">
                <div class="nav-container">
                    <div class="nav-brand">
                        <img src="logo.png" alt="UMakFit Logo" class="nav-brand-logo">
                        UMakFit
                    </div>
                    <ul class="nav nav-pills-custom">
                        <li class="nav-item">
                            <a class="nav-link" href="professor.html">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#">
                                <i class="fas fa-users"></i> Student Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="addactivities.html">
                                <i class="fas fa-dumbbell"></i> Add Activities
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="addlesson.html">
                                <i class="fas fa-book-open"></i> Add Lesson
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="monitoringactivities.html">
                                <i class="fas fa-chart-bar"></i> Monitoring Activities
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="grades.html">
                                <i class="fas fa-graduation-cap"></i> Grades
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="container">
                <div class="info-banner">
                    <img class="info-banner-icon" src="https://c.animaapp.com/kboeAmgh/img/image-13@2x.png" alt="Icon">
                    <div class="info-banner-content">
                        <div class="info-banner-title">Student Management</div>
                        <div class="info-banner-subtitle">View student scores and add additional attempts</div>
                    </div>
                </div>
                
                <!-- My Sections (View Only) -->
                <div class="management-section">
                    <div class="section-header">
                        <div class="section-title">
                            <i class="fas fa-layer-group"></i> My Assigned Sections
                        </div>
                        <div class="section-actions">
                            <button class="btn-secondary-custom" onclick="refreshData()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    
                    <div class="search-filter-bar">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchSections" placeholder="Search sections..." onkeyup="filterSections()">
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                    <table class="custom-table" id="sectionsTable">
                        <thead>
                            <tr>
                                <th>Section Name</th>
                                <th>Year Level</th>
                                <th>Total Students</th>
                                <th>Course Code</th>
                                <th>Semester</th>
                                <th>Academic Year</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                       <tbody id="sectionsTableBody">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                    </table>
                </div>

                <!-- Section count only -->
                <div style="margin-top: 20px; padding: 0 10px;">
                    <div style="font-size: 14px; color: #64748b;">
                        Showing <span id="sectionCount">0</span> sections
                    </div>
                </div>
               <!-- Student List -->
<div class="management-section">
    <div class="section-header">
        <div class="section-title">
            <i class="fas fa-user-graduate"></i> Student Scores & Attempts
        </div>
        <div class="section-actions">
            <button class="btn-secondary-custom" onclick="exportStudents()">
                <i class="fas fa-file-export"></i> Export Scores
            </button>
        </div>
    </div>
    
    <!-- Tabs -->
    <div class="flex gap-2 mb-4 border-b border-gray-200">
        <button id="allStudentsTab" class="px-4 py-2 font-semibold text-blue-600 border-b-2 border-blue-600" onclick="switchTab('all')">
            All Students (<span id="allStudentsCount">0</span>)
        </button>
        <button id="overdueTab" class="px-4 py-2 font-semibold text-gray-600 hover:text-blue-600" onclick="switchTab('overdue')">
            Overdue Tests (<span id="overdueCount">0</span>)
        </button>
    </div>
    
    <!-- All Students View -->
    <div id="allStudentsView">
        <div class="search-filter-bar">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchStudents" placeholder="Search students by name or UMaK ID..." onkeyup="filterStudents()">
            </div>
            <div class="filter-select">
                <select id="filterSection" onchange="filterStudents()">
                    <option value="">All Sections</option>
                </select>
            </div>
            <div class="filter-select">
                <select id="filterPerformance" onchange="filterStudents()">
                    <option value="">All Performance</option>
                    <option value="excellent">Excellent (90-100%)</option>
                    <option value="good">Good (70-89%)</option>
                    <option value="needs-improvement">Needs Improvement (0-69%)</option>
                    <option value="no-attempts">No Attempts Yet</option>
                </select>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="custom-table" id="studentsTable">
                <thead>
                <tr>
                    <th>UMaK ID</th>
                    <th>Student Name</th>
                    <th>Section</th>
                    <th>Best Score</th>
                    <th>Average Score</th>
                    <th>Last Attempt</th>
                    <th>Actions</th>
                </tr>
            </thead>
                <tbody id="studentsTableBody">
                <!-- Will be populated by JavaScript -->
            </tbody>
            </table>
        </div>
        
        <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center; padding: 0 10px;">
            <div style="font-size: 14px; color: #64748b;">
                Showing <span id="studentCount">0</span> students
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn-secondary-custom" onclick="previousPage()" style="padding: 6px 12px;">
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <span style="display: flex; align-items: center; font-size: 14px; color: #64748b;">
                    Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
                </span>
                <button class="btn-secondary-custom" onclick="nextPage()" style="padding: 6px 12px;">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Overdue View -->
    <div id="overdueView" class="hidden">
        <div class="search-filter-bar">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchOverdue" placeholder="Search students or tests..." onkeyup="filterOverdueStudents()">
            </div>
            <div class="filter-select">
                <select id="filterOverdueSection" onchange="filterOverdueStudents()">
                    <option value="">All Sections</option>
                </select>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="custom-table">
                <thead>
                    <tr>
                        <th>Student Name</th>
                        <th>Section</th>
                        <th>Overdue Test</th>
                        <th>Deadline</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="overdueTableBody">
                    <!-- Will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>
                    
                    <div class="pagination-controls" style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center; padding: 0 10px;">
                        <div style="font-size: 14px; color: #64748b;">
                            Showing <span id="studentCount">0</span> students
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-secondary-custom" onclick="previousPage()" style="padding: 6px 12px;">
                                <i class="fas fa-chevron-left"></i> Previous
                            </button>
                            <span style="display: flex; align-items: center; font-size: 14px; color: #64748b;">
                                Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
                            </span>
                            <button class="btn-secondary-custom" onclick="nextPage()" style="padding: 6px 12px;">
                                Next <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- View Section Details Modal -->
<div id="viewSectionModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="fas fa-layer-group"></i> Section Details
            </h3>
            <button class="close-modal" onclick="closeViewSectionModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="section-info-card" id="sectionDetailsContent">
                <!-- Section details will be loaded here -->
            </div>
            
            <!-- Students Table Section -->
            <div class="activities-table">
                <h4 style="margin-bottom: 15px; color: #1e3a8a;">
                    <i class="fas fa-user-graduate"></i> Students in this Section
                </h4>
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="custom-table" id="sectionStudentsTable">
                        <thead>
                            <tr>
                                <th>UMaK ID</th>
                                <th>Student Name</th>
                                <th>Email</th>
                                <th>Total Attempts</th>
                                <th>Best Score</th>
                                <th>Average Score</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sectionStudentsTableBody">
                            <!-- Students will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeViewSectionModal()">Close</button>
        </div>
    </div>
</div>

    <!-- View Student Details & Add Attempt Modal -->
<div id="viewStudentModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="fas fa-user-circle"></i> Student Performance
            </h3>
            <button class="close-modal" onclick="closeViewStudentModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="student-info-card" id="studentDetailsContent">
                <!-- Student details will be loaded here -->
            </div>
            
            <!-- Activities/Actions Table - NOW SCROLLABLE -->
            <div class="activities-table">
                <h4 style="margin-bottom: 15px; color: #1e3a8a;">
                    <i class="fas fa-history"></i> Activity Attempts
                </h4>
               <div class="table-responsive scrollable-attempts-table">
            <table class="custom-table" id="attemptsTable">
                        <thead style="position: sticky; top: 0; background: #f8fafc; z-index: 10;">
                            <tr>
                                <th>Date & Time</th>
                                <th>Activity Type</th>
                                <th>Score</th>
                                <th>Status</th>
                                <th>Duration</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="attemptsTableBody">
                            <!-- Attempts will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Add New Attempt Form -->
            <div class="attempt-form">
                <h4 style="margin-bottom: 15px; color: #1e3a8a;">
                    <i class="fas fa-plus-circle"></i> Add New Attempt
                </h4>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label required" for="attemptType">Activity Type</label>
                        <select class="form-select" id="attemptType" required>
                            <option value="">Select Activity</option>
                            <option value="push-up">Push-up Test</option>
                            <option value="sit-up">Sit-up Test</option>
                            <option value="running">Running Test</option>
                            <option value="flexibility">Flexibility Test</option>
                            <option value="endurance">Endurance Test</option>
                            <option value="other">Other Activity</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label required" for="attemptScore">Score (%)</label>
                        <input type="number" class="form-control" id="attemptScore" min="0" max="100" placeholder="Enter score (0-100)" required>
                    </div>
                </div>
                <div class="form-group full-width">
                    <label class="form-label" for="attemptNotes">Notes (Optional)</label>
                    <textarea class="form-control" id="attemptNotes" rows="2" placeholder="Any notes about this attempt..."></textarea>
                </div>
                <div class="modal-footer" style="padding: 15px 0 0 0; border-top: none;">
                    <button class="btn-cancel" onclick="closeViewStudentModal()">Cancel</button>
                    <button class="btn-submit" onclick="addNewAttempt()">
                        <i class="fas fa-save"></i> Save Attempt
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Edit Score Modal -->
<div id="editScoreModal" class="edit-score-overlay" style="display: none;">
    <div class="edit-score-modal">
        <div class="edit-score-header">
            <button class="close-edit-modal" onclick="closeEditScoreModal()"></button>
            <div class="edit-score-header-content">
                <h3 class="edit-score-title">
                    <span></span> Edit Student Score
                </h3>
                <p class="edit-score-subtitle" id="editScoreTestName">Push-up Test</p>
            </div>
        </div>

        <div class="edit-score-body">
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active" id="step1">
                    <div class="step-circle">1</div>
                    <div class="step-label">View Current</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Edit Score</div>
                </div>
            </div>

            <!-- Test Information -->
            <div class="info-card">
                <div class="info-row">
                    <span class="info-label">Test Target</span>
                    <span class="target-badge" id="editScoreTarget">20 repetitions</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Student</span>
                    <span class="info-value" id="editScoreStudent">Juan Dela Cruz</span>
                </div>
            </div>

            <!-- Step 1: View Current Score -->
            <div id="stepContent1">
                <div class="info-card" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-left-color: #3b82f6;">
                    <div class="info-row">
                        <span class="info-label">Current Result</span>
                        <span class="info-value" id="currentResultDisplay">--</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Current Score</span>
                        <span class="info-value">
                            <span id="currentScoreDisplay" class="text-3xl font-bold text-blue-600">--</span>
                            <span class="text-gray-500">/100</span>
                        </span>
                    </div>
                </div>
                <p class="text-sm text-gray-600 mt-4">
                    <i class="bi bi-info-circle"></i> Click "Next" to edit this score
                </p>
            </div>

            <!-- Step 2: Edit Score -->
            <div id="stepContent2" style="display: none;">
                <div class="form-group-modal">
                    <label class="form-label-modal">
                        Student Result <span class="required">*</span>
                    </label>
                    <div class="input-group">
                        <span class="input-icon"></span>
                        <input type="number" 
                               class="form-input-modal" 
                               id="newResult" 
                               placeholder="Enter result"
                               min="0"
                               step="1">
                    </div>
                    <p class="form-hint" id="resultHint">Enter what the student achieved in this test</p>
                </div>

                <div class="score-preview" id="scorePreview" style="display: none;">
                    <div class="score-preview-label">Calculated Score</div>
                    <div class="score-preview-value" id="previewScore">0</div>
                    <div class="score-preview-text">
                        Based on the result entered, this will be the final score
                    </div>
                </div>
            </div>
        </div>

        <div class="edit-score-footer">
            <button class="btn-modal btn-cancel-modal" onclick="closeEditScoreModal()">Cancel</button>
            <button id="btnNext" class="btn-modal btn-next" onclick="nextStep()">Next <i class="bi bi-arrow-right"></i></button>
            <button id="btnSubmit" class="btn-modal btn-submit-modal" onclick="submitScore()" style="display: none;">
                <span></span> Save Score
            </button>
        </div>
    </div>
</div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
   <script type="module">
        import { 
            initializeApp 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            onAuthStateChanged, 
            signOut,
            createUserWithEmailAndPassword 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    
    // Cloud Firestore
    import { 
        getFirestore,
        collection,
        query,
        where,
        getDocs,
        getDoc,
        addDoc,
        updateDoc,
        deleteDoc,
        doc,
        orderBy,
        serverTimestamp,
        limit,
        Timestamp,
        onSnapshot  // ITO ANG IMPORTANTENG IDAGDAG
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAgaLunqEf2gs6dSpF_sz1hV5XQ5Wm52jo",
            authDomain: "umakfit-e3b1d.firebaseapp.com",
            projectId: "umakfit-e3b1d",
            storageBucket: "umakfit-e3b1d.appspot.com",
            messagingSenderId: "276569891504",
            appId: "1:276569891504:web:39b1732b519f4d8b785175"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
            window.db = db;
            window.collection = collection;
            window.doc = doc;
            window.addDoc = addDoc;
            window.updateDoc = updateDoc;
            window.serverTimestamp = serverTimestamp;
            window.getDocs = getDocs;
            window.getDoc = getDoc;
            window.query = query;
            window.where = where;
            window.orderBy = orderBy;
            window.limit = limit;
            window.Timestamp = Timestamp;
            window.onSnapshot = onSnapshot;
            window.deleteDoc = deleteDoc;
        // Global variables
        window.currentUser = null;
        window.sections = [];
        window.students = [];
        window.filteredStudents = [];
        window.currentStudentId = null;
        window.currentPage = 1;
        window.itemsPerPage = 10;
        window.filteredSections = [];
        window.overdueStudents = [];
        window.filteredOverdueStudents = [];
        window.currentTab = 'all';
        // Load professor's assigned sections
async function loadSections() {
    try {
        console.log('Loading sections for logged-in professor...');
        console.log('Current user UID:', window.currentUser.uid);
        console.log('DisplayName:', window.currentUser.displayName);
        console.log('Email:', window.currentUser.email);

        window.sections = [];

        // STEP 1: Kunin muna ang EXACT professor name/email from users or professors collection
        let professorFullName = null;
        let professorEmail = window.currentUser.email;

        // Try sa 'professors' collection
        const profQuery = query(collection(db, 'professors'), where('email', '==', professorEmail));
        const profSnap = await getDocs(profQuery);
        if (!profSnap.empty) {
            professorFullName = profSnap.docs[0].data().fullName || profSnap.docs[0].data().name;
        }

        // Kung wala, try sa 'users' collection (kung may role: professor)
        if (!professorFullName) {
            const userQuery = query(collection(db, 'users'), where('email', '==', professorEmail));
            const userSnap = await getDocs(userQuery);
            if (!userSnap.empty) {
                const userData = userSnap.docs[0].data();
                if (userData.role === 'professor') {
                    professorFullName = userData.fullName || userData.name || window.currentUser.displayName;
                }
            }
        }

        // Final fallback
        if (!professorFullName) {
            professorFullName = window.currentUser.displayName || professorEmail.split('@')[0].toUpperCase();
        }

        console.log('Professor name to match in sections:', professorFullName);

        // STEP 2: Kunin lahat ng sections at i-match flexibly
        const sectionsSnapshot = await getDocs(collection(db, 'sections'));

        sectionsSnapshot.forEach(sectionDoc => {
            const data = sectionDoc.data();
            const dbProfessor = (data.professor || '').toString().trim();

            // Flexible matching  kahit anong format
            const matches = 
                dbProfessor === professorFullName ||
                dbProfessor.toUpperCase().includes(professorFullName.toUpperCase()) ||
                professorFullName.toUpperCase().includes(dbProfessor.toUpperCase()) ||
                dbProfessor.replace(/[,.\s]/g, '') === professorFullName.replace(/[,.\s]/g, '');

            if (matches) {
                console.log(`MATCHED! Section: ${data.name}  Professor: "${dbProfessor}"`);

                const studentCount = Array.isArray(data.students) ? data.students.length : 0;

                window.sections.push({
                id: sectionDoc.id,
                name: data.name,
                yearLevel: data.yearLevel || extractYearLevel(data.name),
                studentCount: studentCount,
                courseCode: data.courseCode || 'PE 3',
                semester: data.semester || 'N/A',
                academicYear: data.academicYear || 'N/A',
                status: 'active',
                professorName: dbProfessor,
                description: data.description || '',
                students: data.students || []
            });
            }
        });

        console.log(`Total sections loaded for this professor: ${window.sections.length}`);
        window.filteredSections = [...window.sections];
        // Update table
        if (window.sections.length === 0) {
            document.getElementById('sectionsTableBody').innerHTML = `
                <tr>
                    <td colspan="7">
                        <div class="empty-state">
                            <div class="empty-icon">Warning</div>
                            <div class="empty-title">No Sections Assigned</div>
                            <div class="empty-text">
                                Logged in as: <strong>${professorEmail}</strong><br>
                                Looking for professor name: <strong>"${professorFullName}"</strong><br><br>
                                No matching section found. Contact admin if this is incorrect.
                            </div>
                        </div>
                    </td>
                </tr>
            `;
        } else {
            populateSectionsTable();
            populateSectionFilters();
        }
           
    } catch (error) {
        console.error('Error loading sections:', error);
        alert('Error loading sections: ' + error.message);
    }
}
function extractYearLevel(sectionName) {
    if (!sectionName) return 'N/A';
    
    // Try Roman numerals first (like "III-A")
    const romanNumerals = {
        'I': '1',
        'II': '2',
        'III': '3',
        'IV': '4',
        'V': '5'
    };
    
    // Check for Roman numerals at the beginning
    const romanMatch = sectionName.match(/^(I{1,3}|IV|V)/);
    if (romanMatch && romanMatch[0]) {
        return romanNumerals[romanMatch[0]] || romanMatch[0];
    }
    
    // Check for numeric year
    const numericMatch = sectionName.match(/\d/);
    if (numericMatch) {
        return numericMatch[0];
    }
    
    return 'N/A';
}

        // Load students for current professor's sections
        window.loadStudents = async function() {
            try {
                console.log('=== LOADING STUDENTS FOR THIS PROFESSOR ===');

                if (window.sections.length === 0) {
                    console.log('No sections assigned. Skipping student load.');
                    updateStudentsTable([]);
                    return;
                }

                window.students = [];
                const seenStudentIds = new Set();

                for (const section of window.sections) {
                    if (!section.students || !Array.isArray(section.students) || section.students.length === 0) {
                        continue;
                    }

                    for (const rawStudent of section.students) {
                        const studentEmail = rawStudent.email || '';
                        if (!studentEmail || seenStudentIds.has(studentEmail)) continue;
                        seenStudentIds.add(studentEmail);

                        let firstName = '', lastName = '', fullName = rawStudent.name || 'Unknown Student';
                        if (fullName.includes(',')) {
                            const parts = fullName.split(',').map(p => p.trim());
                            lastName = parts[0];
                            firstName = parts.slice(1).join(' ');
                        } else {
                            const nameParts = fullName.split(' ');
                            firstName = nameParts[0] || '';
                            lastName = nameParts.slice(1).join(' ') || '';
                        }

                        // Get test results using email
                        let bestScore = 0;
                        let lastAttempt = null;
                        let lastAttemptTest = '';
                        let totalAttempts = 0;
                        let testAttempts = {}; // Track attempts per test

                        if (studentEmail) {
                            const attemptsQuery = query(
                                collection(db, 'testResults'), 
                                where('studentEmail', '==', studentEmail)
                            );
                            const snapshot = await getDocs(attemptsQuery);
                            totalAttempts = snapshot.size;

                            // Group by testId to get BEST score per test (same as test.html)
                            const testBestScores = new Map();
                            
                            snapshot.forEach(doc => {
                                const data = doc.data();
                                const testId = data.testId;
                                const testName = data.testName || 'Unknown Test';
                                const score = calculateTestScore(data.testName, data.result, data.testTarget);
                                
                                // Track best score per test
                                if (!testBestScores.has(testId) || score > testBestScores.get(testId)) {
                                    testBestScores.set(testId, score);
                                }
                                
                                // Track overall best score
                                if (score > bestScore) bestScore = score;

                                // Track attempts per test name (for display)
                                if (!testAttempts[testName]) {
                                    testAttempts[testName] = 0;
                                }
                                testAttempts[testName]++;

                                // Track last attempt
                                let attemptTime = null;
                                if (data.submittedAt) {
                                    if (typeof data.submittedAt.toDate === 'function') {
                                        attemptTime = data.submittedAt.toDate();
                                    } else if (data.submittedAt instanceof Date) {  
                                        attemptTime = data.submittedAt;
                                    } else if (typeof data.submittedAt === 'string' || typeof data.submittedAt === 'number') {
                                        attemptTime = new Date(data.submittedAt);
                                    }
                                }
                                if (attemptTime && (!lastAttempt || attemptTime > lastAttempt)) {
                                    lastAttempt = attemptTime;
                                    lastAttemptTest = testName;
                                }
                            });
                            
                            // Calculate average from BEST scores only (same as test.html)
                            let totalScore = 0;
                            testBestScores.forEach(score => {
                                totalScore += score;
                            });
                            
                            const totalUniqueTests = testBestScores.size;
                            var averageScore = totalUniqueTests > 0 ? Math.round(totalScore / totalUniqueTests) : 0;
                            
                            console.log(` ${fullName}: ${totalUniqueTests} unique tests, Best: ${bestScore}, Avg: ${averageScore}`);
                        }

                        const student = {
                            id: studentEmail,
                            umakId: rawStudent.student_id || rawStudent.studentId || 'N/A',
                            firstName: firstName || 'Unknown',
                            lastName: lastName || '',
                            fullName: fullName,
                            email: studentEmail,
                            section: section.name,
                            yearLevel: section.yearLevel || extractYearLevel(section.name),
                            totalAttempts: totalAttempts,
                            testAttempts: testAttempts,
                            bestScore: bestScore,
                            averageScore: averageScore, // Now uses best-score-only average
                            lastAttempt: lastAttempt,
                            lastAttemptTest: lastAttemptTest,
                            status: 'active'
                        };

                        console.log(`Student loaded: ${student.fullName} (${student.umakId})  Avg: ${student.averageScore}%`);
                        window.students.push(student);
                    }
                }

                console.log(`Total students loaded: ${window.students.length}`);
                window.filteredStudents = [...window.students];
                window.currentPage = 1;
                updateStudentsTable(window.filteredStudents);
                await loadOverdueStudents();
            } catch (error) {
                console.error('Error loading students:', error);
                alert('Error loading students: ' + error.message);
                updateStudentsTable([]);
            }
        }
            // Calculate test score based on result and target
function calculateTestScore(testName, result, testTarget = null) {
    const normalized = testName.toLowerCase().trim();
    
    // Extract numeric value from result
    let numericValue = 0;
    
    if (typeof result === 'object' && result !== null) {
        numericValue = result.repetitions || result.time || result.distance || result.value || result.score || 0;
    } else if (typeof result === 'string') {
        const match = result.match(/(\d+\.?\d*)/);
        if (match) {
            numericValue = parseFloat(match[1]);
        } else {
            numericValue = parseFloat(result) || 0;
        }
    } else {
        numericValue = parseFloat(result) || 0;
    }
    
    // Use test target if available
    if (testTarget && testTarget > 0) {
        if (normalized.includes('push-up') || normalized.includes('pushup') || 
            normalized.includes('sit-up') || normalized.includes('situp')) {
            const reps = numericValue;
            const percentage = (reps / testTarget) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 100) score = 100;
            else if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            return Math.round(score);
        } else if (normalized.includes('plank')) {
            let seconds = numericValue;
            const percentage = (seconds / testTarget) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 100) score = 100;
            else if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            return Math.round(score);
        } else if (normalized.includes('sit-and-reach')) {
            const distance = numericValue;
            const percentage = (distance / testTarget) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 100) score = 100;
            else if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            return Math.round(score);
        }
    }
    
    // Fallback scoring
    if (normalized.includes('push-up') || normalized.includes('pushup')) {
        const reps = numericValue;
        if (reps >= 40) return 100;
        if (reps >= 35) return 95;
        if (reps >= 30) return 90;
        if (reps >= 25) return 85;
        if (reps >= 20) return 80;
        if (reps >= 15) return 75;
        if (reps >= 10) return 70;
        if (reps >= 5) return 65;
        return 60;
    } else if (normalized.includes('sit-up') || normalized.includes('situp')) {
        const reps = numericValue;
        if (reps >= 50) return 100;
        if (reps >= 45) return 95;
        if (reps >= 40) return 90;
        if (reps >= 35) return 85;
        if (reps >= 30) return 80;
        if (reps >= 25) return 75;
        if (reps >= 20) return 70;
        if (reps >= 15) return 65;
        return 60;
    } else if (normalized.includes('plank')) {
        let seconds = numericValue;
        if (seconds >= 180) return 100;
        if (seconds >= 150) return 95;
        if (seconds >= 120) return 90;
        if (seconds >= 100) return 85;
        if (seconds >= 80) return 80;
        if (seconds >= 60) return 75;
        if (seconds >= 45) return 70;
        if (seconds >= 30) return 65;
        return 60;
    } else if (normalized.includes('step test') || normalized.includes('3-minute')) {
        const heartRate = numericValue;
        if (heartRate <= 70) return 100;
        if (heartRate <= 80) return 95;
        if (heartRate <= 90) return 90;
        if (heartRate <= 100) return 85;
        if (heartRate <= 110) return 80;
        if (heartRate <= 120) return 75;
        if (heartRate <= 130) return 70;
        return 65;
    } else if (normalized.includes('sit-and-reach')) {
        const distance = numericValue;
        if (distance >= 25) return 100;
        if (distance >= 20) return 95;
        if (distance >= 15) return 90;
        if (distance >= 10) return 85;
        if (distance >= 5) return 80;
        if (distance >= 0) return 75;
        if (distance >= -5) return 70;
        return 65;
    }
    
    return 75; // Default score
}
            function populateSectionsTable() {
                const tableBody = document.getElementById('sectionsTableBody');
                const sectionCount = document.getElementById('sectionCount');
                
                // Show ALL sections, no pagination
                sectionCount.textContent = window.filteredSections.length;
                
                if (window.filteredSections.length === 0) {
                    // Check if sections were actually loaded (not just filtered to empty)
                    if (window.sections.length === 0) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="7">
                                    <div class="empty-state">
                                        <div class="empty-icon"></div>
                                        <div class="empty-title">No Sections Assigned</div>
                                        <div class="empty-text">You haven't been assigned to any sections yet. Please contact the Dean or Head Admin.</div>
                                    </div>
                                </td>
                            </tr>
                        `;
                    } else {
                        // Filtered to empty but sections exist
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="7">
                                    <div class="empty-state">
                                        <div class="empty-icon"></div>
                                        <div class="empty-title">No Sections Found</div>
                                        <div class="empty-text">No sections match your search criteria.</div>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }
                    return;
                }
                
                let html = '';
                window.filteredSections.forEach(section => {
                    const statusClass = section.status === 'active' ? 'status-active' : 'status-inactive';
                    const statusText = section.status === 'active' ? 'Active' : 'Inactive';
                    
                    html += `
                        <tr>
                            <td>
                                <strong style="color: #1e3a8a;">${section.name}</strong>
                                ${section.description ? `<br><small style="color: #64748b;">${section.description}</small>` : ''}
                            </td>
                            <td><span style="font-weight: 600;">${section.yearLevel || 'N/A'}</span></td>
                            <td>
                                <span style="font-weight: 700; color: #3b82f6;">${section.studentCount || 0}</span>
                                <small style="color: #64748b;"> students</small>
                            </td>
                            <td><span style="font-family: monospace; background: #f1f5f9; padding: 4px 8px; border-radius: 4px;">${section.courseCode || 'N/A'}</span></td>
                            <td>${section.semester || 'N/A'}</td>
                            <td>${section.academicYear || 'N/A'}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-action btn-view" onclick="viewSectionDetails('${section.id}')">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableBody.innerHTML = html;
            }
            function isMobileView() {
    return window.innerWidth <= 768;
}
       // Modify the updateStudentsTable function
function updateStudentsTable(students) {
    const tableBody = document.getElementById('studentsTableBody');
    const studentCount = document.getElementById('studentCount');
    const currentPageElement = document.getElementById('currentPage');
    const totalPagesElement = document.getElementById('totalPages');

    // On mobile, show all students (no pagination)
    const showAll = isMobileView();
    const displayStudents = showAll ? students : students.slice(
        (window.currentPage - 1) * window.itemsPerPage,
        window.currentPage * window.itemsPerPage
    );

    if (!showAll) {
        const totalPages = Math.ceil(students.length / window.itemsPerPage);
        totalPagesElement.textContent = totalPages || 1;
        currentPageElement.textContent = window.currentPage;
    }

    studentCount.textContent = students.length;

    if (displayStudents.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="empty-icon"></div><div class="empty-title">No Students Found</div><div class="empty-text">Try adjusting your search or filters.</div></div></td></tr>`;
        return;
    }

    let rowsHTML = '';
    displayStudents.forEach(student => {
        let scoreClass = '', scoreText = 'No attempts';
        if (student.totalAttempts > 0) {
            if (student.bestScore >= 90) { scoreClass = 'score-excellent'; scoreText = 'Excellent'; }
            else if (student.bestScore >= 70) { scoreClass = 'score-good'; scoreText = 'Good'; }
            else { scoreClass = 'score-poor'; scoreText = 'Needs Improvement'; }
        }

        let lastAttemptFormatted = 'No attempts';
        if (student.lastAttempt instanceof Date && !isNaN(student.lastAttempt)) {
            lastAttemptFormatted = `
                <strong>${student.lastAttemptTest || 'Unknown Test'}</strong><br>
                <small style="color: #64748b;">
                    ${student.lastAttempt.toLocaleDateString('en-US', {
                        year: 'numeric', month: 'short', day: 'numeric'
                    })}
                </small>
            `;
        }

        rowsHTML += `
            <tr>
                <td><strong>${student.umakId || 'N/A'}</strong></td>
                <td>${student.firstName} ${student.lastName}</td>
                <td>${student.section || 'N/A'}</td>
                <td>${student.totalAttempts > 0 ? `<span class="score-badge ${scoreClass}">${student.bestScore}%</span><br><small style="color: #64748b;">${scoreText}</small>` : ''}</td>
                <td>${student.totalAttempts > 0 ? `<strong>${student.averageScore}%</strong>` : ''}</td>
                <td>${lastAttemptFormatted}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-action btn-view" onclick="viewStudentDetails('${student.id}')"><i class="fas fa-eye"></i> View</button>
                    </div>
                </td>
            </tr>`;
    });

    tableBody.innerHTML = rowsHTML;
}
        // Populate section filters
        function populateSectionFilters() {
            const sectionFilter = document.getElementById('filterSection');
            
            // Clear existing options except the first one
            sectionFilter.innerHTML = '<option value="">All Sections</option>';
            
            // Add only professor's sections
            window.sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section.name;
                option.textContent = `${section.name} (${section.studentCount} students)`;
                sectionFilter.appendChild(option);
            });
            
            console.log(` Populated ${sectionFilter.options.length - 1} professor sections`);
            
        }
        // Also populate overdue section filter
        const overdueFilter = document.getElementById('filterOverdueSection');
        if (overdueFilter) {
            overdueFilter.innerHTML = '<option value="">All Sections</option>';
            window.sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section.name;
                option.textContent = section.name;
                overdueFilter.appendChild(option);
            });
        }

        // View section details (READ ONLY)
        // View section details (READ ONLY) with students list
async function viewSectionDetails(sectionId) {
    try {
        const sectionRef = doc(db, 'sections', sectionId);
        const sectionDoc = await getDoc(sectionRef);
        
        if (!sectionDoc.exists()) {
            alert('Section not found!');
            return;
        }
        
        const sectionData = { id: sectionDoc.id, ...sectionDoc.data() };
        
        // Get students in this section from our loaded data
        const sectionStudents = window.students.filter(student => 
            student.section === sectionData.name
        );
        
        // Get performance statistics
        let totalAttempts = 0;
        let totalScore = 0;
        let studentsWithAttempts = 0;
        
        sectionStudents.forEach(student => {
            if (student.totalAttempts > 0) {
                studentsWithAttempts++;
                totalAttempts += student.totalAttempts;
                totalScore += student.averageScore;
            }
        });
        
        const averageScore = studentsWithAttempts > 0 ? Math.round(totalScore / studentsWithAttempts) : 0;
        const completionRate = sectionStudents.length > 0 ? Math.round((studentsWithAttempts / sectionStudents.length) * 100) : 0;
        
        // Prepare HTML for section details
        let html = `
            <div class="section-info-header">
                <div class="section-basic-info">
                    <div class="section-name">${sectionData.name}</div>
                    <div class="section-details">
                        <span><i class="fas fa-user-graduate"></i> ${sectionStudents.length} Students</span>
                        <span><i class="fas fa-calendar"></i> ${sectionData.academicYear || 'N/A'}</span>
                        <span><i class="fas fa-clock"></i> ${sectionData.semester || 'N/A'}</span>
                    </div>
                </div>
            </div>
            <div class="section-info-grid">
                <div class="info-item">
                    <div class="info-label">Year Level</div>
                    <div class="info-value">${sectionData.yearLevel || 'N/A'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Status</div>
                    <div class="info-value">
                        <span class="status-badge ${sectionData.status === 'active' ? 'status-active' : 'status-inactive'}">
                            ${sectionData.status === 'active' ? 'Active' : 'Inactive'}
                        </span>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">Total Attempts</div>
                    <div class="info-value">${totalAttempts}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Average Score</div>
                    <div class="info-value">
                        ${studentsWithAttempts > 0 ? `
                            <span class="score-badge ${averageScore >= 70 ? 'score-excellent' : 'score-poor'}">
                                ${averageScore}%
                            </span>
                        ` : 'No data'}
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">Completion Rate</div>
                    <div class="info-value">${completionRate}%</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Professor</div>
                    <div class="info-value">${sectionData.professor || window.currentUser.displayName || window.currentUser.email}</div>
                </div>
        `;
        
        if (sectionData.description) {
            html += `
                <div class="info-item full-width">
                    <div class="info-label">Description</div>
                    <div class="info-value">${sectionData.description}</div>
                </div>
            `;
        }
        
        html += `</div>`;
        
        document.getElementById('sectionDetailsContent').innerHTML = html;
        
        // Populate students table
        let studentsHTML = '';
        if (sectionStudents.length > 0) {
            sectionStudents.forEach(student => {
                let scoreClass = '', scoreText = 'No attempts';
                if (student.totalAttempts > 0) {
                    if (student.bestScore >= 90) { scoreClass = 'score-excellent'; scoreText = 'Excellent'; }
                    else if (student.bestScore >= 70) { scoreClass = 'score-good'; scoreText = 'Good'; }
                    else { scoreClass = 'score-poor'; scoreText = 'Needs Improvement'; }
                }
                
                studentsHTML += `
                    <tr>
                        <td><strong>${student.umakId || 'N/A'}</strong></td>
                        <td>${student.firstName} ${student.lastName}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${student.email}">
                            ${student.email || 'N/A'}
                        </td>
                        <td>${student.totalAttempts || 0}</td>
                        <td>
                            ${student.totalAttempts > 0 ? 
                                `<span class="score-badge ${scoreClass}">${student.bestScore}%</span>` : 
                                ''
                            }
                        </td>
                        <td>
                            ${student.totalAttempts > 0 ? 
                                `<strong>${student.averageScore}%</strong>` : 
                                ''
                            }
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-action btn-view" onclick="viewStudentDetails('${student.id}'); closeViewSectionModal();" style="padding: 4px 8px; font-size: 11px;">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        } else {
            studentsHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px; color: #64748b;">
                        <i class="fas fa-user-graduate" style="font-size: 24px; opacity: 0.5;"></i><br>
                        No students found in this section
                    </td>
                </tr>
            `;
        }
        
        document.getElementById('sectionStudentsTableBody').innerHTML = studentsHTML;
        document.getElementById('viewSectionModal').style.display = 'flex';
        
    } catch (error) {
        console.error('Error viewing section details:', error);
        alert('Error: ' + error.message);
    }
}

        // Close view section modal
        function closeViewSectionModal() {
            document.getElementById('viewSectionModal').style.display = 'none';
        }


    async function viewStudentDetails(studentId) {
    try {
        window.currentStudentId = studentId;
        const student = window.students.find(s => s.id === studentId);
        if (!student) {
            alert('Student not found!');
            return;
        }

        // Get all test results for this student
        const attemptsQuery = query(
            collection(db, 'testResults'), 
            where('studentEmail', '==', student.email)
        );
        const attemptsSnapshot = await getDocs(attemptsQuery);

        // Group attempts by testId (NOT testName) to track attempts correctly
        const testGroups = {};
        
        attemptsSnapshot.forEach(docSnap => {
            const attempt = { id: docSnap.id, ...docSnap.data() };
            const testId = attempt.testId || attempt.testName; // Use testId as primary key
            
            if (!testGroups[testId]) {
                testGroups[testId] = {
                    testName: attempt.testName || 'Unknown Test',
                    attempts: []
                };
            }
            testGroups[testId].attempts.push(attempt);
        });

        // Calculate overall stats
        let totalScore = 0, bestScore = 0, totalAttempts = 0;
        
        Object.values(testGroups).forEach(group => {
            group.attempts.forEach(attempt => {
                const score = calculateTestScore(attempt.testName, attempt.result, attempt.testTarget);
                totalScore += score;
                totalAttempts++;
                if (score > bestScore) bestScore = score;
            });
        });

        const averageScore = totalAttempts > 0 ? Math.round(totalScore / totalAttempts) : 0;
        const initials = (student.firstName.charAt(0) + student.lastName.charAt(0)).toUpperCase() || '??';

        // Student info card
        let html = `
            <div class="student-info-header">
                <div class="student-avatar">${initials}</div>
                <div class="student-basic-info">
                    <div class="student-name">${student.firstName} ${student.lastName}</div>
                    <div class="student-id">${student.umakId}  ${student.section}</div>
                </div>
            </div>
            <div class="student-info-grid">
                <div class="info-item">
                    <div class="info-label">Email</div>
                    <div class="info-value info-value-email">${student.email || 'N/A'}</div>
                </div>
                <div class="info-item"><div class="info-label">Year Level</div><div class="info-value">${student.yearLevel || 'N/A'}</div></div>
                <div class="info-item"><div class="info-label">Total Tests Taken</div><div class="info-value"><strong>${Object.keys(testGroups).length}</strong></div></div>
                <div class="info-item"><div class="info-label">Best Score</div><div class="info-value">${totalAttempts > 0 ? `<span class="score-badge ${bestScore >= 90 ? 'score-excellent' : bestScore >= 70 ? 'score-good' : 'score-poor'}">${bestScore}%</span>` : 'No attempts'}</div></div>
                <div class="info-item"><div class="info-label">Average Score</div><div class="info-value">${totalAttempts > 0 ? `<strong>${averageScore}%</strong>` : 'No attempts'}</div></div>
                <div class="info-item"><div class="info-label">Status</div><div class="info-value"><span class="status-badge status-active">Active</span></div></div>
            </div>`;

        document.getElementById('studentDetailsContent').innerHTML = html;

        // Attempts table - Show ALL attempts
        let attemptsHTML = '';
        if (Object.keys(testGroups).length > 0) {
            // Sort tests by most recent attempt
            const sortedTests = Object.entries(testGroups).sort((a, b) => {
                const getLatestTime = (attempts) => {
                    const timestamps = attempts.map(att => {
                        if (!att.submittedAt) return 0;
                        if (typeof att.submittedAt.toMillis === 'function') return att.submittedAt.toMillis();
                        if (att.submittedAt instanceof Date) return att.submittedAt.getTime();
                        if (typeof att.submittedAt === 'string' || typeof att.submittedAt === 'number') return new Date(att.submittedAt).getTime();
                        if (att.submittedAt.seconds && att.submittedAt.nanoseconds) return att.submittedAt.seconds * 1000;
                        return 0;
                    });
                    return Math.max(...timestamps);
                };
                
                return getLatestTime(b[1].attempts) - getLatestTime(a[1].attempts);
            });

            sortedTests.forEach(([testId, group]) => {
                const testName = group.testName;
                const testAttempts = group.attempts;
                
                // Sort attempts by date (oldest first for correct numbering)
                testAttempts.sort((a, b) => {
                    const getTimestamp = (attempt) => {
                        if (!attempt.submittedAt) return 0;
                        if (typeof attempt.submittedAt.toMillis === 'function') return attempt.submittedAt.toMillis();
                        if (attempt.submittedAt instanceof Date) return attempt.submittedAt.getTime();
                        if (typeof attempt.submittedAt === 'string' || typeof attempt.submittedAt === 'number') return new Date(attempt.submittedAt).getTime();
                        if (attempt.submittedAt.seconds && attempt.submittedAt.nanoseconds) return attempt.submittedAt.seconds * 1000;
                        return 0;
                    };
                    
                    return getTimestamp(a) - getTimestamp(b); // oldest first
                });

                const totalAttempts = testAttempts.length;
                
                // Find best score among all attempts
                const bestScoreInTest = Math.max(...testAttempts.map(a => calculateTestScore(a.testName, a.result, a.testTarget)));
                
                // Show ALL attempts for this test
                testAttempts.forEach((attempt, index) => {
                    const attemptNumber = index + 1; // 1, 2, 3, etc.
                    
                    let date = new Date();
                    if (attempt.submittedAt) {
                        if (typeof attempt.submittedAt.toDate === 'function') {
                            date = attempt.submittedAt.toDate();
                        } else if (attempt.submittedAt instanceof Date) {
                            date = attempt.submittedAt;
                        } else if (typeof attempt.submittedAt === 'string' || typeof attempt.submittedAt === 'number') {
                            date = new Date(attempt.submittedAt);
                        } else if (attempt.submittedAt.seconds && attempt.submittedAt.nanoseconds) {
                            date = new Date(attempt.submittedAt.seconds * 1000);
                        }
                    }
                    const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    
                    const score = calculateTestScore(attempt.testName, attempt.result, attempt.testTarget);
                    let statusClass = score >= 90 ? 'score-excellent' : score >= 70 ? 'score-good' : 'score-poor';
                    let statusText = score >= 90 ? 'Excellent' : score >= 70 ? 'Good' : 'Needs Improvement';
                    
                    const isBestScore = score === bestScoreInTest;
                    
                    const bestScoreIndicator = isBestScore && totalAttempts > 1 ? 
                        '<span style="color: #10b981; font-weight: bold; margin-left: 5px;"> Best</span>' : '';

                    attemptsHTML += `
                        <tr style="${isBestScore && totalAttempts > 1 ? 'background-color: #f0fdf4;' : ''}">
                            <td>${formattedDate}</td>
                            <td>
                                <strong>${testName}</strong><br>
                                <small style="color: #64748b;">
                                    Attempt ${attemptNumber} of ${totalAttempts}
                                </small>
                            </td>
                            <td>
                                <span class="score-badge ${statusClass}">${score}%</span>${bestScoreIndicator}
                            </td>
                            <td>${statusText}</td>
                            <td>${attempt.timerValue || 'N/A'}</td>
                            <td>
                                <button class="btn-action btn-view" style="padding: 4px 8px; font-size: 11px;" onclick="viewAttemptDetails('${attempt.id}')">
                                    <i class="fas fa-info-circle"></i> Details
                                </button>
                            </td>
                        </tr>`;
                });
            });
        } else {
            attemptsHTML = `<tr><td colspan="6" style="text-align: center; padding: 40px; color: #64748b;"><i class="fas fa-history" style="font-size: 24px; opacity: 0.5;"></i><br>No test results recorded yet</td></tr>`;
        }

        document.getElementById('attemptsTableBody').innerHTML = attemptsHTML;
        document.getElementById('viewStudentModal').style.display = 'flex';
    } catch (error) {
        console.error('Error viewing student details:', error);
        alert('Error: ' + error.message);
    }
}
        // Helper function to format activity type
        function formatActivityType(type) {
            const types = {
                'push-up': 'Push-up Test',
                'sit-up': 'Sit-up Test',
                'running': 'Running Test',
                'flexibility': 'Flexibility Test',
                'endurance': 'Endurance Test',
                'other': 'Other Activity'
            };
            return types[type] || type;
        }

        // View attempt details
        async function viewAttemptDetails(attemptId) {
            try {
                const attemptRef = doc(db, 'testResults', attemptId);
                const attemptDoc = await getDoc(attemptRef);
                
                if (!attemptDoc.exists()) {
                    alert('Attempt not found!');
                    return;
                }
                
                const attempt = attemptDoc.data();
                const date = attempt.submittedAt?.toDate ? attempt.submittedAt.toDate() : new Date(attempt.createdAt || Date.now());
                
                alert(
                    `Attempt Details:\n\n` +
                    `Activity: ${formatActivityType(attempt.activityType || 'unknown')}\n` +
                    `Score: ${attempt.score || 0}%\n` +
                    `Date: ${date.toLocaleDateString()}\n` +
                    `Time: ${date.toLocaleTimeString()}\n` +
                    `Duration: ${attempt.duration || 'N/A'} minutes\n` +
                    `Notes: ${attempt.notes || 'No notes provided'}`
                );
                
            } catch (error) {
                console.error('Error viewing attempt details:', error);
                alert('Error: ' + error.message);
            }
        }

        // Add new attempt for student
    async function addNewAttempt() {
    const attemptType = document.getElementById('attemptType').value;
    const attemptScore = document.getElementById('attemptScore').value;
    const attemptNotes = document.getElementById('attemptNotes').value.trim();
    
    // Validation
    if (!attemptType || !attemptScore) {
        alert('Please fill in all required fields.');
        return;
    }
    
    const score = parseInt(attemptScore);
    if (isNaN(score) || score < 0 || score > 100) {
        alert('Please enter a valid score between 0 and 100.');
        return;
    }
    
    try {
        const submitBtn = document.querySelector('#viewStudentModal .btn-submit');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        
        // Find student in our loaded data
        const student = window.students.find(s => s.id === window.currentStudentId);
        
        if (!student) {
            throw new Error('Student not found!');
        }
        
        // Create new attempt
        const attemptData = {
            studentId: window.currentStudentId,
            studentName: student.fullName,
            studentEmail: student.email,
            studentSection: student.section,
            activityType: attemptType,
            score: score,
            notes: attemptNotes || null,
            submittedAt: serverTimestamp(),
            createdAt: serverTimestamp(),
            professorId: window.currentUser.uid,
            professorEmail: window.currentUser.email,
            professorName: window.currentUser.displayName || 'Professor'
        };
        
        // Save to testResults collection
        await addDoc(collection(db, 'testResults'), attemptData);
        
        console.log(' New attempt added for student:', student.fullName);
        
        // Clear form
        document.getElementById('attemptType').value = '';
        document.getElementById('attemptScore').value = '';
        document.getElementById('attemptNotes').value = '';
        
        // Refresh student details
        await viewStudentDetails(window.currentStudentId);
        
        // Refresh main student list
        await loadStudents();
        
        alert('Attempt added successfully!');
        
    } catch (error) {
        console.error('Error adding attempt:', error);
        alert('Error: ' + error.message);
        
        const submitBtn = document.querySelector('#viewStudentModal .btn-submit');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Attempt';
    }
}

        // Close view student modal
        function closeViewStudentModal() {
            document.getElementById('viewStudentModal').style.display = 'none';
            window.currentStudentId = null;
        }

        // Filter sections
        function filterSections() {
            const searchTerm = document.getElementById('searchSections').value.toLowerCase();
            
            window.filteredSections = window.sections.filter(section => {
                const matchesSearch = !searchTerm || 
                    section.name.toLowerCase().includes(searchTerm) ||
                    (section.courseCode && section.courseCode.toLowerCase().includes(searchTerm)) ||
                    (section.yearLevel && section.yearLevel.toLowerCase().includes(searchTerm));
                
                return matchesSearch;
            });
            
            window.currentSectionPage = 1;
            populateSectionsTable();
        }

        // Filter students
        function filterStudents() {
            const searchTerm = document.getElementById('searchStudents').value.toLowerCase();
            const sectionFilter = document.getElementById('filterSection').value;
            const performanceFilter = document.getElementById('filterPerformance').value;
            
            window.filteredStudents = window.students.filter(student => {
                // Search term filter
                const matchesSearch = !searchTerm || 
                    student.firstName.toLowerCase().includes(searchTerm) ||
                    student.lastName.toLowerCase().includes(searchTerm) ||
                    (student.umakId && student.umakId.toLowerCase().includes(searchTerm));
                
                // Section filter
                const matchesSection = !sectionFilter || student.section === sectionFilter;
                
                // Performance filter
                let matchesPerformance = true;
                if (performanceFilter) {
                    switch (performanceFilter) {
                        case 'excellent':
                            matchesPerformance = student.bestScore >= 90;
                            break;
                        case 'good':
                            matchesPerformance = student.bestScore >= 70 && student.bestScore < 90;
                            break;
                        case 'needs-improvement':
                            matchesPerformance = student.bestScore > 0 && student.bestScore < 70;
                            break;
                        case 'no-attempts':
                            matchesPerformance = student.totalAttempts === 0;
                            break;
                    }
                }
                
                return matchesSearch && matchesSection && matchesPerformance;
            });
            
            window.currentPage = 1; // Reset to first page when filtering
            updateStudentsTable(window.filteredStudents);
        }

        // Pagination functions
        function previousPage() {
            if (window.currentPage > 1) {
                window.currentPage--;
                updateStudentsTable(window.filteredStudents);
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(window.filteredStudents.length / window.itemsPerPage);
            if (window.currentPage < totalPages) {
                window.currentPage++;
                updateStudentsTable(window.filteredStudents);
            }
        }

        // Export students data
        function exportStudents() {
            if (window.filteredStudents.length === 0) {
                alert('No students to export.');
                return;
            }

            // Create CSV content
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "UMaK ID,Student Name,Section,Total Attempts,Best Score,Average Score,Last Attempt\n";
            
            window.filteredStudents.forEach(student => {
                const row = [
                    student.umakId || '',
                    `${student.firstName} ${student.lastName}`,
                    student.section || '',
                    student.totalAttempts || 0,
                    student.bestScore || 0,
                    student.averageScore || 0,
                    student.lastAttempt ? 
                        (student.lastAttempt.toDate ? student.lastAttempt.toDate().toLocaleDateString() : 
                         new Date(student.lastAttempt).toLocaleDateString()) : 'No attempts'
                ].map(field => `"${field}"`).join(',');
                
                csvContent += row + "\n";
            });
            
            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `student_scores_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Refresh data
       async function refreshData() {
        try {
            // Show a subtle loading indicator (optional)
            const refreshBtn = event?.target?.closest('.btn-secondary-custom');
            if (refreshBtn) {
                const originalHTML = refreshBtn.innerHTML;
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Refreshing...';
                refreshBtn.disabled = true;
            }
            
            window.currentPage = 1;
            
            // Reload data
            await loadSections();
            await loadStudents();
            
            // Restore button
            if (refreshBtn) {
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                refreshBtn.disabled = false;
            }
            
            console.log(' Data refreshed successfully');
            
        } catch (error) {
            console.error('Error refreshing data:', error);
            alert('Error refreshing data. Please try again.');
        }
    }

        // Setup real-time updates
     function setupRealtimeUpdates() {
    // Listen for section changes where this professor is assigned
    if (window.currentUser && window.currentUser.displayName) {
        const sectionsQuery = query(
            collection(db, 'sections'),
            where('professor', '==', window.currentUser.displayName)
        );
        
        onSnapshot(sectionsQuery, (snapshot) => {
            console.log(' Professor sections updated');
            loadSections().then(() => {
                loadStudents();
            });
        });
    }
}
        // Switch between tabs
window.switchTab = function(tab) {
    window.currentTab = tab;
    
    const allTab = document.getElementById('allStudentsTab');
    const overdueTab = document.getElementById('overdueTab');
    const allView = document.getElementById('allStudentsView');
    const overdueView = document.getElementById('overdueView');
    
    if (tab === 'all') {
        allTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
        allTab.classList.remove('text-gray-600');
        overdueTab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
        overdueTab.classList.add('text-gray-600');
        allView.classList.remove('hidden');
        overdueView.classList.add('hidden');
    } else {
        overdueTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
        overdueTab.classList.remove('text-gray-600');
        allTab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
        allTab.classList.add('text-gray-600');
        overdueView.classList.remove('hidden');
        allView.classList.add('hidden');
    }
};

        // Load overdue students
        window.loadOverdueStudents = async function() {
            try {
                window.overdueStudents = [];
                const now = new Date();
                
                for (const section of window.sections) {
                    if (!section.students || section.students.length === 0) continue;
                    
                    // Get all scheduled tests for this section
                    const testsQuery = query(
                        collection(db, 'scheduledTests'),
                        where('section', '==', section.name),
                        where('isActive', '==', true)
                    );
                    const testsSnapshot = await getDocs(testsQuery);
                    
                    for (const student of section.students) {
                        const studentEmail = student.email || '';
                        if (!studentEmail) continue;
                        
                        // Get student's completed tests
                        const completedQuery = query(
                            collection(db, 'testResults'),
                            where('studentEmail', '==', studentEmail)
                        );
                        const completedSnapshot = await getDocs(completedQuery);
                        
                        // Map of testId -> best result
                        const completedTests = new Map();
                        completedSnapshot.forEach(doc => {
                            const data = doc.data();
                            const testId = data.testId;
                            const score = data.score || calculateTestScore(data.testName, data.result, data.testTarget);
                            
                            if (!completedTests.has(testId) || score > completedTests.get(testId).score) {
                                completedTests.set(testId, {
                                    score: score,
                                    result: data.result,
                                    resultId: doc.id,
                                    submittedAt: data.submittedAt,
                                    status: data.status
                                });
                            }
                        });
                        
                        // Check for overdue tests
                        testsSnapshot.forEach(testDoc => {
                            const test = { id: testDoc.id, ...testDoc.data() };
                            
                            let deadlineDateTime = new Date(test.deadline);
                            if (test.deadlineTime) {
                                const [hours, minutes] = test.deadlineTime.split(':').map(Number);
                                deadlineDateTime.setHours(hours, minutes, 0, 0);
                            } else {
                                deadlineDateTime.setHours(23, 59, 59, 999);
                            }
                            
                            // If test is overdue
                            if (deadlineDateTime < now) {
                                const completedData = completedTests.get(test.id);
                                
                                window.overdueStudents.push({
                                    studentName: student.name || 'Unknown',
                                    studentEmail: studentEmail,
                                    studentId: student.student_id || student.studentId || 'N/A',
                                    section: section.name,
                                    testId: test.id,
                                    testName: test.testName,
                                    testTarget: test.testTarget || 0,
                                    testUnit: test.testUnit || '',
                                    deadline: deadlineDateTime,
                                    deadlineString: formatDeadline(test.deadline, test.deadlineTime),
                                    hasCompleted: !!completedData,
                                    currentScore: completedData?.score || 0,
                                    currentResult: completedData?.result || '',
                                    resultId: completedData?.resultId || null,
                                    status: completedData?.status || 'not-started'
                                });
                            }
                        });
                    }
                }
                
                console.log(`Found ${window.overdueStudents.length} overdue test instances`);
                document.getElementById('overdueCount').textContent = window.overdueStudents.length;
                document.getElementById('allStudentsCount').textContent = window.students.length;
                
                window.filteredOverdueStudents = [...window.overdueStudents];
                renderOverdueTable();
                
            } catch (error) {
                console.error('Error loading overdue students:', error);
            }
        }

function formatDeadline(deadline, deadlineTime) {
    if (!deadline) return 'No deadline';
    const date = new Date(deadline);
    const dateText = date.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric', 
        year: 'numeric' 
    });
    let timeText = '';
    if (deadlineTime) {
        const [hours, minutes] = deadlineTime.split(':').map(Number);
        const period = hours >= 12 ? 'PM' : 'AM';
        const hour12 = hours % 12 || 12;
        timeText = ` ${hour12}:${minutes.toString().padStart(2, '0')} ${period}`;
    }
    return dateText + timeText;
}

// Render overdue table
function renderOverdueTable() {
    const tableBody = document.getElementById('overdueTableBody');
    
    if (window.filteredOverdueStudents.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="5">
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <div class="empty-title">No Overdue Tests</div>
                        <div class="empty-text">All students are up to date with their tests!</div>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    const enabledTestsPromise = getDocs(query(
        collection(db, 'testPermissions'),
        where('grantedBy', '==', window.currentUser.email)
    ));
    
    enabledTestsPromise.then(permissionsSnapshot => {
        const enabledTests = new Map();
        permissionsSnapshot.forEach(doc => {
            const perm = doc.data();
            const key = `${perm.studentEmail}_${perm.testId}`;
            enabledTests.set(key, {
                id: doc.id,
                grantedAt: perm.grantedAt,
                grantedByName: perm.grantedByName
            });
        });
        
        let html = '';
        window.filteredOverdueStudents.forEach(item => {
            const key = `${item.studentEmail}_${item.testId}`;
            const isEnabled = enabledTests.has(key);
            const hasCompleted = item.hasCompleted;
            const statusColor = hasCompleted ? 'text-green-600' : 'text-red-600';
            
            html += `
                <tr style="${hasCompleted ? 'background-color: #f0fdf4;' : ''}">
                    <td>
                        <strong>${item.studentName}</strong><br>
                        <small style="color: #64748b;">${item.studentId}</small>
                    </td>
                    <td>${item.section}</td>
                    <td>
                        <strong style="color: ${hasCompleted ? '#10b981' : '#ef4444'};">${item.testName}</strong>
                        ${isEnabled ? '<br><small style="color: #3b82f6;"> Enabled by you</small>' : ''}
                        ${hasCompleted ? `<br><small class="${statusColor}"> Completed (Score: ${item.currentScore.toFixed(1)})</small>` : ''}
                    </td>
                    <td><small style="color: #64748b;">${item.deadlineString}</small></td>
                    <td>
                        <div class="action-buttons">
                            ${!hasCompleted && !isEnabled ? `
                                <button class="btn-action btn-view" onclick="enableOverdueTest('${item.studentEmail}', '${item.testId}', '${item.testName}')">
                                    <i class="fas fa-unlock"></i> Enable Test
                                </button>
                            ` : ''}
                            ${!hasCompleted && isEnabled ? `
                                <button class="btn-action" style="background: #3b82f6; color: white;" disabled>
                                    <i class="fas fa-check-circle"></i> Enabled - Waiting
                                </button>
                            ` : ''}
                            <button class="btn-action btn-attempt" onclick="setOverdueScore('${item.studentEmail}', '${item.testId}', '${item.testName}', ${item.testTarget}, '${item.testUnit}', '${item.studentName}', ${hasCompleted ? item.currentScore : 0}, '${hasCompleted ? item.currentResult : ''}', '${item.resultId || ''}')">
                                <i class="fas fa-edit"></i> ${hasCompleted ? 'Edit' : 'Set'} Score
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        tableBody.innerHTML = html;
    });
}

// Filter overdue students
window.filterOverdueStudents = function() {
    const searchTerm = document.getElementById('searchOverdue').value.toLowerCase();
    const sectionFilter = document.getElementById('filterOverdueSection').value;
    
    window.filteredOverdueStudents = window.overdueStudents.filter(item => {
        const matchesSearch = !searchTerm ||
            item.studentName.toLowerCase().includes(searchTerm) ||
            item.testName.toLowerCase().includes(searchTerm) ||
            item.studentId.toLowerCase().includes(searchTerm);
        
        const matchesSection = !sectionFilter || item.section === sectionFilter;
        
        return matchesSearch && matchesSection;
    });
    
    renderOverdueTable();
};

    // Enable overdue test for specific student
    window.enableOverdueTest = async function(studentEmail, testId, testName) {
        if (!confirm(`Enable "${testName}" for this student? They will be able to take this test even though it's overdue.`)) {
            return;
        }
        
        try {
            // Check if permission already exists
            const existingPermissionQuery = query(
                collection(db, 'testPermissions'),
                where('studentEmail', '==', studentEmail),
                where('testId', '==', testId)
            );
            const existingSnapshot = await getDocs(existingPermissionQuery);
            
            if (!existingSnapshot.empty) {
                alert(' This test is already enabled for this student!');
                return;
            }
            
            // Create a special permission record
            await addDoc(collection(db, 'testPermissions'), {
                studentEmail: studentEmail,
                testId: testId,
                testName: testName,
                grantedBy: window.currentUser.email,
                grantedByName: window.currentUser.displayName || window.currentUser.email,
                grantedAt: serverTimestamp(),
                reason: 'Overdue test enabled by professor',
                status: 'active'
            });
            
            alert(' Test enabled successfully! Student can now take this test.\n\nNote: This will appear in "My Test Schedule" on Add Activities page.');
            await loadOverdueStudents();
            
        } catch (error) {
            console.error('Error enabling test:', error);
            alert('Error: ' + error.message);
        }
    };
            window.setOverdueScore = function(studentEmail, testId, testName, testTarget, testUnit, studentName, currentScore = 0, currentResult = '', resultId = '') {
    // Open the modal with existing data
    window.openEditScoreModal(studentEmail, testId, testName, testTarget, testUnit, studentName, currentScore, currentResult, resultId);
};
window.openEditScoreModal = function(studentEmail, testId, testName, testTarget, testUnit, studentName, currentScore = 0, currentResult = '', resultId = '') {
    console.log(' Opening edit score modal for:', studentName);
    
    editScoreData = {
        studentEmail: studentEmail,
        testId: testId,
        testName: testName,
        testTarget: testTarget || 0,
        testUnit: testUnit || '',
        studentName: studentName,
        resultId: resultId || '',
        currentScore: currentScore,
        currentResult: currentResult
    };

    // Update modal content
    document.getElementById('editScoreTestName').textContent = testName;
    document.getElementById('editScoreTarget').textContent = `${testTarget} ${testUnit}`;
    document.getElementById('editScoreStudent').textContent = studentName;

    // Display current score
    document.getElementById('currentScoreDisplay').textContent = currentScore > 0 ? currentScore.toFixed(1) : 'No score';
    
    // Display current result
    let resultDisplay = 'No result';
    if (currentResult) {
        if (typeof currentResult === 'string') {
            resultDisplay = currentResult;
        } else if (typeof currentResult === 'number') {
            resultDisplay = `${currentResult} ${testUnit}`;
        } else if (typeof currentResult === 'object') {
            const numValue = currentResult.repetitions || currentResult.time || currentResult.distance || currentResult.value || 0;
            resultDisplay = `${numValue} ${testUnit}`;
        }
    }
    document.getElementById('currentResultDisplay').textContent = resultDisplay;

    // Reset to step 1
    currentStep = 1;
    const newResultInput = document.getElementById('newResult');
    const formHint = document.getElementById('resultHint');
    
    if (newResultInput) {
        newResultInput.value = '';
        newResultInput.classList.remove('border-red-500');
        
        if (formHint) {
            formHint.classList.remove('text-red-600');
            formHint.textContent = 'Enter what the student achieved in this test';
        }
        
        // Set input constraints based on test type
        const testNameLower = testName.toLowerCase();
        if (testNameLower.includes('push-up') || testNameLower.includes('pushup') || 
            testNameLower.includes('sit-up') || testNameLower.includes('situp') ||
            testNameLower.includes('curl-up')) {
            newResultInput.type = 'number';
            newResultInput.min = '0';
            newResultInput.max = testTarget.toString();
            newResultInput.step = '1';
            newResultInput.placeholder = `Enter repetitions (0-${testTarget})`;
            if (formHint) {
                formHint.textContent = `Maximum: ${testTarget} repetitions`;
            }
        } else if (testNameLower.includes('plank')) {
            newResultInput.type = 'number';
            newResultInput.min = '0';
            newResultInput.max = testTarget.toString();
            newResultInput.step = '1';
            newResultInput.placeholder = `Enter seconds (0-${testTarget})`;
            if (formHint) {
                formHint.textContent = `Maximum: ${testTarget} seconds`;
            }
        } else if (testNameLower.includes('sit-and-reach')) {
            newResultInput.type = 'number';
            newResultInput.min = '0';
            newResultInput.max = testTarget.toString();
            newResultInput.step = '0.1';
            newResultInput.placeholder = `Enter cm (0-${testTarget})`;
            if (formHint) {
                formHint.textContent = `Maximum: ${testTarget} cm`;
            }
        } else if (testNameLower.includes('grip')) {
            newResultInput.type = 'number';
            newResultInput.min = '0';
            newResultInput.max = testTarget.toString();
            newResultInput.step = '0.1';
            newResultInput.placeholder = `Enter kg (0-${testTarget})`;
            if (formHint) {
                formHint.textContent = `Maximum: ${testTarget} kg`;
            }
        } else {
            newResultInput.type = 'number';
            newResultInput.min = '0';
            newResultInput.placeholder = 'Enter result';
        }
    }
    
    // Hide score preview
    const preview = document.getElementById('scorePreview');
    if (preview) {
        preview.style.display = 'none';
    }
    
    // Update step UI BEFORE showing modal
    updateStepUI();

    // Show modal
    document.getElementById('editScoreModal').style.display = 'flex';
    console.log(' Modal opened successfully');
};
        // Authentication state change handler
        onAuthStateChanged(auth, async (user) => {
            const loadingScreen = document.getElementById('loadingScreen');
            const mainContent = document.getElementById('mainContent');

            if (user) {
                try {
                    console.log('=== STUDENT MANAGEMENT LOADING ===');
                    console.log('Professor authenticated:', user.email);
                    
                    window.currentUser = user;
                    
                    // Load sections and students
                    await loadSections();
                    await loadStudents();
                    
                    // Setup real-time updates
                    setupRealtimeUpdates();

                    loadingScreen.style.display = 'none';
                    mainContent.style.display = 'block';
                    
                    console.log(' Student management loaded');
                    
                } catch (error) {
                    console.error('Error loading student management:', error);
                    
                    loadingScreen.style.display = 'none';
                    mainContent.style.display = 'block';
                    
                    alert('Error loading data from database. Please check console for details.');
                }
            } else {
                console.log('No user, redirecting to login...');
                window.location.href = '/login/index.html';
            }
        });

            
        // Make functions globally available
        window.viewSectionDetails = viewSectionDetails;
        window.closeViewSectionModal = closeViewSectionModal;
        window.viewStudentDetails = viewStudentDetails;
        window.closeViewStudentModal = closeViewStudentModal;
        window.viewAttemptDetails = viewAttemptDetails;
        window.addNewAttempt = addNewAttempt;
        window.exportStudents = exportStudents;
        window.refreshData = refreshData;
        window.filterSections = filterSections;
        window.filterStudents = filterStudents;
        window.previousPage = previousPage;
        window.nextPage = nextPage;
        window.signOut = signOut;
    </script>
    
    <script>
        async function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await window.signOut(window.auth);
                    const baseUrl = window.location.origin;
                    window.location.href = baseUrl + '/login/index.html';
                } catch (error) {
                    console.error('Error logging out:', error);
                    alert('Error logging out. Please try again.');
                }
            }
        }
         // Edit Score Modal Functions
        let currentStep = 1;
        let editScoreData = {
            studentEmail: '',
            testId: '',
            testName: '',
            testTarget: 0,
            testUnit: '',
            studentResult: 0,
            calculatedScore: 0,
            finalScore: 0,
            notes: ''
        };

        window.openEditScoreModal = function(studentEmail, testId, testName, testTarget, testUnit, studentName, currentScore = 0, currentResult = '', resultId = '') {
    editScoreData = {
        studentEmail: studentEmail,
        testId: testId,
        testName: testName,
        testTarget: testTarget || 0,
        testUnit: testUnit || '',
        studentName: studentName,
        resultId: resultId || '',
        currentScore: currentScore,
        currentResult: currentResult
    };

    // Update modal content
    document.getElementById('editScoreTestName').textContent = testName;
    document.getElementById('editScoreTarget').textContent = `${testTarget} ${testUnit}`;
    document.getElementById('editScoreStudent').textContent = studentName;

    // Display current score
    document.getElementById('currentScoreDisplay').textContent = currentScore > 0 ? currentScore.toFixed(1) : 'No score';
    
    // Display current result
    let resultDisplay = 'No result';
    if (currentResult) {
        if (typeof currentResult === 'string') {
            resultDisplay = currentResult;
        } else if (typeof currentResult === 'number') {
            resultDisplay = `${currentResult} ${testUnit}`;
        } else if (typeof currentResult === 'object') {
            const numValue = currentResult.repetitions || currentResult.time || currentResult.distance || currentResult.value || 0;
            resultDisplay = `${numValue} ${testUnit}`;
        }
    }
    document.getElementById('currentResultDisplay').textContent = resultDisplay;

    // Reset to step 1
    currentStep = 1;
    document.getElementById('newScore').value = '';
    document.getElementById('scorePreview').style.display = 'none';
    
    updateStepUI();

    // Show modal
    document.getElementById('editScoreModal').style.display = 'flex';
};

        // Close modal
        window.closeEditScoreModal = function() {
            document.getElementById('editScoreModal').style.display = 'none';
        };

        // Next step
       window.nextStep = function() {
    if (currentStep === 1) {
        currentStep = 2;
        updateStepUI();
    }
};
          
        document.addEventListener('DOMContentLoaded', function() {
    const newResultInput = document.getElementById('newResult');
    if (newResultInput) {
        newResultInput.addEventListener('input', function() {
            const result = parseFloat(this.value);
            const preview = document.getElementById('scorePreview');
            const previewValue = document.getElementById('previewScore');
            
            if (!isNaN(result) && result >= 0) {
                // Calculate score based on result
                const calculatedScore = calculateScoreFromResult(
                    editScoreData.testName,
                    result,
                    editScoreData.testTarget
                );
                
                if (calculatedScore > 0) {
                    preview.style.display = 'block';
                    previewValue.textContent = calculatedScore.toFixed(1);
                } else {
                    preview.style.display = 'none';
                }
            } else {
                preview.style.display = 'none';
            }
        });
    }
});
function calculateScore(testName, result, testTarget = null) {
    const normalized = testName.toLowerCase().trim();
    
    //  CRITICAL: Check if this is a professor override with pre-calculated score
    if (result && typeof result === 'object' && result !== null) {
        // If professor already set a final score, use it directly
        if (result.score !== undefined && result.score !== null) {
            const score = parseFloat(result.score);
            if (!isNaN(score) && score >= 0 && score <= 100) {
                console.log(` Using stored professor score: ${score} for ${testName}`);
                return score;
            }
        }
    }
    
    // Extract numeric value from result
    let numericValue = 0;
    
    if (typeof result === 'object' && result !== null) {
        numericValue = result.repetitions || result.time || result.distance || 
                      result.value || result.result || result.count || 
                      result.score || 0;
    } else if (typeof result === 'string') {
        const match = result.match(/(\d+\.?\d*)/);
        if (match) {
            numericValue = parseFloat(match[1]);
        } else {
            numericValue = parseFloat(result) || 0;
        }
    } else {
        numericValue = parseFloat(result) || 0;
    }
    
    console.log(` Calculating: ${testName} | Value: ${numericValue} | Target: ${testTarget}`);
    
    // Use test target if available - THIS IS THE KEY SECTION
    if (testTarget && testTarget > 0) {
        // REPETITION TESTS (push-ups, sit-ups, curl-ups)
        if (normalized.includes('push-up') || normalized.includes('pushup') || 
            normalized.includes('sit-up') || normalized.includes('situp') ||
            normalized.includes('curl-up')) {
            
            const reps = numericValue;
            if (reps >= testTarget) return 100;
            
            const percentage = (reps / testTarget) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            // Apply grading scale
            if (percentage >= 100) score = 100;
            else if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            return Math.round(score);
        }
        
        // PLANK (time-based in seconds)
        if (normalized.includes('plank')) {
            let seconds = numericValue;
            if (seconds >= testTarget) return 100;
            
            const percentage = (seconds / testTarget) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 100) score = 100;
            else if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            return Math.round(score);
        }
        
        // SIT-AND-REACH (flexibility in cm)
        if (normalized.includes('sit-and-reach')) {
            const distance = numericValue;
            if (distance >= testTarget) return 100;
            
            const percentage = (distance / testTarget) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 100) score = 100;
            else if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            return Math.round(score);
        }
        
        // GRIP STRENGTH (kg)
        if (normalized.includes('grip')) {
            if (numericValue >= testTarget) return 100;
            
            const percentage = (numericValue / testTarget) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            return Math.round(score);
        }
        
        // 1-MILE RUN (seconds - LOWER IS BETTER)
        if (normalized.includes('mile') || normalized.includes('run')) {
            if (numericValue <= testTarget) return 100;
            
            const percentage = (testTarget / numericValue) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            return Math.round(score);
        }
        
        // STEP TEST (heart rate - LOWER IS BETTER)
        if (normalized.includes('step test') || normalized.includes('3-minute')) {
            if (numericValue <= testTarget) return 100;
            
            const percentage = (testTarget / numericValue) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            return Math.round(score);
        }
    }
    
    // Fallback to default scoring if no target set
   function calculateDefaultScore(testName, value) {
    const normalized = testName.toLowerCase();
    
    if (normalized.includes('push-up') || normalized.includes('pushup')) {
        const reps = value;
        if (reps >= 40) return 100;
        if (reps >= 35) return 95;
        if (reps >= 30) return 90;
        if (reps >= 25) return 85;
        if (reps >= 20) return 80;
        if (reps >= 15) return 75;
        if (reps >= 10) return 70;
        if (reps >= 5) return 65;
        return 60;
    }
    
    if (normalized.includes('sit-up') || normalized.includes('situp') || 
        normalized.includes('curl-up')) {
        const reps = value;
        if (reps >= 50) return 100;
        if (reps >= 45) return 95;
        if (reps >= 40) return 90;
        if (reps >= 35) return 85;
        if (reps >= 30) return 80;
        if (reps >= 25) return 75;
        if (reps >= 20) return 70;
        if (reps >= 15) return 65;
        return 60;
    }
    
    if (normalized.includes('plank')) {
        let seconds = value;
        if (seconds >= 180) return 100;
        if (seconds >= 150) return 95;
        if (seconds >= 120) return 90;
        if (seconds >= 100) return 85;
        if (seconds >= 80) return 80;
        if (seconds >= 60) return 75;
        if (seconds >= 45) return 70;
        if (seconds >= 30) return 65;
        return 60;
    }
    
    if (normalized.includes('grip')) {
        if (value >= 60) return 100;
        if (value >= 55) return 95;
        if (value >= 50) return 90;
        if (value >= 45) return 85;
        if (value >= 40) return 80;
        if (value >= 35) return 75;
        if (value >= 30) return 70;
        return 65;
    }
    
    if (normalized.includes('sit-and-reach')) {
        const distance = value;
        if (distance >= 25) return 100;
        if (distance >= 20) return 95;
        if (distance >= 15) return 90;
        if (distance >= 10) return 85;
        if (distance >= 5) return 80;
        if (distance >= 0) return 75;
        if (distance >= -5) return 70;
        return 65;
    }
    
    if (normalized.includes('mile') || normalized.includes('run')) {
        if (value <= 420) return 100; // 7 minutes
        if (value <= 480) return 95;  // 8 minutes
        if (value <= 540) return 90;  // 9 minutes
        if (value <= 600) return 85;  // 10 minutes
        if (value <= 660) return 80;  // 11 minutes
        if (value <= 720) return 75;  // 12 minutes
        return 70;
    }
    
    if (normalized.includes('step test') || normalized.includes('3-minute')) {
        const heartRate = value;
        if (heartRate <= 70) return 100;
        if (heartRate <= 80) return 95;
        if (heartRate <= 90) return 90;
        if (heartRate <= 100) return 85;
        if (heartRate <= 110) return 80;
        if (heartRate <= 120) return 75;
        if (heartRate <= 130) return 70;
        return 65;
    }
    
    if (normalized.includes('bmi')) {
        const bmi = value;
        if (bmi >= 18.5 && bmi <= 24.9) return 100;
        if (bmi >= 17.0 && bmi < 18.5) return 85;
        if (bmi >= 25.0 && bmi < 27.0) return 85;
        if (bmi >= 16.0 && bmi < 17.0) return 70;
        if (bmi >= 27.0 && bmi < 30.0) return 70;
        return 60;
    }
    
    return 75; // Default score
    }
}

        // Update step UI
        function updateStepUI() {
    console.log(' Updating step UI, current step:', currentStep);
    
    // Update step indicators
    for (let i = 1; i <= 2; i++) {
        const step = document.getElementById('step' + i);
        const stepContent = document.getElementById('stepContent' + i);
        
        if (!step || !stepContent) {
            console.error(' Step element not found:', i);
            continue;
        }
        
        if (i < currentStep) {
            step.classList.add('completed');
            step.classList.remove('active');
            stepContent.style.display = 'none';
        } else if (i === currentStep) {
            step.classList.add('active');
            step.classList.remove('completed');
            stepContent.style.display = 'block';
        } else {
            step.classList.remove('active', 'completed');
            stepContent.style.display = 'none';
        }
    }
    
    // Update buttons
    const btnNext = document.getElementById('btnNext');
    const btnSubmit = document.getElementById('btnSubmit');
    
    if (!btnNext || !btnSubmit) {
        console.error(' Button elements not found');
        return;
    }
    
    if (currentStep === 2) {
        btnNext.style.display = 'none';
        btnSubmit.style.display = 'inline-flex';
    } else {
        btnNext.style.display = 'inline-flex';
        btnSubmit.style.display = 'none';
    }
    
    console.log(' Step UI updated');
}

       window.submitScore = async function() {
    const newResult = parseFloat(document.getElementById('newResult').value);
    
    if (isNaN(newResult) || newResult < 0) {
        alert('Please enter a valid result');
        return;
    }
    
    //  NEW VALIDATION: Check if result exceeds target
    const testTarget = editScoreData.testTarget;
    if (testTarget && testTarget > 0) {
        const testName = editScoreData.testName.toLowerCase();
        
        // For repetition-based tests (push-ups, sit-ups, curl-ups)
        if (testName.includes('push-up') || testName.includes('pushup') || 
            testName.includes('sit-up') || testName.includes('situp') ||
            testName.includes('curl-up')) {
            if (newResult > testTarget) {
                alert(` Error: Maximum repetitions for this test is ${testTarget}. Please enter a value between 0 and ${testTarget}.`);
                return;
            }
        }
        
        // For time-based tests (plank)
        else if (testName.includes('plank')) {
            if (newResult > testTarget) {
                alert(` Error: Maximum time for this test is ${testTarget} seconds. Please enter a value between 0 and ${testTarget}.`);
                return;
            }
        }
        
        // For flexibility tests (sit-and-reach)
        else if (testName.includes('sit-and-reach')) {
            if (newResult > testTarget) {
                alert(` Error: Maximum distance for this test is ${testTarget} cm. Please enter a value between 0 and ${testTarget}.`);
                return;
            }
        }
        
        // For grip strength
        else if (testName.includes('grip')) {
            if (newResult > testTarget) {
                alert(` Error: Maximum grip strength for this test is ${testTarget} kg. Please enter a value between 0 and ${testTarget}.`);
                return;
            }
        }
        
        // For running tests (lower is better - no upper limit needed)
        // For step test (lower heart rate is better - no upper limit needed)
    }
    
    try {
        const submitBtn = document.getElementById('btnSubmit');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
        }
        
        // Calculate the score using the same logic as studentgrades.html
        const calculatedScore = calculateScore(
            editScoreData.testName,
            newResult,
            editScoreData.testTarget
        );
        
        const finalScore = Math.max(0, Math.min(100, Math.round(calculatedScore)));
        const now = new Date();
        
        const resultData = {
            studentEmail: editScoreData.studentEmail,
            testId: editScoreData.testId,
            testName: editScoreData.testName,
            result: `${newResult} ${editScoreData.testUnit}`,
            rawResult: newResult,
            resultData: {
                value: newResult,
                unit: editScoreData.testUnit
            },
            score: finalScore,
            testTarget: editScoreData.testTarget,
            testUnit: editScoreData.testUnit,
            status: 'completed',
            submittedAt: now,
            isProfessorOverride: true,
            setByProfessor: true,
            overriddenBy: window.currentUser?.email || '',
            overriddenByName: window.currentUser?.displayName || window.currentUser?.email || 'Professor',
            overriddenAt: now
        };
        
        console.log(' Saving score:', finalScore, 'for', editScoreData.testName);
        
        // Save to Firestore
        if (editScoreData.resultId) {
            await updateDoc(doc(window.db, 'testResults', editScoreData.resultId), resultData);
        } else {
            await addDoc(collection(window.db, 'testResults'), resultData);
        }
        
        alert(` Score saved: ${finalScore}/100`);
        closeEditScoreModal();
        
        // Refresh data
        if (window.loadOverdueStudents) await window.loadOverdueStudents();
        if (window.loadStudents) await window.loadStudents();
        
    } catch (error) {
        console.error(' Error saving score:', error);
        alert('Error: ' + error.message);
        
        const submitBtn = document.getElementById('btnSubmit');
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<span></span> Save Score';
        }
    }
};
        document.addEventListener('DOMContentLoaded', function() {
    const newResultInput = document.getElementById('newResult');
    const formHint = document.getElementById('resultHint');
    
    if (newResultInput) {
        newResultInput.addEventListener('input', function() {
            const result = parseFloat(this.value);
            const preview = document.getElementById('scorePreview');
            const previewValue = document.getElementById('previewScore');
            
            // Clear any previous error styling
            this.classList.remove('border-red-500');
            if (formHint) {
                formHint.classList.remove('text-red-600');
                formHint.textContent = 'Enter what the student achieved in this test';
            }
            
            if (!isNaN(result) && result >= 0) {
                // Validate against target
                const testTarget = editScoreData.testTarget;
                if (testTarget && testTarget > 0) {
                    const testName = editScoreData.testName.toLowerCase();
                    
                    // Check if result exceeds target for specific test types
                    let exceedsLimit = false;
                    let maxMessage = '';
                    
                    if (testName.includes('push-up') || testName.includes('pushup') || 
                        testName.includes('sit-up') || testName.includes('situp') ||
                        testName.includes('curl-up')) {
                        exceedsLimit = result > testTarget;
                        maxMessage = `Maximum: ${testTarget} repetitions`;
                    } else if (testName.includes('plank')) {
                        exceedsLimit = result > testTarget;
                        maxMessage = `Maximum: ${testTarget} seconds`;
                    } else if (testName.includes('sit-and-reach')) {
                        exceedsLimit = result > testTarget;
                        maxMessage = `Maximum: ${testTarget} cm`;
                    } else if (testName.includes('grip')) {
                        exceedsLimit = result > testTarget;
                        maxMessage = `Maximum: ${testTarget} kg`;
                    }
                    
                    if (exceedsLimit) {
                        // Show error styling
                        this.classList.add('border-red-500');
                        if (formHint) {
                            formHint.classList.add('text-red-600');
                            formHint.textContent = ` ${maxMessage}`;
                        }
                        preview.style.display = 'none';
                        return;
                    }
                }
                
                // Calculate score if within limits
                const calculatedScore = calculateScore(
                    editScoreData.testName,
                    result,
                    editScoreData.testTarget
                );
                
                const finalScore = Math.max(0, Math.min(100, Math.round(calculatedScore)));
                
                if (!isNaN(finalScore)) {
                    preview.style.display = 'block';
                    previewValue.textContent = finalScore.toFixed(1);
                    
                    // Show grade letter
                    const gradeText = document.querySelector('.score-preview-text');
                    if (gradeText) {
                        gradeText.innerHTML = `Based on the result entered<br>Grade: ${getGradeLetter(finalScore)}`;
                    }
                } else {
                    preview.style.display = 'none';
                }
            } else {
                preview.style.display = 'none';
            }
        });
    }
});
    </script>
</body>
</html>