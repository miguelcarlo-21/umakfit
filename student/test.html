<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UMakFit - Fitness Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Manrope:wght@600;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .font-manrope { font-family: 'Manrope', sans-serif; }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .slide-down {
            animation: slideDown 0.3s ease;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .spinner {
            border: 4px solid #e5e7eb;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #2563eb;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white/98 flex flex-col items-center justify-center z-50">
        <div class="spinner"></div>
        <div class="mt-5 text-gray-600 font-medium text-sm md:text-base">Loading Tests...</div>
    </div>

    <div id="mainContent" class="hidden">
        <!-- Navigation -->
        <nav class="bg-gradient-to-r from-blue-900 to-blue-500 shadow-lg">
            <div class="container mx-auto px-3 sm:px-4 py-4 sm:py-5">
                <div class="flex flex-wrap items-center justify-between gap-3 sm:gap-4">
                    <!-- Logo -->
                    <a href="#" class="flex items-center gap-2 sm:gap-3">
                        <img src="https://c.animaapp.com/vkhEa8zW/img/screenshot-2025-09-19-2-53-51-pm-removebg-preview-3@2x.png" 
                             alt="UMak Logo" class="h-12 sm:h-14 md:h-16 w-auto object-contain">
                        <span class="text-xl sm:text-2xl md:text-3xl font-extrabold font-manrope bg-gradient-to-r from-yellow-400 to-yellow-200 bg-clip-text text-transparent">
                            UMakFit
                        </span>
                    </a>
                    
                    <!-- Desktop Navigation -->
                    <div class="hidden lg:flex items-center gap-2 flex-wrap">
                        <a href="./studentDashboard.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="bi bi-speedometer2"></i> 
                            <span class="hidden xl:inline">Dashboard</span>
                        </a>
                        <a href="#" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white text-gray-900 rounded-lg font-semibold text-sm flex items-center gap-2 shadow-sm hover:shadow-md hover:-translate-y-0.5 transition-all">
                            <i class="bi bi-clipboard-check"></i> 
                            <span class="hidden xl:inline">Test</span>
                        </a>
                        <a href="./studentlesson.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="bi bi-book"></i> 
                            <span class="hidden xl:inline">Lesson</span>
                        </a>
                       <a href="./studentgrades.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="bi bi-award"></i> 
                            <span class="hidden xl:inline">Grades</span>
                        </a>
                        <a href="./progress.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="bi bi-graph-up"></i> 
                            <span class="hidden xl:inline">Progress</span>
                        </a>
                        <a href="#" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="bi bi-book"></i> 
                            <span class="hidden xl:inline">Learn</span>
                        </a>
                            <!-- Notification Bell -->
                        <div class="relative">
                            <button id="notificationBellBtn" 
                                    class="w-9 h-9 xl:w-10 xl:h-10 bg-white/20 border-2 border-white/30 rounded-full flex items-center justify-center text-white hover:bg-white/30 hover:scale-110 transition-all">
                                <i class="bi bi-bell-fill text-base xl:text-lg"></i>
                                <span id="navNotificationCount" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold px-1.5 py-0.5 rounded-full min-w-[18px] h-4.5 flex items-center justify-center">0</span>
                            </button>
                            
                            <!-- Notification Dropdown -->
                            <div id="notificationDropdown" class="hidden absolute right-0 mt-2 w-96 max-w-[calc(100vw-2rem)] bg-white rounded-xl shadow-2xl z-[9999] max-h-[480px] overflow-y-auto">
                                <div class="p-4 border-b-2 border-gray-200 bg-gradient-to-r from-gray-50 to-white flex justify-between items-center rounded-t-xl sticky top-0 z-10">
                                    <h6 class="font-bold text-gray-900 text-base flex items-center gap-2">
                                        <i class="bi bi-bell-fill text-blue-500"></i> Notifications
                                    </h6>
                                    <button onclick="closeNotificationDropdown()" class="text-gray-400 hover:text-gray-600 p-1">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                                <div id="notificationDropdownBody" class="max-h-96 overflow-y-auto">
                                    <div class="p-8 text-center text-gray-400">
                                        <i class="bi bi-bell-slash text-5xl mb-3 block"></i>
                                        <p class="text-gray-600">No notifications yet</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Profile Dropdown -->
                        <div class="relative">
                            <img src="" alt="Profile" id="profilePictureBtn" onclick="toggleProfileDropdown()"
                                 class="w-9 h-9 xl:w-10 xl:h-10 rounded-full border-2 border-white/30 cursor-pointer hover:border-white/60 hover:scale-105 transition-all object-cover">
                            
                            <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-64 sm:w-72 bg-white rounded-xl shadow-2xl z-[9999] slide-down">
                                <div class="p-4 sm:p-6 border-b-2 border-gray-200 text-center">
                                    <img src="" alt="Profile" id="profileDropdownPicture" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full mx-auto mb-2 sm:mb-3 border-3 border-blue-500 object-cover">
                                    <h6 id="profileDropdownName" class="font-bold text-gray-900 text-base sm:text-lg">Loading...</h6>
                                    <p id="profileDropdownEmail" class="text-xs sm:text-sm text-gray-500 mt-1 truncate px-2">Loading...</p>
                                </div>
                                <div class="p-2">
                                    <a href="./studentProfile.html" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-gray-100 transition-colors">
                                        <i class="bi bi-person-circle text-blue-500 text-lg sm:text-xl"></i>
                                        <span class="font-medium text-gray-700 text-sm sm:text-base">View Profile</span>
                                    </a>
                                    <div class="h-px bg-gray-200 my-1 sm:my-2"></div>
                                    <div onclick="handleLogout()" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-red-50 transition-colors cursor-pointer text-red-500">
                                        <i class="bi bi-box-arrow-right text-lg sm:text-xl"></i>
                                        <span class="font-medium text-sm sm:text-base">Logout</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mobile Right Icons -->
                    <div class="flex lg:hidden items-center gap-2 sm:gap-3">
                        <!-- Mobile Profile -->
                        <div class="relative">
                            <img src="" alt="Profile" id="profilePictureBtnMobile" onclick="toggleProfileDropdown()"
                                 class="w-9 h-9 sm:w-10 sm:h-10 rounded-full border-2 border-white/30 cursor-pointer hover:border-white/60 object-cover">
                            
                            <!-- Mobile Profile Dropdown -->
                            <div id="profileDropdownMobile" class="hidden fixed right-2 top-20 w-64 sm:w-72 bg-white rounded-xl shadow-2xl z-[9999] slide-down">
                                <div class="p-4 sm:p-6 border-b-2 border-gray-200 text-center">
                                    <img src="" alt="Profile" id="profileDropdownPictureMobile" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full mx-auto mb-2 sm:mb-3 border-3 border-blue-500 object-cover">
                                    <h6 id="profileDropdownNameMobile" class="font-bold text-gray-900 text-base sm:text-lg">Loading...</h6>
                                    <p id="profileDropdownEmailMobile" class="text-xs sm:text-sm text-gray-500 mt-1 truncate px-2">Loading...</p>
                                </div>
                                <div class="p-2">
                                    <a href="./studentProfile.html" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-gray-100 transition-colors">
                                        <i class="bi bi-person-circle text-blue-500 text-lg sm:text-xl"></i>
                                        <span class="font-medium text-gray-700 text-sm sm:text-base">View Profile</span>
                                    </a>
                                    <div class="h-px bg-gray-200 my-1 sm:my-2"></div>
                                    <div onclick="handleLogout()" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-red-50 transition-colors cursor-pointer text-red-500">
                                        <i class="bi bi-box-arrow-right text-lg sm:text-xl"></i>
                                        <span class="font-medium text-sm sm:text-base">Logout</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mobile Menu Button -->
                        <button onclick="toggleMobileMenu()" class="text-white p-1 sm:p-2">
                            <i class="bi bi-list text-2xl sm:text-3xl"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Mobile Navigation Menu -->
                <div id="mobileMenu" class="hidden lg:hidden mt-3 sm:mt-4 space-y-2">
                    <a href="./studentDashboard.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                        <i class="bi bi-speedometer2 mr-2"></i> Dashboard
                    </a>
                    <a href="#" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white text-gray-900 rounded-lg font-semibold text-sm">
                        <i class="bi bi-clipboard-check mr-2"></i> Tests
                    </a>
                    <a href="./progress.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                        <i class="bi bi-graph-up mr-2"></i> Progress
                    </a>
                    <a href="./studentlesson.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                        <i class="bi bi-book mr-2"></i> Lesson
                    </a>
                    <a href="./studentgrades.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                        <i class="bi bi-book mr-2"></i> Grade
                    </a>
                    <a href="#" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                        <i class="bi bi-book mr-2"></i> Learn
                    </a>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container mx-auto px-3 sm:px-4 lg:px-6 py-4 sm:py-6 lg:py-8 max-w-7xl">
            <!-- Page Title -->
            <div class="relative mb-6 sm:mb-8">
                <div class="absolute left-0 top-0 w-1 h-full bg-gradient-to-b from-blue-900 to-blue-500 rounded-r"></div>
                <h1 class="pl-4 sm:pl-6 text-2xl sm:text-3xl lg:text-4xl font-bold text-blue-900">Fitness Assessment Test</h1>
            </div>

            <!-- Stats Banner -->
            <div class="bg-white rounded-xl sm:rounded-2xl p-4 sm:p-6 lg:p-8 mb-6 sm:mb-8 shadow-md border border-gray-200">
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 lg:gap-6">
                    <div class="relative bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4 sm:p-6 text-center border-2 border-blue-200 hover:-translate-y-1 transition-transform overflow-hidden">
                        <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-blue-500 to-blue-600"></div>
                        <div id="testsDone" class="text-3xl sm:text-4xl lg:text-5xl font-extrabold text-blue-900 mb-1 sm:mb-2">0</div>
                        <div class="text-[10px] sm:text-xs font-semibold uppercase tracking-wider text-gray-600">Tests Completed</div>
                    </div>
                    <div class="relative bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4 sm:p-6 text-center border-2 border-blue-200 hover:-translate-y-1 transition-transform overflow-hidden">
                        <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-blue-500 to-blue-600"></div>
                        <div id="avgScore" class="text-3xl sm:text-4xl lg:text-5xl font-extrabold text-blue-900 mb-1 sm:mb-2">0</div>
                        <div class="text-[10px] sm:text-xs font-semibold uppercase tracking-wider text-gray-600">Average Score</div>
                    </div>
                    <div class="relative bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4 sm:p-6 text-center border-2 border-blue-200 hover:-translate-y-1 transition-transform overflow-hidden">
                        <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-blue-500 to-blue-600"></div>
                        <div id="bestScore" class="text-3xl sm:text-4xl lg:text-5xl font-extrabold text-blue-900 mb-1 sm:mb-2">0</div>
                        <div class="text-[10px] sm:text-xs font-semibold uppercase tracking-wider text-gray-600">Best Score</div>
                    </div>
                    <div class="relative bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4 sm:p-6 text-center border-2 border-blue-200 hover:-translate-y-1 transition-transform overflow-hidden">
                        <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-blue-500 to-blue-600"></div>
                        <div id="dayStreak" class="text-3xl sm:text-4xl lg:text-5xl font-extrabold text-blue-900 mb-1 sm:mb-2">0</div>
                        <div class="text-[10px] sm:text-xs font-semibold uppercase tracking-wider text-gray-600">Day Streak</div>
                    </div>
                </div>
            </div>

            <!-- Category Cards Container -->
            <div id="categoryCardsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6 mb-6 sm:mb-8"></div>

            <!-- Recent Test History -->
            <div class="bg-white rounded-xl sm:rounded-2xl p-4 sm:p-6 lg:p-8 shadow-md border border-gray-200">
                <div class="flex items-center gap-3 mb-4 sm:mb-6">
                    <img src="https://c.animaapp.com/HN7hFbsr/img/image-151@2x.png" alt="History Icon" class="w-6 h-6 sm:w-8 sm:h-8" />
                    <h2 class="text-lg sm:text-xl lg:text-2xl font-bold text-gray-900">Recent Test History</h2>
                </div>
                <div id="testHistoryContainer">
                    <div class="text-center py-8 sm:py-12">
                        <div class="text-5xl sm:text-6xl mb-3 sm:mb-4">üìã</div>
                        <p class="text-base sm:text-lg font-semibold text-gray-600 mb-1 sm:mb-2">No Test History Yet</p>
                        <small class="text-sm text-gray-400">Your completed tests will appear here</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAgaLunqEf2gs6dSpF_sz1hV5XQ5Wm52jo",
            authDomain: "umakfit-e3b1d.firebaseapp.com",
            projectId: "umakfit-e3b1d",
            storageBucket: "umakfit-e3b1d.appspot.com",
            messagingSenderId: "276569891504",
            appId: "1:276569891504:web:39b1732b519f4d8b785175"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let studentData = null;
        let availableTests = [];
        let allTestHistory = [];
        let showAllHistory = false;
        const VISIBLE_HISTORY_COUNT = 2;

            const testCategories = {
                'Cardiorespiratory Endurance': {
                    tests: ['3-Minute Step Test', '1-Mile Run', '1 Mile Run'],
                    icon: 'https://c.animaapp.com/HN7hFbsr/img/image-148@2x.png',
                    subtitle: 'Heart and lung fitness tests'
                },
                'Muscular Strength': {
                    tests: ['Push-Up Test', 'Grip Strength'],
                    icon: 'https://c.animaapp.com/HN7hFbsr/img/image-149@2x.png',
                    subtitle: 'Maximum force tests'
                },
                'Muscular Endurance': {
                    tests: ['Curl-Up Test', 'Push-up Test', 'Plank Hold'],
                    icon: 'https://c.animaapp.com/HN7hFbsr/img/image-150@2x.png',
                    subtitle: 'Repeated contractions tests'
                },
                'Flexibility': {
                    tests: ['Sit-and-Reach', 'Shoulder Flexibility'],
                    icon: 'https://c.animaapp.com/HN7hFbsr/img/image-48@2x.png',
                    subtitle: 'Range of motion tests'
                },
                'Body Composition': {
                    tests: ['BMI Assessment', 'Skinfold Caliper Measurements'],
                    icon: 'https://c.animaapp.com/HN7hFbsr/img/image-151@2x.png',
                    subtitle: 'Body fat and mass tests'
                }
            };

        // Mobile menu toggle
        window.toggleMobileMenu = function() {
            const menu = document.getElementById('mobileMenu');
            menu.classList.toggle('hidden');
        };

                window.toggleProfileDropdown = function() {
                    const isMobile = window.innerWidth < 1024;
                    const dropdown = document.getElementById(isMobile ? 'profileDropdownMobile' : 'profileDropdown');
                    const notificationDropdown = document.getElementById('notificationDropdown');
                    
                    // Close notification dropdown when opening profile
                    if (notificationDropdown) {
                        notificationDropdown.classList.add('hidden');
                    }
                    
                    dropdown.classList.toggle('hidden');
                    if (!dropdown.classList.contains('hidden')) {
                        setTimeout(() => {
                            document.addEventListener('click', closeProfileOnClickOutside);
                        }, 100);
                    } else {
                        document.removeEventListener('click', closeProfileOnClickOutside);
                    }
                };

                // Add notification bell click handler
                document.addEventListener('DOMContentLoaded', () => {
                    const notificationBtn = document.getElementById('notificationBellBtn');
                    if (notificationBtn) {
                        notificationBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            toggleNotificationDropdown(e);
                            setTimeout(() => {
                                document.addEventListener('click', closeProfileOnClickOutside);
                            }, 100);
                        });
                    }
                });

        function closeProfileOnClickOutside(event) {
            const isMobile = window.innerWidth < 1024;
            const dropdown = document.getElementById(isMobile ? 'profileDropdownMobile' : 'profileDropdown');
            const notificationDropdown = document.getElementById('notificationDropdown');
            const profileBtn = document.getElementById('profilePictureBtn');
            const profileBtnMobile = document.getElementById('profilePictureBtnMobile');
            const notificationBtn = document.getElementById('notificationBellBtn');
            
            // Close profile dropdown if clicked outside
            if (!dropdown.contains(event.target) && !profileBtn?.contains(event.target) && !profileBtnMobile?.contains(event.target)) {
                dropdown.classList.add('hidden');
            }
            
            // Close notification dropdown if clicked outside
            if (notificationDropdown && !notificationDropdown.contains(event.target) && !notificationBtn?.contains(event.target)) {
                notificationDropdown.classList.add('hidden');
            }
            
            // Remove listener if both are closed
            if (dropdown.classList.contains('hidden') && (!notificationDropdown || notificationDropdown.classList.contains('hidden'))) {
                document.removeEventListener('click', closeProfileOnClickOutside);
            }
        }

        function updateProfileUI() {
            if (!currentUser || !studentData) return;
            
            const photoURL = currentUser?.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(studentData?.displayName || 'User') + '&background=3b82f6&color=fff&size=128';
            
            const profileBtn = document.getElementById('profilePictureBtn');
            const profileBtnMobile = document.getElementById('profilePictureBtnMobile');
            if (profileBtn) profileBtn.src = photoURL;
            if (profileBtnMobile) profileBtnMobile.src = photoURL;
            
            const dropdownPic = document.getElementById('profileDropdownPicture');
            const dropdownPicMobile = document.getElementById('profileDropdownPictureMobile');
            if (dropdownPic) dropdownPic.src = photoURL;
            if (dropdownPicMobile) dropdownPicMobile.src = photoURL;
            
            const dropdownName = document.getElementById('profileDropdownName');
            const dropdownNameMobile = document.getElementById('profileDropdownNameMobile');
            if (dropdownName) dropdownName.textContent = studentData?.displayName || 'Student';
            if (dropdownNameMobile) dropdownNameMobile.textContent = studentData?.displayName || 'Student';
            
            const dropdownEmail = document.getElementById('profileDropdownEmail');
            const dropdownEmailMobile = document.getElementById('profileDropdownEmailMobile');
            if (dropdownEmail) dropdownEmail.textContent = studentData?.email || currentUser?.email || '';
            if (dropdownEmailMobile) dropdownEmailMobile.textContent = studentData?.email || currentUser?.email || '';
        }
                // Toggle notification dropdown
function toggleNotificationDropdown(event) {
    event?.stopPropagation();
    const dropdown = document.getElementById('notificationDropdown');
    
    if (dropdown.classList.contains('hidden')) {
        dropdown.classList.remove('hidden');
        loadNotificationDropdown();
        // Close profile dropdown if open
        const profileDropdown = document.getElementById('profileDropdown');
        const profileDropdownMobile = document.getElementById('profileDropdownMobile');
        if (profileDropdown) profileDropdown.classList.add('hidden');
        if (profileDropdownMobile) profileDropdownMobile.classList.add('hidden');
    } else {
        dropdown.classList.add('hidden');
    }
}

window.closeNotificationDropdown = function() {
    document.getElementById('notificationDropdown').classList.add('hidden');
}

// Load notification dropdown
async function loadNotificationDropdown() {
    try {
        if (!studentData || !studentData.section) return;

        const notificationsQuery = query(
            collection(db, 'notifications'),
            where('section', '==', studentData.section)
        );
        
        const notificationsSnapshot = await getDocs(notificationsQuery);
        const dropdownBody = document.getElementById('notificationDropdownBody');
        
        if (!notificationsSnapshot.empty) {
            const notifications = [];
            notificationsSnapshot.forEach(doc => {
                notifications.push({ id: doc.id, ...doc.data() });
            });
            
            notifications.sort((a, b) => {
                const dateA = a.createdAt?.toDate?.() || new Date(0);
                const dateB = b.createdAt?.toDate?.() || new Date(0);
                return dateB - dateA;
            });
            
            let html = '';
            notifications.slice(0, 5).forEach(notification => {
                const createdDate = notification.createdAt?.toDate?.();
                const dateStr = createdDate ? createdDate.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'Recently';
                
                html += `
                    <div class="p-4 border-b border-gray-100 hover:bg-gray-50 transition-colors cursor-pointer">
                        <strong class="text-gray-900 text-sm block mb-1 font-semibold">${notification.title || 'Notification'}</strong>
                        <p class="text-gray-600 text-sm mb-1 leading-relaxed">${notification.message || ''}</p>
                        <small class="text-gray-400 text-xs">${dateStr}</small>
                    </div>
                `;
            });
            
            dropdownBody.innerHTML = html;
        } else {
            dropdownBody.innerHTML = `
                <div class="p-8 text-center text-gray-400">
                    <i class="bi bi-bell-slash text-5xl mb-3 block"></i>
                    <p class="text-gray-600">No notifications yet</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading notifications:', error);
    }
}
        function getCategoryForTest(testName) {
            for (const [category, data] of Object.entries(testCategories)) {
                if (data.tests.some(t => testName.toLowerCase().includes(t.toLowerCase()) || t.toLowerCase().includes(testName.toLowerCase()))) {
                    return category;
                }
            }
            return 'Cardio Endurance';
        }

        async function loadStudentData(user) {
            try {
                const studentsQuery = query(
                    collection(db, 'students'),
                    where('email', '==', user.email)
                );
                const studentsSnapshot = await getDocs(studentsQuery);
                
                studentData = {
                    displayName: user.displayName || user.email.split('@')[0] || 'Student',
                    email: user.email,
                    section: 'Not Assigned',
                    testsDone: 0,
                    overallScore: 0,
                    weekStreak: 0
                };
                
                if (!studentsSnapshot.empty) {
                    studentsSnapshot.forEach((doc) => {
                        const data = doc.data();
                        studentData = { 
                            ...studentData,
                            ...data,
                            testsDone: data.testsDone || 0,
                            overallScore: data.overallScore || 0,
                            weekStreak: data.weekStreak || 0,
                            section: data.section || 'Not Assigned'
                        };
                    });
                }
                
                await calculateAndUpdateStats();
                updateProfileUI();
                return studentData;
            } catch (error) {
                console.error('Error loading student data:', error);
                return null;
            }
        }

        async function calculateAndUpdateStats() {
            try {
                const resultsQuery = query(
                    collection(db, 'testResults'),
                    where('studentEmail', '==', studentData.email)
                );
                
                const resultsSnapshot = await getDocs(resultsQuery);
                
                let totalTests = 0;
                let totalScore = 0;
                let bestScore = 0;
                const testDates = [];
                
                resultsSnapshot.forEach((doc) => {
                    const result = doc.data();
                    const score = calculateTestScore(result.testName, result.result, result.testTarget);
                    
                    totalTests++;
                    totalScore += score;
                    if (score > bestScore) bestScore = score;
                    
                    const testDate = result.submittedAt?.toDate?.() || new Date(result.date);
                    testDates.push(testDate);
                });
                
                const avgScore = totalTests > 0 ? Math.round(totalScore / totalTests) : 0;
                const dayStreak = calculateDayStreak(testDates);
                
                document.getElementById('testsDone').textContent = totalTests;
                document.getElementById('avgScore').textContent = avgScore;
                document.getElementById('bestScore').textContent = bestScore;
                document.getElementById('dayStreak').textContent = dayStreak;
                
            } catch (error) {
                console.error('Error calculating stats:', error);
                document.getElementById('testsDone').textContent = '0';
                document.getElementById('avgScore').textContent = '0';
                document.getElementById('bestScore').textContent = '0';
                document.getElementById('dayStreak').textContent = '0';
            }
        }

        function calculateDayStreak(testDates) {
            if (testDates.length === 0) return 0;
            
            testDates.sort((a, b) => b - a);
            
            let streak = 0;
            let currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0);
            
            for (const testDate of testDates) {
                const date = new Date(testDate);
                date.setHours(0, 0, 0, 0);
                
                const diffTime = currentDate - date;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays === streak) {
                    streak++;
                    currentDate = date;
                } else if (diffDays > streak) {
                    break;
                }
            }
            
            return streak;
        }

    async function loadAvailableTests() {
    try {
        if (!studentData || !studentData.section || studentData.section === 'Not Assigned') {
            renderEmptyState();
            return;
        }

        console.log('üìã Loading tests for section:', studentData.section);
        
        // Query for ALL tests in the student's section
        const testsQuery = query(
            collection(db, 'scheduledTests'),
            where('section', '==', studentData.section)
        );
        
        const testsSnapshot = await getDocs(testsQuery);
        availableTests = [];
        const now = new Date();
        
        console.log(`üìä Found ${testsSnapshot.size} tests in database for section ${studentData.section}`);
        
        // Get all completed tests
        const completedTestsQuery = query(
            collection(db, 'testResults'),
            where('studentEmail', '==', studentData.email)
        );
        const completedTestsSnapshot = await getDocs(completedTestsQuery);
        
        // Map to store test completion status
        const testStatus = new Map();
        
        completedTestsSnapshot.forEach(doc => {
            const result = doc.data();
            const testId = result.testId;
            const score = calculateTestScore(result.testName, result.result, result.testTarget);
            
            if (!testStatus.has(testId)) {
                testStatus.set(testId, {
                    attempts: 0,
                    bestScore: 0
                });
            }
            
            const status = testStatus.get(testId);
            status.attempts++;
            if (score > status.bestScore) {
                status.bestScore = score;
            }
        });
        
        if (!testsSnapshot.empty) {
            testsSnapshot.forEach((doc) => {
                const test = { id: doc.id, ...doc.data() };
                
                console.log(`üîç Processing test: ${test.testName}`, test);
                
                // Calculate deadline
                let deadlineDateTime;
                if (test.deadlineDateTime) {
                    deadlineDateTime = new Date(test.deadlineDateTime);
                } else {
                    deadlineDateTime = new Date(test.deadline);
                    if (test.deadlineTime) {
                        const [hours, minutes] = test.deadlineTime.split(':').map(Number);
                        deadlineDateTime.setHours(hours, minutes, 0, 0);
                    } else {
                        deadlineDateTime.setHours(23, 59, 59, 999);
                    }
                }
                
                console.log(`‚è∞ Test deadline: ${deadlineDateTime}, Now: ${now}`);
            
                // SIMPLIFIED LOGIC: Only check if deadline hasn't passed
                if (deadlineDateTime >= now) {
                    const status = testStatus.get(test.id);
                    
                    if (!status) {
                        // Never attempted - always show
                        console.log(`‚úÖ Adding test ${test.testName}: Never attempted`);
                        availableTests.push(test);
                    } else {
                        const isUnlimited = test.attemptsAllowed === 0;
                        const isPerfect = status.bestScore === 100;
                        const hasAttemptsLeft = status.attempts < test.attemptsAllowed;
                        
                        // Show if not perfect AND (unlimited OR has attempts left)
                        if (!isPerfect && (isUnlimited || hasAttemptsLeft)) {
                            console.log(`‚úÖ Adding test ${test.testName}: Can retry (Best: ${status.bestScore}, Attempts: ${status.attempts}/${test.attemptsAllowed})`);
                            availableTests.push(test);
                        } else {
                            console.log(`‚ùå Skipping test ${test.testName}: ${isPerfect ? 'Perfect score achieved' : 'No attempts left'}`);
                        }
                    }
                } else {
                    console.log(`‚ùå Skipping test ${test.testName}: Deadline passed`);
                }
            });
        } else {
            console.log('‚ùå No tests found for section:', studentData.section);
        }
        
        console.log(`üéØ Available tests for student: ${availableTests.length}`);
        await renderCategoryCards();
        
    } catch (error) {
        console.error('‚ùå Error loading tests:', error);
        console.error('Error details:', error.message);
        renderEmptyState();
    }
}
                function setupTestUpdatesForStudent() {
    try {
        if (!studentData || !studentData.section) return;
        
        console.log('üëÇ Setting up real-time test updates for student section:', studentData.section);
        
        // Listen for ALL changes to tests in the student's section
        const testsQuery = query(
            collection(db, 'scheduledTests'),
            where('section', '==', studentData.section)
        );
        
        onSnapshot(testsQuery, (snapshot) => {
            console.log('üîÑ Real-time test update detected!');
            
            snapshot.docChanges().forEach((change) => {
                if (change.type === 'added') {
                    const testData = change.doc.data();
                    console.log('üÜï NEW TEST ADDED:', testData.testName);
                    console.log('üìã Test details:', testData);
                }
                if (change.type === 'modified') {
                    console.log('‚úèÔ∏è TEST MODIFIED:', change.doc.data().testName);
                }
                if (change.type === 'removed') {
                    console.log('üóëÔ∏è TEST REMOVED:', change.doc.data().testName);
                }
            });
            
            // Refresh the tests list
            loadAvailableTests();
        }, (error) => {
            console.error('‚ùå Error in real-time listener:', error);
        });
        
    } catch (error) {
        console.error('Error setting up test updates for student:', error);
    }
}
    async function renderCategoryCards() {
    const container = document.getElementById('categoryCardsContainer');
    
    if (availableTests.length === 0) {
        renderEmptyState();
        return;
    }
    
    // Remove duplicate tests based on test id
    const uniqueTests = [];
    const seenIds = new Set();
    
    availableTests.forEach(test => {
        if (!seenIds.has(test.id)) {
            seenIds.add(test.id);
            uniqueTests.push(test);
        }
    });
    
    console.log(`üîç After deduplication: ${uniqueTests.length} unique tests`);
    
    // Categorize unique tests
    const categorizedTests = {
        'Cardiorespiratory Endurance': [],
        'Muscular Strength': [],
        'Muscular Endurance': [],
        'Flexibility': [],
        'Body Composition': []
    };
    
    uniqueTests.forEach(test => {
        const category = getCategoryForTest(test.testName);
        if (categorizedTests[category]) {
            categorizedTests[category].push(test);
        } else {
            // Default to first category if no match
            categorizedTests['Cardiorespiratory Endurance'].push(test);
        }
    });
    
    let html = '';
    
    // Collect attempt data for all tests first
    const attemptPromises = uniqueTests.map(async (test) => {
        try {
            const attemptQuery = query(
                collection(db, 'testResults'),
                where('testId', '==', test.id),
                where('studentEmail', '==', studentData.email)
            );
            const attemptSnapshot = await getDocs(attemptQuery);
            const currentAttempts = attemptSnapshot.size;
            
            let bestScore = 0;
            attemptSnapshot.forEach(doc => {
                const result = doc.data();
                const score = calculateTestScore(result.testName, result.result, result.testTarget);
                if (score > bestScore) bestScore = score;
            });
            
            return {
                testId: test.id,
                attempts: currentAttempts,
                bestScore: bestScore,
                testData: test
            };
        } catch (error) {
            console.error(`Error fetching attempts for test ${test.id}:`, error);
            return {
                testId: test.id,
                attempts: 0,
                bestScore: 0,
                testData: test
            };
        }
    });
    
    const attemptsData = await Promise.all(attemptPromises);
    const attemptsMap = new Map();
    attemptsData.forEach(data => {
        attemptsMap.set(data.testId, data);
    });
    
    // Now render categories
    for (const [category, tests] of Object.entries(categorizedTests)) {
        const categoryData = testCategories[category];
        
        if (!categoryData) continue;
        
        html += `
            <div class="bg-white rounded-xl sm:rounded-2xl p-4 sm:p-6 shadow-md border border-gray-200 hover:shadow-lg hover:-translate-y-1 transition-all">
                <div class="flex items-center gap-3 sm:gap-4 mb-4 sm:mb-6">
                    <img class="w-12 h-12 sm:w-14 sm:h-14 object-contain" src="${categoryData.icon}" alt="${category}" />
                    <div class="flex-1 min-w-0">
                        <h3 class="text-base sm:text-lg lg:text-xl font-bold text-gray-900 mb-1">${category}</h3>
                        <p class="text-xs sm:text-sm text-gray-600">${categoryData.subtitle}</p>
                    </div>
                </div>
                <div class="space-y-2 sm:space-y-3">
        `;
        
        if (tests.length === 0) {
            html += `
                <div class="text-center py-4 sm:py-6">
                    <p class="text-sm text-gray-500">No tests in this category</p>
                </div>
            `;
        } else {
            // Render each test in this category
            tests.forEach(test => {
                const attemptData = attemptsMap.get(test.id) || { attempts: 0, bestScore: 0 };
                const currentAttempts = attemptData.attempts;
                const bestScore = attemptData.bestScore;
                const isUnlimited = test.attemptsAllowed === 0;
                const hasAttempts = currentAttempts > 0;
                const isPerfect = bestScore === 100;
                const canRetry = isUnlimited ? (bestScore < 100) : (currentAttempts < test.attemptsAllowed && bestScore < 100);
                const attemptsLeft = test.attemptsAllowed - currentAttempts;
                
                let buttonText = 'Start';
                let buttonClass = 'from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700';
                
                if (hasAttempts && canRetry) {
                    buttonText = isUnlimited ? 'Retry' : `Retry (${attemptsLeft} left)`;
                    buttonClass = 'from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700';
                }
                
                html += `
                    <div class="bg-gray-50 rounded-lg sm:rounded-xl p-3 sm:p-4 hover:bg-gray-100 transition-colors">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                            <div class="flex-1 min-w-0 w-full sm:w-auto">
                                <h4 class="font-semibold text-gray-900 text-sm sm:text-base mb-1">${test.testName}</h4>
                                <div class="flex flex-wrap gap-2 text-xs sm:text-sm">
                                    <p class="${isUnlimited ? 'text-green-600' : 'text-gray-600'}">
                                        üìÖ ${test.date || 'No date'}
                                    </p>
                                    <p class="text-gray-600">
                                        ‚è∞ Due: ${test.deadline} ${test.deadlineTime || ''}
                                    </p>
                                    ${hasAttempts ? `
                                    <p class="${isPerfect ? 'text-green-600 font-bold' : canRetry ? 'text-orange-600 font-semibold' : 'text-gray-600'}">
                                        ${isPerfect ? '‚úÖ Perfect Score!' : isUnlimited ? `üîÑ ${currentAttempts} Attempt${currentAttempts > 1 ? 's' : ''} ‚Ä¢ Best: ${bestScore}` : `üîÑ ${currentAttempts}/${test.attemptsAllowed} Attempts ‚Ä¢ Best: ${bestScore}`}
                                    </p>
                                    ` : `
                                    <p class="${isUnlimited ? 'text-green-600 font-semibold' : 'text-blue-600 font-semibold'}">
                                        üîÑ ${isUnlimited ? 'Unlimited Attempts' : test.attemptsAllowed + ' Attempt' + (test.attemptsAllowed > 1 ? 's' : '') + ' Allowed'}
                                    </p>
                                    `}
                                </div>
                            </div>
                            ${canRetry ? `
                            <button onclick="startTest('${test.id}')" class="w-full sm:w-auto px-4 sm:px-5 py-2 sm:py-2.5 bg-gradient-to-r ${buttonClass} text-white rounded-lg font-semibold text-sm hover:-translate-y-0.5 hover:shadow-lg transition-all whitespace-nowrap">
                                ${buttonText}
                            </button>
                            ` : isPerfect ? `
                            <div class="w-full sm:w-auto px-4 sm:px-5 py-2 sm:py-2.5 bg-green-100 text-green-700 rounded-lg font-semibold text-sm text-center border-2 border-green-300">
                                üèÜ Completed
                            </div>
                            ` : !hasAttempts ? `
                            <button onclick="startTest('${test.id}')" class="w-full sm:w-auto px-4 sm:px-5 py-2 sm:py-2.5 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg font-semibold text-sm hover:from-blue-600 hover:to-blue-700 hover:-translate-y-0.5 hover:shadow-lg transition-all whitespace-nowrap">
                                Start
                            </button>
                            ` : `
                            <div class="w-full sm:w-auto px-4 sm:px-5 py-2 sm:py-2.5 bg-gray-200 text-gray-600 rounded-lg font-semibold text-sm text-center">
                                No Attempts Left
                            </div>
                            `}
                        </div>
                    </div>
                `;
            });
        }
        
        html += `
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

        function renderEmptyState() {
            const container = document.getElementById('categoryCardsContainer');
            
            let html = '';
            for (const [category, categoryData] of Object.entries(testCategories)) {
                html += `
                    <div class="bg-white rounded-xl sm:rounded-2xl p-4 sm:p-6 shadow-md border border-gray-200">
                        <div class="flex items-center gap-3 sm:gap-4 mb-4 sm:mb-6">
                            <img class="w-12 h-12 sm:w-14 sm:h-14 object-contain" src="${categoryData.icon}" alt="${category}" />
                            <div class="flex-1 min-w-0">
                                <h3 class="text-base sm:text-lg lg:text-xl font-bold text-gray-900 mb-1">${category}</h3>
                                <p class="text-xs sm:text-sm text-gray-600">${categoryData.subtitle}</p>
                            </div>
                        </div>
                        <div class="text-center py-4 sm:py-6">
                            <p class="text-sm text-gray-500">No tests in this category</p>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        async function loadRecentTestHistory() {
    try {
        if (!studentData) return;

        // Set up real-time listener for test results
        const historyQuery = query(
            collection(db, 'testResults'),
            where('studentEmail', '==', studentData.email)
        );
        
        onSnapshot(historyQuery, (snapshot) => {
            console.log('üîÑ Real-time test results update detected!');
            
            allTestHistory = [];
            
            snapshot.forEach((doc) => {
                allTestHistory.push({ id: doc.id, ...doc.data() });
            });
            
            // Sort by date (NEWEST FIRST - most recent at top)
            allTestHistory.sort((a, b) => {
                const dateA = a.submittedAt?.toDate ? a.submittedAt.toDate() : (a.submittedAt ? new Date(a.submittedAt) : new Date(0));
                const dateB = b.submittedAt?.toDate ? b.submittedAt.toDate() : (b.submittedAt ? new Date(b.submittedAt) : new Date(0));
                return dateB - dateA; // Descending order (newest first)
            });
            
            renderTestHistory();
            calculateAndUpdateStats(); // Update stats when new results come in
            
            // IMPORTANT: Also refresh the available tests to update retry buttons
            loadAvailableTests();
            
        }, (error) => {
            console.error('‚ùå Error in test results listener:', error);
            const container = document.getElementById('testHistoryContainer');
            container.innerHTML = `
                <div class="text-center py-8 sm:py-12">
                    <div class="text-5xl sm:text-6xl mb-3 sm:mb-4">‚ö†Ô∏è</div>
                    <p class="text-base sm:text-lg font-semibold text-gray-600 mb-1 sm:mb-2">Error Loading History</p>
                    <small class="text-sm text-gray-400">Please refresh the page to try again</small>
                </div>
            `;
        });
        
    } catch (error) {
        console.error('Error setting up test history listener:', error);
        const container = document.getElementById('testHistoryContainer');
        container.innerHTML = `
            <div class="text-center py-8 sm:py-12">
                <div class="text-5xl sm:text-6xl mb-3 sm:mb-4">‚ö†Ô∏è</div>
                <p class="text-base sm:text-lg font-semibold text-gray-600 mb-1 sm:mb-2">Error Loading History</p>
                <small class="text-sm text-gray-400">Please refresh the page to try again</small>
            </div>
        `;
    }
}

        function renderTestHistory() {
            const container = document.getElementById('testHistoryContainer');
            
            if (allTestHistory.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 sm:py-12">
                        <div class="text-5xl sm:text-6xl mb-3 sm:mb-4">üìã</div>
                        <p class="text-base sm:text-lg font-semibold text-gray-600 mb-1 sm:mb-2">No Test History Yet</p>
                        <small class="text-sm text-gray-400">Your completed tests will appear here</small>
                    </div>
                `;
                return;
            }

            const visibleHistory = showAllHistory ? allTestHistory : allTestHistory.slice(0, VISIBLE_HISTORY_COUNT);
            const hiddenCount = allTestHistory.length - visibleHistory.length;

            let html = `
                <div class="mb-3 sm:mb-4">
                    <small class="text-xs sm:text-sm text-gray-500">
                        Showing ${visibleHistory.length} of ${allTestHistory.length} test results
                    </small>
                </div>
                <div class="space-y-2 sm:space-y-3">
            `;

            visibleHistory.forEach((result) => {
                const score = calculateTestScore(result.testName, result.result, result.testTarget);
                const rating = getRating(score);
                const date = result.submittedAt?.toDate 
                    ? result.submittedAt.toDate().toLocaleDateString() 
                    : new Date().toLocaleDateString();
                
                html += `
                    <div class="bg-gray-50 rounded-lg sm:rounded-xl p-3 sm:p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 hover:bg-gray-100 transition-colors">
                        <div class="flex-1 min-w-0 w-full sm:w-auto">
                            <h4 class="font-semibold text-gray-900 text-sm sm:text-base mb-1">${result.testName}</h4>
                            <p class="${rating.class} text-xs sm:text-sm font-medium mb-1">Score: ${score}/100 ‚Ä¢ ${rating.text}</p>
                            <small class="text-gray-500 text-xs">Completed: ${date}</small>
                        </div>
                        <button onclick="viewResult('${result.id}')" class="w-full sm:w-auto px-4 sm:px-5 py-2 sm:py-2.5 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg font-semibold text-sm hover:from-blue-600 hover:to-blue-700 hover:-translate-y-0.5 hover:shadow-lg transition-all whitespace-nowrap">
                            View Result
                        </button>
                    </div>
                `;
            });

            html += `</div>`;

            if (allTestHistory.length > VISIBLE_HISTORY_COUNT) {
                html += `
                    <div class="text-center mt-4 sm:mt-6 pt-4 sm:pt-6 border-t border-gray-200">
                        <button onclick="toggleHistoryViewMoreLess()" class="inline-flex items-center gap-2 px-4 sm:px-6 py-2 sm:py-2.5 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg font-semibold text-sm hover:from-blue-600 hover:to-blue-700 hover:-translate-y-0.5 hover:shadow-lg transition-all">
                            <i class="bi bi-${showAllHistory ? 'chevron-up' : 'chevron-down'}"></i>
                            ${showAllHistory ? 'View Less' : `View More (${hiddenCount} more)`}
                        </button>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        window.toggleHistoryViewMoreLess = function() {
            showAllHistory = !showAllHistory;
            renderTestHistory();
            
            if (showAllHistory) {
                setTimeout(() => {
                    document.getElementById('testHistoryContainer').scrollIntoView({ 
                        behavior: 'smooth',
                        block: 'nearest'
                    });
                }, 100);
            }
        };
function calculateTestScore(testName, result, testTarget = null) {
    const normalized = testName.toLowerCase().trim();
    
    // Extract numeric value from result
    let numericValue = 0;
    
    if (typeof result === 'object' && result !== null) {
        numericValue = result.repetitions || result.time || result.distance || result.value || result.score || 0;
    } else if (typeof result === 'string') {
        const match = result.match(/(\d+\.?\d*)/);
        if (match) {
            numericValue = parseFloat(match[1]);
        } else {
            numericValue = parseFloat(result) || 0;
        }
    } else {
        numericValue = parseFloat(result) || 0;
    }
    
    console.log(`üî¢ Score Calculation: ${testName} ‚Üí Value: ${numericValue}, Target: ${testTarget}`);
    
    // Use test target if available for more accurate scoring
    if (testTarget && testTarget > 0) {
        if (normalized.includes('push-up') || normalized.includes('pushup') || 
            normalized.includes('sit-up') || normalized.includes('situp')) {
            const reps = numericValue;
            const percentage = (reps / testTarget) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            // Apply grading curve for better distribution
            if (percentage >= 100) score = 100;
            else if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            console.log(`üí™ Strength Test: ${reps}/${testTarget} reps ‚Üí ${score}%`);
            return Math.round(score);
            
        } else if (normalized.includes('plank')) {
            let seconds = 0;
            if (typeof result === 'string' && result.includes(':')) {
                const [mins, secs] = result.split(':').map(Number);
                seconds = (mins * 60) + (secs || 0);
            } else {
                seconds = numericValue;
            }
            
            const percentage = (seconds / testTarget) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 100) score = 100;
            else if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            console.log(`‚è±Ô∏è Plank Test: ${seconds}s/${testTarget}s ‚Üí ${score}%`);
            return Math.round(score);
            
        } else if (normalized.includes('sit-and-reach')) {
            const distance = numericValue;
            const percentage = (distance / testTarget) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 100) score = 100;
            else if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            console.log(`üìè Flexibility Test: ${distance}cm/${testTarget}cm ‚Üí ${score}%`);
            return Math.round(score);
        }
    }
    
    // Fallback to standard scoring if no target available
    if (normalized.includes('push-up') || normalized.includes('pushup')) {
        const reps = numericValue;
        if (reps >= 40) return 100;
        if (reps >= 35) return 95;
        if (reps >= 30) return 90;
        if (reps >= 25) return 85;
        if (reps >= 20) return 80;
        if (reps >= 15) return 75;
        if (reps >= 10) return 70;
        if (reps >= 5) return 65;
        return 60;
        
    } else if (normalized.includes('sit-up') || normalized.includes('situp')) {
        const reps = numericValue;
        if (reps >= 50) return 100;
        if (reps >= 45) return 95;
        if (reps >= 40) return 90;
        if (reps >= 35) return 85;
        if (reps >= 30) return 80;
        if (reps >= 25) return 75;
        if (reps >= 20) return 70;
        if (reps >= 15) return 65;
        return 60;
        
    } else if (normalized.includes('plank')) {
        let seconds = 0;
        if (typeof result === 'string' && result.includes(':')) {
            const [mins, secs] = result.split(':').map(Number);
            seconds = (mins * 60) + (secs || 0);
        } else {
            seconds = numericValue;
        }
        
        if (seconds >= 180) return 100;
        if (seconds >= 150) return 95;
        if (seconds >= 120) return 90;
        if (seconds >= 100) return 85;
        if (seconds >= 80) return 80;
        if (seconds >= 60) return 75;
        if (seconds >= 45) return 70;
        if (seconds >= 30) return 65;
        return 60;
        
    } else if (normalized.includes('step test') || normalized.includes('3-minute')) {
        const heartRate = numericValue;
        if (heartRate <= 70) return 100;
        if (heartRate <= 80) return 95;
        if (heartRate <= 90) return 90;
        if (heartRate <= 100) return 85;
        if (heartRate <= 110) return 80;
        if (heartRate <= 120) return 75;
        if (heartRate <= 130) return 70;
        return 65;
        
    } else if (normalized.includes('mile') || normalized.includes('run')) {
        let totalSeconds = 0;
        if (typeof result === 'string' && result.includes(':')) {
            const [minutes, seconds] = result.split(':').map(Number);
            totalSeconds = (minutes * 60) + (seconds || 0);
        } else {
            totalSeconds = numericValue;
        }
        
        if (totalSeconds <= 360) return 100;
        if (totalSeconds <= 420) return 95;
        if (totalSeconds <= 480) return 90;
        if (totalSeconds <= 540) return 85;
        if (totalSeconds <= 600) return 80;
        if (totalSeconds <= 660) return 75;
        if (totalSeconds <= 720) return 70;
        if (totalSeconds <= 780) return 65;
        return 60;
        
    } else if (normalized.includes('sit-and-reach')) {
        const distance = numericValue;
        if (distance >= 25) return 100;
        if (distance >= 20) return 95;
        if (distance >= 15) return 90;
        if (distance >= 10) return 85;
        if (distance >= 5) return 80;
        if (distance >= 0) return 75;
        if (distance >= -5) return 70;
        return 65;
        
    } else if (normalized.includes('grip')) {
        const strength = numericValue;
        if (strength >= 60) return 100;
        if (strength >= 55) return 95;
        if (strength >= 50) return 90;
        if (strength >= 45) return 85;
        if (strength >= 40) return 80;
        if (strength >= 35) return 75;
        if (strength >= 30) return 70;
        return 65;
    }
    
    console.log(`‚ùì Unknown test type: ${testName}, using default score`);
    return 75;
}
        function getRating(score) {
            if (score >= 90) return { text: 'Excellent', class: 'text-green-600' };
            if (score >= 80) return { text: 'Good', class: 'text-blue-600' };
            if (score >= 70) return { text: 'Fair', class: 'text-yellow-600' };
            return { text: 'Needs Improvement', class: 'text-red-600' };
        }

        window.startTest = function(testId) {
            const test = availableTests.find(t => t.id === testId);
            if (test) {
                window.location.href = `./testdetails.html?testId=${testId}&testName=${encodeURIComponent(test.testName)}`;
            }
        };

        window.viewResult = function(resultId) {
            window.location.href = `./studentresult.html?resultId=${resultId}`;
        };

        window.handleLogout = async function() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await signOut(auth);
                    window.location.href = '../login/index.html';
                } catch (error) {
                    console.error('Error logging out:', error);
                    alert('Error logging out. Please try again.');
                }
            }
        };

        onAuthStateChanged(auth, async (user) => {
    const loadingScreen = document.getElementById('loadingScreen');
    const mainContent = document.getElementById('mainContent');

    if (user) {
        try {
            currentUser = user;
            await loadStudentData(user);
            await loadAvailableTests();
            await loadRecentTestHistory();
            setupTestUpdatesForStudent(); // ADD THIS LINE
            
            loadingScreen.classList.add('hidden');
            mainContent.classList.remove('hidden');
        } catch (error) {
            console.error('Error loading page:', error);
            alert('Error loading page. Please try again.');
        }
    } else {
        window.location.href = '../login/index.html';
    }
});
    </script>
</body>
</html>