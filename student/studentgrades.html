<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UMak Fitness - Grades</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .font-manrope { font-family: 'Manrope', sans-serif; }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .spinner {
            border: 4px solid #e5e7eb;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white/98 flex flex-col items-center justify-center z-50">
        <div class="spinner"></div>
        <div class="mt-5 text-gray-600 font-medium">Loading Grades...</div>
    </div>

    <div id="mainContent" class="hidden">
        <!-- Navigation -->
<nav class="bg-gradient-to-r from-blue-900 to-blue-500 shadow-lg">
    <div class="container mx-auto px-4 py-5">
        <div class="flex items-center justify-between">
            <a href="#" class="flex items-center gap-3">
                <img src="https://c.animaapp.com/vkhEa8zW/img/screenshot-2025-09-19-2-53-51-pm-removebg-preview-3@2x.png" 
                     alt="UMak Logo" class="h-16 w-auto">
                <span class="text-3xl font-extrabold font-manrope bg-gradient-to-r from-yellow-400 to-yellow-200 bg-clip-text text-transparent">
                    UMakFit
                </span>
            </a>
            
            <div class="hidden lg:flex items-center gap-2">
                <a href="./studentDashboard.html" class="px-4 py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </a>
                <a href="./test.html" class="px-4 py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                    <i class="bi bi-clipboard-check"></i> Tests
                </a>
                <a href="./studentlesson.html" class="px-4 py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                    <i class="bi bi-book"></i> Lessons
                </a>
                <a href="#" class="px-4 py-3 bg-white text-gray-900 rounded-lg font-semibold text-sm flex items-center gap-2 shadow-sm">
                    <i class="bi bi-award"></i> Grades
                </a>
                <a href="./progress.html" class="px-4 py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                    <i class="bi bi-graph-up"></i> Progress
                </a>
                
                <!-- Notification Bell -->
                <div class="relative">
                    <button id="notificationBellBtn" 
                            class="w-10 h-10 bg-white/20 border-2 border-white/30 rounded-full flex items-center justify-center text-white hover:bg-white/30 hover:scale-110 transition-all">
                        <i class="bi bi-bell-fill text-lg"></i>
                        <span id="navNotificationCount" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold px-1.5 py-0.5 rounded-full min-w-[18px] h-4.5 flex items-center justify-center">0</span>
                    </button>
                    
                    <!-- Notification Dropdown -->
                    <div id="notificationDropdown" class="hidden absolute right-0 mt-2 w-96 max-w-[calc(100vw-2rem)] bg-white rounded-xl shadow-2xl z-[9999] max-h-[480px] overflow-y-auto">
                        <div class="p-4 border-b-2 border-gray-200 bg-gradient-to-r from-gray-50 to-white flex justify-between items-center rounded-t-xl sticky top-0 z-10">
                            <h6 class="font-bold text-gray-900 text-base flex items-center gap-2">
                                <i class="bi bi-bell-fill text-blue-500"></i> Notifications
                            </h6>
                            <button onclick="closeNotificationDropdown()" class="text-gray-400 hover:text-gray-600 p-1">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        <div id="notificationDropdownBody" class="max-h-96 overflow-y-auto">
                            <div class="p-8 text-center text-gray-400">
                                <i class="bi bi-bell-slash text-5xl mb-3 block"></i>
                                <p class="text-gray-600">No notifications yet</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Profile Dropdown -->
                <div class="relative">
                    <img src="" alt="Profile" id="profilePictureBtn"
                         class="w-10 h-10 rounded-full border-2 border-white/30 cursor-pointer hover:border-white/60 hover:scale-105 transition-all object-cover">
                    
                    <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-72 bg-white rounded-xl shadow-2xl z-[9999]">
                        <div class="p-6 border-b-2 border-gray-200 text-center">
                            <img src="" alt="Profile" id="profileDropdownPicture" class="w-20 h-20 rounded-full mx-auto mb-3 border-3 border-blue-500 object-cover">
                            <h6 id="profileDropdownName" class="font-bold text-gray-900 text-lg">Loading...</h6>
                            <p id="profileDropdownEmail" class="text-sm text-gray-500 mt-1 truncate px-2">Loading...</p>
                        </div>
                        <div class="p-2">
                            <a href="./studentProfile.html" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition-colors">
                                <i class="bi bi-person-circle text-blue-500 text-xl"></i>
                                <span class="font-medium text-gray-700">View Profile</span>
                            </a>
                            <div class="h-px bg-gray-200 my-2"></div>
                            <div onclick="handleLogout()" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-red-50 transition-colors cursor-pointer text-red-500">
                                <i class="bi bi-box-arrow-right text-xl"></i>
                                <span class="font-medium">Logout</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</nav>

        <!-- Main Content -->
        <div class="container mx-auto px-4 py-8 max-w-7xl">
            <!-- Page Header -->
<div class="mb-8">
    <div class="flex items-center gap-4 mb-2">
        <div class="w-16 h-16 bg-gradient-to-br from-blue-600 to-blue-700 rounded-xl flex items-center justify-center shadow-lg">
            <i class="bi bi-award-fill text-white text-3xl"></i>
        </div>
        <div>
            <h1 class="text-4xl font-bold text-gray-900 mb-1">My Grades</h1>
            <p class="text-gray-600">View your test scores and overall performance</p>
        </div>
    </div>
    <div class="h-1 bg-gradient-to-r from-blue-600 to-blue-400 rounded-full w-32"></div>
</div>

            <!-- Overall Summary -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8 mb-6">
    <div class="flex items-center gap-3 mb-6 pb-4 border-b border-gray-200">
        <div class="w-12 h-12 bg-gradient-to-br from-blue-600 to-blue-700 rounded-lg flex items-center justify-center">
            <i class="bi bi-graph-up-arrow text-white text-xl"></i>
        </div>
        <div>
            <h2 class="text-2xl font-bold text-gray-900">Academic Overview</h2>
            <p class="text-sm text-gray-500">Your overall performance summary</p>
        </div>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <div class="text-center md:text-left">
            <p class="text-sm text-gray-500 mb-2 font-medium uppercase tracking-wide">Final Grade</p>
            <p class="text-5xl font-bold text-blue-600" id="finalGrade">--</p>
        </div>
        <div class="text-center md:text-left">
            <p class="text-sm text-gray-500 mb-2 font-medium uppercase tracking-wide">Tests Completed</p>
            <p class="text-5xl font-bold text-gray-900">
                <span id="completedTests">--</span><span class="text-3xl text-gray-400" id="totalTests">/0</span>
            </p>
        </div>
        <div class="text-center md:text-left">
            <p class="text-sm text-gray-500 mb-2 font-medium uppercase tracking-wide">Completion Rate</p>
            <p class="text-5xl font-bold text-gray-900" id="completionRate">--</p>
        </div>
    </div>
</div>

           <!-- Grades by Category -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
    <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-700 rounded-lg flex items-center justify-center">
                <i class="bi bi-list-check text-white text-lg"></i>
            </div>
            <div>
                <h2 class="text-xl font-bold text-gray-900">Performance by Category</h2>
                <p class="text-sm text-gray-500">Average scores across fitness categories</p>
            </div>
        </div>
    </div>
    
    <!-- Table Header - Desktop Only -->
    <div class="hidden md:block px-6 py-3 bg-gray-50 border-b border-gray-200">
        <div class="grid grid-cols-12 gap-4 text-sm font-semibold text-gray-600">
            <div class="col-span-5">Category</div>
            <div class="col-span-3 text-center">Tests Taken</div>
            <div class="col-span-4 text-right">Average Score</div>
        </div>
    </div>
    
    <div id="categoriesContainer" class="divide-y divide-gray-100">
        <!-- Categories will be dynamically inserted -->
    </div>
</div>
            

                        <!-- Detailed Test Results -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200">
    <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-700 rounded-lg flex items-center justify-center">
                <i class="bi bi-clipboard-data text-white text-lg"></i>
            </div>
            <div>
                <h2 class="text-xl font-bold text-gray-900">Recent Test Results</h2>
                <p class="text-sm text-gray-500">Your most recent fitness assessments</p>
            </div>
        </div>
    </div>
    
            <!-- Table Header - Desktop Only -->
            <div class="hidden md:block px-6 py-3 bg-gray-50 border-b border-gray-200">
                <div class="grid grid-cols-12 gap-4 text-sm font-semibold text-gray-600">
                    <div class="col-span-4">Test Name</div>
                    <div class="col-span-3">Category</div>
                    <div class="col-span-2 text-center">Date</div>
                    <div class="col-span-2 text-right">Score</div>
                    <div class="col-span-1 text-right">Action</div>
                </div>
            </div>
            
            <div id="testResultsContainer" class="divide-y divide-gray-100">
                <!-- Test results will be dynamically inserted -->
            </div>
        </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs, doc, getDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAgaLunqEf2gs6dSpF_sz1hV5XQ5Wm52jo",
            authDomain: "umakfit-e3b1d.firebaseapp.com",
            projectId: "umakfit-e3b1d",
            storageBucket: "umakfit-e3b1d.appspot.com",
            messagingSenderId: "276569891504",
            appId: "1:276569891504:web:39b1732b519f4d8b785175"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
     
        let cachedStudentData = null;
        let cachedTestResults = null;

        
        async function loadEssentialData(user) {
            try {
                // Load student data and test results in parallel
                const [studentDataResult, assignedTestsResult] = await Promise.allSettled([
                    loadStudentData(user),
                    // Pre-load assigned tests count
                    getDocs(query(
                        collection(db, 'scheduledTests'),
                        where('section', '==', studentData?.section || ''),
                        where('isVisible', '==', true),
                        where('isActive', '==', true)
                    ))
                ]);
                
                // Cache the data
                if (studentDataResult.status === 'fulfilled') {
                    cachedStudentData = studentDataResult.value;
                }
                
                return cachedStudentData;
            } catch (error) {
                console.error('Error in parallel loading:', error);
                return null;
            }
        }
        let currentUser = null;

                // Toggle notification dropdown
                function toggleNotificationDropdown(event) {
                    event?.stopPropagation();
                    const dropdown = document.getElementById('notificationDropdown');
                    
                    if (dropdown.classList.contains('hidden')) {
                        dropdown.classList.remove('hidden');
                        loadNotificationDropdown();
                        closeProfileDropdown();
                    } else {
                        dropdown.classList.add('hidden');
                    }
                }

                window.closeNotificationDropdown = function() {
                    document.getElementById('notificationDropdown').classList.add('hidden');
                }

                // Toggle profile dropdown
                function toggleProfileDropdown(event) {
                    event?.stopPropagation();
                    const dropdown = document.getElementById('profileDropdown');
                    
                    if (dropdown.classList.contains('hidden')) {
                        dropdown.classList.remove('hidden');
                        closeNotificationDropdown();
                    } else {
                        dropdown.classList.add('hidden');
                    }
                }

                function closeProfileDropdown() {
                    document.getElementById('profileDropdown').classList.add('hidden');
                }

                // Close dropdowns when clicking outside
                document.addEventListener('click', function(event) {
                    if (!event.target.closest('#notificationBellBtn') && 
                        !event.target.closest('#notificationDropdown')) {
                        closeNotificationDropdown();
                    }
                    
                    if (!event.target.closest('#profilePictureBtn') && 
                        !event.target.closest('#profileDropdown')) {
                        closeProfileDropdown();
                    }
                });

                // Update profile UI
                function updateProfileUI() {
                    if (!currentUser || !studentData) return;
                    
                    const photoURL = currentUser?.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(studentData?.displayName || studentData?.firstName + ' ' + studentData?.lastName || 'User') + '&background=3b82f6&color=fff&size=128';
                    
                    const profileBtn = document.getElementById('profilePictureBtn');
                    if (profileBtn) profileBtn.src = photoURL;
                    
                    const dropdownPic = document.getElementById('profileDropdownPicture');
                    if (dropdownPic) dropdownPic.src = photoURL;
                    
                    const dropdownName = document.getElementById('profileDropdownName');
                    if (dropdownName) dropdownName.textContent = studentData?.displayName || `${studentData?.firstName || ''} ${studentData?.lastName || ''}`.trim() || 'Student';
                    
                    const dropdownEmail = document.getElementById('profileDropdownEmail');
                    if (dropdownEmail) dropdownEmail.textContent = studentData?.email || currentUser?.email || '';
                }

                // Load notification dropdown
                async function loadNotificationDropdown() {
                    try {
                        if (!studentData || !studentData.section) return;

                        const notificationsQuery = query(
                            collection(db, 'notifications'),
                            where('section', '==', studentData.section)
                        );
                        
                        const notificationsSnapshot = await getDocs(notificationsQuery);
                        const dropdownBody = document.getElementById('notificationDropdownBody');
                        
                        if (!notificationsSnapshot.empty) {
                            const notifications = [];
                            notificationsSnapshot.forEach(doc => {
                                notifications.push({ id: doc.id, ...doc.data() });
                            });
                            
                            notifications.sort((a, b) => {
                                const dateA = a.createdAt?.toDate?.() || new Date(0);
                                const dateB = b.createdAt?.toDate?.() || new Date(0);
                                return dateB - dateA;
                            });
                            
                            let html = '';
                            notifications.slice(0, 5).forEach(notification => {
                                const createdDate = notification.createdAt?.toDate?.();
                                const dateStr = createdDate ? createdDate.toLocaleDateString('en-US', {
                                    month: 'short',
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                }) : 'Recently';
                                
                                html += `
                                    <div class="p-4 border-b border-gray-100 hover:bg-gray-50 transition-colors cursor-pointer">
                                        <strong class="text-gray-900 text-sm block mb-1 font-semibold">${notification.title || 'Notification'}</strong>
                                        <p class="text-gray-600 text-sm mb-1 leading-relaxed">${notification.message || ''}</p>
                                        <small class="text-gray-400 text-xs">${dateStr}</small>
                                    </div>
                                `;
                            });
                            
                            dropdownBody.innerHTML = html;
                        } else {
                            dropdownBody.innerHTML = `
                                <div class="p-8 text-center text-gray-400">
                                    <i class="bi bi-bell-slash text-5xl mb-3 block"></i>
                                    <p class="text-gray-600">No notifications yet</p>
                                </div>
                            `;
                        }
                    } catch (error) {
                        console.error('Error loading notifications:', error);
                    }
                }

                // Logout handler
                window.handleLogout = async function() {
                    if (confirm('Are you sure you want to logout?')) {
                        try {
                            await signOut(auth);
                            window.location.href = '../login/index.html';
                        } catch (error) {
                            console.error('Error logging out:', error);
                            alert('Error logging out. Please try again.');
                        }
                    }
                }

                // Event listeners
                document.addEventListener('DOMContentLoaded', () => {
                    const notificationBtn = document.getElementById('notificationBellBtn');
                    if (notificationBtn) {
                        notificationBtn.addEventListener('click', toggleNotificationDropdown);
                    }
                    
                    const profileBtn = document.getElementById('profilePictureBtn');
                    if (profileBtn) {
                        profileBtn.addEventListener('click', toggleProfileDropdown);
                    }
                });
        let studentData = null;

                    const testCategories = {
                'Cardiorespiratory Endurance': {
                    tests: ['3-Minute Step Test', '1-Mile Run', '1 Mile Run'],
                    icon: '‚ù§Ô∏è',
                    color: 'from-red-500 to-pink-500'
                },
                'Muscular Strength': {
                    tests: ['Push-Up Test', 'Grip Strength', 'Push-up Test'],
                    icon: 'üí™',
                    color: 'from-blue-500 to-indigo-500'
                },
                'Muscular Endurance': {
                    tests: ['Curl-Up Test', 'Push-up Test', 'Plank Hold', 'Sit-Up Test'],
                    icon: 'üîÅ',
                    color: 'from-orange-500 to-red-500'
                },
                'Flexibility': {
                    tests: ['Sit-and-Reach', 'Shoulder Flexibility'],
                    icon: 'ü§∏',
                    color: 'from-green-500 to-emerald-500'
                },
                'Body Composition': {
                    tests: ['BMI Assessment', 'Skinfold Caliper Measurements'],
                    icon: '‚öñÔ∏è',
                    color: 'from-purple-500 to-violet-500'
                }
            };

        function getCategoryForTest(testName) {
            const normalized = testName.toLowerCase().trim();
            for (const [category, data] of Object.entries(testCategories)) {
                if (data.tests.some(t => normalized.includes(t.toLowerCase()) || t.toLowerCase().includes(normalized))) {
                    return category;
                }
            }
            return 'Cardio Endurance';
        }

        function calculateScore(testName, result, testTarget = null) {
    const normalized = testName.toLowerCase().trim();
    
    // ‚≠ê CRITICAL: Check if this is a professor override with pre-calculated score
    if (result && typeof result === 'object' && result !== null) {
        // If professor already set a final score, use it directly
        if (result.score !== undefined && result.score !== null) {
            const score = parseFloat(result.score);
            if (!isNaN(score) && score >= 0 && score <= 100) {
                console.log(`‚úÖ Using stored professor score: ${score} for ${testName}`);
                return score;
            }
        }
    }
    
    // Extract numeric value from result
    let numericValue = 0;
    
    if (typeof result === 'object' && result !== null) {
        numericValue = result.repetitions || result.time || result.distance || 
                      result.value || result.result || result.count || 
                      result.score || 0;
    } else if (typeof result === 'string') {
        const match = result.match(/(\d+\.?\d*)/);
        if (match) {
            numericValue = parseFloat(match[1]);
        } else {
            numericValue = parseFloat(result) || 0;
        }
    } else {
        numericValue = parseFloat(result) || 0;
    }
    
    console.log(`üéØ Calculating: ${testName} | Value: ${numericValue} | Target: ${testTarget}`);
    
    // Use test target if available - THIS IS THE KEY SECTION
    if (testTarget && testTarget > 0) {
        // REPETITION TESTS (push-ups, sit-ups, curl-ups)
        if (normalized.includes('push-up') || normalized.includes('pushup') || 
            normalized.includes('sit-up') || normalized.includes('situp') ||
            normalized.includes('curl-up')) {
            
            const reps = numericValue;
            if (reps >= testTarget) return 100;
            
            const percentage = (reps / testTarget) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            // Apply grading scale
            if (percentage >= 100) score = 100;
            else if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            return Math.round(score);
        }
        
        // PLANK (time-based in seconds)
        if (normalized.includes('plank')) {
            let seconds = numericValue;
            if (seconds >= testTarget) return 100;
            
            const percentage = (seconds / testTarget) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 100) score = 100;
            else if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            return Math.round(score);
        }
        
        // SIT-AND-REACH (flexibility in cm)
        if (normalized.includes('sit-and-reach')) {
            const distance = numericValue;
            if (distance >= testTarget) return 100;
            
            const percentage = (distance / testTarget) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 100) score = 100;
            else if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            return Math.round(score);
        }
        
        // GRIP STRENGTH (kg)
        if (normalized.includes('grip')) {
            if (numericValue >= testTarget) return 100;
            
            const percentage = (numericValue / testTarget) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            return Math.round(score);
        }
        
        // 1-MILE RUN (seconds - LOWER IS BETTER)
        if (normalized.includes('mile') || normalized.includes('run')) {
            if (numericValue <= testTarget) return 100;
            
            const percentage = (testTarget / numericValue) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            return Math.round(score);
        }
        
        // STEP TEST (heart rate - LOWER IS BETTER)
        if (normalized.includes('step test') || normalized.includes('3-minute')) {
            if (numericValue <= testTarget) return 100;
            
            const percentage = (testTarget / numericValue) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            return Math.round(score);
        }
    }
    
    // Fallback to default scoring if no target set
    return calculateDefaultScore(normalized, numericValue);
}
        function getGradeLetter(score) {
            if (score >= 95) return 'A+';
            if (score >= 90) return 'A';
            if (score >= 85) return 'B+';
            if (score >= 80) return 'B';
            if (score >= 75) return 'C+';
            if (score >= 70) return 'C';
            if (score >= 65) return 'D';
            return 'F';
        }

        function getGradeColor(score) {
            if (score >= 90) return 'text-green-600';
            if (score >= 80) return 'text-blue-600';
            if (score >= 70) return 'text-yellow-600';
            return 'text-red-600';
        }

        async function loadStudentData(user) {
            try {
                const studentsQuery = query(
                    collection(db, 'students'),
                    where('email', '==', user.email)
                );
                const studentsSnapshot = await getDocs(studentsQuery);
                
                if (!studentsSnapshot.empty) {
                    studentsSnapshot.forEach((doc) => {
                        studentData = doc.data();
                    });
                }
                return studentData;
            } catch (error) {
                console.error('Error loading student data:', error);
                return null;
            }
        }

        async function loadGrades() {
    try {
        if (!studentData || !studentData.email) {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            return;
        }

        // Get all assigned tests (including overdue ones)
        const assignedTestsQuery = query(
            collection(db, 'scheduledTests'),
            where('section', '==', studentData.section),
            where('isVisible', '==', true),
            where('isActive', '==', true)
        );
        
        let totalAssignedTests = 0;
        let overdueTests = 0;
        let completedTests = 0;
        
        // Set up listener for assigned tests
        onSnapshot(assignedTestsQuery, async (assignedSnapshot) => {
            totalAssignedTests = assignedSnapshot.size;
            overdueTests = 0;
            
            // Check for overdue tests
            const now = new Date();
            assignedSnapshot.forEach((doc) => {
                const test = doc.data();
                if (test.dueDate) {
                    const dueDate = test.dueDate.toDate();
                    if (dueDate < now) {
                        overdueTests++;
                    }
                }
            });
            
            document.getElementById('totalTests').textContent = `/${totalAssignedTests}`;
            
            // Now load the completed tests to calculate completion rate
            const resultsQuery = query(
                collection(db, 'testResults'),
                where('studentEmail', '==', studentData.email),
                where('status', 'in', ['completed', 'overdue']) // Include overdue status
            );
            
            const resultsSnapshot = await getDocs(resultsQuery);
            completedTests = resultsSnapshot.size;
            
            // Calculate actual completion rate (completed / total)
            const completionRate = totalAssignedTests > 0 ? 
                Math.round((completedTests / totalAssignedTests) * 100) : 0;
            
            document.getElementById('completedTests').textContent = completedTests;
            document.getElementById('completionRate').textContent = completionRate + '%';
            
            // Load real-time updates for test results
            setupRealTimeGradeListener(overdueTests);
        });
        
    } catch (error) {
        console.error('Error loading grades:', error);
        document.getElementById('loadingScreen').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
    }
}


    async function setupRealTimeGradeListener(overdueCount) {
    try {
        const resultsQuery = query(
            collection(db, 'testResults'),
            where('studentEmail', '==', studentData.email),
            where('status', 'in', ['completed', 'overdue', 'late'])
        );
        
        onSnapshot(resultsQuery, (resultsSnapshot) => {
            const testResults = [];
            const categoryScores = {};
            const OVERDUE_PENALTY = 0.10;
            
            // Initialize categories
            Object.keys(testCategories).forEach(cat => {
                categoryScores[cat] = { scores: [], tests: [] };
            });
            
            let totalScore = 0;
            let testCount = 0;
            let hasOverdueWithPenalty = false;
            let penaltyInfo = [];
            
            const testGroups = {};

            resultsSnapshot.forEach((doc) => {
    const result = doc.data();
    
    // ‚≠ê Check if professor override exists first
    const isProfessorOverride = result.isProfessorOverride === true;
    
    let score = 0;
    
    if (isProfessorOverride && typeof result.score === 'number' && !isNaN(result.score)) {
        // Use professor's score directly
        score = result.score;
        console.log(`‚úÖ Professor override: ${score} for ${result.testName}`);
    } else {
        // Calculate normally
        score = calculateScore(
            result.testName, 
            result.result || result.resultData, 
            result.testTarget
        );
        
        // ‚≠ê Apply penalty ONLY if overdue AND not professor override
        const isOverdue = (result.status === 'overdue' || result.status === 'late');
        if (isOverdue && !isProfessorOverride) {
            const originalScore = score;
            const penalty = score * OVERDUE_PENALTY;
            score = Math.max(0, score - penalty);
            hasOverdueWithPenalty = true;
            console.log(`‚ö†Ô∏è Penalty: ${originalScore.toFixed(1)} ‚Üí ${score.toFixed(1)}`);
        }
    }
    
    // Validate score
    score = Math.max(0, Math.min(100, score));
                
                const category = getCategoryForTest(result.testName);
                const testId = result.testId || doc.id;
                
                // Keep highest score per test
                if (!testGroups[testId] || score > testGroups[testId].score) {
                    testGroups[testId] = {
                        ...result,
                        score,
                        category,
                        id: doc.id,
                        isProfessorOverride: isProfessorOverride,
                        isOverdue: result.status === 'overdue' || result.status === 'late'
                    };
                }
            });

            // Calculate totals from best scores
            Object.values(testGroups).forEach(result => {
                // Ensure score is valid
                if (typeof result.score === 'number' && !isNaN(result.score) && result.score >= 0) {
                    testResults.push(result);
                    
                    if (categoryScores[result.category]) {
                        categoryScores[result.category].scores.push(result.score);
                        categoryScores[result.category].tests.push({
                            name: result.testName,
                            score: result.score,
                            isOverdue: result.isOverdue
                        });
                    }
                    
                    totalScore += result.score;
                    testCount++;
                }
            });
            
            // Update final grade - ensure no NaN
            const avgScore = testCount > 0 ? (totalScore / testCount).toFixed(1) : '0.0';
            const finalGrade = document.getElementById('finalGrade');
            
            if (hasOverdueWithPenalty) {
                finalGrade.innerHTML = `
                    ${avgScore}
                    <div class="text-xs text-red-600 font-normal mt-2">
                        ‚ö†Ô∏è 10% penalty applied to overdue test(s)<br>
                        <span class="text-[10px]">Retake tests to remove penalty</span>
                    </div>
                `;
            } else {
                finalGrade.textContent = avgScore;
            }
            
            document.getElementById('completedTests').textContent = testCount;
            
            renderCategoryGrades(categoryScores);
            renderTestResults(testResults);
            
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
        });
        
    } catch (error) {
        console.error('Error in real-time listener:', error);
        document.getElementById('loadingScreen').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
    }
}
        function validateScore(score) {
    if (score === null || score === undefined || score === '' || isNaN(score)) {
        return 0;
    }
    
    const numScore = parseFloat(score);
    if (isNaN(numScore)) {
        return 0;
    }
    
    // Ensure score is between 0 and 100
    return Math.max(0, Math.min(100, numScore));
}
        function renderCategoryGrades(categoryScores) {
    const container = document.getElementById('categoriesContainer');
    
    if (!container) {
        console.error('Categories container not found');
        return;
    }
    
    let html = '';
    let hasData = false;
    
    Object.entries(categoryScores).forEach(([category, data]) => {
        if (data.scores.length > 0) {
            hasData = true;
            const avgScore = (data.scores.reduce((a, b) => a + b, 0) / data.scores.length).toFixed(1);
            
            const scoreColor = parseFloat(avgScore) >= 85 ? 'text-green-600' : 
                              parseFloat(avgScore) >= 75 ? 'text-blue-600' : 
                              parseFloat(avgScore) >= 65 ? 'text-yellow-600' : 'text-red-600';
            
            // Count overdue tests in this category
            const overdueCount = data.tests.filter(test => test.isOverdue).length;
            
            html += `
                <div class="px-4 py-4 md:px-6 hover:bg-gray-50 transition-colors">
                    <!-- Mobile Layout -->
                    <div class="block md:hidden">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-semibold text-gray-900 text-sm">${category}</h4>
                            ${overdueCount > 0 ? 
                                `<span class="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded-full">${overdueCount} overdue</span>` 
                                : ''}
                        </div>
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-xs text-gray-500 mb-1">${data.scores.length} test${data.scores.length !== 1 ? 's' : ''}</p>
                                <span class="text-2xl font-bold ${scoreColor}">${avgScore}</span>
                                <span class="text-xs text-gray-400 ml-1">/ 100</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Desktop Layout -->
                    <div class="hidden md:grid grid-cols-12 gap-4 items-center">
                        <div class="col-span-5">
                            <h4 class="font-semibold text-gray-900">${category}</h4>
                            <p class="text-xs text-gray-500 mt-0.5">
                                ${data.scores.length} test${data.scores.length !== 1 ? 's' : ''}
                                ${overdueCount > 0 ? 
                                    ` ‚Ä¢ <span class="text-red-600">${overdueCount} overdue</span>` 
                                    : ''}
                            </p>
                        </div>
                        <div class="col-span-3 text-center">
                            <span class="text-gray-600">${data.scores.length} taken</span>
                        </div>
                        <div class="col-span-4 text-right flex items-center justify-end gap-4">
                            <span class="text-3xl font-bold ${scoreColor}">${avgScore}</span>
                        </div>
                    </div>
                </div>
            `;
        }
    });
    
    if (!hasData) {
        html = `
            <div class="px-6 py-12 text-center">
                <i class="bi bi-inbox text-gray-300 text-5xl mb-3 block"></i>
                <p class="text-gray-500">No category data available yet</p>
                <p class="text-gray-400 text-sm mt-2">Complete tests to see your performance by category</p>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

        function renderTestResults(testResults) {
    const container = document.getElementById('testResultsContainer');
    
    if (!container) {
        console.error('Test results container not found');
        return;
    }
    
    if (!testResults || testResults.length === 0) {
        container.innerHTML = `
            <div class="px-6 py-12 text-center">
                <i class="bi bi-clipboard-x text-gray-300 text-5xl mb-3 block"></i>
                <p class="text-gray-500 font-medium">No test results yet</p>
                <p class="text-gray-400 text-sm mt-2">Complete tests to see your results here</p>
            </div>
        `;
        return;
    }
    
    // Sort by date - most recent first
    testResults.sort((a, b) => {
        const dateA = a.submittedAt?.toDate?.() || new Date(0);
        const dateB = b.submittedAt?.toDate?.() || new Date(0);
        return dateB - dateA;
    });
    
    console.log('Rendering', testResults.length, 'test results');
    
    let html = '';
    testResults.forEach((result) => {
        const scoreColor = result.score >= 85 ? 'text-green-600' : 
                          result.score >= 75 ? 'text-blue-600' : 
                          result.score >= 65 ? 'text-yellow-600' : 'text-red-600';
        
        const date = result.submittedAt?.toDate 
            ? result.submittedAt.toDate().toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            })
            : (result.submittedAt ? new Date(result.submittedAt).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            }) : 'N/A');
        
        // Check if test is overdue
        const isOverdue = result.status === 'overdue' || result.status === 'late';
        const isProfessorOverride = result.isProfessorOverride === true;
        
        html += `
            <div class="px-6 py-4 hover:bg-gray-50 transition-colors ${isOverdue && !isProfessorOverride ? 'bg-red-50/30' : ''}">
                <!-- Mobile Layout -->
                <div class="block md:hidden">
                    <div class="mb-3">
                        <h4 class="font-semibold text-gray-900 text-sm mb-1">
                            ${result.testName}
                            ${isProfessorOverride ? 
                                '<span class="ml-2 text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">‚úì Professor Set</span>' : 
                                ''}
                            ${isOverdue && !isProfessorOverride ? 
                                '<span class="ml-2 text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded-full font-semibold">‚ö†Ô∏è Overdue (-10%)</span>' : 
                                ''}
                        </h4>
                        <p class="text-xs text-gray-500">${result.category}</p>
                        <p class="text-xs text-gray-400 mt-1">
                            <i class="bi bi-calendar3"></i> ${date}
                        </p>
                    </div>
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="text-2xl font-bold ${scoreColor}">${result.score.toFixed(1)}</span>
                            <span class="text-xs text-gray-400 ml-1">/ 100</span>
                            ${isOverdue && !isProfessorOverride ? 
                                '<p class="text-xs text-red-600 mt-1">Penalty applied</p>' : 
                                ''}
                        </div>
                        <a href="./studentresult.html?resultId=${result.id}" 
                           class="text-blue-600 hover:text-blue-700 text-sm font-medium inline-flex items-center gap-1">
                            View <i class="bi bi-arrow-right"></i>
                        </a>
                    </div>
                </div>
                
                <!-- Desktop Layout -->
                <div class="hidden md:grid grid-cols-12 gap-4 items-center">
                    <div class="col-span-4">
                        <h4 class="font-semibold text-gray-900">
                            ${result.testName}
                            ${isProfessorOverride ? 
                                '<span class="ml-2 text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">‚úì Professor Set</span>' : 
                                ''}
                            ${isOverdue && !isProfessorOverride ? 
                                '<span class="ml-2 text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded-full font-semibold">‚ö†Ô∏è Overdue (-10%)</span>' : 
                                ''}
                        </h4>
                        <p class="text-xs text-gray-500 mt-1">${result.category}</p>
                    </div>
                    <div class="col-span-3">
                        <div class="flex flex-col">
                            <span class="text-gray-600 text-sm">${result.category}</span>
                            ${isOverdue && !isProfessorOverride ? 
                                '<span class="text-xs text-red-600 font-semibold mt-1">‚ö†Ô∏è Submitted Late</span>' : 
                                ''}
                        </div>
                    </div>
                    <div class="col-span-2 text-center">
                        <span class="text-gray-600 text-sm">
                            <i class="bi bi-calendar3"></i> ${date}
                        </span>
                    </div>
                    <div class="col-span-2 text-right">
                        <div>
                            <span class="text-3xl font-bold ${scoreColor}">${result.score.toFixed(1)}</span>
                            <span class="text-xs text-gray-400 ml-1">/ 100</span>
                            ${isOverdue && !isProfessorOverride ? 
                                '<p class="text-xs text-red-600 mt-1 font-medium">With penalty</p>' : 
                                ''}
                        </div>
                    </div>
                    <div class="col-span-1 text-right">
                        <a href="./studentresult.html?resultId=${result.id}" 
                           class="text-blue-600 hover:text-blue-700 text-sm font-medium inline-flex items-center gap-1 hover:gap-2 transition-all">
                            View <i class="bi bi-arrow-right"></i>
                        </a>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}
onAuthStateChanged(auth, async (user) => {
    if (user) {
        currentUser = user;  
        // Hide loading screen faster by showing main content while loading data
        setTimeout(() => {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
        }, 1500); // Max 1.5 second loading screen
        
        // Load data in background
        await loadEssentialData(user);
        await loadGrades();
        updateProfileUI();  
    } else {
        window.location.href = '../login/index.html';
    }
});
    </script>
</body>
</html>