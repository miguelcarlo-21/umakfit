<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UMakFit - Active Test</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Manrope:wght@600;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
    @import url("https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css");
    
    * {
        -webkit-font-smoothing: antialiased;
        box-sizing: border-box;
        font-family: 'Inter', sans-serif;
    }
    
    html, body {
        margin: 0;
        height: 100%;
    }
    
    button:focus-visible {
        outline: 2px solid #4a90e2 !important;
    }
    
    a {
        text-decoration: none;
    }

    body {
      
        background: #f8fafc;
        min-height: 100vh;
    }

    /* Navbar Styles - Match testdetails.html */
    .navbar-custom {
        background: linear-gradient(180deg, rgba(30, 58, 138, 1) 0%, rgba(59, 130, 246, 1) 100%);
        padding: 20px 0;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border-bottom: none;
        height: auto;
    }

    .navbar-brand {
        display: flex;
        align-items: center;
        gap: 15px;
        margin: 0;
        padding: 0;
    }

    .navbar-brand-img {
        height: 60px;
        width: auto;
        object-fit: contain;
    }

    .navbar-brand-text {
        font-family: "Manrope", Helvetica;
        font-weight: 800;
        font-size: 28px;
        background: linear-gradient(90deg, rgba(245, 158, 11, 1) 0%, rgba(255, 229, 0, 1) 100%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        line-height: 1;
    }

    .nav-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 20px;
    }

    .nav-pills-custom {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 0;
        margin: 0;
        list-style: none;
    }

    .nav-link-custom {
        font-family: "Manrope", Helvetica;
        font-weight: 600;
        color: #000000;
        font-size: 14px;
        padding: 12px 18px;
        border-radius: 8px;
        background-color: #ffffff;
        transition: all 0.3s;
        border: none;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        text-decoration: none;
    }

    .nav-link-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        color: #000000;
    }

    .nav-link-custom i {
        font-size: 14px;
    }

    .nav-link-custom.active {
        background: linear-gradient(90deg, rgba(251, 191, 36, 1) 0%, rgba(245, 158, 11, 1) 100%);
        box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
    }

    .btn-logout-nav {
        background: linear-gradient(90deg, rgba(251, 191, 36, 1) 0%, rgba(245, 158, 11, 1) 100%);
        border: none;
        color: #000000;
        padding: 8px 20px;
        border-radius: 8px;
        font-family: "Manrope", Helvetica;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-logout-nav:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(245, 158, 11, 0.4);
    }

    /* Main Content */
    .main-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }

    /* Back Button */
    .back-button {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        border-radius: 10px;
        border: 2px solid #1e3a8a;
        background-color: white;
        color: #1e3a8a;
        font-family: "Inter", Helvetica;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 2px 8px rgba(30, 58, 138, 0.15);
        margin-bottom: 2rem;
    }

    .back-button:hover {
        background: #1e3a8a;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
    }

    /* Test Container */
    .test-container {
        background: white;
        border-radius: 20px;
        padding: 3rem;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
        margin-bottom: 2rem;
    }

    /* Test Header */
    .test-active-header {
        text-align: center;
        margin-bottom: 3rem;
        padding-bottom: 2rem;
        border-bottom: 3px solid #e5e7eb;
    }

    .test-active-title {
        font-family: "Inter", Helvetica;
        font-weight: 800;
        color: #1e3a8a;
        font-size: 2.5rem;
        margin-bottom: 0.75rem;
        letter-spacing: -0.5px;
    }

    .test-active-subtitle {
        font-family: "Inter", Helvetica;
        font-weight: 500;
        color: #64748b;
        font-size: 16px;
        margin-bottom: 1.5rem;
    }

    /* Status Badge */
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        border-radius: 25px;
        font-family: "Inter", Helvetica;
        font-weight: 600;
        font-size: 14px;
        letter-spacing: 0.3px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .status-ready {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        color: #1e40af;
        border: 2px solid #93c5fd;
    }

    .status-running {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        color: #065f46;
        border: 2px solid #6ee7b7;
        animation: pulse 2s ease-in-out infinite;
    }

    .status-paused {
        background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%);
        color: #92400e;
        border: 2px solid #fb923c;
    }

    .status-completed {
        background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
        color: #3730a3;
        border: 2px solid #a5b4fc;
    }

    @keyframes pulse {
        0%, 100% {
            transform: scale(1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        50% {
            transform: scale(1.05);
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
        }
    }

    /* Instructions Card */
    .instructions-card {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border-radius: 16px;
        padding: 1.75rem;
        margin-bottom: 3rem;
        border-left: 5px solid #f59e0b;
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.15);
    }

    .instructions-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 1rem;
    }

    .instructions-icon {
        font-size: 24px;
        color: #92400e;
    }

    .instructions-title {
        font-family: "Inter", Helvetica;
        font-weight: 700;
        color: #92400e;
        font-size: 18px;
        margin: 0;
    }

    .instructions-text {
        font-family: "Inter", Helvetica;
        font-weight: 500;
        color: #78350f;
        font-size: 15px;
        line-height: 1.7;
        margin: 0;
    }

    /* Timer Section */
    .timer-section {
        text-align: center;
        margin-bottom: 3rem;
    }

    .timer-label {
        font-family: "Inter", Helvetica;
        font-weight: 700;
        color: #475569;
        font-size: 14px;
        margin-bottom: 1.5rem;
        text-transform: uppercase;
        letter-spacing: 1.5px;
    }

    .timer-display {
        background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        border-radius: 24px;
        padding: 3rem 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 12px 32px rgba(59, 130, 246, 0.35);
        position: relative;
        overflow: hidden;
    }

    .timer-display::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
        pointer-events: none;
    }

    .timer-digits {
        font-family: "Inter", Helvetica;
        font-weight: 800;
        color: white;
        font-size: 5rem;
        letter-spacing: 4px;
        text-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        position: relative;
    }

    .timer-milliseconds {
        font-size: 3rem;
        opacity: 0.85;
    }

    /* Timer Controls */
    .timer-controls {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 3rem;
        flex-wrap: wrap;
    }

    .btn-timer {
        padding: 14px 36px;
        border-radius: 12px;
        border: none;
        font-family: "Inter", Helvetica;
        font-weight: 700;
        font-size: 15px;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .btn-start {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }

    .btn-start:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }

    .btn-pause {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
    }

    .btn-pause:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
    }

    .btn-stop {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }

    .btn-stop:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
    }

    .btn-reset {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        color: white;
    }

    .btn-reset:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(107, 114, 128, 0.4);
    }

    /* Input Section */
    .input-section {
        max-width: 700px;
        margin: 0 auto 3rem;
    }

    .input-group-custom {
        margin-bottom: 2rem;
    }

    .input-label {
        font-family: "Inter", Helvetica;
        font-weight: 700;
        color: #1e3a8a;
        font-size: 16px;
        margin-bottom: 0.75rem;
        display: block;
    }

    .input-field {
        width: 100%;
        padding: 14px 18px;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        font-family: "Inter", Helvetica;
        font-weight: 500;
        font-size: 18px;
        color: #1e3a8a;
        transition: all 0.3s;
        background: #f9fafb;
    }

    .input-field:focus {
        outline: none;
        border-color: #3b82f6;
        background: white;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }

    .input-hint {
        font-family: "Inter", Helvetica;
        font-weight: 500;
        color: #64748b;
        font-size: 13px;
        margin-top: 0.75rem;
        font-style: italic;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    /* Notes Section */
    .notes-textarea {
        width: 100%;
        min-height: 120px;
        padding: 14px 18px;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        font-family: "Inter", Helvetica;
        font-weight: 400;
        font-size: 15px;
        color: #1e3a8a;
        resize: vertical;
        transition: all 0.3s;
        background: #f9fafb;
    }

    .notes-textarea:focus {
        outline: none;
        border-color: #3b82f6;
        background: white;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }

    /* Submit Section */
    .submit-section {
        text-align: center;
        padding-top: 2.5rem;
        border-top: 3px solid #e5e7eb;
    }

    .btn-submit {
        background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        border: none;
        color: white;
        padding: 16px 56px;
        border-radius: 12px;
        font-family: "Inter", Helvetica;
        font-weight: 700;
        font-size: 17px;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 6px 16px rgba(59, 130, 246, 0.35);
        display: inline-flex;
        align-items: center;
        gap: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .btn-submit:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 8px 24px rgba(59, 130, 246, 0.45);
    }

    .btn-submit:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    /* Loading Screen */
    .loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.98);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        flex-direction: column;
        gap: 24px;
    }

    .spinner {
        border: 5px solid #e5e7eb;
        border-top: 5px solid #3b82f6;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loading-text {
        font-family: "Inter", sans-serif;
        font-weight: 600;
        color: #475569;
        font-size: 18px;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .main-content {
            padding: 1rem;
        }

        .test-container {
            padding: 2rem 1.5rem;
        }

        .test-active-title {
            font-size: 1.75rem;
        }

        .timer-digits {
            font-size: 3.5rem;
        }

        .timer-milliseconds {
            font-size: 2rem;
        }

        .timer-controls {
            flex-direction: column;
        }

        .btn-timer {
            width: 100%;
            justify-content: center;
        }

        .btn-submit {
            width: 100%;
            justify-content: center;
        }
    }
    </style>
</head>
<body>
    <div id="loadingScreen" class="loading">
        <div class="spinner"></div>
        <div class="loading-text">Loading Test...</div>
    </div>

    <div id="mainContent" style="display: none;">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-custom">
            <div class="container">
                <div class="nav-container w-100">
                    <a class="navbar-brand" href="#">
                        <img src="https://c.animaapp.com/vkhEa8zW/img/screenshot-2025-09-19-2-53-51-pm-removebg-preview-3@2x.png" 
                             alt="UMak Logo" class="navbar-brand-img">
                        <span class="navbar-brand-text">UMakFit</span>
                    </a>
                    
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="nav-pills-custom ms-auto">
                            <li class="nav-item">
                                <a class="nav-link-custom" href="./studentDashboard.html">
                                    <i class="bi bi-speedometer2"></i> Dashboard
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link-custom" href="./studentProfile.html">
                                    <i class="bi bi-person-circle"></i> Profile
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link-custom active" href="./test.html">
                                    <i class="bi bi-clipboard-check"></i> Test
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link-custom" href="./progress.html">
                                    <i class="bi bi-graph-up"></i> Progress
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link-custom" href="#">
                                    <i class="bi bi-book"></i> Learn
                                </a>
                            </li>
                            <li class="nav-item d-flex align-items-center gap-2 ms-2">
                                <button class="btn-logout-nav" onclick="handleLogout()">
                                    <i class="bi bi-box-arrow-right"></i> Logout
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        <div class="main-content">
            <!-- Back Button -->
            <button class="back-button" onclick="window.history.back()">
                <i class="bi bi-arrow-left"></i> Back to Test Details
            </button>

            <!-- Test Container -->
            <div class="test-container">
                <!-- Test Header -->
                <div class="test-active-header">
                    <h1 class="test-active-title" id="testName">Loading Test...</h1>
                    <p class="test-active-subtitle" id="testSubtitle">Prepare yourself and click start when ready</p>
                    <div style="margin-top: 1.5rem;">
                        <span class="status-badge status-ready" id="statusIndicator">
                            <i class="bi bi-circle-fill" style="font-size: 10px;"></i>
                            Ready to Start
                        </span>
                    </div>
                </div>

                <!-- Instructions Card -->
                <div class="instructions-card">
                    <div class="instructions-header">
                        <i class="bi bi-info-circle-fill instructions-icon"></i>
                        <h3 class="instructions-title">Quick Instructions</h3>
                    </div>
                    <p class="instructions-text" id="quickInstructions">
                        Click "START" to begin the timer. Complete the test according to the protocol. 
                        When finished, click "STOP" and enter your results below.
                    </p>
                </div>

                <!-- Timer Section -->
                <div class="timer-section">
                    <div class="timer-label" id="timerLabel">‚è±Ô∏è STOPWATCH</div>
                    <div class="timer-display">
                        <div class="timer-digits">
                            <span id="minutes">00</span>:<span id="seconds">00</span><span class="timer-milliseconds">.<span id="milliseconds">00</span></span>
                        </div>
                    </div>

                    <!-- Timer Controls -->
                    <div class="timer-controls" id="timerControls">
                        <button class="btn-timer btn-start" id="startBtn" onclick="startTimer()">
                            <i class="bi bi-play-fill"></i> Start
                        </button>
                        <button class="btn-timer btn-pause" id="pauseBtn" onclick="pauseTimer()" style="display: none;">
                            <i class="bi bi-pause-fill"></i> Pause
                        </button>
                        <button class="btn-timer btn-stop" id="stopBtn" onclick="stopTimer()" style="display: none;">
                            <i class="bi bi-stop-fill"></i> Stop
                        </button>
                        <button class="btn-timer btn-reset" id="resetBtn" onclick="resetTimer()" style="display: none;">
                            <i class="bi bi-arrow-clockwise"></i> Reset
                        </button>
                    </div>
                </div>

                <!-- Input Section -->
                <div class="input-section" id="inputSection">
                    <!-- Dynamic inputs will be inserted here based on test type -->
                </div>

                <!-- Notes Section -->
                <div class="input-section">
                    <div class="input-group-custom">
                        <label class="input-label">üìù Additional Notes (Optional)</label>
                        <textarea class="notes-textarea" id="notesField" placeholder="Add any observations, difficulties, or comments about your test performance..."></textarea>
                        <div class="input-hint">
                            <i class="bi bi-lightbulb"></i>
                            These notes will help your instructor understand your test experience
                        </div>
                    </div>
                </div>

                <!-- Submit Section -->
                <div class="submit-section">
                    <button class="btn-submit" id="submitBtn" onclick="submitTest()" disabled>
                        <i class="bi bi-check-circle-fill"></i> Submit Test Results
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, collection, addDoc, serverTimestamp, updateDoc, increment, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAgaLunqEf2gs6dSpF_sz1hV5XQ5Wm52jo",
            authDomain: "umakfit-e3b1d.firebaseapp.com",
            projectId: "umakfit-e3b1d",
            storageBucket: "umakfit-e3b1d.appspot.com",
            messagingSenderId: "276569891504",
            appId: "1:276569891504:web:39b1732b519f4d8b785175"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables
        let currentUser = null;
        let studentData = null;
        let currentTest = null;
        let timerInterval = null;
        let startTime = 0;
        let elapsedTime = 0;
        let isRunning = false;
        let isPaused = false;

        // Timer functions
        window.startTimer = async function() {
    if (!isRunning) {
        // Create active test document when starting
        window.activeTestId = await createActiveTestDocument();
        
        isRunning = true;
        isPaused = false;
        startTime = Date.now() - elapsedTime;
        timerInterval = setInterval(updateTimer, 1000); // Update every second
        
        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('pauseBtn').style.display = 'inline-flex';
        document.getElementById('stopBtn').style.display = 'inline-flex';
        document.getElementById('resetBtn').style.display = 'none';
        
        updateStatus('running', 'Test in Progress');
        
        // Update initial progress
        await updateActiveTestProgress(10);
    }
};

// Update the timer to track progress
function updateTimer() {
    elapsedTime = Date.now() - startTime;
    
    const totalSeconds = Math.floor(elapsedTime / 1000);
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    const milliseconds = Math.floor((elapsedTime % 1000) / 10);
    
    document.getElementById('minutes').textContent = String(minutes).padStart(2, '0');
    document.getElementById('seconds').textContent = String(seconds).padStart(2, '0');
    document.getElementById('milliseconds').textContent = String(milliseconds).padStart(2, '0');
    
    // Update progress based on time (simulate progress)
    const progress = Math.min(10 + Math.floor(totalSeconds / 2), 95);
    
    // Update active test with current metrics
    updateActiveTestProgress(progress, {
        timeElapsed: `${minutes}:${seconds.toString().padStart(2, '0')}`,
        // Simulate some form analysis data
        formAnalysis: {
            formScore: Math.min(70 + Math.floor(totalSeconds / 5), 95),
            feedback: getSimulatedFeedback(progress)
        }
    });
}

function getSimulatedFeedback(progress) {
    if (progress < 30) return "Starting strong, maintain good form";
    if (progress < 60) return "Good pace, focus on breathing";
    if (progress < 90) return "Excellent form, keep it up";
    return "Almost done, finish strong";
}

window.stopTimer = async function() {
    if (isRunning || isPaused) {
        isRunning = false;
        isPaused = false;
        clearInterval(timerInterval);
        
        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('pauseBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display = 'none';
        document.getElementById('resetBtn').style.display = 'inline-flex';
        document.getElementById('submitBtn').disabled = false;
        
        updateStatus('completed', 'Test Completed');
        
        // Update progress to 100% and complete
        await updateActiveTestProgress(100, {
            formAnalysis: {
                formScore: 85,
                feedback: "Test completed successfully"
            }
        });
        await completeActiveTest();
        
        // Auto-fill timer value
        const timerValue = `${document.getElementById('minutes').textContent}:${document.getElementById('seconds').textContent}`;
        const durationInput = document.getElementById('durationInput');
        const timeInput = document.getElementById('timeInput');
        
        if (durationInput) durationInput.value = timerValue;
        if (timeInput) timeInput.value = timerValue;
    }
};

        window.resetTimer = function() {
            if (confirm('Are you sure you want to reset the timer? Your current time will be lost.')) {
                clearInterval(timerInterval);
                isRunning = false;
                isPaused = false;
                elapsedTime = 0;
                
                document.getElementById('minutes').textContent = '00';
                document.getElementById('seconds').textContent = '00';
                document.getElementById('milliseconds').textContent = '00';
                
                document.getElementById('startBtn').style.display = 'inline-flex';
                document.getElementById('startBtn').innerHTML = '<i class="bi bi-play-fill"></i> Start';
                document.getElementById('pauseBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'none';
                document.getElementById('resetBtn').style.display = 'none';
                document.getElementById('submitBtn').disabled = true;
                
                updateStatus('ready', 'Ready to Start');
            }
        };

       

        function updateStatus(status, text) {
            const indicator = document.getElementById('statusIndicator');
            indicator.className = `status-badge status-${status}`;
            indicator.innerHTML = `<i class="bi bi-circle-fill" style="font-size: 10px;"></i> ${text}`;
        }

                function setupTestInputs(testName) {
            const inputSection = document.getElementById('inputSection');
            const timerSection = document.querySelector('.timer-section');
            let html = '';

            const normalizedName = testName.toLowerCase();

            // Determine if test needs timer
            const needsTimer = normalizedName.includes('plank') || 
                            normalizedName.includes('step test') || 
                            normalizedName.includes('3-minute') ||
                            normalizedName.includes('mile') || 
                            normalizedName.includes('run') ||
                            normalizedName.includes('1-mile');

            // Show/hide timer
            if (needsTimer) {
                timerSection.style.display = 'block';
            } else {
                timerSection.style.display = 'none';
            }

            // CURL-UP TEST (NEW)
            if (normalizedName.includes('curl-up') || normalizedName.includes('curl up')) {
                const targetHint = currentTest.testTarget ? ` (Target: ${currentTest.testTarget} curl-ups)` : '';
                html = `
                    <div class="input-group-custom">
                        <label class="input-label">üí™ Number of Curl-Ups Completed <span style="color: #ef4444;">*</span></label>
                        <input type="number" class="input-field" id="repetitionsInput" placeholder="Enter number of curl-ups${targetHint}" min="0" required>
                        <div class="input-hint">
                            <i class="bi bi-info-circle"></i>
                            Count only complete curl-ups at 1 per 3 seconds pace${targetHint}
                        </div>
                    </div>
                `;
                document.getElementById('submitBtn').disabled = false;
            }
            // PUSH-UP TEST
            else if (normalizedName.includes('push-up') || normalizedName.includes('pushup')) {
                const targetHint = currentTest.testTarget ? ` (Target: ${currentTest.testTarget} push-ups)` : '';
                html = `
                    <div class="input-group-custom">
                        <label class="input-label">üí™ Number of Push-ups Completed <span style="color: #ef4444;">*</span></label>
                        <input type="number" class="input-field" id="repetitionsInput" placeholder="Enter number of push-ups${targetHint}" min="0" required>
                        <div class="input-hint">
                            <i class="bi bi-info-circle"></i>
                            Count only complete push-ups with proper form${targetHint}
                        </div>
                    </div>
                `;
                document.getElementById('submitBtn').disabled = false;
            }
            // GRIP STRENGTH (NEW)
            else if (normalizedName.includes('grip strength') || normalizedName.includes('grip')) {
                const targetHint = currentTest.testTarget ? ` (Target: ${currentTest.testTarget} kg)` : '';
                html = `
                    <div class="input-group-custom">
                        <label class="input-label">üí™ Grip Strength (kg) <span style="color: #ef4444;">*</span></label>
                        <input type="number" class="input-field" id="strengthInput" placeholder="Enter grip strength${targetHint}" step="0.1" min="0" required>
                        <div class="input-hint">
                            <i class="bi bi-info-circle"></i>
                            Record the highest reading from 3 attempts per hand${targetHint}
                        </div>
                    </div>
                `;
                document.getElementById('submitBtn').disabled = false;
            }
            // PLANK HOLD
            else if (normalizedName.includes('plank')) {
                const targetHint = currentTest.testTarget ? ` (Target: ${currentTest.testTarget} seconds)` : '';
                html = `
                    <div class="input-group-custom">
                        <label class="input-label">‚è±Ô∏è Plank Hold Duration <span style="color: #ef4444;">*</span></label>
                        <input type="text" class="input-field" id="durationInput" placeholder="Use timer above${targetHint}" readonly>
                        <div class="input-hint">
                            <i class="bi bi-info-circle"></i>
                            Use the timer above to track your plank hold time${targetHint}
                        </div>
                    </div>
                `;
            }
            // 3-MINUTE STEP TEST
            else if (normalizedName.includes('step test') || normalizedName.includes('3-minute')) {
                const targetHint = currentTest.testTarget ? ` (Target duration: ${currentTest.testTarget} minutes)` : '';
                html = `
                    <div class="input-group-custom">
                        <label class="input-label">‚ù§Ô∏è Recovery Heart Rate (bpm) <span style="color: #ef4444;">*</span></label>
                        <input type="number" class="input-field" id="heartRateInput" placeholder="Enter 60-second heart rate after test" min="40" max="220" required>
                        <div class="input-hint">
                            <i class="bi bi-info-circle"></i>
                            Complete ${currentTest.testTarget || '3'} minutes stepping, rest 5 seconds, then count pulse for 60 seconds
                        </div>
                    </div>
                `;
            }
            // 1-MILE RUN (NEW)
            else if (normalizedName.includes('mile') || normalizedName.includes('run') || normalizedName.includes('1-mile')) {
                const targetHint = currentTest.testTarget ? ` (Target: ${currentTest.testTarget} minutes)` : '';
                html = `
                    <div class="input-group-custom">
                        <label class="input-label">‚è±Ô∏è Completion Time <span style="color: #ef4444;">*</span></label>
                        <input type="text" class="input-field" id="timeInput" placeholder="Use timer above${targetHint}" readonly>
                        <div class="input-hint">
                            <i class="bi bi-info-circle"></i>
                            Use the timer above to track your 1-mile run time${targetHint}
                        </div>
                    </div>
                `;
            }
            // SIT-AND-REACH
            else if (normalizedName.includes('sit-and-reach') || normalizedName.includes('sit and reach')) {
                const targetHint = currentTest.testTarget ? ` (Target: ${currentTest.testTarget} cm)` : '';
                html = `
                    <div class="input-group-custom">
                        <label class="input-label">üìè Distance Reached (cm) <span style="color: #ef4444;">*</span></label>
                        <input type="number" class="input-field" id="distanceInput" placeholder="Enter distance in cm${targetHint}" step="0.1" required>
                        <div class="input-hint">
                            <i class="bi bi-info-circle"></i>
                            Measure how far you can reach past your toes (positive = past toes)${targetHint}
                        </div>
                    </div>
                `;
                document.getElementById('submitBtn').disabled = false;
            }
            // BMI ASSESSMENT (NEW)
            else if (normalizedName.includes('bmi')) {
                html = `
                    <div class="input-group-custom">
                        <label class="input-label">üìè Height (cm) <span style="color: #ef4444;">*</span></label>
                        <input type="number" class="input-field" id="heightInput" placeholder="Enter height in centimeters" step="0.1" min="100" max="250" required>
                    </div>
                    <div class="input-group-custom">
                        <label class="input-label">‚öñÔ∏è Weight (kg) <span style="color: #ef4444;">*</span></label>
                        <input type="number" class="input-field" id="weightInput" placeholder="Enter weight in kilograms" step="0.1" min="30" max="200" required>
                        <div class="input-hint">
                            <i class="bi bi-info-circle"></i>
                            BMI will be calculated automatically: weight (kg) √∑ height¬≤ (m¬≤)
                        </div>
                    </div>
                `;
                document.getElementById('submitBtn').disabled = false;
            }
            // SKINFOLD CALIPER (NEW)
            else if (normalizedName.includes('skinfold')) {
                const targetHint = currentTest.testTarget ? ` (Target: ${currentTest.testTarget}% body fat)` : '';
                html = `
                    <div class="input-group-custom">
                        <label class="input-label">üìä Body Fat Percentage (%) <span style="color: #ef4444;">*</span></label>
                        <input type="number" class="input-field" id="bodyFatInput" placeholder="Enter calculated body fat %${targetHint}" step="0.1" min="3" max="50" required>
                        <div class="input-hint">
                            <i class="bi bi-info-circle"></i>
                            Enter the body fat percentage calculated by trained professional using skinfold measurements${targetHint}
                        </div>
                    </div>
                `;
                document.getElementById('submitBtn').disabled = false;
            }
            // DEFAULT
            else {
                const targetHint = currentTest.testTarget ? ` (Target: ${currentTest.testTarget})` : '';
                html = `
                    <div class="input-group-custom">
                        <label class="input-label">üìä Test Result <span style="color: #ef4444;">*</span></label>
                        <input type="text" class="input-field" id="resultInput" placeholder="Enter your test result${targetHint}" required>
                        <div class="input-hint">
                            <i class="bi bi-info-circle"></i>
                            Enter your test result as instructed by your instructor${targetHint}
                        </div>
                    </div>
                `;
                document.getElementById('submitBtn').disabled = false;
            }

            inputSection.innerHTML = html;
        }
        function getTargetLabel(testName) {
    const normalized = testName.toLowerCase();
    if (normalized.includes('push-up') || normalized.includes('pushup')) return 'push-ups';
    if (normalized.includes('sit-up') || normalized.includes('situp')) return 'sit-ups';
    if (normalized.includes('plank')) return 'seconds';
    if (normalized.includes('step test')) return 'minutes';
    if (normalized.includes('sit-and-reach')) return 'cm';
    return 'units';
}
       
async function loadTestData() {
    const urlParams = new URLSearchParams(window.location.search);
    const testId = urlParams.get('testId');
    const testName = urlParams.get('testName');

    if (!testId || !testName) {
        alert('Invalid test parameters');
        window.location.href = './test.html';
        return;
    }

    try {
        console.log('üîÑ Loading test data:', testId);
        
        // Show loading state
        document.getElementById('testName').textContent = 'Loading Test...';
        document.getElementById('testSubtitle').textContent = 'Please wait while we load your test';
        
        const testDoc = await getDoc(doc(db, 'scheduledTests', testId));
        
        if (testDoc.exists()) {
            const testData = testDoc.data();
            currentTest = { 
                id: testDoc.id, 
                ...testData
            };
            
            console.log('üìã Test data loaded:', currentTest);
            
            // CRITICAL FIX: Ensure professor data exists
            if (!currentTest.professorId || !currentTest.professorEmail) {
                console.warn('‚ö†Ô∏è Professor data missing from test, attempting to find professor...');
                
                // Method 1: Try to get professor from section
                let professorFound = false;
                
                try {
                    const professorQuery = query(
                        collection(db, 'professorProfiles'),
                        where('assignedClass', '==', currentTest.section)
                    );
                    const professorSnapshot = await getDocs(professorQuery);
                    
                    if (!professorSnapshot.empty) {
                        professorSnapshot.forEach((profDoc) => {
                            const profData = profDoc.data();
                            currentTest.professorId = profData.uid || profDoc.id;
                            currentTest.professorEmail = profData.email || 'professor@umak.edu.ph';
                            professorFound = true;
                            console.log('‚úÖ Found professor by section:', profData.email);
                        });
                    }
                } catch (profError) {
                    console.error('Error finding professor by section:', profError);
                }
                
                // Method 2: Try to get any professor as fallback
                if (!professorFound) {
                    try {
                        const allProfessorsQuery = query(
                            collection(db, 'professorProfiles'),
                            where('role', '==', 'professor')
                        );
                        const allProfessorsSnapshot = await getDocs(allProfessorsQuery);
                        
                        if (!allProfessorsSnapshot.empty) {
                            const firstProf = allProfessorsSnapshot.docs[0];
                            const profData = firstProf.data();
                            currentTest.professorId = profData.uid || firstProf.id;
                            currentTest.professorEmail = profData.email || 'professor@umak.edu.ph';
                            professorFound = true;
                            console.log('‚úÖ Using first available professor:', profData.email);
                        }
                    } catch (fallbackError) {
                        console.error('Error finding any professor:', fallbackError);
                    }
                }
                
                // Final fallback if no professor found
                if (!professorFound) {
                    currentTest.professorId = 'default-professor-id';
                    currentTest.professorEmail = 'professor@umak.edu.ph';
                    console.log('‚ö†Ô∏è Using default professor data');
                }
                
                // Update the test document with professor data for future use
                try {
                    await updateDoc(doc(db, 'scheduledTests', currentTest.id), {
                        professorId: currentTest.professorId,
                        professorEmail: currentTest.professorEmail
                    });
                    console.log('‚úÖ Updated test with professor data');
                } catch (updateError) {
                    console.error('Error updating test with professor data:', updateError);
                }
            }
            
            console.log('‚úÖ Test data loaded successfully:', currentTest.testName);
            console.log('üë®‚Äçüè´ Professor assigned:', currentTest.professorEmail);
            
            // Update UI immediately
            let subtitleText = `Section: ${currentTest.section} ‚Ä¢ Deadline: ${new Date(currentTest.deadline).toLocaleDateString()}`;
            if (currentTest.testTarget) {
                const targetLabel = getTargetLabel(currentTest.testName);
                subtitleText += ` ‚Ä¢ üéØ Target: ${currentTest.testTarget} ${targetLabel}`;
            }
            document.getElementById('testName').textContent = currentTest.testName;
            document.getElementById('testSubtitle').textContent = subtitleText;
            
            // Setup inputs and instructions
            setupTestInputs(currentTest.testName);
            updateInstructions(currentTest.testName);
            
        } else {
            console.error('‚ùå Test not found:', testId);
            alert('Test not found or has been removed');
            window.location.href = './test.html';
        }
    } catch (error) {
        console.error('‚ùå Error loading test:', error);
        alert('Error loading test data. Please try again.');
        window.location.href = './test.html';
    }
}


       function updateInstructions(testName) {
    const instructionsText = document.getElementById('quickInstructions');
    const normalizedName = testName.toLowerCase();

    if (normalizedName.includes('push-up') || normalizedName.includes('pushup')) {
        instructionsText.textContent = 'Perform as many push-ups as you can with proper form. Keep your body straight, lower your chest to the ground, and push back up. Stop when you can no longer maintain correct form. Record your total repetitions below.';
    } else if (normalizedName.includes('sit-up') || normalizedName.includes('situp')) {
        instructionsText.textContent = 'Perform as many sit-ups as possible with proper form. Lie on your back with knees bent, hands behind your head, and curl up until your elbows touch your knees. Record your total repetitions below.';
    } else if (normalizedName.includes('plank')) {
        instructionsText.textContent = 'Click START to begin the timer. Hold a plank position with your body straight from head to heels, supporting yourself on your forearms and toes. When you can no longer maintain proper form, click STOP. Your time will be automatically recorded.';
    } else if (normalizedName.includes('step test') || normalizedName.includes('3-minute')) {
        instructionsText.textContent = 'Click START to begin the 3-minute timer. Step up and down on the platform at a steady pace of 24 steps per minute. After exactly 3 minutes, click STOP and immediately measure your heart rate. Record your heart rate below.';
    } else if (normalizedName.includes('mile') || normalizedName.includes('run')) {
        instructionsText.textContent = 'Click START to begin the timer and complete the run as fast as you can. When you finish, click STOP immediately. Your completion time will be automatically recorded.';
    } else if (normalizedName.includes('sit-and-reach') || normalizedName.includes('sit and reach')) {
        instructionsText.textContent = 'Sit on the floor with legs extended straight ahead. Slowly reach forward with both hands as far as possible, hold for 2 seconds. Measure the distance reached past your toes in centimeters. Perform 3 attempts and record the best result below.';
    } else if (normalizedName.includes('shoulder flexibility')) {
        instructionsText.textContent = 'Reach one arm over your shoulder and the other arm behind your back. Try to touch or overlap your fingers. Measure the distance between your hands in centimeters. If fingers touch, record 0. Record the measurement below.';
    } else if (normalizedName.includes('grip strength')) {
        instructionsText.textContent = 'Hold the grip strength dynamometer in one hand with your arm at your side. Squeeze as hard as you can for 3-5 seconds. Perform 3 attempts with each hand. Record the highest reading in kilograms below.';
           } else if (normalizedName.includes('curl-up') || normalizedName.includes('curl up')) {
        instructionsText.textContent = 'Lie on your back with knees bent and feet flat. Place tape marks 4.5 inches apart. With arms straight, slide your fingertips from the first mark to the second mark by curling your upper body. Perform one curl-up every 3 seconds following the metronome. Stop when you can no longer maintain the pace. Record your total repetitions.';
    } else if (normalizedName.includes('grip strength') || normalizedName.includes('grip')) {
        instructionsText.textContent = 'Stand with your arm at your side at 90-degree angle. Hold the dynamometer and squeeze as hard as possible for 3-5 seconds without moving your arm. Rest 1 minute between attempts. Perform 3 attempts with each hand. Record the highest reading in kilograms.';
    } else if (normalizedName.includes('1-mile') || normalizedName.includes('mile run')) {
        instructionsText.textContent = 'After warming up, click START and run 1 mile as fast as possible on a measured track. Try to maintain a steady pace throughout. Sprint the final 100 meters if possible. Click STOP immediately when you finish. Your completion time will be automatically recorded.';
    } else if (normalizedName.includes('bmi')) {
        instructionsText.textContent = 'Remove shoes and heavy clothing. Measure your height accurately using the stadiometer, standing straight with heels together. Measure your weight on a calibrated scale. Enter both measurements below and your BMI will be calculated automatically using the formula: weight (kg) √∑ height¬≤ (m¬≤).';
    } else if (normalizedName.includes('skinfold')) {
        instructionsText.textContent = 'This test requires a trained professional to perform skinfold measurements at 3 or 7 specific body sites using calipers. The measurements will be used in a formula to calculate your body fat percentage. Once the professional provides your calculated body fat percentage, enter it in the field below.';
    } else {
        instructionsText.textContent = 'Follow the test protocol as instructed. Complete the test according to proper form and technique. Record your results in the input field below when finished.';
    }
}

        async function loadStudentData(user) {
            try {
                const studentsQuery = query(
                    collection(db, 'students'),
                    where('email', '==', user.email)
                );
                const studentsSnapshot = await getDocs(studentsQuery);
                
                studentData = {
                    displayName: user.displayName || user.email.split('@')[0] || 'Student',
                    email: user.email,
                    section: 'Not Assigned'
                };
                
                if (!studentsSnapshot.empty) {
                    studentsSnapshot.forEach((doc) => {
                        const data = doc.data();
                        studentData = { 
                            ...studentData,
                            ...data,
                            studentId: doc.id
                        };
                    });
                }
                
                return studentData;
            } catch (error) {
                console.error('Error loading student data:', error);
                return null;
            }
        }

        window.submitTest = async function() {
    if (!currentTest || !studentData) {
        alert('Missing required data');
        return;
    }

    // Get input values based on test type
    let resultValue = '';
    let rawResult = ''; // Store raw numeric value for scoring
    const testName = currentTest.testName.toLowerCase();

    if (testName.includes('push-up') || testName.includes('pushup') || 
        testName.includes('sit-up') || testName.includes('situp')) {
        const input = document.getElementById('repetitionsInput');
        if (!input || !input.value) {
            alert('Please enter the number of repetitions');
            return;
        }
        rawResult = input.value;
        resultValue = input.value + ' reps';
    } else if (testName.includes('curl-up') || testName.includes('curl up')) {
        const input = document.getElementById('repetitionsInput');
        if (!input || !input.value) {
            alert('Please enter the number of curl-ups');
            return;
        }
        rawResult = input.value;
        resultValue = input.value + ' curl-ups';
    } else if (testName.includes('plank')) {
        const input = document.getElementById('durationInput');
        if (!input || !input.value) {
            alert('Please complete the timer and stop it');
            return;
        }
        // Convert MM:SS to seconds for scoring
        const [mins, secs] = input.value.split(':').map(Number);
        rawResult = (mins * 60 + secs).toString();
        resultValue = input.value;
    } else if (testName.includes('step test') || testName.includes('3-minute')) {
        const input = document.getElementById('heartRateInput');
        if (!input || !input.value) {
            alert('Please enter your heart rate');
            return;
        }
        rawResult = input.value;
        resultValue = input.value + ' bpm';
    } else if (testName.includes('mile') || testName.includes('run') || testName.includes('1-mile')) {
        const input = document.getElementById('timeInput');
        if (!input || !input.value) {
            alert('Please complete the timer and stop it');
            return;
        }
        // Convert MM:SS to total seconds for scoring
        const [mins, secs] = input.value.split(':').map(Number);
        rawResult = (mins * 60 + secs).toString();
        resultValue = input.value;
    } else if (testName.includes('sit-and-reach') || testName.includes('sit and reach')) {
        const input = document.getElementById('distanceInput');
        if (!input || !input.value) {
            alert('Please enter the distance');
            return;
        }
        rawResult = input.value;
        resultValue = input.value + ' cm';
    } else if (testName.includes('grip')) {
        const input = document.getElementById('strengthInput');
        if (!input || !input.value) {
            alert('Please enter your grip strength');
            return;
        }
        rawResult = input.value;
        resultValue = input.value + ' kg';
    } else if (testName.includes('bmi')) {
        const heightInput = document.getElementById('heightInput');
        const weightInput = document.getElementById('weightInput');
        if (!heightInput || !heightInput.value || !weightInput || !weightInput.value) {
            alert('Please enter both height and weight');
            return;
        }
        const heightCm = parseFloat(heightInput.value);
        const weightKg = parseFloat(weightInput.value);
        const heightM = heightCm / 100;
        const bmi = (weightKg / (heightM * heightM)).toFixed(1);
        rawResult = bmi;
        resultValue = `BMI: ${bmi} (H: ${heightCm}cm, W: ${weightKg}kg)`;
    } else if (testName.includes('skinfold')) {
        const input = document.getElementById('bodyFatInput');
        if (!input || !input.value) {
            alert('Please enter the body fat percentage');
            return;
        }
        rawResult = input.value;
        resultValue = input.value + '% body fat';
    } else {
        const input = document.getElementById('resultInput');
        if (!input || !input.value) {
            alert('Please enter your test result');
            return;
        }
        rawResult = input.value;
        resultValue = input.value;
    }

    const notes = document.getElementById('notesField').value;
    const timerValue = `${document.getElementById('minutes').textContent}:${document.getElementById('seconds').textContent}.${document.getElementById('milliseconds').textContent}`;

    // CALCULATE SCORE using the target
    const calculatedScore = calculateScoreWithTarget(currentTest.testName, rawResult, currentTest.testTarget);

    try {
        document.getElementById('submitBtn').disabled = true;
        document.getElementById('submitBtn').innerHTML = '<i class="bi bi-hourglass-split"></i> Submitting...';

        // Check how many attempts the student has already made
        const attemptsQuery = query(
            collection(db, 'testResults'),
            where('testId', '==', currentTest.id),
            where('studentEmail', '==', studentData.email)
        );
        const attemptsSnapshot = await getDocs(attemptsQuery);
        const currentAttempts = attemptsSnapshot.size;

        const docRef = await addDoc(collection(db, 'testResults'), {
            testId: currentTest.id,
            testName: currentTest.testName,
            studentEmail: studentData.email,
            studentName: studentData.displayName,
            studentId: currentUser.uid,
            section: studentData.section || currentTest.section,
            result: resultValue,
            resultData: rawResult, // Store raw result for recalculation
            testTarget: currentTest.testTarget || null,
            score: calculatedScore, // STORE THE CALCULATED SCORE
            timerValue: timerValue,
            notes: notes,
            attemptNumber: currentAttempts + 1,
            attemptsAllowed: currentTest.attemptsAllowed || 1,
            timestamp: serverTimestamp(),
            submittedAt: new Date().toISOString(),
            status: 'completed'
        });

        // Update student stats
        if (studentData.studentId) {
            await updateDoc(doc(db, 'students', studentData.studentId), {
                testsDone: increment(1),
                lastTestDate: serverTimestamp()
            });
        }

        // Update scheduled test completion count
        const testRef = doc(db, 'scheduledTests', currentTest.id);
        await updateDoc(testRef, {
            completedStudents: increment(1)
        });

        alert(`Test submitted successfully! (Attempt ${currentAttempts + 1} of ${currentTest.attemptsAllowed || 1})\nYour Score: ${calculatedScore}/100`);
        
        // Redirect to result page
        window.location.href = `./studentresult.html?resultId=${docRef.id}&testId=${currentTest.id}`;
    } catch (error) {
        console.error('Error submitting test:', error);
        alert('Error submitting test. Please try again.');
        document.getElementById('submitBtn').disabled = false;
        document.getElementById('submitBtn').innerHTML = '<i class="bi bi-check-circle-fill"></i> Submit Test Results';
    }
};

// ADD THIS NEW FUNCTION for accurate scoring
function calculateScoreWithTarget(testName, rawResult, testTarget) {
    const normalized = testName.toLowerCase();
    const numericValue = parseFloat(rawResult);
    
    console.log(`üéØ Scoring: ${testName} | Result: ${numericValue} | Target: ${testTarget}`);
    
    // If no target set, use default scoring
    if (!testTarget || testTarget <= 0) {
        return calculateDefaultScore(normalized, numericValue);
    }
    
    // TARGET-BASED SCORING
    if (normalized.includes('push-up') || normalized.includes('pushup') || 
        normalized.includes('sit-up') || normalized.includes('situp') ||
        normalized.includes('curl-up') || normalized.includes('curl up')) {
        // Repetition-based tests
        const percentage = (numericValue / testTarget) * 100;
        if (percentage >= 100) return 100;
        if (percentage >= 90) return 95;
        if (percentage >= 80) return 90;
        if (percentage >= 70) return 85;
        if (percentage >= 60) return 80;
        if (percentage >= 50) return 75;
        if (percentage >= 40) return 70;
        return Math.max(50, Math.round(percentage));
    }
    
    if (normalized.includes('plank')) {
        // Time-based (seconds)
        const percentage = (numericValue / testTarget) * 100;
        if (percentage >= 100) return 100;
        if (percentage >= 90) return 95;
        if (percentage >= 80) return 90;
        if (percentage >= 70) return 85;
        if (percentage >= 60) return 80;
        if (percentage >= 50) return 75;
        return Math.max(50, Math.round(percentage));
    }
    
    if (normalized.includes('grip')) {
        // Strength-based (kg)
        const percentage = (numericValue / testTarget) * 100;
        if (percentage >= 100) return 100;
        if (percentage >= 90) return 95;
        if (percentage >= 80) return 90;
        if (percentage >= 70) return 85;
        if (percentage >= 60) return 80;
        if (percentage >= 50) return 75;
        return Math.max(50, Math.round(percentage));
    }
    
    if (normalized.includes('sit-and-reach')) {
        // Distance-based (cm)
        const percentage = (numericValue / testTarget) * 100;
        if (percentage >= 100) return 100;
        if (percentage >= 90) return 95;
        if (percentage >= 80) return 90;
        if (percentage >= 70) return 85;
        if (percentage >= 60) return 80;
        if (percentage >= 50) return 75;
        return Math.max(50, Math.round(percentage));
    }
    
    if (normalized.includes('mile') || normalized.includes('run')) {
        // Time-based - LOWER IS BETTER
        const percentage = (testTarget / numericValue) * 100;
        if (percentage >= 100) return 100;
        if (percentage >= 90) return 95;
        if (percentage >= 80) return 90;
        if (percentage >= 70) return 85;
        if (percentage >= 60) return 80;
        if (percentage >= 50) return 75;
        return Math.max(50, Math.round(percentage));
    }
    
    if (normalized.includes('step test') || normalized.includes('3-minute')) {
        // Heart rate - LOWER IS BETTER
        // If target is 100 bpm, and student gets 90, that's better (110%)
        const percentage = (testTarget / numericValue) * 100;
        if (percentage >= 100) return 100;
        if (percentage >= 90) return 95;
        if (percentage >= 80) return 90;
        if (percentage >= 70) return 85;
        if (percentage >= 60) return 80;
        if (percentage >= 50) return 75;
        return Math.max(50, Math.round(percentage));
    }
    
    // Default for other tests
    return calculateDefaultScore(normalized, numericValue);
}

function calculateDefaultScore(normalized, numericValue) {
    // Fallback scoring when no target is set
    if (normalized.includes('push-up') || normalized.includes('pushup')) {
        if (numericValue >= 40) return 100;
        if (numericValue >= 30) return 90;
        if (numericValue >= 20) return 80;
        if (numericValue >= 15) return 70;
        return 60;
    }
    
    if (normalized.includes('curl-up') || normalized.includes('curl up')) {
        if (numericValue >= 75) return 100;
        if (numericValue >= 50) return 90;
        if (numericValue >= 30) return 80;
        if (numericValue >= 20) return 70;
        return 60;
    }
    
    if (normalized.includes('plank')) {
        if (numericValue >= 120) return 100;
        if (numericValue >= 90) return 90;
        if (numericValue >= 60) return 80;
        if (numericValue >= 45) return 70;
        return 60;
    }
    
    if (normalized.includes('grip')) {
        if (numericValue >= 60) return 100;
        if (numericValue >= 50) return 90;
        if (numericValue >= 40) return 80;
        if (numericValue >= 30) return 70;
        return 60;
    }
    
    if (normalized.includes('sit-and-reach')) {
        if (numericValue >= 20) return 100;
        if (numericValue >= 15) return 90;
        if (numericValue >= 10) return 80;
        if (numericValue >= 5) return 70;
        return 60;
    }
    
    return 75; // Default
}

        onAuthStateChanged(auth, async (user) => {
    const loadingScreen = document.getElementById('loadingScreen');
    const mainContent = document.getElementById('mainContent');

    if (user) {
        try {
            console.log('üë§ User authenticated:', user.email);
            currentUser = user;
            
            // Show a more specific loading message
            document.querySelector('.loading-text').textContent = 'Loading your test...';
            
            // Load data in parallel for better performance
            await Promise.all([
                loadStudentData(user),
                loadTestData()
            ]);
            
            console.log('‚úÖ All data loaded successfully');
            
            // Hide loading screen with a smooth transition
            loadingScreen.style.opacity = '0';
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                mainContent.style.display = 'block';
                // Trigger a small animation to show content is ready
                mainContent.style.opacity = '0';
                mainContent.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    mainContent.style.opacity = '1';
                    mainContent.style.transform = 'translateY(0)';
                }, 50);
            }, 300);
            
        } catch (error) {
            console.error('‚ùå Error loading page:', error);
            // Show user-friendly error message
            loadingScreen.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                    <div class="loading-text" style="color: #ef4444;">Failed to Load Test</div>
                    <p style="color: #64748b; margin: 15px 0;">There was an error loading your test.</p>
                    <button onclick="window.location.reload()" style="
                        background: #3b82f6;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-family: 'Inter', sans-serif;
                    ">Try Again</button>
                </div>
            `;
        }
    } else {
        console.log('üö´ No user authenticated, redirecting to login');
        window.location.href = '../login/index.html';
    }
});
        // Add this function to create active test document
async function createActiveTestDocument() {
    try {
        console.log('üéØ Creating active test document...');
        console.log('üë®‚Äçüè´ Professor data:', {
            professorId: currentTest.professorId,
            professorEmail: currentTest.professorEmail
        });
        
        const activeTestData = {
            studentId: currentUser.uid,
            studentName: studentData.displayName,
            studentEmail: studentData.email,
            professorId: currentTest.professorId,
            professorEmail: currentTest.professorEmail,
            section: studentData.section || currentTest.section,
            testName: currentTest.testName,
            testId: currentTest.id,
            status: 'active',
            progress: 0,
            startTime: serverTimestamp(),
            metrics: {
                repetitions: 0,
                timeElapsed: '0:00',
                heartRate: null,
                formAnalysis: {
                    formScore: 0,
                    feedback: 'Test started...'
                }
            },
            createdAt: serverTimestamp()
        };

        const activeTestRef = await addDoc(collection(db, 'activeTests'), activeTestData);
        console.log('‚úÖ Active test document created:', activeTestRef.id);
        
        // Verify the document was created
        const createdDoc = await getDoc(activeTestRef);
        console.log('üìã Created document data:', createdDoc.data());
        
        return activeTestRef.id;
        
    } catch (error) {
        console.error('‚ùå Error creating active test document:', error);
        return null;
    }
}

// Add this function to update progress
async function updateActiveTestProgress(progress, metrics = {}) {
    try {
        // You'll need to store the activeTestId when creating the document
        if (window.activeTestId) {
            const activeTestRef = doc(db, 'activeTests', window.activeTestId);
            await updateDoc(activeTestRef, {
                progress: progress,
                metrics: metrics,
                lastUpdate: serverTimestamp()
            });
        }
    } catch (error) {
        console.error('Error updating active test progress:', error);
    }
}

// Add this function to complete/delete active test
async function completeActiveTest() {
    try {
        if (window.activeTestId) {
            const activeTestRef = doc(db, 'activeTests', window.activeTestId);
            await updateDoc(activeTestRef, {
                status: 'completed',
                completedAt: serverTimestamp()
            });
            // Or delete it if you don't need history:
            // await deleteDoc(activeTestRef);
        }
    } catch (error) {
        console.error('Error completing active test:', error);
    }
}


    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>