<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UMak Fitness Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .font-manrope { font-family: 'Manrope', sans-serif; }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-down {
            animation: slideDown 0.3s ease;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .spinner {
            border: 4px solid #e5e7eb;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #2563eb;
        }
        
        /* Chart container improvements */
        .chart-container {
            position: relative;
            height: 100%;
            width: 100%;
        }
        
        /* Card hover effects */
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* Loading states */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
        }
        
        @keyframes loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white/98 flex flex-col items-center justify-center z-50">
        <div class="spinner"></div>
        <div class="mt-5 text-gray-600 font-medium text-sm md:text-base">Loading Dashboard...</div>
    </div>
    
    <div id="mainContent" class="hidden">
        <!-- Navigation -->
        <nav class="bg-gradient-to-r from-blue-900 to-blue-500 shadow-lg">
            <div class="container mx-auto px-3 sm:px-4 py-4 sm:py-5">
                <div class="flex flex-wrap items-center justify-between gap-3 sm:gap-4">
                    <!-- Logo -->
                    <a href="#" class="flex items-center gap-2 sm:gap-3">
                        <img src="https://c.animaapp.com/vkhEa8zW/img/screenshot-2025-09-19-2-53-51-pm-removebg-preview-3@2x.png" 
                             alt="UMak Logo" class="h-12 sm:h-14 md:h-16 w-auto object-contain">
                        <span class="text-xl sm:text-2xl md:text-3xl font-extrabold font-manrope bg-gradient-to-r from-yellow-400 to-yellow-200 bg-clip-text text-transparent">
                            UMakFit
                        </span>
                    </a>
                    
                    <!-- Desktop Navigation -->
                    <div class="hidden lg:flex items-center gap-2 flex-wrap">
                        <a href="#" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white text-gray-900 rounded-lg font-semibold text-sm flex items-center gap-2 shadow-sm hover:shadow-md hover:-translate-y-0.5 transition-all">
                            <i class="bi bi-speedometer2"></i> 
                            <span class="hidden xl:inline">Dashboard</span>
                        </a>
                        <a href="./test.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="bi bi-clipboard-check"></i> 
                            <span class="hidden xl:inline">Tests</span>
                        </a>
                        <a href="./progress.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="bi bi-graph-up"></i> 
                            <span class="hidden xl:inline">Progress</span>
                        </a>
                        <a href="./studentlesson.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="bi bi-book"></i> 
                            <span class="hidden xl:inline">Lessons</span>
                        </a>
                        <a href="./studentgrades.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="bi bi-award"></i> 
                            <span class="hidden xl:inline">Grades</span>
                        </a>
                        <a href="#" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="bi bi-book"></i> 
                            <span class="hidden xl:inline">Achievements</span>
                        </a>
                        
                        <!-- Notification Bell -->
                        <div class="relative">
                            <button id="notificationBellBtn" 
                                    class="w-9 h-9 xl:w-10 xl:h-10 bg-white/20 border-2 border-white/30 rounded-full flex items-center justify-center text-white hover:bg-white/30 hover:scale-110 transition-all">
                                <i class="bi bi-bell-fill text-base xl:text-lg"></i>
                                <span id="navNotificationCount" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold px-1.5 py-0.5 rounded-full min-w-[18px] h-4.5 flex items-center justify-center pulse-animation">0</span>
                            </button>
                            
                            <!-- Notification Dropdown -->
                            <div id="notificationDropdown" class="hidden absolute right-0 mt-2 w-80 sm:w-96 max-w-[calc(100vw-2rem)] bg-white rounded-xl shadow-2xl z-[9999] slide-down max-h-[480px] overflow-y-auto">
                                <div class="p-3 sm:p-4 border-b-2 border-gray-200 bg-gradient-to-r from-gray-50 to-white flex justify-between items-center rounded-t-xl sticky top-0 z-10">
                                    <h6 class="font-bold text-gray-900 text-sm sm:text-base flex items-center gap-2">
                                        <i class="bi bi-bell-fill text-blue-500"></i> Notifications
                                    </h6>
                                    <button class="text-gray-400 hover:text-gray-600 p-1">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                                <div id="notificationDropdownBody" class="max-h-96 overflow-y-auto">
                                    <div class="p-6 sm:p-8 text-center text-gray-400">
                                        <i class="bi bi-bell-slash text-4xl sm:text-5xl mb-3 block"></i>
                                        <p class="text-gray-600 text-sm sm:text-base">No notifications yet</p>
                                    </div>
                                </div>
                                <div class="p-2 sm:p-3 border-t-2 border-gray-200 bg-gray-50 rounded-b-xl sticky bottom-0">
                                    <button class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-2 px-3 sm:px-4 rounded-lg font-semibold text-xs sm:text-sm hover:from-blue-600 hover:to-blue-700 hover:shadow-lg transition-all">
                                        View All Notifications
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Profile Dropdown -->
                        <div class="relative">
                            <img src="" alt="Profile" id="profilePictureBtn"
                                 class="w-9 h-9 xl:w-10 xl:h-10 rounded-full border-2 border-white/30 cursor-pointer hover:border-white/60 hover:scale-105 transition-all object-cover">
                            
                            <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-64 sm:w-72 bg-white rounded-xl shadow-2xl z-[9999] slide-down">
                                <div class="p-4 sm:p-6 border-b-2 border-gray-200 text-center">
                                    <img src="" alt="Profile" id="profileDropdownPicture" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full mx-auto mb-2 sm:mb-3 border-3 border-blue-500 object-cover">
                                    <h6 id="profileDropdownName" class="font-bold text-gray-900 text-base sm:text-lg">Loading...</h6>
                                    <p id="profileDropdownEmail" class="text-xs sm:text-sm text-gray-500 mt-1 truncate px-2">Loading...</p>
                                </div>
                                <div class="p-2">
                                    <a href="./studentProfile.html" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-gray-100 transition-colors">
                                        <i class="bi bi-person-circle text-blue-500 text-lg sm:text-xl"></i>
                                        <span class="font-medium text-gray-700 text-sm sm:text-base">View Profile</span>
                                    </a>
                                    <div class="h-px bg-gray-200 my-1 sm:my-2"></div>
                                    <div class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-red-50 transition-colors cursor-pointer text-red-500">
                                        <i class="bi bi-box-arrow-right text-lg sm:text-xl"></i>
                                        <span class="font-medium text-sm sm:text-base">Logout</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mobile Right Icons -->
                    <div class="flex lg:hidden items-center gap-2 sm:gap-3">
                        <!-- Mobile Notification -->
                        <div class="relative">
                            <button id="notificationBellBtnMobile" 
                                    class="w-9 h-9 sm:w-10 sm:h-10 bg-white/20 border-2 border-white/30 rounded-full flex items-center justify-center text-white hover:bg-white/30 transition-all">
                                <i class="bi bi-bell-fill text-base"></i>
                                <span id="navNotificationCountMobile" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold px-1.5 py-0.5 rounded-full min-w-[18px] h-4.5 flex items-center justify-center pulse-animation">0</span>
                            </button>
                            
                            <!-- Mobile Notification Dropdown (positioned fixed for mobile) -->
                            <div id="notificationDropdownMobile" class="hidden fixed right-2 left-2 top-20 bg-white rounded-xl shadow-2xl z-[9999] slide-down max-h-[calc(100vh-6rem)] overflow-y-auto">
                                <div class="p-3 sm:p-4 border-b-2 border-gray-200 bg-gradient-to-r from-gray-50 to-white flex justify-between items-center rounded-t-xl sticky top-0 z-10">
                                    <h6 class="font-bold text-gray-900 text-sm sm:text-base flex items-center gap-2">
                                        <i class="bi bi-bell-fill text-blue-500"></i> Notifications
                                    </h6>
                                    <button class="text-gray-400 hover:text-gray-600 p-1">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                                <div id="notificationDropdownBodyMobile" class="max-h-96 overflow-y-auto">
                                    <div class="p-6 sm:p-8 text-center text-gray-400">
                                        <i class="bi bi-bell-slash text-4xl sm:text-5xl mb-3 block"></i>
                                        <p class="text-gray-600 text-sm sm:text-base">No notifications yet</p>
                                    </div>
                                </div>
                                <div class="p-2 sm:p-3 border-t-2 border-gray-200 bg-gray-50 rounded-b-xl sticky bottom-0">
                                    <button class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-2 px-3 sm:px-4 rounded-lg font-semibold text-xs sm:text-sm hover:from-blue-600 hover:to-blue-700 hover:shadow-lg transition-all">
                                        View All Notifications
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mobile Profile -->
                        <div class="relative">
                            <img src="" alt="Profile" id="profilePictureBtnMobile"
                                 class="w-9 h-9 sm:w-10 sm:h-10 rounded-full border-2 border-white/30 cursor-pointer hover:border-white/60 object-cover">
                            
                            <!-- Mobile Profile Dropdown (positioned fixed for mobile) -->
                            <div id="profileDropdownMobile" class="hidden fixed right-2 top-20 w-64 sm:w-72 bg-white rounded-xl shadow-2xl z-[9999] slide-down">
                                <div class="p-4 sm:p-6 border-b-2 border-gray-200 text-center">
                                    <img src="" alt="Profile" id="profileDropdownPictureMobile" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full mx-auto mb-2 sm:mb-3 border-3 border-blue-500 object-cover">
                                    <h6 id="profileDropdownNameMobile" class="font-bold text-gray-900 text-base sm:text-lg">Loading...</h6>
                                    <p id="profileDropdownEmailMobile" class="text-xs sm:text-sm text-gray-500 mt-1 truncate px-2">Loading...</p>
                                </div>
                                <div class="p-2">
                                    <a href="./studentProfile.html" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-gray-100 transition-colors">
                                        <i class="bi bi-person-circle text-blue-500 text-lg sm:text-xl"></i>
                                        <span class="font-medium text-gray-700 text-sm sm:text-base">View Profile</span>
                                    </a>
                                    <div class="h-px bg-gray-200 my-1 sm:my-2"></div>
                                    <div class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-red-50 transition-colors cursor-pointer text-red-500">
                                        <i class="bi bi-box-arrow-right text-lg sm:text-xl"></i>
                                        <span class="font-medium text-sm sm:text-base">Logout</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mobile Menu Button -->
                        <button id="mobileMenuButton" class="text-white p-1 sm:p-2">
                            <i class="bi bi-list text-2xl sm:text-3xl"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Mobile Navigation Menu -->
                <div id="mobileMenu" class="hidden lg:hidden mt-3 sm:mt-4 space-y-2">
                    <a href="#" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white text-gray-900 rounded-lg font-semibold text-sm">
                        <i class="bi bi-speedometer2 mr-2"></i> Dashboard
                    </a>
                    <a href="./test.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                        <i class="bi bi-clipboard-check mr-2"></i> Tests
                    </a>
                    <a href="./progress.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                        <i class="bi bi-graph-up mr-2"></i> Progress
                    </a>
                    <a href="./studentlesson.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                         <i class="bi bi-book mr-2"></i> Lessons
                    </a>
                    <a href="./studentgrades.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                        <i class="bi bi-award mr-2"></i> Grades
                    </a>
                    <a href="#" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                        <i class="bi bi-book mr-2"></i> Achievements
                    </a>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container mx-auto px-3 sm:px-4 lg:px-6 py-4 sm:py-6 max-w-7xl">
            <!-- UMak Logo -->
            <div class="mb-4 sm:mb-6 text-center">
                <img src="https://c.animaapp.com/OLLvAv1E/img/screenshot-2025-10-18-110909-1@2x.png" 
                     alt="UMak Banner" class="h-12 sm:h-14 md:h-16 mx-auto object-contain">
            </div>

            <!-- Hero Welcome Card -->
            <div class="bg-gradient-to-br from-blue-900 to-blue-500 rounded-xl sm:rounded-2xl p-4 sm:p-6 md:p-8 lg:p-10 text-white shadow-xl mb-4 sm:mb-6 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 sm:w-48 sm:h-48 bg-white/10 rounded-full transform translate-x-1/3 -translate-y-1/3"></div>
                
                <div class="relative z-10">
                    <h1 class="text-xl sm:text-2xl md:text-3xl lg:text-4xl font-bold mb-1 sm:mb-2 leading-tight">
                        Welcome Back<br><span id="studentName" class="break-words">Student Name</span>!
                    </h1>
                    <p class="text-xs sm:text-sm md:text-base opacity-90 mb-4 sm:mb-6 md:mb-8">
                        <span id="studentCourse" class="break-words">Subject</span> | ID: <span id="studentId">A12345678</span>
                    </p>
                    
                    <!-- Stats Grid -->
                    <div class="grid grid-cols-3 gap-2 sm:gap-3 md:gap-4">
                        <div class="bg-white/20 backdrop-blur-lg rounded-lg sm:rounded-xl p-2.5 sm:p-4 md:p-5 text-center border border-white/20 hover:bg-white/25 transition-all hover:-translate-y-1">
                            <div id="testsDone" class="text-2xl sm:text-3xl md:text-4xl font-bold mb-0.5 sm:mb-1">0</div>
                            <div class="text-[10px] sm:text-xs md:text-sm font-semibold opacity-90 leading-tight">Tests<br class="sm:hidden"> Completed</div>
                        </div>
                        <div class="bg-white/20 backdrop-blur-lg rounded-lg sm:rounded-xl p-2.5 sm:p-4 md:p-5 text-center border border-white/20 hover:bg-white/25 transition-all hover:-translate-y-1">
                            <div id="avgScore" class="text-2xl sm:text-3xl md:text-4xl font-bold mb-0.5 sm:mb-1">0</div>
                            <div class="text-[10px] sm:text-xs md:text-sm font-semibold opacity-90 leading-tight">Average<br class="sm:hidden"> Score</div>
                        </div>
                       <div class="bg-white/20 backdrop-blur-lg rounded-lg sm:rounded-xl p-2.5 sm:p-4 md:p-5 text-center border border-white/20 hover:bg-white/25 transition-all hover:-translate-y-1">
                        <div id="bestScore" class="text-2xl sm:text-3xl md:text-4xl font-bold mb-0.5 sm:mb-1">0</div>
                        <div class="text-[10px] sm:text-xs md:text-sm font-semibold opacity-90 leading-tight">Best<br class="sm:hidden"> Score</div>
                        <div id="bestScoreTest" class="text-[9px] sm:text-[10px] opacity-75 mt-1 truncate hidden"></div>
                        </div>
                    </div>
                </div>
            </div>

           <!-- Content Grid -->
           <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 sm:gap-6 mb-4 sm:mb-6">
                <!-- Left Column - Performance Summary -->
                <div class="lg:col-span-4 xl:col-span-4">
                    <div class="bg-white rounded-xl shadow-md border border-gray-200 p-4 sm:p-5 md:p-6 hover:shadow-lg transition-shadow h-full card-hover">
                        <h5 class="text-base sm:text-lg font-bold text-gray-900 mb-3 sm:mb-4 flex items-center">
                            <i class="bi bi-trophy text-blue-600 mr-2 text-lg sm:text-xl"></i>
                            <span class="text-sm sm:text-base md:text-lg">Performance Summary</span>
                        </h5>
                        
                        <div class="space-y-3 sm:space-y-4">
                            <div class="flex items-center gap-3 sm:gap-4 p-3 sm:p-4 bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl border-l-4 border-blue-500 hover:translate-x-1 transition-transform">
                                <div class="w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <i class="bi bi-clipboard-check-fill text-white text-lg sm:text-2xl"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="text-[10px] sm:text-xs text-gray-600 font-semibold uppercase tracking-wider mb-0.5 sm:mb-1">Completion Rate</div>
                                    <div id="completionRate" class="text-base sm:text-lg font-bold text-gray-900">0%</div>
                                </div>
                            </div>

                            <div class="flex items-center gap-3 sm:gap-4 p-3 sm:p-4 bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl border-l-4 border-blue-500 hover:translate-x-1 transition-transform">
                                <div class="w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <i class="bi bi-graph-up-arrow text-white text-lg sm:text-2xl"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="text-[10px] sm:text-xs text-gray-600 font-semibold uppercase tracking-wider mb-0.5 sm:mb-1">Overall Progress</div>
                                    <div id="overallProgress" class="text-base sm:text-lg font-bold text-gray-900">Beginner</div>
                                </div>
                            </div>

                            <!-- New Elements Added Here -->
                            <div class="flex items-center gap-3 sm:gap-4 p-3 sm:p-4 bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl border-l-4 border-blue-500 hover:translate-x-1 transition-transform">
                                <div class="w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <i class="bi bi-fire text-white text-lg sm:text-2xl"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="text-[10px] sm:text-xs text-gray-600 font-semibold uppercase tracking-wider mb-0.5 sm:mb-1">Week Streak</div>
                                    <div id="currentStreak" class="text-base sm:text-lg font-bold text-gray-900">0 days</div>
                                </div>
                            </div>

                            <div class="flex items-center gap-3 sm:gap-4 p-3 sm:p-4 bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl border-l-4 border-blue-500 hover:translate-x-1 transition-transform">
                                <div class="w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <i class="bi bi-award text-white text-lg sm:text-2xl"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="text-[10px] sm:text-xs text-gray-600 font-semibold uppercase tracking-wider mb-0.5 sm:mb-1">Rank / Level</div>
                                    <div id="rankLevel" class="text-base sm:text-lg font-bold text-gray-900">Novice</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 sm:gap-4 p-3 sm:p-4 bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl border-l-4 border-blue-500 hover:translate-x-1 transition-transform">
                                <div class="w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <i class="bi bi-trophy text-white text-lg sm:text-2xl"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="text-[10px] sm:text-xs text-gray-600 font-semibold uppercase tracking-wider mb-0.5 sm:mb-1">Class Ranking</div>
                                    <div id="classRanking" class="text-base sm:text-lg font-bold text-gray-900">Loading...</div>
                                    <div id="classRankingDetails" class="text-xs text-gray-500 mt-1">Calculating your position</div>
                                </div>
                            </div>

                            <!-- Strongest Category (Blue Version) -->
                            <div class="flex items-center gap-3 sm:gap-4 p-3 sm:p-4 bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl border-l-4 border-blue-500 hover:translate-x-1 transition-transform">
                                <div class="w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <i class="bi bi-star-fill text-white text-lg sm:text-2xl"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="text-[10px] sm:text-xs text-gray-600 font-semibold uppercase tracking-wider mb-0.5 sm:mb-1">Strongest Category</div>
                                    <div id="strongestCategory" class="text-base sm:text-lg font-bold text-gray-900">Loading...</div>
                                    <div id="strongestCategoryScore" class="text-xs text-gray-500 mt-1">Calculating your best performance</div>
                                </div>
                            </div>
                            
                            <div class="bg-gradient-to-r from-yellow-100 to-yellow-200 p-3 sm:p-4 md:p-5 rounded-xl border-l-4 border-yellow-500 mt-3 sm:mt-4">
                                <h6 class="font-bold text-yellow-900 text-xs sm:text-sm mb-1 sm:mb-2">ðŸ’¡ Personalized Quick Tip</h6>
                                <p id="dailyTip" class="text-xs sm:text-sm text-gray-900 leading-relaxed">Complete your pending tests to track your fitness progress!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Middle Column - Comprehensive Fitness Overview -->
                <div class="lg:col-span-5 xl:col-span-5 space-y-4 sm:space-y-6">
                    <!-- Overall Fitness Progress -->
                    <div class="bg-white rounded-xl shadow-md border border-gray-200 p-4 sm:p-5 md:p-6 hover:shadow-lg transition-shadow card-hover">
                        <h5 class="text-base sm:text-lg font-bold text-gray-900 mb-3 sm:mb-4 flex items-center">
                            <i class="bi bi-graph-up-arrow text-blue-600 mr-2 text-lg sm:text-xl"></i>
                            <span class="text-sm sm:text-base md:text-lg">Fitness Progress Overview</span>
                        </h5>
                        <div class="h-48 sm:h-56 md:h-64 lg:h-72 bg-gray-50 rounded-xl p-2 chart-container">
                            <canvas id="fitnessOverviewChart"></canvas>
                        </div>
                    </div>

                    <!-- Category Performance Radar -->
                    <div class="bg-white rounded-xl shadow-md border border-gray-200 p-4 sm:p-5 md:p-6 hover:shadow-lg transition-shadow card-hover">
                        <h5 class="text-base sm:text-lg font-bold text-gray-900 mb-3 sm:mb-4 flex items-center">
                            <i class="bi bi-radar text-blue-600 mr-2 text-lg sm:text-xl"></i>
                            <span class="text-sm sm:text-base md:text-lg">Category Performance</span>
                        </h5>
                        <div class="h-48 sm:h-56 md:h-64 lg:h-72 bg-gray-50 rounded-xl p-2 chart-container">
                            <canvas id="performanceRadarChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Upcoming Tests -->
                <div class="lg:col-span-3 xl:col-span-3">
                    <div class="bg-white rounded-xl shadow-md border border-gray-200 p-4 sm:p-5 md:p-6 hover:shadow-lg transition-shadow h-full card-hover">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 sm:gap-4 mb-4 sm:mb-6">
                            <h5 class="text-base sm:text-lg font-bold text-gray-900 flex items-center">
                                <i class="bi bi-calendar-check text-blue-600 mr-2 text-lg sm:text-xl"></i>
                                <span class="text-sm sm:text-base md:text-lg">Upcoming Tests</span>
                            </h5>
                            <a href="./test.html" class="w-full sm:w-auto px-3 sm:px-4 py-2 border-2 border-blue-500 text-blue-500 rounded-lg font-semibold text-xs sm:text-sm hover:bg-blue-500 hover:text-white transition-all text-center">
                                <i class="bi bi-eye mr-1"></i>View All
                            </a>
                        </div>
                        
                        <div id="upcomingTestsCard">
                            <div class="text-center py-8 sm:py-12">
                                <i class="bi bi-calendar-x text-5xl sm:text-6xl text-gray-300 mb-2 sm:mb-3"></i>
                                <p class="text-gray-600 font-semibold mb-1 text-sm sm:text-base">No upcoming tests</p>
                                <small class="text-gray-400 text-xs sm:text-sm">Check back later for scheduled tests</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Test Results Card - Full Width at Bottom -->
            <div class="bg-white rounded-xl shadow-md border border-gray-200 p-4 sm:p-5 md:p-6 hover:shadow-lg transition-shadow mb-4 sm:mb-6 card-hover">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 sm:gap-4 mb-4 sm:mb-6">
                    <h5 class="text-base sm:text-lg font-bold text-gray-900 flex items-center">
                        <i class="bi bi-clipboard-data text-blue-600 mr-2 text-lg sm:text-xl"></i>
                        <span class="text-sm sm:text-base md:text-lg">Recent Test Results</span>
                    </h5>
                    <button id="exportResultsBtn" class="w-full sm:w-auto px-3 sm:px-4 py-2 border-2 border-blue-500 text-blue-500 rounded-lg font-semibold text-xs sm:text-sm hover:bg-blue-500 hover:text-white transition-all">
                        <i class="bi bi-download mr-1"></i>Export All
                    </button>
                </div>
                
                <div id="recentTestResultCard">
                    <div class="text-center py-8 sm:py-12">
                        <i class="bi bi-clipboard-data text-5xl sm:text-6xl text-gray-300 mb-2 sm:mb-3"></i>
                        <p class="text-gray-600 font-semibold mb-1 text-sm sm:text-base">No test results yet</p>
                        <small class="text-gray-400 text-xs sm:text-sm">Complete a test to see your results here</small>
                    </div>
                </div>
            </div>
        </div>
            <!-- Footer -->
            <footer class="bg-gray-800 text-white mt-12 sm:mt-16 py-8 sm:py-12 -mx-3 sm:-mx-4 lg:-mx-6">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 sm:gap-8 text-center md:text-left">
                        <div>
                            <h6 class="text-orange-500 font-bold text-base sm:text-lg mb-3 sm:mb-4">About CTBL</h6>
                            <p class="text-xs leading-relaxed text-gray-300">
                                The Center for Technology Based Learning serves as the learning management system operating hub, reporting to the university MANCOM officials.
                            </p>
                        </div>

                        <div>
                            <h6 class="text-orange-500 font-bold text-base sm:text-lg mb-3 sm:mb-4">Contact Us</h6>
                            <p class="text-xs leading-relaxed text-gray-300 mb-2 sm:mb-3">
                                J.P. Rizal Extension, West Rembo, 1644 City of Taguig, Metro Manila, Philippines<br>
                                Email: <a href="mailto:tblhub@umak.edu.ph" class="underline hover:text-orange-400">tblhub@umak.edu.ph</a>
                            </p>
                            <a href="https://www.facebook.com/CHKstudentcouncilofficial" target="_blank" 
                               class="inline-flex items-center gap-2 hover:text-orange-400 transition-colors text-xs sm:text-sm">
                                <i class="bi bi-facebook text-lg sm:text-xl text-blue-600"></i>
                                <span>Follow us on Facebook</span>
                            </a>
                        </div>

                        <div>
                            <h6 class="text-orange-500 font-bold text-base sm:text-lg mb-3 sm:mb-4">Links</h6>
                            <p class="text-xs leading-relaxed text-gray-300">
                                University of Makati<br>
                                Legacy TBL Hub<br>
                                UMak Online Library<br>
                                Contact TBL Hub Support
                            </p>
                        </div>
                    </div>
                </div>
            </footer>

            <div class="bg-black text-gray-400 py-4 sm:py-6 text-center text-[10px] sm:text-xs px-4 -mx-3 sm:-mx-4 lg:-mx-6">
                Copyright Â© 2025 - University of Makati - Technology Based Learning Hub.
                Powered by <a href="https://moodle.org/" class="underline hover:text-white">Moodle</a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            collection, 
            query, 
            where, 
            getDocs, 
            orderBy,
            limit
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAgaLunqEf2gs6dSpF_sz1hV5XQ5Wm52jo",
            authDomain: "umakfit-e3b1d.firebaseapp.com",
            projectId: "umakfit-e3b1d",
            storageBucket: "umakfit-e3b1d.appspot.com",
            messagingSenderId: "276569891504",
            appId: "1:276569891504:web:39b1732b519f4d8b785175"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables
        let currentUser = null;
        let studentData = null;
        let availableTests = [];
        let currentTest = null;
        let allTestResults = [];
        let showAllResults = false;

        const VISIBLE_RESULTS_COUNT = 2;
            const testCategories = {
            'Cardiorespiratory Endurance': {
                tests: ['3-Minute Step Test', '1-Mile Run', '1 Mile Run', 'BMI Assessment'],
                icon: 'https://c.animaapp.com/HN7hFbsr/img/image-148@2x.png',
                subtitle: 'Heart and lung fitness tests'
            },
            'Muscular Strength': {
                tests: ['Push-Up Test', 'Grip Strength'],
                icon: 'https://c.animaapp.com/HN7hFbsr/img/image-149@2x.png',
                subtitle: 'Maximum force tests'
            },
            'Muscular Endurance': {
                tests: ['Curl-Up Test', 'Push-up Test', 'Plank Hold'],
                icon: 'https://c.animaapp.com/HN7hFbsr/img/image-150@2x.png',
                subtitle: 'Repeated contractions tests'
            },
            'Flexibility': {
                tests: ['Sit-and-Reach', 'Shoulder Flexibility'],
                icon: 'https://c.animaapp.com/HN7hFbsr/img/image-48@2x.png',
                subtitle: 'Range of motion tests'
            },
            'Body Composition': {
                tests: ['BMI Assessment', 'Skinfold Caliper Measurements'],
                icon: 'https://c.animaapp.com/HN7hFbsr/img/image-151@2x.png',
                subtitle: 'Body fat and mass tests'
            }
        };
        // DOM Elements
        const loadingScreen = document.getElementById('loadingScreen');
        const mainContent = document.getElementById('mainContent');
        const mobileMenuButton = document.getElementById('mobileMenuButton');
        const mobileMenu = document.getElementById('mobileMenu');
        const notificationBellBtn = document.getElementById('notificationBellBtn');
        const notificationBellBtnMobile = document.getElementById('notificationBellBtnMobile');
        const notificationDropdown = document.getElementById('notificationDropdown');
        const notificationDropdownMobile = document.getElementById('notificationDropdownMobile');
        const profilePictureBtn = document.getElementById('profilePictureBtn');
        const profilePictureBtnMobile = document.getElementById('profilePictureBtnMobile');
        const profileDropdown = document.getElementById('profileDropdown');
        const profileDropdownMobile = document.getElementById('profileDropdownMobile');
        const exportResultsBtn = document.getElementById('exportResultsBtn');

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
    // Mobile menu toggle
    if (mobileMenuButton) {
        mobileMenuButton.addEventListener('click', toggleMobileMenu);
    }
    
    // Notification dropdowns
    if (notificationBellBtn) {
        notificationBellBtn.addEventListener('click', toggleNotificationDropdown);
    }
    
    if (notificationBellBtnMobile) {
        notificationBellBtnMobile.addEventListener('click', toggleNotificationDropdown);
    }
    
    // Profile dropdowns
    if (profilePictureBtn) {
        profilePictureBtn.addEventListener('click', toggleProfileDropdown);
    }
    
    if (profilePictureBtnMobile) {
        profilePictureBtnMobile.addEventListener('click', toggleProfileDropdown);
    }
    
    // Export results
    if (exportResultsBtn) {
        exportResultsBtn.addEventListener('click', exportAllResults);
    }
    
    // ADD THESE LOGOUT EVENT LISTENERS:
    // Logout buttons - Desktop
    document.querySelectorAll('#profileDropdown [class*="text-red-500"]').forEach(btn => {
        btn.addEventListener('click', handleLogout);
    });
    
    // Logout buttons - Mobile
    document.querySelectorAll('#profileDropdownMobile [class*="text-red-500"]').forEach(btn => {
        btn.addEventListener('click', handleLogout);
    });
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', closeAllDropdowns);
});

        // Mobile menu toggle
        function toggleMobileMenu() {
            mobileMenu.classList.toggle('hidden');
        }

        // Notification dropdown
        function toggleNotificationDropdown(event) {
    event?.stopPropagation();
    const isMobile = window.innerWidth < 1024;
    const dropdown = isMobile ? notificationDropdownMobile : notificationDropdown;
    
    const isHidden = dropdown.classList.contains('hidden');
    
    if (isHidden) {
        dropdown.classList.remove('hidden');
        document.body.classList.add('dropdown-open');
        loadNotificationDropdown();
        updateNavNotificationCount(0);
        closeProfileDropdown();
    } else {
        dropdown.classList.add('hidden');
        document.body.classList.remove('dropdown-open');
    }
}

        function closeNotificationDropdown() {
    notificationDropdown.classList.add('hidden');
    notificationDropdownMobile.classList.add('hidden');
    document.body.classList.remove('dropdown-open');
}

        // Profile dropdown
        function toggleProfileDropdown(event) {
    event?.stopPropagation();
    const isMobile = window.innerWidth < 1024;
    const dropdown = isMobile ? profileDropdownMobile : profileDropdown;
    
    const isHidden = dropdown.classList.contains('hidden');
    
    if (isHidden) {
        dropdown.classList.remove('hidden');
        document.body.classList.add('dropdown-open');
        closeNotificationDropdown();
    } else {
        dropdown.classList.add('hidden');
        document.body.classList.remove('dropdown-open');
    }
}

        function closeProfileDropdown() {
    profileDropdown.classList.add('hidden');
    profileDropdownMobile.classList.add('hidden');
    document.body.classList.remove('dropdown-open');
}

        // Close all dropdowns when clicking outside
        function closeAllDropdowns(event) {
            if (!event.target.closest('#notificationBellBtn') && 
                !event.target.closest('#notificationBellBtnMobile') && 
                !event.target.closest('#notificationDropdown') && 
                !event.target.closest('#notificationDropdownMobile')) {
                closeNotificationDropdown();
            }
            
            if (!event.target.closest('#profilePictureBtn') && 
                !event.target.closest('#profilePictureBtnMobile') && 
                !event.target.closest('#profileDropdown') && 
                !event.target.closest('#profileDropdownMobile')) {
                closeProfileDropdown();
            }
        }

        // Logout function
        async function handleLogout() {
    if (confirm('Are you sure you want to logout?')) {
        try {
            await signOut(auth);
            window.location.href = '../login/index.html';
        } catch (error) {
            console.error('Error logging out:', error);
            alert('Error logging out. Please try again.');
        }
    }
}
            function initializeCharts() {
    initializeFitnessOverviewChart();
    initializePerformanceRadarChart();
}
        // Initialize charts
        function initializeFitnessOverviewChart() {
    const canvas = document.getElementById('fitnessOverviewChart');
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    
    window.fitnessOverviewChart = new Chart(ctx, {
        type: 'line',  // Changed to line chart for better progress visualization
        data: {
            labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Current'],
            datasets: [{
                label: 'Cardiorespiratory',
                data: [0, 0, 0, 0, 0],
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Muscular Strength',
                data: [0, 0, 0, 0, 0],
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Muscular Endurance',
                data: [0, 0, 0, 0, 0],
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Flexibility',
                data: [0, 0, 0, 0, 0],
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Body Composition',
                data: [0, 0, 0, 0, 0],
                borderColor: '#a855f7',
                backgroundColor: 'rgba(168, 85, 247, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        padding: 10,
                        font: { size: 11, weight: '600' },
                        usePointStyle: true
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                    padding: 12,
                    titleFont: { size: 13, weight: 'bold' },
                    bodyFont: { size: 12 },
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.parsed.y}/100`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    grid: { color: 'rgba(0, 0, 0, 0.05)' },
                    ticks: {
                        font: { size: 11, weight: '600' },
                        stepSize: 20
                    },
                    title: {
                        display: true,
                        text: 'Score (0-100)',
                        font: { size: 12, weight: '700' }
                    }
                },
                x: {
                    grid: { display: false },
                    ticks: {
                        font: { size: 11, weight: '600' }
                    }
                }
            },
            animation: {
                duration: 1200,
                easing: 'easeOutQuart'
            }
        }
    });
}

        function initializePerformanceRadarChart() {
    const canvas = document.getElementById('performanceRadarChart');
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    
    // Sample data matching 5 categories
    const sampleData = {
        labels: [
            'Cardiorespiratory Endurance',
            'Muscular Strength',
            'Muscular Endurance',
            'Flexibility',
            'Body Composition'
        ],
        datasets: [{
            label: 'Current Performance',
            data: [0, 0, 0, 0, 0],
            backgroundColor: 'rgba(59, 130, 246, 0.2)',
            borderColor: '#3b82f6',
            pointBackgroundColor: '#3b82f6',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: '#3b82f6',
            borderWidth: 2
        }, {
            label: 'Target Performance',
            data: [85, 85, 85, 85, 85],
            backgroundColor: 'rgba(16, 185, 129, 0.2)',
            borderColor: '#10b981',
            pointBackgroundColor: '#10b981',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: '#10b981',
            borderWidth: 2,
            borderDash: [5, 5]
        }]
    };

    window.performanceRadarChart = new Chart(ctx, {
        type: 'radar',
        data: sampleData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        padding: 15,
                        font: {
                            size: 11,
                            weight: '600'
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 10,
                    titleFont: {
                        size: 11,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 10
                    }
                }
            },
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        stepSize: 20,
                        font: {
                            size: 9
                        }
                    },
                    pointLabels: {
                        font: {
                            size: 10,
                            weight: '600'
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                }
            },
            elements: {
                line: {
                    borderWidth: 2
                }
            }
        }
    });
}

        // Update charts with real data
        async function updateChartsWithRealData() {
    try {
        if (!studentData || !studentData.email) return;

        const resultsQuery = query(
            collection(db, 'testResults'),
            where('studentEmail', '==', studentData.email),
            where('status', '==', 'completed'),
            orderBy('submittedAt', 'asc')
        );
        
        const resultsSnapshot = await getDocs(resultsQuery);
        
        const categoryData = {
            'Cardiorespiratory Endurance': [],
            'Muscular Strength': [],
            'Muscular Endurance': [],
            'Flexibility': [],
            'Body Composition': []
        };
        
        console.log('ðŸ“Š Processing test results for charts...');
        
        // Group results by category with timestamps
        resultsSnapshot.forEach((doc) => {
            const result = doc.data();
            const category = getCategoryForTest(result.testName);
            
            // Use stored score if available, otherwise calculate
            const score = result.score || calculateTestScore(
                result.testName, 
                result.resultData || result.result, 
                result.testTarget
            );
            
            const timestamp = result.submittedAt?.toDate?.() || new Date(result.date);
            
            console.log(`ðŸ“ Test: ${result.testName} â†’ Category: ${category} â†’ Score: ${score}`);
            
            if (categoryData[category]) {
                categoryData[category].push({
                    score: score,
                    timestamp: timestamp,
                    testName: result.testName
                });
            }
        });
        
        console.log('ðŸ“Š Final category data:', categoryData);
        
        // Update Fitness Overview Chart (Line Chart showing progress over time)
        if (window.fitnessOverviewChart) {
            // Sort all tests by date to create timeline
            const allTests = [];
            Object.entries(categoryData).forEach(([category, tests]) => {
                tests.forEach(test => {
                    allTests.push({ ...test, category });
                });
            });
            
            allTests.sort((a, b) => a.timestamp - b.timestamp);
            
            // Group by time periods (last 5 data points)
            const timePoints = Math.min(5, allTests.length || 1);
            const labels = [];
            const dataByCategory = {
                'Cardiorespiratory Endurance': [],
                'Muscular Strength': [],
                'Muscular Endurance': [],
                'Flexibility': [],
                'Body Composition': []
            };
            
            if (allTests.length > 0) {
                // Create time-based labels
                for (let i = 0; i < timePoints; i++) {
                    const index = Math.floor((i / timePoints) * allTests.length);
                    const test = allTests[Math.min(index, allTests.length - 1)];
                    labels.push(test.timestamp.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric' 
                    }));
                }
                
                // Calculate progressive averages for each category
                Object.keys(dataByCategory).forEach(category => {
                    const categoryTests = categoryData[category];
                    
                    for (let i = 0; i < timePoints; i++) {
                        if (categoryTests.length > 0) {
                            const upToIndex = Math.min(
                                Math.floor((i + 1) / timePoints * categoryTests.length),
                                categoryTests.length
                            );
                            const relevantTests = categoryTests.slice(0, upToIndex || 1);
                            const avg = relevantTests.reduce((sum, t) => sum + t.score, 0) / relevantTests.length;
                            dataByCategory[category].push(Math.round(avg));
                        } else {
                            dataByCategory[category].push(0);
                        }
                    }
                });
            } else {
                // No data yet
                labels.push('No Data');
                Object.keys(dataByCategory).forEach(category => {
                    dataByCategory[category].push(0);
                });
            }
            
            window.fitnessOverviewChart.data.labels = labels;
            window.fitnessOverviewChart.data.datasets[0].data = dataByCategory['Cardiorespiratory Endurance'];
            window.fitnessOverviewChart.data.datasets[1].data = dataByCategory['Muscular Strength'];
            window.fitnessOverviewChart.data.datasets[2].data = dataByCategory['Muscular Endurance'];
            window.fitnessOverviewChart.data.datasets[3].data = dataByCategory['Flexibility'];
            window.fitnessOverviewChart.data.datasets[4].data = dataByCategory['Body Composition'];
            
            window.fitnessOverviewChart.update('active');
            console.log('âœ… Fitness Overview Chart updated');
        }
        
        // Update Performance Radar Chart
        if (window.performanceRadarChart) {
            const currentPerformance = [
                getLatestScore(categoryData['Cardiorespiratory Endurance']),
                getLatestScore(categoryData['Muscular Strength']),
                getLatestScore(categoryData['Muscular Endurance']),
                getLatestScore(categoryData['Flexibility']),
                getLatestScore(categoryData['Body Composition'])
            ];
            
            console.log('ðŸ“Š Current Performance:', currentPerformance);
            
            window.performanceRadarChart.data.datasets[0].data = currentPerformance;
            window.performanceRadarChart.data.datasets[1].data = [85, 85, 85, 85, 85];
            
            window.performanceRadarChart.update();
            console.log('âœ… Performance Radar Chart updated');
        }
        
    } catch (error) {
        console.error('âŒ Error updating charts:', error);
    }
}

        // Helper function to categorize tests
        function getCategoryForTest(testName) {
    const normalized = testName.toLowerCase().trim();
    
    console.log('ðŸ” Categorizing test:', testName, 'â†’', normalized);
    
    // Check each category's test list
    for (const [category, data] of Object.entries(testCategories)) {
        if (data.tests.some(t => 
            normalized.includes(t.toLowerCase()) || 
            t.toLowerCase().includes(normalized)
        )) {
            console.log('âœ… Category:', category);
            return category;
        }
    }
    
    // Fallback categorization
    if (normalized.includes('sit-and-reach') || 
        normalized.includes('sit and reach') ||
        normalized.includes('flexibility') ||
        normalized.includes('shoulder')) {
        console.log('âœ… Category: Flexibility (fallback)');
        return 'Flexibility';
    } else if (normalized.includes('push-up') || 
               normalized.includes('pushup') || 
               normalized.includes('push up') ||
               normalized.includes('grip')) {
        console.log('âœ… Category: Muscular Strength (fallback)');
        return 'Muscular Strength';
    } else if (normalized.includes('curl-up') ||
               normalized.includes('curl up') ||
               normalized.includes('plank')) {
        console.log('âœ… Category: Muscular Endurance (fallback)');
        return 'Muscular Endurance';
    } else if (normalized.includes('step') || 
               normalized.includes('run') || 
               normalized.includes('cardio') || 
               normalized.includes('mile') ||
               normalized.includes('bmi')) {
        console.log('âœ… Category: Cardiorespiratory Endurance (fallback)');
        return 'Cardiorespiratory Endurance';
    }
    
    console.log('âŒ No category found, defaulting to Cardiorespiratory Endurance');
    return 'Cardiorespiratory Endurance';
}
        
        function generateTimeLabels(categoryData) {
            // Generate time labels based on available data
            const allDates = [];
            Object.values(categoryData).forEach(category => {
                category.forEach(item => {
                    if (!allDates.includes(item.date)) {
                        allDates.push(item.date);
                    }
                });
            });
            
            allDates.sort((a, b) => new Date(a) - new Date(b));
            return allDates.slice(-5); // Last 5 data points
        }

        function getAveragedData(categoryData, length) {
            if (categoryData.length === 0) return Array(length).fill(0);
            
            // Simple average for demo - in real app, you'd want more sophisticated aggregation
            const avg = categoryData.reduce((sum, item) => sum + item.score, 0) / categoryData.length;
            return Array(length).fill(Math.round(avg));
        }

        function getLatestScore(categoryData) {
            if (categoryData.length === 0) return 0;
            return categoryData[categoryData.length - 1].score;
        }
            function getAverageScore(categoryData) {
    if (!categoryData || categoryData.length === 0) return 0;
    const sum = categoryData.reduce((total, item) => total + item.score, 0);
    const average = sum / categoryData.length;
    console.log(`ðŸ“Š Average for category: ${categoryData.length} tests, sum: ${sum}, avg: ${average}`);
    return Math.round(average);
}
       
        function calculateConsistencyScore(categoryData) {
            const allScores = [];
            Object.values(categoryData).forEach(category => {
                category.forEach(item => allScores.push(item.score));
            });
            
            if (allScores.length === 0) return 0;
            
            const avg = allScores.reduce((sum, score) => sum + score, 0) / allScores.length;
            const variance = allScores.reduce((sum, score) => sum + Math.pow(score - avg, 2), 0) / allScores.length;
            const consistency = Math.max(0, 100 - (variance * 2)); // Lower variance = higher consistency
            
            return Math.round(consistency);
        }

        // Load student data
        async function loadStudentData(user) {
            try {
                console.log('Loading data for student:', user.email);
                
                const studentRef = doc(db, 'students', user.uid);
                const studentDoc = await getDoc(studentRef);
                
                if (studentDoc.exists()) {
                    const data = studentDoc.data();
                    studentData = {
                        uid: user.uid,
                        displayName: `${data.firstName || ''} ${data.lastName || ''}`.trim() || user.email.split('@')[0],
                        email: data.email || user.email,
                        studentId: data.umakId || '000000',
                        course: data.department || 'Not Assigned',
                        section: data.section || 'Not Assigned',
                        overallScore: data.overallScore || 0,
                        testsDone: data.testsDone || 0,
                        weekStreak: data.weekStreak || 0,
                        profileComplete: data.profileComplete || false
                    };
                    console.log('âœ“ Student data loaded by UID:', studentData);
                } else {
                    console.log('Student not found by UID, trying by email...');
                    const studentsQuery = query(
                        collection(db, 'students'),
                        where('email', '==', user.email)
                    );
                    const studentsSnapshot = await getDocs(studentsQuery);
                    
                    if (!studentsSnapshot.empty) {
                        studentsSnapshot.forEach((doc) => {
                            const data = doc.data();
                            studentData = {
                                uid: user.uid,
                                displayName: `${data.firstName || ''} ${data.lastName || ''}`.trim() || user.email.split('@')[0],
                                email: data.email || user.email,
                                studentId: data.umakId || '000000',
                                course: data.department || 'Not Assigned',
                                section: data.section || 'Not Assigned',
                                overallScore: data.overallScore || 0,
                                testsDone: data.testsDone || 0,
                                weekStreak: data.weekStreak || 0,
                                profileComplete: data.profileComplete || false
                            };
                        });
                        console.log('âœ“ Student data loaded by email:', studentData);
                    } else {
                        console.log('âœ— No student profile found');
                        window.location.href = './profilesetup.html';
                        return null;
                    }
                }
                
                document.getElementById('studentName').textContent = studentData.displayName;
                document.getElementById('studentCourse').textContent = studentData.course;
                document.getElementById('studentId').textContent = studentData.studentId;

                await calculateAndUpdateStats();
                await updateChartsWithRealData();
                updateProfileUI();

                console.log('Final student data for dashboard:', studentData);
                return studentData;
            } catch (error) {
                console.error('Error loading student data:', error);
                alert('Error loading your profile. Please try again.');
                return null;
            }
        }

        // Load upcoming tests
        async function loadUpcomingTests() {
            try {
                if (!studentData || !studentData.section || studentData.section === 'Not Assigned') {
                    console.log('No student data or section available');
                    const container = document.getElementById('upcomingTestsCard');
                    if (container) {
                        container.innerHTML = `
                            <div class="text-center py-8 sm:py-12">
                                <i class="bi bi-calendar-x text-5xl sm:text-6xl text-gray-300 mb-2 sm:mb-3"></i>
                                <p class="text-gray-600 font-semibold mb-1 text-sm sm:text-base">No section assigned</p>
                                <small class="text-gray-400 text-xs sm:text-sm">Contact your instructor to be assigned to a section</small>
                            </div>
                        `;
                    }
                    return;
                }

                // Get all scheduled tests for this section
                const testsQuery = query(
                    collection(db, 'scheduledTests'),
                    where('section', '==', studentData.section),
                    where('isVisible', '==', true)
                );
                
                const testsSnapshot = await getDocs(testsQuery);
                const now = new Date();
                
                // Get all completed tests
                const completedTestsQuery = query(
                    collection(db, 'testResults'),
                    where('studentEmail', '==', studentData.email)
                );
                const completedTestsSnapshot = await getDocs(completedTestsQuery);
                
                // Map to store test completion status
                const testStatus = new Map();
                
                completedTestsSnapshot.forEach(doc => {
                    const result = doc.data();
                    const testId = result.testId;
                    const score = calculateTestScore(result.testName, result.result, result.testTarget);
                    
                    if (!testStatus.has(testId)) {
                        testStatus.set(testId, {
                            attempts: 0,
                            bestScore: 0
                        });
                    }
                    
                    const status = testStatus.get(testId);
                    status.attempts++;
                    if (score > status.bestScore) {
                        status.bestScore = score;
                    }
                });
                
                // Filter tests that can still be taken
                const upcomingTests = [];
                
                if (!testsSnapshot.empty) {
                    testsSnapshot.forEach((doc) => {
                        const test = { id: doc.id, ...doc.data() };
                        
                        let deadlineDateTime;
                        if (test.deadlineDateTime) {
                            deadlineDateTime = new Date(test.deadlineDateTime);
                        } else {
                            deadlineDateTime = new Date(test.deadline);
                            deadlineDateTime.setHours(23, 59, 59, 999);
                        }
                    
                        // Check if deadline hasn't passed
                        if (deadlineDateTime >= now) {
                            const status = testStatus.get(test.id);
                            
                            // Show test if:
                            // 1. Never attempted yet, OR
                            // 2. Has unlimited attempts and not perfect score, OR
                            // 3. Has attempts remaining and not perfect score
                            if (!status) {
                                upcomingTests.push(test);
                            } else {
                                const isUnlimited = test.attemptsAllowed === 0;
                                const isPerfect = status.bestScore === 100;
                                const hasAttemptsLeft = status.attempts < test.attemptsAllowed;
                                
                                if (!isPerfect && (isUnlimited || hasAttemptsLeft)) {
                                    upcomingTests.push(test);
                                }
                            }
                        }
                    });
                }
                
                // Sort by deadline (earliest first)
                upcomingTests.sort((a, b) => {
                    const dateA = new Date(a.deadlineDateTime || a.deadline);
                    const dateB = new Date(b.deadlineDateTime || b.deadline);
                    return dateA - dateB;
                });
                
                // Render the tests
                const container = document.getElementById('upcomingTestsCard');
                if (!container) {
                    console.error('Container "upcomingTestsCard" not found!');
                    return;
                }
                
                if (upcomingTests.length > 0) {
                    let html = '<div class="space-y-3 sm:space-y-4">';
                    
                    upcomingTests.forEach(test => {
                        const deadlineDateTime = test.deadlineDateTime ? new Date(test.deadlineDateTime) : new Date(test.deadline);
                        const dateStr = deadlineDateTime.toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            year: 'numeric'
                        });
                        const timeStr = test.deadlineTime || deadlineDateTime.toLocaleTimeString('en-US', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        const status = testStatus.get(test.id);
                        const isUnlimited = test.attemptsAllowed === 0;
                        const hasAttempts = status && status.attempts > 0;
                        
                        html += `
                            <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl p-3 sm:p-4 border-l-4 border-blue-500 hover:bg-blue-200 transition-colors">
                                <div class="flex justify-between items-start mb-2">
                                    <h6 class="font-semibold text-gray-900 text-sm sm:text-base flex-1 mr-2">${test.testName}</h6>
                                    <span class="bg-blue-500 text-white text-xs px-2 py-1 rounded-full font-semibold whitespace-nowrap">Due: ${dateStr}</span>
                                </div>
                                <p class="text-gray-600 text-xs sm:text-sm mb-2">â° ${timeStr}</p>
                                ${hasAttempts ? `
                                <p class="text-orange-600 font-semibold text-xs mb-2">
                                    ðŸ”„ ${isUnlimited ? `${status.attempts} Attempt${status.attempts > 1 ? 's' : ''} â€¢ Best: ${status.bestScore}` : `${status.attempts}/${test.attemptsAllowed} Attempts â€¢ Best: ${status.bestScore}`}
                                </p>
                                ` : `
                                <p class="text-green-600 font-semibold text-xs mb-2">
                                    âœ¨ ${isUnlimited ? 'Unlimited Attempts' : test.attemptsAllowed + ' Attempt' + (test.attemptsAllowed > 1 ? 's' : '') + ' Allowed'}
                                </p>
                                `}
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-gray-500">${getCategoryForTest(test.testName)}</span>
                                    <button data-test-id="${test.id}" class="start-test-btn px-3 py-1.5 ${hasAttempts ? 'bg-orange-500 hover:bg-orange-600' : 'bg-blue-500 hover:bg-blue-600'} text-white text-xs font-semibold rounded-lg transition-colors whitespace-nowrap">
                                        ${hasAttempts ? 'ðŸŽ¯ Retry' : 'Start Test'}
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    
                    if (upcomingTests.length > 3) {
                        html += `
                            <div class="mt-4 text-center">
                                <a href="./test.html" class="text-blue-600 hover:text-blue-700 font-semibold text-sm">
                                    View all ${upcomingTests.length} tests â†’
                                </a>
                            </div>
                        `;
                    }
                    
                    container.innerHTML = html;
                    
                    // Add event listeners to start test buttons
                    document.querySelectorAll('.start-test-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            const testId = this.getAttribute('data-test-id');
                            startTest(testId);
                        });
                    });
                    
                } else {
                    container.innerHTML = `
                        <div class="text-center py-8 sm:py-12">
                            <i class="bi bi-check-circle text-5xl sm:text-6xl text-green-300 mb-2 sm:mb-3"></i>
                            <p class="text-gray-600 font-semibold mb-1 text-sm sm:text-base">All tests completed!</p>
                            <small class="text-gray-400 text-xs sm:text-sm">Great job! Check back later for new tests</small>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading upcoming tests:', error);
                const container = document.getElementById('upcomingTestsCard');
                if (container) {
                    container.innerHTML = `
                        <div class="text-center py-8 sm:py-12">
                            <i class="bi bi-exclamation-circle text-red-500 text-5xl sm:text-6xl mb-2 sm:mb-3"></i>
                            <p class="text-red-500 font-semibold mb-1 text-sm sm:text-base">Error loading tests</p>
                            <small class="text-gray-400 text-xs sm:text-sm">${error.message}</small>
                        </div>
                    `;
                }
            }
        }

        // Calculate and update stats
        async function calculateAndUpdateStats() {
    try {
        if (!studentData || !studentData.email) {
            console.log('No student data available');
            return;
        }

        const resultsQuery = query(
            collection(db, 'testResults'),
            where('studentEmail', '==', studentData.email),
            where('status', '==', 'completed')
        );
        
        const resultsSnapshot = await getDocs(resultsQuery);
        
        let totalTests = 0;
        let totalScore = 0;
        let bestScore = 0;
        let bestTestName = '';
        
        resultsSnapshot.forEach((doc) => {
            const result = doc.data();
            // Use stored score or calculate from result data
            const score = result.score || calculateTestScore(result.testName, result.resultData || result.result, result.testTarget);
            
            totalTests++;
            totalScore += score;
            
            // Track best score and test name
            if (score > bestScore) {
                bestScore = score;
                bestTestName = result.testName;
            }
        });
        
        const avgScore = totalTests > 0 ? Math.round(totalScore / totalTests) : 0;
        
        // Update the DOM elements
        document.getElementById('testsDone').textContent = totalTests;
        document.getElementById('avgScore').textContent = avgScore;
        
        // Update best score with tooltip showing test name
        const bestScoreElement = document.getElementById('bestScore');
        bestScoreElement.textContent = bestScore;
        const bestScoreTestElement = document.getElementById('bestScoreTest');
        if (bestScoreTestElement && bestTestName) {
    bestScoreTestElement.textContent = bestTestName;
    bestScoreTestElement.classList.remove('hidden');
}
        
        // Add tooltip/title to show which test achieved the best score
        if (bestTestName) {
            bestScoreElement.title = `Best score from: ${bestTestName}`;
            bestScoreElement.style.cursor = 'help';
        }
        
        console.log('Stats updated:', { 
            totalTests, 
            avgScore, 
            bestScore,
            bestTestName 
        });
        
    } catch (error) {
        console.error('Error calculating stats:', error);
        document.getElementById('testsDone').textContent = '0';
        document.getElementById('avgScore').textContent = '0';
        document.getElementById('bestScore').textContent = '0';
    }
}

        // Update performance summary
        async function updatePerformanceSummary() {
            try {
                if (!studentData || !studentData.email) return;

                const assignedTestsQuery = query(
                    collection(db, 'scheduledTests'),
                    where('section', '==', studentData.section),
                    where('isVisible', '==', true)
                );
                const assignedTestsSnapshot = await getDocs(assignedTestsQuery);
                const totalAssigned = assignedTestsSnapshot.size;

                const completedTestsQuery = query(
                    collection(db, 'testResults'),
                    where('studentEmail', '==', studentData.email),
                    where('status', '==', 'completed')
                );
                const completedTestsSnapshot = await getDocs(completedTestsQuery);
                const totalCompleted = completedTestsSnapshot.size;

                const completionRate = totalAssigned > 0 ? Math.round((totalCompleted / totalAssigned) * 100) : 0;
                document.getElementById('completionRate').textContent = completionRate + '%';

                let progressLevel = 'Beginner';
                if (completionRate >= 80) progressLevel = 'Expert';
                else if (completionRate >= 60) progressLevel = 'Advanced';
                else if (completionRate >= 40) progressLevel = 'Intermediate';
                document.getElementById('overallProgress').textContent = progressLevel;

                // Calculate week streak
                let weekStreak = 0;
                if (!completedTestsSnapshot.empty) {
                    const tests = [];
                    completedTestsSnapshot.forEach(doc => {
                        tests.push(doc.data());
                    });
                    tests.sort((a, b) => {
                        const dateA = a.submittedAt?.toDate?.() || new Date(0);
                        const dateB = b.submittedAt?.toDate?.() || new Date(0);
                        return dateB - dateA;
                    });
                    
                    weekStreak = calculateWeekStreak(tests);
                }
                
                document.getElementById('currentStreak').textContent = weekStreak > 0 ? `${weekStreak} ${weekStreak === 1 ? 'week' : 'weeks'}` : '0 weeks';
                
                // Calculate rank/level based on completion rate and average score
                const avgScore = parseInt(document.getElementById('avgScore').textContent) || 0;
                const rankLevel = calculateRankLevel(completionRate, avgScore);
                document.getElementById('rankLevel').textContent = rankLevel;
                
                // Calculate Class Ranking
                await calculateClassRanking();
                
                // Calculate Strongest Category
                await calculateStrongestCategory();

                const tips = {
                    'Elite': 'Outstanding! You\'re at the top of your game. Maintain this excellence!',
                    'Expert': 'Excellent work! Keep maintaining your fitness routine.',
                    'Advanced': 'Great progress! Challenge yourself with harder variations.',
                    'Intermediate': 'Good job! Stay consistent to reach the next level.',
                    'Beginner': 'Keep pushing! Complete more tests to improve your ranking.',
                    'Novice': 'Complete your pending tests to track your fitness progress!'
                };
                document.getElementById('dailyTip').textContent = tips[rankLevel];

            } catch (error) {
                console.error('Error updating performance summary:', error);
            }
        }

        // Calculate class ranking
        async function calculateClassRanking() {
            try {
                if (!studentData || !studentData.section) return;
                
                // Get all students in the same section
                const studentsQuery = query(
                    collection(db, 'students'),
                    where('section', '==', studentData.section)
                );
                const studentsSnapshot = await getDocs(studentsQuery);
                
                // Calculate each student's average score
                const studentScores = [];
                for (const studentDoc of studentsSnapshot.docs) {
                    const student = studentDoc.data();
                    
                    const resultsQuery = query(
                        collection(db, 'testResults'),
                        where('studentEmail', '==', student.email),
                        where('status', '==', 'completed')
                    );
                    const resultsSnapshot = await getDocs(resultsQuery);
                    
                    let totalScore = 0;
                    let count = 0;
                    resultsSnapshot.forEach(doc => {
                        const result = doc.data();
                        const score = result.score || calculateTestScore(result.testName, result.resultData);
                        totalScore += score;
                        count++;
                    });
                    
                    const avgScore = count > 0 ? totalScore / count : 0;
                    studentScores.push({
                        email: student.email,
                        name: `${student.firstName || ''} ${student.lastName || ''}`.trim(),
                        avgScore: avgScore,
                        testsCompleted: count
                    });
                }
                
                // Sort by average score (descending)
                studentScores.sort((a, b) => b.avgScore - a.avgScore);
                
                // Find current student's rank
                const myRank = studentScores.findIndex(s => s.email === studentData.email) + 1;
                const totalStudents = studentScores.length;
                
                if (myRank > 0) {
                    document.getElementById('classRanking').textContent = `#${myRank} of ${totalStudents}`;
                    
                    // Calculate percentile
                    const percentile = Math.round(((totalStudents - myRank + 1) / totalStudents) * 100);
                    document.getElementById('classRankingDetails').textContent = `Top ${percentile}% in your section`;
                } else {
                    document.getElementById('classRanking').textContent = 'Not Ranked';
                    document.getElementById('classRankingDetails').textContent = 'Complete tests to get ranked';
                }
                
            } catch (error) {
                console.error('Error calculating class ranking:', error);
                document.getElementById('classRanking').textContent = 'Error';
                document.getElementById('classRankingDetails').textContent = 'Unable to calculate ranking';
            }
        }

        // Calculate strongest category
        async function calculateStrongestCategory() {
    try {
        const resultsQuery = query(
            collection(db, 'testResults'),
            where('studentEmail', '==', studentData.email),
            where('status', '==', 'completed')
        );

        const resultsSnapshot = await getDocs(resultsQuery);

        if (resultsSnapshot.empty) {
            document.getElementById('strongestCategory').textContent = 'No Data Yet';
            document.getElementById('strongestCategoryScore').textContent = 'Complete tests to see your strongest area';
            return;
        }

        // Initialize category scores using the same categories
        const categoryScores = {};
        Object.keys(testCategories).forEach(category => {
            categoryScores[category] = {
                totalScore: 0,
                testCount: 0,
                averageScore: 0
            };
        });

        // Calculate scores using getCategoryForTest function
        resultsSnapshot.forEach((doc) => {
            const result = doc.data();
            const score = result.score || calculateTestScore(result.testName, result.resultData || result.result, result.testTarget);
            const category = getCategoryForTest(result.testName);
            
            if (categoryScores[category]) {
                categoryScores[category].totalScore += score;
                categoryScores[category].testCount++;
            }
        });

        // Calculate average scores
        Object.keys(categoryScores).forEach(category => {
            if (categoryScores[category].testCount > 0) {
                categoryScores[category].averageScore = 
                    categoryScores[category].totalScore / categoryScores[category].testCount;
            }
        });

        // Find strongest category
        let strongestCategory = null;
        let highestAverageScore = -1;

        Object.entries(categoryScores).forEach(([category, data]) => {
            if (data.testCount > 0 && data.averageScore > highestAverageScore) {
                highestAverageScore = data.averageScore;
                strongestCategory = category;
            }
        });

        // Update UI
        if (strongestCategory && highestAverageScore > 0) {
            document.getElementById('strongestCategory').textContent = strongestCategory;
            document.getElementById('strongestCategoryScore').textContent = 
                `Average Score: ${Math.round(highestAverageScore)}/100 (${categoryScores[strongestCategory].testCount} test${categoryScores[strongestCategory].testCount > 1 ? 's' : ''})`;
        } else {
            document.getElementById('strongestCategory').textContent = 'No Data';
            document.getElementById('strongestCategoryScore').textContent = 'Complete tests to see your strongest area';
        }

        console.log('ðŸ“Š Category Scores:', categoryScores);
        console.log('ðŸ† Strongest Category:', strongestCategory, 'Score:', highestAverageScore);

    } catch (error) {
        console.error('Error calculating strongest category:', error);
        document.getElementById('strongestCategory').textContent = 'Error';
        document.getElementById('strongestCategoryScore').textContent = 'Unable to calculate';
    }
}

        // Calculate week streak
        function calculateWeekStreak(tests) {
            if (tests.length === 0) return 0;
            
            const currentDate = new Date();
            const currentWeek = getWeekNumber(currentDate);
            const currentYear = currentDate.getFullYear();
            
            // Group tests by week
            const weekMap = new Map();
            tests.forEach(test => {
                const testDate = test.submittedAt?.toDate?.() || new Date(test.date);
                const weekNum = getWeekNumber(testDate);
                const year = testDate.getFullYear();
                const key = `${year}-W${weekNum}`;
                weekMap.set(key, true);
            });
            
            // Count consecutive weeks from current week backwards
            let streak = 0;
            let checkYear = currentYear;
            let checkWeek = currentWeek;
            
            for (let i = 0; i < 52; i++) { // Max 52 weeks
                const key = `${checkYear}-W${checkWeek}`;
                if (weekMap.has(key)) {
                    streak++;
                    // Move to previous week
                    checkWeek--;
                    if (checkWeek < 1) {
                        checkWeek = 52;
                        checkYear--;
                    }
                } else {
                    break; // Streak broken
                }
            }
            
            return streak;
        }

        // Helper function to calculate rank/level
        function calculateRankLevel(completionRate, overallScore) {
            const score = (completionRate + overallScore) / 2;
            
            if (score >= 90) return 'Elite';
            if (score >= 80) return 'Expert';
            if (score >= 70) return 'Advanced';
            if (score >= 60) return 'Intermediate';
            if (score >= 40) return 'Beginner';
            return 'Novice';
        }

        // Load notification dropdown
        async function loadNotificationDropdown() {
            try {
                if (!studentData || !studentData.section) {
                    return;
                }

                const notificationsQuery = query(
                    collection(db, 'notifications'),
                    where('section', '==', studentData.section)
                );
                
                const notificationsSnapshot = await getDocs(notificationsQuery);
                
                // Use custom body if provided, otherwise update both
                const dropdownBodies = [
                    document.getElementById('notificationDropdownBody'),
                    document.getElementById('notificationDropdownBodyMobile')
                ];
                
                if (!notificationsSnapshot.empty) {
                    const notifications = [];
                    notificationsSnapshot.forEach(doc => {
                        notifications.push({ id: doc.id, ...doc.data() });
                    });
                    
                    notifications.sort((a, b) => {
                        const dateA = a.createdAt?.toDate?.() || new Date(0);
                        const dateB = b.createdAt?.toDate?.() || new Date(0);
                        return dateB - dateA;
                    });
                    
                    let html = '';
                    for (let i = 0; i < notifications.length; i++) {
                        const notification = notifications[i];
                        const createdDate = notification.createdAt?.toDate?.();
                        const dateStr = createdDate ? createdDate.toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        }) : 'Recently';
                        
                        html += `
                            <div class="p-3 sm:p-4 border-b border-gray-100 hover:bg-gray-50 transition-colors cursor-pointer">
                                <strong class="text-gray-900 text-xs sm:text-sm block mb-1 font-semibold">${notification.title || 'Notification'}</strong>
                                <p class="text-gray-600 text-xs sm:text-sm mb-1 leading-relaxed">${notification.message || ''}</p>
                                <small class="text-gray-400 text-[10px] sm:text-xs">${dateStr}</small>
                            </div>
                        `;
                    }
                    dropdownBodies.forEach(body => {
                        if (body) body.innerHTML = html;
                    });
                } else {
                    const emptyHtml = `
                        <div class="p-6 sm:p-8 text-center text-gray-400">
                            <i class="bi bi-bell-slash text-4xl sm:text-5xl mb-3 block"></i>
                            <p class="text-gray-600 text-sm">No notifications yet</p>
                        </div>
                    `;
                    dropdownBodies.forEach(body => {
                        if (body) body.innerHTML = emptyHtml;
                    });
                }
            } catch (error) {
                console.error('Error loading notification dropdown:', error);
            }
        }

        // Get week number
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNum = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return weekNum;
        }

        // Update nav notification count
        function updateNavNotificationCount(count) {
            const badge = document.getElementById('navNotificationCount');
            const badgeMobile = document.getElementById('navNotificationCountMobile');
            
            [badge, badgeMobile].forEach(el => {
                if (el) {
                    if (count > 0) {
                        el.textContent = count > 99 ? '99+' : count;
                        el.classList.remove('hidden');
                    } else {
                        el.classList.add('hidden');
                    }
                }
            });
        }

        // Update profile UI
        function updateProfileUI() {
            if (!currentUser || !studentData) return;
            
            const photoURL = currentUser?.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(studentData?.displayName || 'User') + '&background=3b82f6&color=fff&size=128';
            
            // Update all profile pictures
            const profileBtn = document.getElementById('profilePictureBtn');
            const profileBtnMobile = document.getElementById('profilePictureBtnMobile');
            if (profileBtn) profileBtn.src = photoURL;
            if (profileBtnMobile) profileBtnMobile.src = photoURL;
            
            // Update dropdown pictures
            const dropdownPic = document.getElementById('profileDropdownPicture');
            const dropdownPicMobile = document.getElementById('profileDropdownPictureMobile');
            if (dropdownPic) dropdownPic.src = photoURL;
            if (dropdownPicMobile) dropdownPicMobile.src = photoURL;
            
            // Update names
            const dropdownName = document.getElementById('profileDropdownName');
            const dropdownNameMobile = document.getElementById('profileDropdownNameMobile');
            if (dropdownName) dropdownName.textContent = studentData?.displayName || 'Student';
            if (dropdownNameMobile) dropdownNameMobile.textContent = studentData?.displayName || 'Student';
            
            // Update emails
            const dropdownEmail = document.getElementById('profileDropdownEmail');
            const dropdownEmailMobile = document.getElementById('profileDropdownEmailMobile');
            if (dropdownEmail) dropdownEmail.textContent = studentData?.email || currentUser?.email || '';
            if (dropdownEmailMobile) dropdownEmailMobile.textContent = studentData?.email || currentUser?.email || '';
        }

        // Load test history
        async function loadTestHistory() {
    try {
        if (!currentUser || !studentData) {
            console.log('No current user or student data');
            return;
        }

        console.log('=== LOADING MOST RECENT TEST RESULT ===');
        console.log('Student Email:', studentData.email);

        // Query by studentEmail with proper ordering
        const historyQuery = query(
            collection(db, 'testResults'),
            where('studentEmail', '==', studentData.email),
            where('status', '==', 'completed'),
            orderBy('submittedAt', 'desc'),
            limit(1)
        );
        
        let historySnapshot;
        try {
            historySnapshot = await getDocs(historyQuery);
            console.log('Query with orderBy found:', historySnapshot.size, 'results');
        } catch (indexError) {
            console.warn('Index not ready, trying without orderBy:', indexError);
            // Fallback without orderBy if index isn't ready
            const simpleQuery = query(
                collection(db, 'testResults'),
                where('studentEmail', '==', studentData.email),
                where('status', '==', 'completed')
            );
            historySnapshot = await getDocs(simpleQuery);
            
            // Manually sort and get the most recent
            const results = [];
            historySnapshot.forEach(doc => {
                results.push({ id: doc.id, ...doc.data() });
            });
            
            results.sort((a, b) => {
                const dateA = a.submittedAt?.toDate?.() || new Date(a.date || 0);
                const dateB = b.submittedAt?.toDate?.() || new Date(b.date || 0);
                return dateB - dateA;
            });
            
            const container = document.getElementById('recentTestResultCard');
            if (results.length > 0) {
                allTestResults = [results[0]];
                renderSingleTestResult(results[0], container);
            } else {
                allTestResults = [];
                container.innerHTML = `
                    <div class="text-center py-8 sm:py-12">
                        <i class="bi bi-clipboard-data text-5xl sm:text-6xl text-gray-300 mb-2 sm:mb-3"></i>
                        <p class="text-gray-600 font-semibold mb-1 text-sm sm:text-base">No test results yet</p>
                        <small class="text-gray-400 text-xs sm:text-sm">Complete a test to see your results here</small>
                    </div>
                `;
            }
            return;
        }
        
        const container = document.getElementById('recentTestResultCard');
        
        if (!container) {
            console.error('Container "recentTestResultCard" not found!');
            return;
        }
        
        if (!historySnapshot.empty) {
            const results = [];
            historySnapshot.forEach(doc => {
                const data = doc.data();
                console.log('Most recent test result:', data.testName, 'Score:', data.score, 'Date:', data.submittedAt?.toDate?.());
                results.push({ id: doc.id, ...data });
            });
            
            console.log('âœ“ Found most recent test result');
            
            allTestResults = results;
            renderSingleTestResult(results[0], container);
            
        } else {
            console.log('âœ— No completed tests found');
            allTestResults = [];
            container.innerHTML = `
                <div class="text-center py-8 sm:py-12">
                    <i class="bi bi-clipboard-data text-5xl sm:text-6xl text-gray-300 mb-2 sm:mb-3"></i>
                    <p class="text-gray-600 font-semibold mb-1 text-sm sm:text-base">No test results yet</p>
                    <small class="text-gray-400 text-xs sm:text-sm">Complete a test to see your results here</small>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading test history:', error);
        console.error('Error details:', error.message);
        const container = document.getElementById('recentTestResultCard');
        if (container) {
            container.innerHTML = `
                <div class="text-center py-8 sm:py-12">
                    <i class="bi bi-exclamation-circle text-red-500 text-5xl sm:text-6xl mb-2 sm:mb-3"></i>
                    <p class="text-red-500 font-semibold mb-1 text-sm sm:text-base">Error loading test results</p>
                    <small class="text-gray-400 text-xs sm:text-sm">${error.message}</small>
                </div>
            `;
        }
    }
}

        // Render single test result
        function renderSingleTestResult(result, container) {
    if (!result) {
        container.innerHTML = `
            <div class="text-center py-8 sm:py-12">
                <i class="bi bi-clipboard-data text-5xl sm:text-6xl text-gray-300 mb-2 sm:mb-3"></i>
                <p class="text-gray-600 font-semibold mb-1 text-sm sm:text-base">No test results yet</p>
                <small class="text-gray-400 text-xs sm:text-sm">Complete a test to see your results here</small>
            </div>
        `;
        return;
    }

    const submittedDate = result.submittedAt?.toDate?.() || new Date(result.date);
    const dateStr = submittedDate.toLocaleDateString('en-US', {
        month: '2-digit',
        day: '2-digit',
        year: 'numeric'
    });

    // Use stored score or calculate from result
    const score = result.score || calculateTestScore(result.testName, result.result, result.testTarget);
    const rating = getRating(score);

    const html = `
        <div class="bg-gray-50 rounded-xl p-3 sm:p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 sm:gap-4 hover:bg-gray-100 transition-colors">
            <div class="flex-1 w-full sm:w-auto">
                <h4 class="font-semibold text-gray-900 text-sm sm:text-base mb-1 sm:mb-2 break-words">${result.testName}</h4>
                <p class="${rating.class} text-xs sm:text-sm font-medium mb-1">Score: ${score}/100 â€¢ ${rating.text}</p>
                <small class="text-gray-500 text-[10px] sm:text-xs">Completed: ${dateStr}</small>
            </div>
            <button data-result-id="${result.id}" class="view-result-btn w-full sm:w-auto px-4 sm:px-6 py-2 sm:py-2.5 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg font-semibold text-xs sm:text-sm hover:from-blue-600 hover:to-blue-700 hover:-translate-y-0.5 hover:shadow-lg transition-all whitespace-nowrap">
                View Result
            </button>
        </div>
    `;

    container.innerHTML = html;
    
    // Add event listener to view result button
    const viewResultBtn = container.querySelector('.view-result-btn');
    if (viewResultBtn) {
        viewResultBtn.addEventListener('click', function() {
            const resultId = this.getAttribute('data-result-id');
            window.location.href = `./studentresult.html?resultId=${resultId}`;
        });
    }
}

        // Calculate test score
       function calculateTestScore(testName, result, testTarget = null) {
    const normalized = testName.toLowerCase().trim();
    
    // Extract numeric value from result
    let numericValue = 0;
    
    if (typeof result === 'object' && result !== null) {
        numericValue = result.repetitions || result.time || result.distance || result.value || result.score || 0;
    } else if (typeof result === 'string') {
        const match = result.match(/(\d+\.?\d*)/);
        if (match) {
            numericValue = parseFloat(match[1]);
        } else {
            numericValue = parseFloat(result) || 0;
        }
    } else {
        numericValue = parseFloat(result) || 0;
    }
    
    console.log(`ðŸ”¢ Score Calculation: ${testName} â†’ Value: ${numericValue}, Target: ${testTarget}`);
    
    // Use test target if available for more accurate scoring
    if (testTarget && testTarget > 0) {
        if (normalized.includes('push-up') || normalized.includes('pushup') || 
            normalized.includes('sit-up') || normalized.includes('situp') ||
            normalized.includes('curl-up') || normalized.includes('curl up')) {
            const percentage = (numericValue / testTarget) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 100) score = 100;
            else if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            console.log(`ðŸ’ª Strength Test: ${numericValue}/${testTarget} reps â†’ ${score}%`);
            return Math.round(score);
        } else if (normalized.includes('bmi')) {
            const bmi = numericValue;
            if (bmi >= 18.5 && bmi <= 24.9) return 100;
            if (bmi >= 17.0 && bmi < 18.5) return 85;
            if (bmi >= 25.0 && bmi < 27.0) return 85;
            if (bmi >= 16.0 && bmi < 17.0) return 70;
            if (bmi >= 27.0 && bmi < 30.0) return 70;
            if (bmi >= 15.0 && bmi < 16.0) return 60;
            if (bmi >= 30.0 && bmi < 35.0) return 60;
            return 50;
        } else if (normalized.includes('plank')) {
            let seconds = 0;
            if (typeof result === 'string' && result.includes(':')) {
                const [mins, secs] = result.split(':').map(Number);
                seconds = (mins * 60) + (secs || 0);
            } else {
                seconds = numericValue;
            }
            
            const percentage = (seconds / testTarget) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 100) score = 100;
            else if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            console.log(`â±ï¸ Plank Test: ${seconds}s/${testTarget}s â†’ ${score}%`);
            return Math.round(score);
        } else if (normalized.includes('sit-and-reach')) {
            const distance = numericValue;
            const percentage = (distance / testTarget) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 100) score = 100;
            else if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            console.log(`ðŸ“ Flexibility Test: ${distance}cm/${testTarget}cm â†’ ${score}%`);
            return Math.round(score);
        } else if (normalized.includes('grip')) {
            const strength = numericValue;
            const percentage = (strength / testTarget) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 100) score = 100;
            else if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            console.log(`ðŸ’ª Grip Test: ${strength}kg/${testTarget}kg â†’ ${score}%`);
            return Math.round(score);
        } else if (normalized.includes('mile') || normalized.includes('run')) {
            let totalSeconds = 0;
            if (typeof result === 'string' && result.includes(':')) {
                const [minutes, seconds] = result.split(':').map(Number);
                totalSeconds = (minutes * 60) + (seconds || 0);
            } else {
                totalSeconds = numericValue;
            }
            
            // Lower time is better
            const percentage = (testTarget / totalSeconds) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 100) score = 100;
            else if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            return Math.round(score);
        } else if (normalized.includes('step test') || normalized.includes('3-minute')) {
            // Lower heart rate is better
            const percentage = (testTarget / numericValue) * 100;
            let score = Math.min(100, Math.max(50, percentage));
            
            if (percentage >= 100) score = 100;
            else if (percentage >= 90) score = 95;
            else if (percentage >= 80) score = 90;
            else if (percentage >= 70) score = 85;
            else if (percentage >= 60) score = 80;
            else if (percentage >= 50) score = 75;
            
            return Math.round(score);
        }
    }
    
    // Fallback scoring without target
    if (normalized.includes('push-up') || normalized.includes('pushup')) {
        if (numericValue >= 40) return 100;
        if (numericValue >= 35) return 95;
        if (numericValue >= 30) return 90;
        if (numericValue >= 25) return 85;
        if (numericValue >= 20) return 80;
        if (numericValue >= 15) return 75;
        return 70;
    } else if (normalized.includes('curl-up') || normalized.includes('curl up')) {
        if (numericValue >= 75) return 100;
        if (numericValue >= 60) return 95;
        if (numericValue >= 50) return 90;
        if (numericValue >= 40) return 85;
        if (numericValue >= 30) return 80;
        return 75;
    } else if (normalized.includes('plank')) {
        let seconds = 0;
        if (typeof result === 'string' && result.includes(':')) {
            const [mins, secs] = result.split(':').map(Number);
            seconds = (mins * 60) + (secs || 0);
        } else {
            seconds = numericValue;
        }
        
        if (seconds >= 180) return 100;
        if (seconds >= 150) return 95;
        if (seconds >= 120) return 90;
        if (seconds >= 100) return 85;
        if (seconds >= 80) return 80;
        if (seconds >= 60) return 75;
        return 70;
    } else if (normalized.includes('sit-and-reach')) {
        if (numericValue >= 25) return 100;
        if (numericValue >= 20) return 95;
        if (numericValue >= 15) return 90;
        if (numericValue >= 10) return 85;
        if (numericValue >= 5) return 80;
        return 75;
    } else if (normalized.includes('grip')) {
        if (numericValue >= 60) return 100;
        if (numericValue >= 55) return 95;
        if (numericValue >= 50) return 90;
        if (numericValue >= 45) return 85;
        if (numericValue >= 40) return 80;
        return 75;
    }
    
    console.log(`â“ Unknown test type: ${testName}, using default score of 75`);
    return 75;
}

        // Get rating
        function getRating(score) {
            if (score >= 90) return { text: 'Excellent', class: 'text-green-600' };
            if (score >= 80) return { text: 'Good', class: 'text-blue-600' };
            if (score >= 70) return { text: 'Fair', class: 'text-yellow-600' };
            return { text: 'Needs Improvement', class: 'text-red-600' };
        }

        // View detailed result
        async function viewDetailedResult(resultId) {
            try {
                const resultRef = doc(db, 'testResults', resultId);
                const resultSnap = await getDoc(resultRef);
                
                if (resultSnap.exists()) {
                    const result = resultSnap.data();
                    const submittedDate = result.submittedAt?.toDate?.() || new Date(result.date);
                    const dateStr = submittedDate.toLocaleDateString('en-US', {
                        month: 'long',
                        day: 'numeric',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    let detailsHtml = `
                        <div style="padding: 1rem;">
                            <h5 style="color: #111827; margin-bottom: 1rem; font-size: 1.125rem;">${result.testName}</h5>
                            
                            <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 1.5rem; border-radius: 12px; text-align: center; margin-bottom: 1.5rem;">
                                <div style="font-size: 3rem; font-weight: 700; margin-bottom: 0.5rem;">${result.score}</div>
                                <div style="font-size: 0.875rem; opacity: 0.9;">Your Score</div>
                            </div>
                            
                            <div style="display: grid; gap: 1rem; margin-bottom: 1.5rem;">
                                <div style="padding: 1rem; background: #f9fafb; border-radius: 8px; border-left: 3px solid #3b82f6;">
                                    <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">DATE SUBMITTED</div>
                                    <div style="font-size: 1rem; color: #111827; font-weight: 600;">${dateStr}</div>
                                </div>
                                
                                <div style="padding: 1rem; background: #f9fafb; border-radius: 8px; border-left: 3px solid #3b82f6;">
                                    <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">SECTION</div>
                                    <div style="font-size: 1rem; color: #111827; font-weight: 600;">${result.section || 'N/A'}</div>
                                </div>
                                
                                ${result.resultData?.repetitions ? `
                                    <div style="padding: 1rem; background: #f9fafb; border-radius: 8px; border-left: 3px solid #3b82f6;">
                                        <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">REPETITIONS</div>
                                        <div style="font-size: 1rem; color: #111827; font-weight: 600;">${result.resultData.repetitions}</div>
                                    </div>
                                ` : ''}
                                
                                ${result.resultData?.time ? `
                                    <div style="padding: 1rem; background: #f9fafb; border-radius: 8px; border-left: 3px solid #3b82f6;">
                                        <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">TIME HELD</div>
                                        <div style="font-size: 1rem; color: #111827; font-weight: 600;">${result.resultData.time} seconds</div>
                                    </div>
                                ` : ''}
                                
                                ${result.resultData?.distance ? `
                                    <div style="padding: 1rem; background: #f9fafb; border-radius: 8px; border-left: 3px solid #3b82f6;">
                                        <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">DISTANCE REACHED</div>
                                        <div style="font-size: 1rem; color: #111827; font-weight: 600;">${result.resultData.distance} cm</div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            ${result.resultData?.notes ? `
                                <div style="padding: 1rem; background: #fef3c7; border-radius: 8px; border-left: 3px solid #f59e0b;">
                                    <div style="font-size: 0.75rem; color: #78350f; margin-bottom: 0.5rem; font-weight: 600;">YOUR NOTES</div>
                                    <div style="font-size: 0.875rem; color: #111827; line-height: 1.6;">${result.resultData.notes}</div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    alert(detailsHtml.replace(/<[^>]*>/g, '\n'));
                }
            } catch (error) {
                console.error('Error viewing detailed result:', error);
                alert('Error loading result details. Please try again.');
            }
        }

        // Export all results
        async function exportAllResults() {
            try {
                if (!currentUser) return;
                
                const historyQuery = query(
                    collection(db, 'testResults'),
                    where('studentId', '==', currentUser.uid),
                    where('status', '==', 'completed')
                );
                
                const historySnapshot = await getDocs(historyQuery);
                
                if (historySnapshot.empty) {
                    alert('No test results to export');
                    return;
                }
                
                let csvContent = 'Test Name,Date,Score,Section,Details\n';
                
                historySnapshot.forEach(doc => {
                    const result = doc.data();
                    const date = result.submittedAt?.toDate?.() || new Date(result.date);
                    const dateStr = date.toLocaleDateString('en-US');
                    
                    let details = '';
                    if (result.resultData?.repetitions) details += `${result.resultData.repetitions} reps`;
                    if (result.resultData?.time) details += `${result.resultData.time}s`;
                    if (result.resultData?.distance) details += `${result.resultData.distance}cm`;
                    
                    csvContent += `"${result.testName}","${dateStr}","${result.score}","${result.section || 'N/A'}","${details}"\n`;
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `my_test_results_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                alert('Test results exported successfully!');
            } catch (error) {
                console.error('Error exporting results:', error);
                alert('Error exporting results. Please try again.');
            }
        }

        // Start test
        function startTest(testId) {
    // Redirect to test details page
    window.location.href = `./testdetails.html?testId=${testId}`;
}

        // View test details
        function viewTestDetails(testId) {
            alert('Viewing test details: ' + testId);
        }

        // Auth state change listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    console.log('=== DASHBOARD: Checking access ===');
                    console.log('User:', user.email);
                    currentUser = user;
                    
                    const studentRef = doc(db, 'students', user.uid);
                    const studentSnap = await getDoc(studentRef);
                    
                    if (!studentSnap.exists()) {
                        console.log('âŒ No student profile, redirect to setup');
                        window.location.href = './profilesetup.html';  
                        return;
                    }
                    
                    const studentDataTemp = studentSnap.data();
                    
                    if (!studentDataTemp.profileComplete) {
                        console.log('âŒ Profile incomplete, redirect to setup');
                        window.location.href = './profilesetup.html';  
                        return;
                    }
                    
                    console.log('âœ“ Profile complete, loading dashboard...');
                    
                    const userRef = doc(db, 'users', user.uid);
                    const userDoc = await getDoc(userRef);
                    
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        
                        if (userData.role !== 'student') {
                            alert('Access Denied: This dashboard is for students only');
                            await signOut(auth);
                            window.location.href = '../login/index.html';
                            return;
                        }
                    }
                    
                    await loadStudentData(user);
                    initializeCharts(); // Initialize charts first
                    await loadTestHistory();
                    await updatePerformanceSummary();
                    await updateChartsWithRealData(); // Then populate with real data
                    await loadUpcomingTests();
                    
                    loadingScreen.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                    
                    console.log('âœ“ Dashboard loaded successfully');
                } catch (error) {
                    console.error('Error loading dashboard:', error);
                    alert('Error loading dashboard. Please try again.');
                    loadingScreen.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                }
            } else {    
                console.log('No user, redirecting to login');
                window.location.href = '../login/index.html';
            }
        });
    </script>
</body>
</html>